type: article
article_id: v0agy0hlyj
user_id: c5pqxi9gu9
category_id: 01tyeraya4
author:
  name: Manish Jaiswal
  profile_image: https://www.gravatar.com/avatar/a690002c3812e556fec2f79f91e5715e?d=mm&s=150
title: Save and Restore Cache from GCS
slug: save-cache-in-gcs
description: 'Caching has two primary benefits: It can make your jobs run faster by
  reusing the expensive fetch operation data from previous jobs. . It enables you
  to share data across Stages. In a Harness CI Pipe…'
short_version: 'Caching has two primary benefits: It can make your jobs run faster
  by reusing the expensive fetch operation data from previous jobs. . It enables you
  to share data across Stages. In a Harness CI Pipe…'
tags: []
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: ""
  source: API
  triggered_at: 2022-05-25T19:45:52.717183Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Save and Restore Cache from GCS
  description: ""
  short_version: ""
  body: '<p></p><p>Caching has two primary benefits:</p><ul><li>It can make your jobs
    run faster by reusing the expensive fetch operation data from previous jobs. </li><li>It
    enables you to share data across Stages.</li></ul><p>In a Harness CI Pipeline,
    you can save the cache to Google Cloud Storage (GCS) bucket in one stage using
    the Save Cache to GCS step and then restore it in the same or another stage using
    Restore Cache from GCS step. </p><p>The topic explains how to configure the Save
    Cache to GCS and Restore Cache from GCS steps in CIE using a two-Stage Pipeline.</p><div
    class="note-callout">You cannot share access credentials or other <a href="https://ngdocs.harness.io/article/osfw70e59c-add-use-text-secrets">Text
    Secrets</a> across Stages.</div><h3 id="undefined">Before You Begin</h3><ul><li><a
    href="https://newdocs.helpdocs.io/article/x0d77ktjw8-ci-pipeline-quickstart">CI
    Pipeline Quickstart</a></li><li><a href="https://newdocs.helpdocs.io/article/yn4x8vzw3q-ci-stage-settings">CI
    Stage Settings</a></li><li><a href="https://newdocs.helpdocs.io/category/rg8mrhqm95-set-up-build-infrastructure">Set
    Up Build Infrastructure</a></li><li><a href="https://newdocs.helpdocs.io/article/hv2758ro4e-learn-harness-key-concepts">Learn
    Harness&#39; Key Concepts</a></li></ul><h3>Limitations</h3><ul><li>You cannot
    share access credentials or other <a href="https://ngdocs.harness.io/article/osfw70e59c-add-use-text-secrets">Text
    Secrets</a> across Stages.</li><li>Use a dedicated bucket for your Harness cache
    operations. Do not save files to the bucket manually. The Retrieve Cache operation
    will fail if the bucket includes any files that do not have a Harness cache key.</li></ul><h3
    id="undefined">Review: YAML Example</h3><p>If you want to configure your Pipeline
    in YAML, in <strong>Pipeline Studio,</strong> click <strong>YAML</strong>. </p><p>The
    following YAML file defines a Pipeline with two Stages: Save Cache and Restore
    Cache. Copy the following YAML, paste it in the Harness YAML editor, and modify
    its attributes based on your Pipeline requirements.</p><pre class="hljs yaml">pipeline:<br/>    identifier:
    GCS_Save_and_Restore_Cache<br/>    name: GCS Save and Restore Cache<br/>    stages:<br/>        -
    stage:<br/>              identifier: GCS_Save_Cache<br/>              name: GCS
    Save Cache<br/>              type: CI<br/>              variables:<br/>                  -
    name: GCP_Access_Key<br/>                    type: String<br/>                    value:
    &lt;+input&gt;<br/>                  - name: GCP_Secret_Key<br/>                    type:
    Secret<br/>                    value: &lt;+input&gt;<br/>              spec:<br/>                  sharedPaths:<br/>                      -
    /.config<br/>                      - /.gsutil<br/>                  execution:<br/>                      steps:<br/>                          -
    step:<br/>                                identifier: createBucket<br/>                                name:
    create bucket<br/>                                type: Run<br/>                                spec:<br/>                                    connectorRef:
    &lt;+input&gt;<br/>                                    image: google/cloud-sdk:alpine<br/>                                    command:
    |+<br/>                                        echo $GCP_SECRET_KEY &gt; secret.json<br/>                                        cat
    secret.json<br/>                                        gcloud auth -q activate-service-account
    --key-file=secret.json<br/>                                        gsutil rm -r
    gs://harness-gcs-cache-tar || true<br/><br/>                                        gsutil
    mb -p ci-play gs://harness-gcs-cache-tar<br/><br/>                                    privileged:
    false<br/>                          - step:<br/>                                identifier:
    saveCacheTar<br/>                                name: Save Cache<br/>                                type:
    SaveCacheGCS<br/>                                spec:<br/>                                    connectorRef:
    &lt;+input&gt;<br/>                                    bucket: harness-gcs-cache-tar<br/>                                    key:
    cache-tar<br/>                                    sourcePaths:<br/>                                        -
    &lt;+input&gt;<br/>                                    archiveFormat: Tar<br/>                  infrastructure:<br/>                      type:
    KubernetesDirect<br/>                      spec:<br/>                          connectorRef:
    &lt;+input&gt;<br/>                          namespace: default<br/>                  cloneCodebase:
    true<br/>        - stage:<br/>              identifier: gcs_restore_cache<br/>              name:
    GCS Restore Cache<br/>              type: CI<br/>              variables:<br/>                  -
    name: GCP_Access_Key<br/>                    type: String<br/>                    value:
    &lt;+input&gt;<br/>                  - name: GCP_Secret_Key<br/>                    type:
    Secret<br/>                    value: &lt;+input&gt;<br/>              spec:<br/>                  sharedPaths:<br/>                      -
    /.config<br/>                      - /.gsutil<br/>                  execution:<br/>                      steps:<br/>                          -
    step:<br/>                                identifier: restoreCacheTar<br/>                                name:
    Restore Cache<br/>                                type: RestoreCacheGCS<br/>                                spec:<br/>                                    connectorRef:
    &lt;+input&gt;<br/>                                    bucket: harness-gcs-cache-tar<br/>                                    key:
    cache-tar<br/>                                    archiveFormat: Tar<br/>                                    failIfKeyNotFound:
    true<br/>                  infrastructure:<br/>                      useFromStage:
    gcs_save_cache<br/>                  cloneCodebase: false<br/> </pre><h3 id="undefined">Step
    1: Open the Build Stage</h3><p>In your Harness Pipeline, open the Stage where
    you want to save the cache.</p><h3 id="undefined">Step 2: Define the Build Farm
    Infrastructure</h3><p>In the Infrastructure tab, define the build farm for the
    codebase.</p><p>The following step uses a Kubernetes cluster build farm.</p><p>See <a
    href="https://ngdocs.harness.io/article/x7aedul8qs-kubernetes-cluster-build-infrastructure-setup">Define
    Kubernetes Cluster Build Infrastructure</a>.</p><h3 id="undefined">Step 3: Save
    Cache to GCS</h3><p>In the Execution tab, click <strong>Add Step</strong> and
    then select <strong>Save Cache to GCS</strong>. Here you configure the GCS bucket,
    keys, and source paths to enable Harness to save the cache to GCS.</p><p>For step
    settings, see <a href="/article/11nzeuntrz-save-cache-to-gcs-step-settings">Save
    Cache to GCS Step Settings</a>.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/v0agy0hlyj/1629116881353/save-to-cache-gcs.png"
    style="max-height:50%;max-width:50%;display:block;margin-left:0;margin-right:auto"
    data-hd-height="50%" data-hd-width="50%" data-hd-align="left"/></figure><h3>Step
    4: Restore Cache from GCS Stage</h3><p>In your Pipeline, click <strong>Add Stage</strong>
    where you want to restore the saved cache from GCS. </p><p>In the Execution tab,
    click <strong>Add Step</strong> and then select <strong>Restore Cache from GCS</strong>.
    Here you configure the GCS bucket keys on which you have your saved cache.</p><p>For
    step settings, see <a href="/article/zlpx6lli6d-restore-cache-from-s-3-step-settings">Restore
    Cache Step Settings</a>.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/v0agy0hlyj/1636692026066/zyucv-ui-f-4-al-29-rh-ld-89-y-kqe-gvwwpu-dh-xfw-kd-i-0-ek-jl-q-70-p-ztu-bzc-xxekr-4-uqn-p-6-p-2-t-y-57-a-6-cy-0-dvk-ouxr-56-qvikega-mlh-o-8-xqeczz-xmke-eoe-qm-7-js-m-ysa-z-k-2-s-wcdo-tidu"
    style="max-height:50%;max-width:50%;display:block;margin-left:0;margin-right:auto"
    data-hd-height="50%" data-hd-width="50%" data-hd-align="left"/></figure><p></p><p>When
    you are done, click <strong>Apply Changes</strong>.</p><h3>Step 5: Run Pipeline</h3><p>Click
    <strong>Save</strong> to save the changes, then click <strong>Run Pipeline</strong>. </p><h3>Step
    6: View the Results</h3><p>You can see the logs for the Pipeline as it runs.</p><h4>Save
    Cache Stage Output</h4><p>In the Save Cache stage, you can see the logs for <strong>Save
    Cache to GCS</strong> step in the Pipeline as it runs.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/v0agy0hlyj/1636692038272/7-l-71-d-i-299-k-gmdcsez-xi-0-d-sktn-ahjm-r-1-kfpjow-vntx-y-4-zxai-io-7-w-2-unw-l-4-d-1-mc-nma-av-m-5-m-3-he-47-thjv-bccgj-in-rk-nmrcn-syin-4-od-3-uvbr-3-yf-ql-m-3-q-tkx-sd-1-wvqat-hiul-e-5-rnq"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><pre>level=info
    name=drone-cache ts=2021-11-11T09:06:48.834761074Z caller=rebuilder.go:93 component=plugin
    component=rebuilder msg=&#34;cache built&#34; took=253.210746ms</pre><p></p><h4>Restore
    Cache Stage Output</h4><p>In the Restore Cache stage, you can see the logs for
    <strong>Restore Cache from GCS</strong> step in the Pipeline as it runs.</p><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/v0agy0hlyj/1636692067156/nni-uc-1-0-j-wlovaf-l-49-ufvwgyg-w-6-j-6-kyjqd-wwc-5-ilic-srxvn-93-a-ovy-s-82-yqnfwwe-dfj-txwe-um-1-e-6-x-h-2-i-3-h-9-oynudvqrc-qd-0-tv-crkv-7-prrqarfm-x-8-anm-n-9-bp-vwi-fqqa-rseh-z-0"
    style="max-height:50%;max-width:50%;display:block;margin-left:0;margin-right:auto"
    data-hd-height="50%" data-hd-width="50%" data-hd-align="left"/></figure><p></p><pre>level=info
    name=drone-cache ts=2021-11-11T09:07:00.803158076Z caller=restorer.go:94 component=plugin
    component=restorer msg=&#34;cache restored&#34; took=239.769663ms</pre><h3 id="undefined">See
    Also</h3><ul><li><a href="/article/qibyllcmza-saving-cache">Save and Restore Cache
    from S3</a></li></ul><p></p>'
  slug: save-cache-in-gcs
  tags: []
  is_live: true
