<p>The Relay Proxy enables your apps to connect directly to Feature Flag services without having to make a significant number of outbound connections to FF services. The Relay Proxy establishes a connection to the Feature Flags configuration data and relays that connection to clients in an organization&#39;s network.</p><p>This topic describes how to deploy and start the <a href="/article/q0kvq8nd2o-relay-proxy" target="_blank">Relay Proxy</a>. For an overview, go to the <a href="/article/q0kvq8nd2o-relay-proxy" target="_blank">Relay Proxy Overview</a>.</p><h3>Requirements</h3><ul><li>When the Proxy starts up, if an API key does not exist in Feature Flags, the Proxy will not be able to validate that API key during Authentication. Because the Proxy only retrieves API keys at startup and does not check for new ones.</li><li>If you start the proxy and then later create a new API key in Feature Flags, you must restart the proxy and pass the new API key in its configuration.</li></ul><h3>Configure the Relay Proxy</h3><p>You can start the Relay Proxy by pulling the <code>harness/ff-proxy</code> image from <a href="https://hub.docker.com/r/harness/ff-proxy" target="_blank">Docker</a>.</p><ol><li>Pull the latest Relay Proxy <a href="https://hub.docker.com/r/harness/ff-proxy" target="_blank">Docker image</a>.<br/><br/><code>docker pull harness/ff-proxy</code></li><li>View the configuration variables by running the following command:<br/><br/><code>docker run harness/ff-proxy</code><br/><br/>This prints all the configuration variables.<br/><details><summary>Details of /app/ff-proxy Configuration variables:</summary><div><p></p><pre>account-identifier string</pre><p> An account identifier to load remote config.</p><p></p><p></p><pre>admin-service string</pre><p> The URL of the ff admin service (default <code>https://harness.io/gateway/cf</code>).</p><p></p><p></p><pre>admin-service-token string</pre><p> Token to use with the ff service.</p><p></p><pre>api-keys value</pre><p> API keys to connect with ff-server for each environment.</p><p></p><pre> auth-secret string</pre><p> The secret used for signing the authentication token generated by the Proxy.</p><p></p><pre>bypass-auth</pre><p> Bypasses authentication.</p><p></p><pre>client-service string</pre><p> The URL of the ff client service (default <code>https://config.ff.harness.io/</code>).</p><p></p><pre>debug</pre><p> Enables debug logging.</p><p></p><pre>offline</pre><p> Enables side loading of data from the config directory.</p><p></p><pre>org-identifier string</pre><p> An org identifier to load remote config.</p><p></p><pre>port int</pre><p> Port that the proxy service is exposed on (default 7000).</p><p></p><pre>redis-address string</pre><p> Redis host:port address.</p><p></p><pre>redis-db int</pre><p> Database to be selected after connecting to the server.</p><p></p><pre>redis-password string</pre><p> (Optional) Redis password.</p><p></p><pre>sdk-base-url string</pre><p> URL for the SDK to connect to (default <code>https://config.ff.harness.io/</code>).</p><p></p><pre>sdk-events-url string</pre><p> URL for the SDK to send metrics to (default <code>https://events.ff.harness.io/</code>).</p><pre>generate-offline-config boolean</pre><p> If set to <code>true</code>, the proxy produces an offline configuration in the mounted <code>/config</code> directory, then terminates.</p><pre>config-dir string</pre><p>Specify a path for the offline config directory. The default is <code>/config</code>. </p></div></details></li></ol><p>The Relay Proxy obtains a list of all Environments and associated API keys for the given Account and Organization when it first starts up, which it will use to validate authentication requests and generate tokens.</p><p></p><p>The following are the required configuration variables to connect to the Feature Flags service:</p><ul><li><strong>admin-service-token</strong>: Enter the Service Account details. An auth token that lets the proxy communicate with Feature Flags. For more information on how to create a Service Account, go to <a href="/article/e5p4hdq6bd-add-and-manage-service-account#create_a_service_account" target="_blank">Create a Service Account</a>.</li><li><strong>account-identifier</strong>: Enter your account identifier for which you want to retrieve the config. You can copy the account ID from the Harness Manager. In Harness Manager&#39;s address bar, copy the <strong>Harness account ID</strong> from your Harness URL. The Harness account ID comes after <code>account</code> in the URL. For example in the following URL, the account ID is <code>1a2b3c</code>: <code>https://app.harness.io/#/account/1a2b3c</code>.</li><li><strong>org-identifier</strong>: Enter your organization identifier for which you want to retrieve the config. For more information, go to <a href="/article/36fw2u92i4-create-an-organization#step_1_create_a_harness_org" target="_blank">Create a Harness Organization</a>.</li><li><strong>api-keys</strong>: Enter you server SDK key. For more information, go to <a href="/article/1j7pdkqh7j-create-a-feature-flag#step_3_create_an_sdk_key" target="_blank">Add and Manage API Keys</a>.</li><li><strong>auth-secret</strong>: Enter your authentication secret details. A secret that is used by the proxy to sign the <a href="https://jwt.io/" target="_blank">JWTs</a> that it sends to the SDKs. For more information, go to <a href="/article/bo4qbrcggv-add-secrets-manager" target="_blank">Add a Secrets Manager</a>.</li></ul><ol><li>Specify your configuration details and Docker run the proxy image. The following are the examples:<ol><li>Here is an example of a Docker Relay Proxy image with the required configuration details:<br/><br/><pre>docker run -d -p 7000:7000 harness/ff-proxy -admin-service-token $MY_SERVICE_TOKEN -account-identifier $MY_ACCOUNT_IDENTIFIER -org-identifier $MY_ORG_IDENTIFIER -api-keys $ENV_1_KEY,$ENV_2_KEY,$ENV_3_KEY... -auth-secret $ANY_AUTH_SECRET</pre></li><li>The following example uses a <code>.env</code> file. Create a <code>.env</code> file with the following environment variables:<br/><br/><pre>// Create a .env file with these envs <br/>DEBUG=false <br/>OFFLINE=false <br/>PORT=7000 <br/>ACCOUNT_IDENTIFIER=&lt;string&gt; <br/>ORG_IDENTIFIER=&lt;string&gt; <br/>ADMIN_SERVICE_TOKEN=&lt;string&gt; <br/>AUTH_SECRET=&lt;string&gt; <br/>REDIS_ADDRESS=&lt;host:port&gt; <br/>API_KEYS=6cfe5e7b-e264-4fa7-b163-befab9fd1223,9e4ec55f-3d11-4621-88c7-5ca0aa8b868b</pre><br/>Then use the <code>.env</code> file with <code>docker run</code><br/><br/><pre>docker run -d -p 7000:7000 --env-file .env harness/ff-proxy</pre></li></ol></li><li>(Optional) You can optionally provide config for a Redis instance used to store flag data using the <code>redis-address</code>, <code>redis-db</code> (optional), and <code>redis-password</code> (optional).<br/><div class="note-callout">If you do not use Redis, the flag data is stored in the memory. In-memory is the default option.</div></li></ol><h3>Configure SDKs to Work With the Relay Proxy</h3><p>The SDKs do not require any additional configuration to work with the proxy. The only difference is that instead of supplying the Feature Flags URL when starting up an SDK, you should pass the proxy URL.</p><p>For example, if you wanted your SDK to go via QA without the Proxy, you&#39;d give it the following URLs:</p><pre>baseURL:   http://config.feature-flags.qa.harness.io/api/1.0</pre><p></p><pre>eventsURL: http://event.feature-flags.qa.harness.io/api/1.0</pre><p></p><p>But if you have a Proxy running locally on localhost:7000 and it’s connected to QA then pass the following URLs to the SDK:</p><p></p><pre>baseURL:   http://localhost:7000</pre><p></p><pre>eventsURL: http://localhost:7000</pre><p></p><h4>SDK Examples With Relay Proxy</h4><p>The following examples show how to point an SDK at the Relay Proxy:</p><h5>Go SDK</h5><pre><br/><br/>go<br/>proxyURL := &#34;http://localhost:7000&#34;<br/>apiKey := &#34;your API Key&#34;<br/><br/>target := dto.NewTargetBuilder(&#34;your-target&#34;).<br/>    Name(&#34;your-target-name&#34;).<br/>    Build()<br/><br/>client, err := harness.NewCfClient(apiKey,<br/>    harness.WithURL(proxyURL),<br/>    harness.WithEventsURL(proxyURL),<br/>    harness.WithTarget(target),<br/>)<br/>if err != nil {<br/>    log.Fatal(err)<br/>}</pre><p></p><h5>.NET SDK</h5><p></p><pre>String API_KEY = &#34;YOUR_API_KEY&#34;;<br/>String proxyURL = &#34;http://localhost:7000&#34;;<br/><br/>config = Config.Builder()<br/>                .SetPollingInterval(60000)<br/>                .SetAnalyticsEnabled()<br/>                .SetStreamEnabled(true)<br/>                .EventUrl(proxyURL)<br/>                .ConfigUrl(proxyURL)<br/>                .Build();<br/><br/>await CfClient.Instance.Initialize(API_KEY, config);<br/><br/>/**<br/> * Define you target on which you would like to evaluate <br/> * the featureFlag<br/> */<br/>                Target target =<br/>                io.harness.cfsdk.client.dto.Target.builder()<br/>                .Name(&#34;User1&#34;) //can change with your target name<br/>                .Identifier(&#34;user1@example.com&#34;) //can change with your target identifier<br/>                .build();</pre><p></p><h5>JavaScript SDK</h5><p></p><pre>javascript<br/>apiKey = &#34;your API Key&#34;<br/>proxyURL = &#34;http://localhost:7000&#34;<br/><br/>var cf = initialize(apiKey,<br/>        {<br/>            baseUrl: proxyURL,<br/>            eventUrl: proxyURL,<br/>        }<br/>)</pre><p></p><h3>Configure Relay Proxy with Redis</h3><p>You can run Redis locally and configure the Proxy to work with it. Perform the following steps to configure Proxy with Redis.</p><ol><li>Start Redis.<br/><br/><pre> docker run --rm --name redis -d -p 6379:6379 redis:latest</pre></li><li>Start the Proxy and configure using a <code>.env</code>.<br/><br/><pre> docker run -d -p 7000:7000 --env-file .online.uat.env harness/ff-proxy:latest</pre></li><li>Start the Proxy and configure using flags.<br/><br/><pre>docker run -d -p 7000:7000 harness/ff-proxy -redis-address $REDIS_ADDRESS -admin-service-token $MY_SERVICE_TOKEN -account-identifier $MY_ACCOUNT_IDENTIFIER -org-identifier $MY_ORG_IDENTIFIER -api-keys $ENV_1_KEY,$ENV_2_KEY,$ENV_3_KEY... -auth-secret $ANY_AUTH_SECRET</pre></li></ol><h3>Run the Relay Proxy in offline mode</h3><p>You can configure the Relay Proxy to load and use configuration data that is stored offline. The following configuration data from your Project is stored in a configuration directory:</p><ul><li>Flags</li><li>Targets</li><li>Target Groups</li><li>Hashed data of your SDK keys</li></ul><p>This stored configuration is then loaded from this directory when you enable the <code>offline</code> Flag.</p><p>To use offline mode, you need to:</p><ol><li><a href="#generate-the-offline-configuration-directory">Generate the offline configuration directory</a></li><li><a href="#run-the-proxy-in-offline-mode-when-needed">Run the proxy in offline mode when needed</a></li></ol><h4>Generate the offline configuration directory</h4><p>You need to generate the configuration directory that contains your Project data before you can run the proxy in offline mode. To do this you run the proxy using your usual configuration, but also:</p><ol><li>Include the variable for generating an offline configuration</li><li>Mount your configuration directory to the docker container</li></ol><p>How you add these depends on whether you use Flags or a .env file:</p><h5>Docker command when using flags</h5><p>As well as your usual variables, include the <code>generate-offline-config</code> variable and add the directory path in place of <code>{YOUR_ABSOLUTE_PATH}</code>:</p><pre>docker run -d -p 7000:7000 -v {YOUR_ABSOLUTE_PATH}/config:/config ff-proxy -generate-offline-config -admin-service-token $MY_SERVICE_TOKEN -account-identifier $MY_ACCOUNT_IDENTIFIER -org-identifier $MY_ORG_IDENTIFIER -api-keys $ENV_1_KEY,$ENV_2_KEY,$ENV_3_KEY... -auth-secret $ANY_AUTH_SECRET</pre><h5>Docker command when using a .env file</h5><p>Add <code>GENERATE_OFFLINE_CONFIG=true</code> to your .env file, and add the directory path in place of <code>{YOUR_ABSOLUTE_PATH}</code>:</p><pre>docker run -d -p 7000:7000 --env-file .env -v {YOUR_ABSOULUTE_PATH}/config:/config ff-proxy</pre><p></p><p>This generates the configuration you need to run the proxy in offline mode, then terminates. To then use the offline configuration you store, you need to run the proxy in offline mode.</p><h4>Run the Proxy in offline mode when needed</h4><p>After you have generated a configuration directory, you can load the data from it any time you need to run the proxy offline. To use the stored configuration when the proxy is offline you run the proxy using your usual configuration, but also:</p><ol><li>Include the variable for running offline</li><li>Mount your configuration directory to the docker container</li></ol><div class="warning-callout">When you run the proxy in offline mode, it remains offline until you run the proxy in online mode again. This means that the proxy won&#39;t send metrics data or connect to the Harness servers.</div><p>How you run the proxy in offline mode depends on whether you use flags or a .env file:</p><h5>Docker command when using flags</h5><p>Run the following Docker command and add the directory path in place of <code>{YOUR_ABSOLUTE_PATH}</code>as well as your usual variables:</p><pre>docker run -d -p 7000:7000 -v {YOUR_ABSOULUTE_PATH}/config:/config ff-proxy -offline -admin-service-token $MY_SERVICE_TOKEN -account-identifier $MY_ACCOUNT_IDENTIFIER -org-identifier $MY_ORG_IDENTIFIER -api-keys $ENV_1_KEY,$ENV_2_KEY,$ENV_3_KEY... -auth-secret $ANY_AUTH_SECRET</pre><h5>Docker command when using a .env file</h5><p>Add <code>OFFLINE=true</code> to your .env file and add the directory path in place of <code>{YOUR_ABSOLUTE_PATH}</code>:</p><pre>docker run -d -p 7000:7000 --env-file .env -v {YOUR_ABSOULUTE_PATH}/config:/config ff-proxy</pre><p></p>