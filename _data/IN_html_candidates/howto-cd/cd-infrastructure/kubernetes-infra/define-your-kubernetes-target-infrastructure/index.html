<p>When you set up a Deploy stage, you specify the Kubernetes cluster you want to target for deployment as a Harness Infrastructure Definition.</p><p>A Harness Infrastructure Definition specifies the target deployment infrastructure for your Harness stage. It includes specific infrastructure details for the deployment, such as the Harness Connector that provides credentials for the cluster and the cluster namespace.</p><div class="note-callout">For Amazon Elastic Kubernetes Service (Amazon EKS) and OpenShift, use <a href="/article/0ud2ut4vt2-define-your-kubernetes-target-infrastructure#option_1_specify_a_vendor_agnostic_kubernetes_cluster">Option 1: Specify a Vendor Agnostic Kubernetes Cluster</a>.</div><h3>Before You Begin</h3><ul><li><a href="https://ngdocs.harness.io/article/knunou9j30-kubernetes-cd-quickstart">Kubernetes CD Quickstart</a></li><li><a href="https://ngdocs.harness.io/article/u29v1uc1mh-kubernetes-deployments-overview">Kubernetes Deployments Overview</a></li><li><a href="https://ngdocs.harness.io/article/4ifq51cp0i-add-artifacts-for-kubernetes-deployments">Add Container Images as Artifacts for Kubernetes Deployments</a></li></ul><h3>Step 1: Add Deploy Stage and Service</h3><p>For steps on adding a stage, see <a href="https://ngdocs.harness.io/article/2chyf1acil-add-a-stage">Add a Stage</a>.</p><p>When you add a stage, select <strong>Deploy</strong>.</p><p>Name the stage, and select what you&#39;d like to deploy. For example, select <strong>Service</strong>.</p><p>Click <strong>Set Up Stage</strong>.</p><p>The new stage&#39;s settings appear.</p><p>In <strong>Service</strong>, create or select a Service.</p><p>In Service Definition <strong>Deployment Type</strong>, select <strong>Kubernetes</strong>.</p><p>Add artifacts and manifests. See:</p><ul><li><a href="/article/4ifq51cp0i">Add Container Images as Artifacts for Kubernetes Deployments</a></li><li><a href="/article/ssbq0xh0hx">Add Kubernetes Manifests</a></li></ul><p>Click <strong>Next</strong> or <strong>Infrastructure</strong>.</p><h3>Step 2: Select or Create an Environment</h3><p>Let&#39;s take a moment and review Harness Environments and Infrastructure Definitions.</p><p>Harness Environments represent your deployment targets logically (QA, Prod, etc). You can add the same Environment to as many stages are you need. Infrastructure Definitions represent your target infrastructure physically. They are the actual clusters, hosts, etc.</p><p>By separating Environments and Infrastructure Definitions, you can use the same Environment in multiple stages while changing the target infrastructure settings with each stage.</p><p>In <strong>Infrastructure</strong>, in <strong>Environment</strong>, select or create an Environment.</p><h3>Step 3: Select Connection Method</h3><p>Select one of the connection methods, such as Direct Connection or Cloud Provider.</p><p>We will cover all options below.</p><h3>Step 4: Enter Cluster Details</h3><p>The cluster details you enter will depend on the connection method you select.</p><h3>Option 1: Direct Connection</h3><div class="note-callout">This is the recommend method for cluster connections because it avoids vendor-specific settings.</div><p>A Direct Connection is a vendor agnostic connection to the Kubernetes cluster.</p><p>It uses a <a href="/article/sjjik49xww">Harness Kubernetes Cluster Connector</a> to connect a cluster on any platform.</p><div class="note-callout">Currently, Harness connects to Amazon Elastic Kubernetes Service (Amazon EKS) and OpenShift using the Kubernetes Cluster Connector.</div><p>If you are using a Harness Kubernetes Cluster Cloud Provider to connect to your target cluster, enter the following settings.</p><h4>Connector</h4><p>Select or create a Kubernetes Cluster Connector for your target cluster.</p><p>For details on the Kubernetes Cluster Connector settings, see <a href="/article/sjjik49xww">Kubernetes Cluster Connector Settings Reference</a>.</p><h4>Namespace</h4><p>Select the namespace in the target Kubernetes cluster. Typically, this is <code>default</code>.</p><p>The namespace must already exist during deployment. Harness will not create a new namespace if you enter one here.</p><p>You can enter a fixed value, runtime input, or expression.</p><p>You can reference the namespace in your manifest using the Harness expression: <code>&lt;+infra.namespace&gt;</code>.</p><p>For example, if you entered <code>default</code> in <strong>Namespace</strong>, in your values.yaml you can use:</p><pre>name: myApp<br/>replicas: 2<br/><br/>image: &lt;+artifact.image&gt;<br/><br/>createNamespace: true<br/>namespace: &lt;+infra.namespace&gt;<br/>...</pre><p></p><p>And then in the Namespace object manifest (and any object manifest that uses the namespace) you reference the values.yaml value for namespace:</p><pre> {{- if .Values.createNamespace}}<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/> name: {{.Values.namespace}}<br/>{{- end}}</pre><p></p><p>Now your values.yaml and manifest is templated for use with any stage.</p><p>For more information about manifests in Harness, see <a href="/article/ssbq0xh0hx-define-kubernetes-manifests">Add Kubernetes Manifests</a>.</p><div class="note-callout">If you omit the <code>namespace</code> key and value from a manifest in your Service Definition, Harness automatically uses the namespace you entered in the Harness Environment  <strong>Infrastructure Definition</strong> settings <strong>Namespace</strong> field.</div><h4>Release Name</h4><p><strong>Release name</strong> is located in <strong>Advanced</strong>. You do not need to edit it.</p><p>During deployment Harness creates a ConfigMap listing the resources of the release and uses the <strong>Release name</strong> for tracking them.</p><p>The <strong>Release name</strong> is a combination of <code>release-</code> and a unique string created using the Harness expression <code>&lt;+INFRA_KEY&gt;</code>.</p><p>For example, in a Kubernetes deployment you can see <code>harness.io/release-name=release-2f9eadcc06e2c2225265ab3cbb1160bc5eacfd4f</code>.</p><p>In Harness, the Release Name is displayed in the logs of the deployment step:</p><p> </p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/0ud2ut4vt2/1652813251788/clean-shot-2022-05-17-at-11-46-54.png"/></figure><p>The release name must be unique across the cluster. <code>release-&lt;+INFRA_KEY&gt;</code> ensures a unique name.</p><p><code>release-</code> is used as a prefix because Kubernetes service and pod names must follow RFC-1035 and must consist of lowercase alphanumeric characters or &#39;-&#39;, start with an alphabetic character, and end with an alphanumeric character.</p><p>See <a href="/article/zahb65jgmy-kubernetes-releases-and-versioning">Kubernetes Releases and Versioning</a>.</p><h3>Option 2: Cloud Provider</h3><p>Select the cloud platform where your Kubernetes cluster is hosted, such as Google Kubernetes Engine on GCP.</p><h4>Connector</h4><p>Select or create a Connector for your target cluster&#39;s platform.</p><p>For details on the Connector settings, see <a href="/category/1ehb4tcksy">Cloud Platform Connectors</a>.</p><h4>Cluster</h4><p>Select the cluster you created for this deployment.</p><p>If the cluster name is taking a long time to load, check the connectivity of the host running the Harness Delegate.</p><h4>Namespace</h4><p>Enter the namespace of the target Kubernetes cluster. Typically, this is <code>default</code>.</p><p>The namespace must already exist during deployment. Harness will not create a new namespace if you enter one here.</p><p>You can enter a fixed value, runtime input, or expression.</p><p>You can reference the namespace in your manifest using the Harness expression: <code>&lt;+infra.namespace&gt;</code>.</p><p>For example, if you entered <code>default</code> in <strong>Namespace</strong>, in your values.yaml you can use:</p><pre>name: myApp<br/>replicas: 2<br/><br/>image: &lt;+artifact.image&gt;<br/><br/>createNamespace: true<br/>namespace: &lt;+infra.namespace&gt;<br/>...</pre><p></p><p>And then in the Namespace object manifest (and any object manifest that uses the namespace) you reference the values.yaml value for namespace:</p><pre> {{- if .Values.createNamespace}}<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/> name: {{.Values.namespace}}<br/>{{- end}}</pre><p></p><p>Now your values.yaml and manifest is templated for use with any stage.</p><p>For more information about manifests in Harness, see <a href="/article/ssbq0xh0hx-define-kubernetes-manifests">Add Kubernetes Manifests</a>.</p><div class="note-callout">If you omit the <code>namespace</code> key and value from a manifest in your Service, Harness automatically uses the namespace you entered in the Harness Environment  <strong>Infrastructure Definition</strong> settings <strong>Namespace</strong> field.</div><h4>Release Name</h4><p>Harness requires a Kubernetes release name for tracking.</p><p>The release name must be unique across the cluster.</p><p>See <a href="/article/zahb65jgmy-kubernetes-releases-and-versioning">Kubernetes Releases and Versioning</a>.</p><p>The Harness-generated unique identifier <code>&lt;+infrastructure.infrastructureKey&gt;</code> can be used to ensure a unique release name.</p><p>Use <code>release-&lt;+infrastructure.infrastructureKey&gt;</code> for the <strong>Release Name</strong> instead of just <code>&lt;+infrastructure.infrastructureKey&gt;</code>. Kubernetes service and pod names follow DNS-1035 and must consist of lowercase alphanumeric characters or &#39;-&#39;, start with an alphabetic character, and end with an alphanumeric character. Using <code>release-</code> as a prefix will prevent any issues.</p><h3>Notes</h3><ul><li>When using names in Harness Kubernetes stages, remember that Kubernetes service and pod names follow DNS-1035 and must consist of lowercase alphanumeric characters or &#39;-&#39;, start with an alphabetic character, and end with an alphanumeric character.</li><li><strong>GCP Workload Identity:</strong> if you installed the Harness Kubernetes Delegate in a GCP Kubernetes cluster (GKE) that has GCP Workload Identity enabled, the GCP Connector will use the GCP Workload Identity if it inherits its credentials from that Delegate (using the <strong>Use the credentials of a specific Harness Delegate</strong> option).</li></ul><h3>See Also</h3><ul><li><a href="/article/knunou9j30-kubernetes-cd-quickstart">Kubernetes CD Quickstart</a></li><li><a href="/article/cifa2yb19a-helm-cd-quickstart">Helm CD Quickstart</a></li></ul><p></p>