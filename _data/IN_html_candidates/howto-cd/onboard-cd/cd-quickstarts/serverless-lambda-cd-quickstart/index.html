<p></p><div class="note-callout">Currently, this feature is behind the feature flag <code>SERVERLESS_SUPPORT</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature.</div><p></p><p>This quickstart shows you how to deploy a Serverless Lambda application to AWS Lambda using Harness. We&#39;ll use a publicly-available serverless.yaml and artifact and deploy them to your AWS Lambda service using a Harness Pipeline.</p><div class="note-callout">New to Serverless? See <a href="https://www.serverless.com/framework/docs/tutorial" target="_blank">Tutorial: Your First Serverless Framework Project</a> from Serverless.</div><h3>Objectives</h3><ol><li>Add a serverless.yaml file and ZIP artifact to a Harness Pipeline stage.</li><li>Define your AWS Lambda service as the deployment target.</li><li>Deploy the Serverless application to Lambda.</li></ol><h3>Before You Begin</h3><div class="note-callout">Review <a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts">Harness Key Concepts</a> to establish a general understanding of Harness.</div><ul><li><strong>GitHub account:</strong> this quickstart uses a publicly available serverless.yaml file, but GitHub requires that you use a GitHub account for fetching files.</li><li><strong>Kubernetes</strong> <strong>Delegate cluster with Serverless installed:</strong> the Harness Delegate is a worker process that performs all deployment tasks. For this quickstart, we&#39;ll install a Kubernetes Delegate running in a Kubernetes cluster.<ul><li>You can use a cluster hosted on a cloud platform or run one in minikube using Docker Desktop locally. The installation steps are the same.</li><li>The Delegate host must have Serverless installed. We&#39;ll add the Serverless installation script to the Delegate YAML file later in this quickstart.</li></ul></li><li><strong>AWS User account with required policy:</strong> Serverless deployments require an AWS User with specific AWS permissions, as described in <a href="https://www.serverless.com/framework/docs/providers/aws/guide/credentials" target="_blank">AWS Credentials</a> from Serverless. To create the AWS User, do the following:<ul><li>Log into your AWS account and go to the Identity &amp; Access Management (IAM) page.</li><li>Click <strong>Users</strong>, and then <strong>Add user</strong>. Enter a name. Enable <strong>Programmatic access</strong> by clicking the checkbox. Click <strong>Next</strong> to go to the <strong>Permissions</strong> page. Do one of the following:<ul><li><strong>Full Admin Access:</strong> click on <strong>Attach existing policies directly</strong>. Search for and select <strong>AdministratorAccess</strong> then click <strong>Next: Review</strong>. Check to make sure everything looks good and click <strong>Create user</strong>.</li><li><strong>Limited Access:</strong> click on <strong>Create policy</strong>. Select the <strong>JSON</strong> tab, and add the JSON using the following code from the <a href="https://gist.github.com/ServerlessBot/7618156b8671840a539f405dea2704c8" target="_blank">Serverless gist</a>:</li></ul><details><summary>IAMCredentials.json</summary><div><pre class="hljs json">{<br/>    &#34;Statement&#34;: [<br/>        {<br/>            &#34;Action&#34;: [<br/>                &#34;apigateway:*&#34;,<br/>                &#34;cloudformation:CancelUpdateStack&#34;,<br/>                &#34;cloudformation:ContinueUpdateRollback&#34;,<br/>                &#34;cloudformation:CreateChangeSet&#34;,<br/>                &#34;cloudformation:CreateStack&#34;,<br/>                &#34;cloudformation:CreateUploadBucket&#34;,<br/>                &#34;cloudformation:DeleteStack&#34;,<br/>                &#34;cloudformation:Describe*&#34;,<br/>                &#34;cloudformation:EstimateTemplateCost&#34;,<br/>                &#34;cloudformation:ExecuteChangeSet&#34;,<br/>                &#34;cloudformation:Get*&#34;,<br/>                &#34;cloudformation:List*&#34;,<br/>                &#34;cloudformation:UpdateStack&#34;,<br/>                &#34;cloudformation:UpdateTerminationProtection&#34;,<br/>                &#34;cloudformation:ValidateTemplate&#34;,<br/>                &#34;dynamodb:CreateTable&#34;,<br/>                &#34;dynamodb:DeleteTable&#34;,<br/>                &#34;dynamodb:DescribeTable&#34;,<br/>                &#34;dynamodb:DescribeTimeToLive&#34;,<br/>                &#34;dynamodb:UpdateTimeToLive&#34;,<br/>                &#34;ec2:AttachInternetGateway&#34;,<br/>                &#34;ec2:AuthorizeSecurityGroupIngress&#34;,<br/>                &#34;ec2:CreateInternetGateway&#34;,<br/>                &#34;ec2:CreateNetworkAcl&#34;,<br/>                &#34;ec2:CreateNetworkAclEntry&#34;,<br/>                &#34;ec2:CreateRouteTable&#34;,<br/>                &#34;ec2:CreateSecurityGroup&#34;,<br/>                &#34;ec2:CreateSubnet&#34;,<br/>                &#34;ec2:CreateTags&#34;,<br/>                &#34;ec2:CreateVpc&#34;,<br/>                &#34;ec2:DeleteInternetGateway&#34;,<br/>                &#34;ec2:DeleteNetworkAcl&#34;,<br/>                &#34;ec2:DeleteNetworkAclEntry&#34;,<br/>                &#34;ec2:DeleteRouteTable&#34;,<br/>                &#34;ec2:DeleteSecurityGroup&#34;,<br/>                &#34;ec2:DeleteSubnet&#34;,<br/>                &#34;ec2:DeleteVpc&#34;,<br/>                &#34;ec2:Describe*&#34;,<br/>                &#34;ec2:DetachInternetGateway&#34;,<br/>                &#34;ec2:ModifyVpcAttribute&#34;,<br/>                &#34;events:DeleteRule&#34;,<br/>                &#34;events:DescribeRule&#34;,<br/>                &#34;events:ListRuleNamesByTarget&#34;,<br/>                &#34;events:ListRules&#34;,<br/>                &#34;events:ListTargetsByRule&#34;,<br/>                &#34;events:PutRule&#34;,<br/>                &#34;events:PutTargets&#34;,<br/>                &#34;events:RemoveTargets&#34;,<br/>                &#34;iam:AttachRolePolicy&#34;,<br/>                &#34;iam:CreateRole&#34;,<br/>                &#34;iam:DeleteRole&#34;,<br/>                &#34;iam:DeleteRolePolicy&#34;,<br/>                &#34;iam:DetachRolePolicy&#34;,<br/>                &#34;iam:GetRole&#34;,<br/>                &#34;iam:PassRole&#34;,<br/>                &#34;iam:PutRolePolicy&#34;,<br/>                &#34;iot:CreateTopicRule&#34;,<br/>                &#34;iot:DeleteTopicRule&#34;,<br/>                &#34;iot:DisableTopicRule&#34;,<br/>                &#34;iot:EnableTopicRule&#34;,<br/>                &#34;iot:ReplaceTopicRule&#34;,<br/>                &#34;kinesis:CreateStream&#34;,<br/>                &#34;kinesis:DeleteStream&#34;,<br/>                &#34;kinesis:DescribeStream&#34;,<br/>                &#34;lambda:*&#34;,<br/>                &#34;logs:CreateLogGroup&#34;,<br/>                &#34;logs:DeleteLogGroup&#34;,<br/>                &#34;logs:DescribeLogGroups&#34;,<br/>                &#34;logs:DescribeLogStreams&#34;,<br/>                &#34;logs:FilterLogEvents&#34;,<br/>                &#34;logs:GetLogEvents&#34;,<br/>                &#34;logs:PutSubscriptionFilter&#34;,<br/>                &#34;s3:GetBucketLocation&#34;,<br/>                &#34;s3:CreateBucket&#34;,<br/>                &#34;s3:DeleteBucket&#34;,<br/>                &#34;s3:DeleteBucketPolicy&#34;,<br/>                &#34;s3:DeleteObject&#34;,<br/>                &#34;s3:DeleteObjectVersion&#34;,<br/>                &#34;s3:GetObject&#34;,<br/>                &#34;s3:GetObjectVersion&#34;,<br/>                &#34;s3:ListAllMyBuckets&#34;,<br/>                &#34;s3:ListBucket&#34;,<br/>                &#34;s3:PutBucketNotification&#34;,<br/>                &#34;s3:PutBucketPolicy&#34;,<br/>                &#34;s3:PutBucketTagging&#34;,<br/>                &#34;s3:PutBucketWebsite&#34;,<br/>                &#34;s3:PutEncryptionConfiguration&#34;,<br/>                &#34;s3:PutObject&#34;,<br/>                &#34;sns:CreateTopic&#34;,<br/>                &#34;sns:DeleteTopic&#34;,<br/>                &#34;sns:GetSubscriptionAttributes&#34;,<br/>                &#34;sns:GetTopicAttributes&#34;,<br/>                &#34;sns:ListSubscriptions&#34;,<br/>                &#34;sns:ListSubscriptionsByTopic&#34;,<br/>                &#34;sns:ListTopics&#34;,<br/>                &#34;sns:SetSubscriptionAttributes&#34;,<br/>                &#34;sns:SetTopicAttributes&#34;,<br/>                &#34;sns:Subscribe&#34;,<br/>                &#34;sns:Unsubscribe&#34;,<br/>                &#34;states:CreateStateMachine&#34;,<br/>                &#34;states:DeleteStateMachine&#34;<br/>            ],<br/>            &#34;Effect&#34;: &#34;Allow&#34;,<br/>            &#34;Resource&#34;: &#34;*&#34;<br/>        }<br/>    ],<br/>    &#34;Version&#34;: &#34;2012-10-17&#34;<br/>}</pre></div></details><div class="note-callout">The <code>s3:GetBucketLocation</code> action is only required for a <u>custom</u> S3 bucket.</div><ul><li>View and copy the API Key and Secret to a temporary place. You&#39;ll need them when setting up the Harness AWS Connector later in this quickstart.</li></ul></li></ul></li></ul><h3>Limitations</h3><ul><li>Harness supports all language runtimes that Serverless supports.</li><li>Harness supports ZIP files and Docker image artifacts only.<ul><li>ZIP files are supported with JFrog Artifactory.</li><li>Docker images are supported with AWS ECR.</li></ul></li></ul><h3>Step 1: Create the Deploy Stage</h3><p>Pipelines are collections of stages. For this quickstart, we&#39;ll create a new Pipeline and add a single stage.</p><div class="note-callout"><strong>Create a Project for your new CD Pipeline:</strong> if you don&#39;t already have a Harness Project, create a Project for your new CD Pipeline. Ensure that you add the <strong>Continuous Delivery</strong> module to the Project. See <a href="https://ngdocs.harness.io/article/36fw2u92i4-create-an-organization">Create Organizations and Projects</a>.</div><p>In your Harness Project, click <strong>Deployments</strong>, and then click <strong>Create a</strong> <strong>Pipeline</strong>.</p><p>Enter the name <strong>Serverless Quickstart</strong> and click <strong>Start</strong>.</p><p>Your Pipeline appears.</p><p>Click <strong>Add Stage</strong> and select <strong>Deploy</strong>.</p><p>Enter the name <strong>Deploy Service</strong>, make sure <strong>Service</strong> is selected, and then click <strong>Set Up Stage</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653433578000/clean-shot-2022-05-24-at-16-05-51.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>The new stage settings appear.</p><p>In <strong>About the</strong> <strong>Service</strong>, click <strong>New Service</strong>.</p><p>Give the Service the name <strong>quickstart</strong> and click <strong>Save</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653433729332/clean-shot-2022-05-24-at-16-08-21.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><div class="note-callout">Let&#39;s take a moment and review Harness Services and Service Definitions (which are explained below). Harness Services represent your microservices/apps logically.<br/>You can add the same Service to as many stages as you need. Service Definitions represent your artifacts, manifests, and variables physically. They are the actual files and variable values.<br/>By separating Services and Service Definitions, you can propagate the same Service across stages while changing the artifacts, manifests, and variables with each stage.</div><p>Once you have created a Service, it is persistent and can be used throughout the stages of this or any other Pipeline in the Project.</p><h3>Step 2: Add the Manifest</h3><p>Next, we can add a serverless.yaml for our deployment. We&#39;ll use <a href="https://github.com/wings-software/harness-docs/tree/main/serverless/artifacts" target="_blank">publicly-available serverless.yaml file</a> available from Harness.</p><p>In <strong>Service Definition</strong>, in <strong>Deployment Type</strong>, click <strong>Serverless Lambda</strong>.</p><p>In <strong>Manifests</strong>, click <strong>Add Manifest</strong>.</p><p>Select <strong>Serverless Lambda Manifest</strong>, and click <strong>Continue</strong>.</p><p>In <strong>Specify Serverless Lambda Manifest Store</strong>, click <strong>GitHub</strong>, and then click <strong>New GitHub Connector</strong>.</p><p>The <strong>Git Connector</strong> settings appear. Enter the following settings.</p><p></p><table><tbody><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653085408588/clean-shot-2022-05-20-at-15-23-21-2-x.png"/></figure></td><td><p><strong>Name:</strong> <code>serverless</code>.</p></td></tr><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653085421850/clean-shot-2022-05-20-at-15-23-35-2-x.png"/></figure></td><td><p><strong>URL Type:</strong> <code>Repository</code>.</p><p><strong>Connection Type:</strong> <code>HTTP</code>.</p><p><strong>GitHub Repository URL:</strong> <code>https://github.com/wings-software/harness-docs.git</code>.</p></td></tr><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653085454929/clean-shot-2022-05-20-at-15-23-55-2-x.png"/></figure></td><td><p><strong>Username:</strong> Enter your GitHub account username.</p><p>In <strong>Personal Access Token</strong>, click <strong>Create or Select a Secret</strong>.</p><p>Click <strong>New Secret Text</strong>.</p><p>In <strong>Secret Name</strong>, enter a name for the secret like <strong>github-pat</strong>.</p><p>In <strong>Secret Value</strong>, paste in a GitHub Personal access token.</p><p>When you&#39;re logged into GitHub, these are typically listed at <a href="https://github.com/settings/tokens" target="_blank">https://github.com/settings/tokens</a>. For steps on setting up a GitHub PAT, see <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank">Creating a personal access token</a> from GitHub.</p><p>Ensure you PAT has the <strong>repo</strong> scope selected:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653341381360/image.png"/></figure></td></tr><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653085598757/clean-shot-2022-05-20-at-15-26-23-2-x.png"/></figure></td><td><p>Select <strong>Connect through Harness Platform</strong>.</p></td></tr><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653085654836/clean-shot-2022-05-20-at-15-27-25-2-x.png"/></figure></td><td><p>Verify the connection.</p></td></tr></tbody></table><p></p><p>Click <strong>Finish</strong>.</p><p>Back in <strong>Specify Serverless Lambda Manifest Store</strong>, click <strong>Continue</strong>.</p><p>In <strong>Manifest Details</strong>, enter the following.</p><p></p><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653341522797/clean-shot-2022-05-23-at-14-31-52.png"/></figure></td><td><p><strong>Manifest Identifier:</strong> <code>serverless</code>.</p><p><strong>Git Fetch Type:</strong> <code>Latest from Branch</code>.</p><p><strong>Branch:</strong> <code>main</code>.</p><p><strong>Folder Path:</strong> <code>serverless/artifacts</code>.</p></td></tr></tbody></table><p></p><div class="note-callout">In <strong>Advanced</strong>, you can see <strong>Serverless Config File Path</strong>. Use this setting when your Serverless manifest is not named <code>serverless.yml|.yaml|.js|.json</code>. The is the same as the <code>--config</code> option in <code>serverless deploy</code>. See <a href="https://www.serverless.com/framework/docs/providers/aws/cli-reference/deploy" target="_blank">AWS - deploy</a> from Serverless.</div><p>The serverless.yaml manifest is added to Harness.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653341545903/clean-shot-2022-05-23-at-14-32-17.png"/></figure><p>Here&#39;s what the serverless.yaml looks like:</p><pre>service: &lt;+service.name&gt;<br/>frameworkVersion: &#39;2 || 3&#39;<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - httpApi:<br/>          path: /tello<br/>          method: get  <br/>package:<br/>  artifact: &lt;+artifact.path&gt;        <br/>plugins:<br/>  - serverless-deployment-bucket@latest</pre><p></p><p>You can see the <a href="/article/lml71vhsim-harness-variables">Harness expression</a> <code>&lt;+artifact.path&gt;</code> in <code>artifact: &lt;+artifact.path&gt;</code>. The expression <code>&lt;+artifact.path&gt;</code> tells Harness to get the artifact from <strong>Artifacts</strong> section of the Service. We&#39;ll add the artifact next.</p><p>The expression <code>&lt;+service.name&gt;</code> simply uses the Harness Service name for the deployed service name.</p><div class="note-callout">For Docker images, you use the expression <code>&lt;+artifact.image&gt;</code>.</div><h3>Step 3: Add the Artifact</h3><div class="note-callout">Currently, Harness supports ZIP file artifacts only. Harness does not support Docker images yet.</div><p>Next, we&#39;ll add a publicly-available artifact to your Service. The artifact is a zip file with a Javascript function hosted in Artifactory.</p><p>We&#39;ll add a new Artifactory Connector and install a Harness Kubernetes Delegate in a Kubernetes cluster. The Delegate is a worker process that performs the deployment operations. The Delegate will use the URL and credentials you provide in the Connector to connect to Artifactory and fetch the artifact at runtime.</p><p>In <strong>Artifact</strong>, click <strong>Add Primary</strong>.</p><p>In <strong>Specify Artifact Repository Type</strong>, click <strong>Artifactory</strong>, and click <strong>Continue.</strong></p><p>In <strong>Artifactory Repository</strong>, click <strong>New Artifactory Connector</strong>.</p><p>In <strong>Create or Select an Existing Connector</strong>, click <strong>New Artifactory Connector</strong>.</p><p>Enter a name for the Connector, such as <strong>JFrog Serverless</strong>. Click <strong>Continue</strong>.</p><p>In <strong>Details</strong>, in <strong>Artifactory Repository URL</strong>, enter <code>https://harness.jfrog.io/artifactory/</code>.</p><p>In <strong>Authentication</strong>, select <strong>Anonymous</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653341962561/clean-shot-2022-05-23-at-14-39-15.png"/></figure><p>In <strong>Delegates Setup</strong>, click <strong>Install new Delegate</strong>.</p><p>The Delegate wizard appears.</p><p>Click <strong>Kubernetes</strong>, and then click <strong>Continue</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653342053889/clean-shot-2022-05-23-at-14-40-44.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Enter a name for the Delegate, like <strong>serverlesslocal</strong>, click the <u><strong>Laptop</strong></u> size.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653342106983/clean-shot-2022-05-23-at-14-41-36.png"/></figure><div class="note-callout">With the <strong>Laptop</strong> size, you can use a local minikube cluster or a small cluster hosted in a cloud platform. In you use minikube, start minikube with the following resources: <code>minikube start --memory 3g --cpus 2</code>.</div><p>Click <strong>Continue</strong>.</p><p>Click <strong>Download YAML file</strong>. The YAML file for the Kubernetes Delegate will download to your computer.</p><h4>Installing Serverless on the Delegate</h4><p>Now we need to edit the YAML to install Serverless when the Delegate pods are created.</p><p>Open the Delegate YAML in a text editor.</p><p>Locate the Environment variable <code>INIT_SCRIPT</code> in the <code>StatefulSet</code>.</p><pre>...<br/>        - name: INIT_SCRIPT<br/>          value: &#34;&#34;<br/>...</pre><p>Replace the value with the follow Serverless installation script.</p><pre>...<br/>        - name: INIT_SCRIPT<br/>          value: |-<br/>            #!/bin/bash<br/>            echo &#34;Start&#34;<br/>            export DEBIAN_FRONTEND=noninteractive<br/>            echo &#34;non-inte&#34;<br/>            apt-get update<br/>            echo &#34;updagte&#34;<br/>            apt install -yq npm<br/>            echo &#34;npm&#34;<br/>            npm install -g serverless@v2.50.0<br/>            echo &#34;Done&#34;<br/>...</pre><p></p><div class="note-callout">In cases when the Delegate OS does not support <code>apt</code> (like Red Hat Linux), you can can edit this script to install <code>npm</code>. The rest of the code should remain the same. If you are using <a href="/article/4zzg5qitkv-immutable-delegate-overview">Immutable Delegates</a>, the base image is Red Hat UBI.</div><p>Save the YAML file as <strong>harness-delegate.yml</strong>.</p><h4>Install and Register the Delegate</h4><p>Open a terminal and navigate to where the Delegate file is located.</p><p>You will connect to your cluster using the terminal so you can simply run the YAML file on the cluster.</p><p>In the same terminal, log into your Kubernetes cluster. In most platforms, you select the cluster, click <strong>Connect</strong>, and copy the access command.</p><p>Next, install the Harness Delegate using the <strong>harness-delegate.yml</strong> file you just downloaded. In the terminal connected to your cluster, run this command:</p><pre class="hljs cs">kubectl apply -f harness-delegate.yml</pre><p>You can find this command in the Delegate wizard:</p><figure><a href="https://files.helpdocs.io/i5nl071jo5/articles/knunou9j30/1625006899148/clean-shot-2021-06-29-at-15-48-13.png"><img src="https://files.helpdocs.io/i5nl071jo5/articles/knunou9j30/1625006899148/clean-shot-2021-06-29-at-15-48-13.png"/></a></figure><p>In Harness, click <strong>Verify</strong>. It will take a few minutes to verify the Delegate. Once it is verified, close the wizard.</p><p>Back in <strong>Set Up Delegates</strong>, in the list of Delegates, you can see your new Delegate and its tags.</p><p>Select the <strong>Connect using Delegates with the following Tags</strong> option.</p><p>Enter the tag of the new Delegate and click <strong>Save and Continue</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653343968666/clean-shot-2022-05-23-at-15-12-35.png"/></figure><p>In <strong>Connection Test</strong>, you can see that the connection is successful. Click <strong>Finish</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653344046140/clean-shot-2022-05-23-at-15-13-50.png"/></figure><h4>Add the Artifact</h4><p>Back in <strong>Artifactory Repository</strong>, click <strong>Continue</strong>.</p><p>Enter the following artifact settings and click <strong>Submit</strong>. The following image shows how the Artifactory settings corresponded to <strong>Artifact Details</strong>.</p><p></p><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653344758802/clean-shot-2022-05-23-at-15-25-41.png"/></figure></td><td><p><strong>Repository:</strong> <code>lambda</code>.</p><p><strong>Artifact Directory:</strong> <code>serverless</code>.</p><p><strong>Artifact Details:</strong> <code>Value</code>.</p><p><strong>Artifact Path:</strong> <code>handler.zip</code>.</p></td></tr></tbody></table><p></p><p>When you click one of the settings, the Harness Delegate fetches artifact metadata from Artifactory.</p><p>Click <strong>Submit</strong>.</p><p>The artifact is added to the Service.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653344876912/clean-shot-2022-05-23-at-15-27-40.png"/></figure><p>Now the Service is configured, we can define the target for our deployment.</p><p>Click <strong>Continue</strong> to view the <strong>Infrastructure</strong>.</p><h3>Step 3: Define Amazon Web Services Deployment Target</h3><p>In <strong>Infrastructure</strong>, we&#39;ll add an AWS Connector to connect Harness with your Lambda service.</p><p>In <strong>Infrastructure Details</strong>, in <strong>Specify your environment</strong>, click <strong>New Environment</strong>. Just like with a Service, you can create a new Environment or selecting an existing one. We&#39;ll create a new one.</p><p>In <strong>New Environment</strong>, enter a name, select <strong>Pre-Production</strong>, and click <strong>Save</strong>. The new Environment appears.</p><p>In <strong>Infrastructure Definition</strong>, click <strong>AWS</strong>.</p><p>In <strong>Amazon Web Services Details</strong>, click in <strong>Connector</strong>.</p><p>In <strong>Create or Select an Existing Connector</strong>, click <strong>New Connector</strong>.</p><p>Enter the following and click <strong>Save and Continue</strong>.</p><p></p><table><tbody><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653346041322/clean-shot-2022-05-23-at-15-47-15.png"/></figure></td><td><p><strong>Name:</strong> <code>AWS Serverless</code>.</p></td></tr><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653346066645/clean-shot-2022-05-23-at-15-47-27.png"/></figure></td><td><p><strong>Credentials:</strong> <code>AWS Access Key</code>.</p><p>Enter the AWS access key for the AWS User you created with the required policies in <a href="https://ngdocs.harness.io/article/5fnx4hgwsa-serverless-lambda-cd-quickstart#before_you_begin">Before You Begin</a>.</p><p>Enter the secret key as a <a href="/article/osfw70e59c-add-use-text-secrets">Harness Text Secret</a>.</p><p>The Harness Delegate will use these credentials to authenticate Harness with AWS at deployment runtime.</p></td></tr><tr><td><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653346101945/clean-shot-2022-05-23-at-15-48-15.png"/></figure></td><td><p><strong>Delegates Setup:</strong> <code>Only use Delegates with all of the following tags</code>.</p><p>Select the Delegate you added earlier in this quickstart.</p></td></tr></tbody></table><p></p><p>The <strong>Connection Test</strong> verifies the connection. Click <strong>Finish</strong>.</p><p>Back in <strong>Amazon Web Services Details</strong>, in <strong>Region</strong>, enter the region for your AWS Lambda service, such as <strong>us-east-1</strong>.</p><p>In <strong>Stage</strong>, enter the name of the stage in your service that you want to deploy to, such as <strong>dev</strong>. This is the same as the <code>--stage</code> option in the <code>serverless deploy</code> command.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653346203426/clean-shot-2022-05-23-at-15-49-55.png"/></figure><p></p><p>When you run your deployment, you will see these settings used in logs. For example: <code>serverless deploy list --stage dev --region us-east-1</code>.</p><p>Click <strong>Continue</strong>. The <strong>Execution</strong> steps appear.</p><h3>Step 4: Add a Serverless AWS Lambda Deploy Step</h3><p>In <strong>Execution</strong>, you add the steps that define how Harness deploys your Serverless Lambda service.</p><p>Harness automatically add two Serverless Lambda steps to <strong>Execution</strong>:</p><ul><li><strong>Serverless Lambda Deploy:</strong> this step performs the deployment.</li><li><strong>Serverless Lambda Rollback:</strong> this step performs rollback in the event of a deployment failure. To see this step, toggle the Execution/Rollback setting.<figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653412834083/clean-shot-2022-05-24-at-10-20-08.png"/></figure></li></ul><p>In <strong>Execution</strong>, click <strong>Serverless Lambda Deploy</strong>.</p><p>Click the <strong>Advanced</strong> tab and select the Delegate that you installed in <strong>Delegate Selector</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653416591258/clean-shot-2022-05-24-at-11-22-55.png"/></figure><p>If you only have one Delegate installed in your Project, then this isn&#39;t necessary. But if you have multiple Delegates, you want to make sure the Serverless Lambda Deploy step uses the Delegate where you installed Serverless.</p><p>Click <strong>Apply Changes</strong>.</p><p>Now you&#39;re ready to deploy.</p><h4>Serverless Deploy Command Options</h4><p>In <strong>Serverless Deploy Command Options</strong>, you can add any <code>serverless deploy</code> command options. See the <a href="https://www.serverless.com/framework/docs/providers/aws/cli-reference/deploy" target="_blank">Serverless AWS - Deploy</a> doc for the list of options.</p><p>In the deployment logs, you will see the options added to the serverless deploy command.</p><p>For example, if you add <code>--conceal</code> in <strong>Serverless Deploy Command Options</strong> you will see the following:</p><pre>serverless deploy --stage dev --region us-east-1 --conceal</pre><h3>Step 5: Deploy and Review</h3><p>Save you Pipeline and then click <strong>Run</strong>, and then <strong>Run Pipeline</strong>.</p><p>The Pipeline executes.</p><p>In the <strong>Serverless AWS Lambda Deploy</strong> step, click <strong>Input</strong> to see the deployment inputs:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653416823048/clean-shot-2022-05-24-at-11-26-51.png"/></figure><p>Click <strong>Output</strong> to see what is deployed:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/5fnx4hgwsa/1653416837906/clean-shot-2022-05-24-at-11-27-09.png"/></figure><p>Click <strong>Details</strong> or <strong>Console View</strong> to see the logs.</p><p>In the logs you can see the successful deployment.</p><pre>Deploying..<br/><br/>Serverless Deployment Starting..<br/>serverless deploy --stage dev --region us-east-1<br/>Serverless: Deprecation warning: Support for Node.js versions below v12 will be dropped with next major release. Please upgrade at https://nodejs.org/en/<br/>            More Info: https://www.serverless.com/framework/docs/deprecations/#OUTDATED_NODEJS<br/>Serverless: Deprecation warning: Resolution of lambda version hashes was improved with better algorithm, which will be used in next major release.<br/>            Switch to it now by setting &#34;provider.lambdaHashingVersion&#34; to &#34;20201221&#34;<br/>            More Info: https://www.serverless.com/framework/docs/deprecations/#LAMBDA_HASHING_VERSION_V2<br/>Serverless: Packaging service...<br/>Serverless: Uploading CloudFormation file to S3...<br/>Serverless: Uploading artifacts...<br/>Serverless: Uploading service artifactFile file to S3 (721 B)...<br/>Serverless: Validating template...<br/>Serverless: Updating Stack...<br/>Serverless: Checking Stack update progress...<br/>.........<br/>Serverless: Stack update finished...<br/>Service Information<br/>service: myfunction<br/>stage: dev<br/>region: us-east-1<br/>stack: myfunction-dev<br/>resources: 11<br/>api keys:<br/>  None<br/>endpoints:<br/>  GET - https://85h6zffizc.execute-api.us-east-1.amazonaws.com/tello<br/>functions:<br/>  hello: myfunction-dev-hello<br/>layers:<br/>  None<br/><br/>Deployment completed successfully.</pre><p></p><p>Congratulations! You have successfully deployed a function using Serverless Lambda and Harness.</p><h3>Clean Up</h3><p>To delete the Harness Delegate from your Kubernetes cluster, you delete the StatefulSet for the Delegate. Once created, the StatefulSet ensures that the desired number of pods are running and available at all times. Deleting the pod without deleting the StatefulSet will result in the pod being recreated.</p><p>For example, if you have the Delegate pod name <code>quickstart-vutpmk-0</code>, you can delete the StatefulSet with the following command:</p><p><code>$ kubectl delete statefulset -n harness-delegate-ng quickstart-vutpmk</code></p><p>Note that the <code>-0</code> suffix in the pod name is removed for the StatefulSet name.</p><h3>Notes</h3><p>Now that you&#39;re done the quickstart, here is some more information to help you extend your Harness Serverless Lambda deployments.</p><h4>Serverless Manifest Supports Harness Secrets and Expressions</h4><p>The serverless.yaml file you use with Harness can use Harness secret and built-in expressions.</p><p>Expression support lets you take advantage of Runtime Inputs and Input Sets in your serverless.yaml files. For example, you could use a Stage variable as a runtime input to change plugins with each stage deployment:</p><pre>service: &lt;+service.name&gt;<br/>frameworkVersion: &#39;2 || 3&#39;<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - httpApi:<br/>          path: /tello<br/>          method: get  <br/>package:<br/>  artifact: &lt;+artifact.path&gt;          <br/>plugins:<br/>  - &lt;+stage.variables.devplugins&gt;</pre><p></p><p>See:</p><ul><li><a href="/article/osfw70e59c-add-use-text-secrets">Add and Reference Text Secrets</a></li><li><a href="/article/lml71vhsim-harness-variables">Built-in Harness Variables Reference</a></li><li><a href="/article/gfk52g74xt-run-pipelines-using-input-sets-and-overlays">Run Pipelines using Input Sets and Overlays</a></li></ul><h4>Rollback Timestamps</h4><p>In a Serverless CLI rollback (<code>serverless rollback --timestamp timestamp</code>), you would have to manually identify and select the timestamp of the last successful deployment. This can be difficult because you need to know which timestamp to use. With multiple developers deploying, there is the possibility of rolling back to the wrong version.</p><p>Harness avoids this issue by automatically identifying the <u>last successful deployment</u> using its timestamp. During the event of a rollback, Harness will automatically rollback to that deployment.</p><p>You can see the timestamps in the deployment logs:</p><pre>Serverless: Listing deployments:<br/>Serverless: -------------<br/>Serverless: Timestamp: 1653065606430<br/>Serverless: Datetime: 2022-05-20T16:53:26.430Z<br/>Serverless: Files:<br/>Serverless: - compiled-cloudformation-template.json<br/>Serverless: - myfunction.zip<br/>Serverless: -------------<br/>Serverless: Timestamp: 1653344285842<br/>Serverless: Datetime: 2022-05-23T22:18:05.842Z<br/>Serverless: Files:<br/>Serverless: - artifactFile<br/>Serverless: - compiled-cloudformation-template.json<br/>Serverless: -------------<br/>Serverless: Timestamp: 1653415240343<br/>Serverless: Datetime: 2022-05-24T18:00:40.343Z<br/>Serverless: Files:<br/>Serverless: - artifactFile<br/>Serverless: - compiled-cloudformation-template.json</pre><p></p><div class="note-callout">If there is no change in code, Serverless doesn&#39;t deploy anything new. In the logs you will see <code>Serverless: Service files not changed. Skipping deployment...</code>.</div><p>While this is somewhat similar to how rollback is performed in Serverless CLI, Harness performs rollback automatically and always uses the timestamp of last successful deployment.</p><p>During a Harness rollback, you can see the timestamp used to rollback to the last successful deployment (<code>rollback --timestamp 1653415240343 --region us-east-1 --stage dev</code>):</p><pre>Rollback..<br/><br/>Serverless Rollback Starting..<br/>serverless rollback --timestamp 1653415240343 --region us-east-1 --stage dev<br/>Serverless: Deprecation warning: Support for Node.js versions below v12 will be dropped with next major release. Please upgrade at https://nodejs.org/en/<br/>            More Info: https://www.serverless.com/framework/docs/deprecations/#OUTDATED_NODEJS<br/>Serverless: Deprecation warning: Resolution of lambda version hashes was improved with better algorithm, which will be used in next major release.<br/>            Switch to it now by setting &#34;provider.lambdaHashingVersion&#34; to &#34;20201221&#34;<br/>            More Info: https://www.serverless.com/framework/docs/deprecations/#LAMBDA_HASHING_VERSION_V2<br/>Serverless: Updating Stack...<br/><br/>Rollback completed successfully.</pre><p></p><h4>Versioning</h4><p>Serverless Lambda deployments are versioned using the timestamp of their deployment. This versioning has no relation to the <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-versions.html" target="_blank">versioning in AWS Lambda</a>.</p><h4>Sidecar Artifacts</h4><p>You reference sidecar artifacts with the format <code>&lt;+artifacts.sidecars.[artifact_Id]&gt;</code>.</p><p>The artifact Id comes from the Artifact Details:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/5fnx4hgwsa/1661878032766/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>You can see it in the artifact list:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/5fnx4hgwsa/1661878018330/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h5>Docker Sidecars</h5><p>Here&#39;s an example of a serverless.yaml referencing primary and sidecar artifacts:</p><pre>...<br/>functions:<br/>  hello:<br/>    image: &lt;+artifact.image&gt;<br/>  hello1:<br/>    image: &lt;+artifacts.sidecars.mysidecar&gt;<br/>...</pre><h5>Non-container Sidecars</h5><p>Here&#39;s an example of a serverless.yaml referencing primary and sidecar artifacts:</p><pre>service: my-project-134fadsaez<br/>frameworkVersion: &#39;2.35.0&#39;<br/><br/>provider:<br/>  name: aws<br/>  runtime: java8<br/><br/>package:<br/>  artifact: &lt;+artifact.path&gt;<br/><br/>functions:<br/>  currentTime:<br/>    handler: com.serverless.Handler<br/>    events:<br/>      - httpApi:<br/>          path: /time<br/>          method: get<br/>    layers:<br/>      # Ref name is generated by TitleCasing the layer name &amp; appending LambdaLayer<br/>      - { Ref: CommonLibsLambdaLayer }<br/><br/>layers:<br/>  commonLibs:<br/>    package:<br/>      artifact: &lt;+artifacts.sidecars.mysidecar&gt;</pre><h4>Plugin Support</h4><p>Harness supports Serverless plugins in your serverless.yaml file.</p><p>You simply add the plugin using the standard Serverless <code>plugins</code> format and Harness adds the plugin at runtime.</p><pre>service: &lt;+service.name&gt;<br/>frameworkVersion: &#39;2 || 3&#39;<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - httpApi:<br/>          path: /tello<br/>          method: get  <br/>package:<br/>  artifact: &lt;+artifact.path&gt;          <br/>plugins:<br/>  - serverless-deployment-bucket@latest</pre><p></p><h4>Serverless YAML for Files and Images</h4><p>The serverless.yaml format for files (for example, ZIP, JAR, WAR) is different from the format for Docker images.</p><h5>Serverless YAML for Files</h5><pre>service: example-service<br/>frameworkVersion: &#39;2 || 3&#39;<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - httpApi:<br/>          path: /tello<br/>          method: get  <br/>package:<br/>  artifact: &lt;+artifact.path&gt;<br/>plugins:<br/>  - serverless-deployment-bucket@latest</pre><h5>Serverless YAML for Docker Images</h5><pre>service: example-service<br/>frameworkVersion: &#39;2 || 3&#39;<br/><br/>provider:<br/>  name: aws<br/><br/>functions:<br/>  hello:<br/>    image: &lt;+artifact.image&gt;</pre><p></p>