<div class="note-callout">Currently, this feature is behind the Feature Flag <code>PRUNE_KUBERNETES_RESOURCES_NG</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature.</div><p>Changes to the manifests used in Harness Kubernetes deployments can result in orphaned resources you are unaware of.</p><p>For example, one deployment might deploy resources A and B but the next deployment deploys A and C. C is the new resource and B was removed from the manifest. Without pruning, resource B will remain in the cluster.</p><p>You can manually delete Kubernetes resources using the <a href="/article/eaj0xuegln-delete-kubernetes-resources">Delete</a> step, but Harness will also perform resource pruning automatically during deployment.</p><p>Harness uses pruning by default to remove any resources that were present in an old manifest, but no longer present in the manifest used for the current deployment.</p><p>Harness also allows you to identify resources you do not want pruned using the annotation <code>harness.io/skipPruning</code>.</p><h3>Before You Begin</h3><ul><li><a href="/article/knunou9j30-kubernetes-cd-quickstart">Kubernetes CD Quickstart</a></li><li><a href="/article/xsla71qg8t-create-a-kubernetes-rolling-deployment">Create a Kubernetes Rolling Deployment</a></li><li><a href="/article/i5p4feil89-create-a-kubernetes-canary-deployment">Create a Kubernetes Canary Deployment</a></li><li><a href="/article/eaj0xuegln-delete-kubernetes-resources">Delete Kubernetes Resources</a></li></ul><h3>Supported Platforms and Technologies</h3><p>Pruning is supported for the following deployment strategies:</p><ul><li>Rolling Deployments</li><li>Blue/Green Deployments</li></ul><p>See <a href="/article/1e536z41av-supported-platforms-and-technologies">Supported Platforms and Technologies</a>.</p><h3>Limitations</h3><ul><li>To prevent pruning using the Harness annotation <code>harness.io/skipPruning: &#34;true&#34;</code>, the resource must have been deployed by Harness.<br/>Harness pruning does not consider resources outside of a Harness deployment.<br/>If you make any changes to your Kubernetes resources using a tool other than Harness (before or after the deployment), Harness does not track those changes.</li><li>The maximum manifest/chart size is 0.5MB. When Harness prunes, it stores the full manifest in configMap to use it as part of release history. While deploying very large manifests/charts though Kubernetes, Harness is limited by configMap capacity.</li><li>While it is unlikely, if you are using the same entity in two Harness Services, Harness does not know this. So if you prune the resource in one deployment it might be unavailable in another deployment. Use the annotation <code>harness.io/skipPruning: &#34;true&#34;</code> to avoid issues.</li></ul><h3>Review: Harness Kubernetes Pruning Criteria</h3><p>Kubernetes pruning in Harness is similar to the <code>kubectl apply --prune</code> method provided by <a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#alternative-kubectl-apply-f-directory-prune-l-your-label" target="_blank">Kubernetes</a>.</p><p>Kubernetes pruning queries the API server for all objects matching a set of labels and attempts to match the returned live object configurations against the object configuration files.</p><p>Similarly, Harness compares the objects you are deploying with the objects it finds in the cluster. If Harness finds objects which are not in the current release, it prunes them.</p><p>Harness also allows you to identify resources you do not want pruned using the annotation <code>harness.io/skipPruning</code>. This is described later in this topic.</p><h4>Rolling Deployments</h4><p>Kubernetes Rolling deployments manage pruning as follows:</p><p>During deployment, Harness compares resources in the <u>last successful release</u> with the current release.</p><p>Harness prunes the resources from the last successful release that are not in current release.</p><p>If a deployment fails, Harness recreates the pruned resources during its Rollback stage.</p><p>During rollback, any new resources that were created in the failed deployment stage that were not in the last successful release are deleted also.</p><h4>Blue/Green Deployments</h4><p>Kubernetes Blue/Green deployments manage pruning as follows:</p><p>In the first step of a Blue/Green deployment, the new version of the release is deployed to the stage environment (pod set).</p><p>Harness prunes by comparing the new and previous releases in the stage pod set. Harness prunes the resources from the last successful release which are not in the current release.</p><p>Let&#39;s look at an example.</p><ol><li>Deployment 1 is successfully deployed. It contained manifests for resources a, b, and c.</li><li>Deployment 2 failed. It contained manifests for resources a, c, and d, but not b.</li><li>Before failure, resource d is created and resource b is pruned.</li><li>During rollback, Harness recreates the previously pruned resource b and deletes resource d.</li></ol><h3>Review: Pruning Examples</h3><p>The first time you deploy a resource (Deployment, StatefulSet, ReplicaSet, etc) no pruning will take place.</p><p>In Harness Pipeline execution, you will see a <strong>Prune</strong> section with the following message:</p><pre>No previous successful deployment found, so no pruning required</pre><p></p><p>When Harness finds resources that match the pruning criteria, you will see a message like this:</p><pre>kubectl --kubeconfig=config delete Deployment/k8s-orphaned-resource-b --namespace=default<br/><br/>deployment.apps &#34;k8s-orphaned-resource-b&#34; deleted<br/><br/>kubectl --kubeconfig=config delete ConfigMap/k8s-orphaned-resource-configmap-b --namespace=default<br/><br/>configmap &#34;k8s-orphaned-resource-configmap-b&#34; deleted<br/><br/>Pruning step completed</pre><p></p><p>If a deployment fails, Harness recreates any of the pruned resources it removed as part of the deployment. In the <strong>Rollback</strong> step, you will see a <strong>Recreate Pruned Resources</strong> section with message like this:</p><pre>kubectl --kubeconfig=config apply --filename=manifests.yaml --record<br/><br/>deployment.apps/k8s-orphaned-resource-f created<br/><br/>Successfully recreated pruned resources.</pre><h3>Step 1: Skip Pruning for a Resource</h3><p>To ensure that a resource is not pruned, add the annotation <code>harness.io/skipPruning: &#34;true&#34;</code>.</p><p>When Harness identifies resources from the last successful release which are not in current release, it searches for the <code>harness.io/skipPruning</code> annotation and ignores any resources that have it set to <code>true</code>.</p><p>You can deploy a resource using the annotation <code>harness.io/skipPruning: &#34;true&#34;</code>, and then if the manifest is removed and another deployment occurs, Harness will see the annotation <code>harness.io/skipPruning: &#34;true&#34;</code> on the resource previously deployed and skip pruning it.</p><div class="note-callout">As mentioned in <strong>Limitations</strong> above, you cannot add a resource with the annotation outside of a Harness deployment and have Harness skip the pruning of that resource.</div><h3>See Also</h3><ul><li><a href="/article/eaj0xuegln-delete-kubernetes-resources">Delete Kubernetes Resources</a></li></ul><p></p><p></p>