<div class="note-callout">Currently, this feature is behind the feature flag <code>CLOUDFORMATION_NG</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature.</div><p></p><p>This topic describes how to provision resources in a CD stage&#39;s deployment infrastructure using the CloudFormation <strong>Create Stack</strong> step.</p><p>You use the CloudFormation <strong>Create Stack</strong> step in a CD stage&#39;s <strong>Execution</strong> section as part of the deployment process. The <strong>Create Stack</strong> step runs the CloudFormation template and supporting files that you supply inline or from your repos (Git, AWS S3). Harness provisions the CloudFormation stack defined in the template as part of the stage&#39;s <strong>Execution</strong>.</p><div class="note-callout">You can also use <strong>Create Stack</strong> in the <strong>Infrastructure</strong> section of a CD stage. You can even map the CloudFormation template outputs to the target infrastructure in <strong>Infrastructure</strong>. During deployment, Harness first provisions the target deployment infrastructure and then the stage&#39;s Execution steps deploy to the provisioned infrastructure. For steps on this process, see <a href="/article/6jfl7i6a5u-provision-target-deployment-infra-dynamically-with-cloud-formation">Provision Target Deployment Infra Dynamically with CloudFormation</a>.</div><p></p><h3>Before You Begin</h3><ul><li><a href="/article/vu2qi7dfzm-cloud-formation-provisioning-with-harness">CloudFormation Provisioning with Harness</a></li></ul><h3>Step 1: Add the CloudFormation Create Stack Step</h3><p>In the <strong>Execution</strong> section of your Deploy stage, click <strong>Add Step</strong>, and then select the <strong>CloudFormation Create Stack</strong> step.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/pq58d0llyx/1654813392166/clean-shot-2022-06-09-at-15-23-03.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>The <strong>Create Stack</strong> step is where you connect Harness to your templates and provide additional settings.</p><h4>Name</h4><p>In <strong>Name</strong>, enter a name for the step, for example, <strong>C</strong><strong>reate EC2 Instance</strong>.</p><p>Harness will create an <a href="/article/li0my8tcz3-entity-identifier-reference">Entity Id</a> using the name. The Id is very important. You can use an Harness expression and Id to refer to settings in this step from another step.</p><p>See <a href="/article/lml71vhsim-harness-variables">Built-in and Custom Harness Variables Reference</a>.</p><h4>Timeout</h4><p>In <strong>Timeout</strong>, enter how long Harness should wait to complete the step before failing the step and initiating the <a href="/article/htrur23poj-step-failure-strategy-settings">Step and Stage Failure Strategy</a>.</p><h4>Provisioner Identifier</h4><p>Enter a unique value in <strong>Provisioner Identifier</strong>.</p><p>The <strong>Provisioner Identifier</strong> identifies the provisioning done by this step. You reference the <strong>Provisioner Identifier</strong> in other steps to refer to the provisioning done by this step.</p><div class="note-callout">Only one <strong>Create Stack</strong> step with a specific <strong>Provisioner Identifier</strong> can be added in the same stage. If you add multiple <strong>Create Stack</strong> steps with the same <strong>Provisioner Identifier</strong>, only the first <strong>Create Stack</strong> step will be successful.</div><p>The most common use of <strong>Provisioner Identifier</strong> is between the Create Stack, Delete Stack, and Rollback Stack steps.</p><p>For example, in the case of a <strong>Create Stack</strong> failure, the <strong>Rollback Stack</strong> step rolls back the provisioning from the <strong>Create Stack</strong> step using its <strong>Provisioner Identifier</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/6jfl7i6a5u/1654197456868/clean-shot-2022-06-02-at-12-17-27.png"/></figure><p>Ultimately, Harness determines what stack to roll back to using a combination of <code>Provisioner Identifier + Harness account id + Harness org id + Harness project id</code>.</p><h5 id="undefined">Provisioner Identifier Scope</h5><p>The <strong>Provisioner Identifier</strong> is a <u>Project-wide</u> setting. You can reference it across Pipelines in the same Project.</p><p>For this reason, it&#39;s important that all your Project members know the Provisioner Identifiers. This will prevent one member building a Pipeline from accidentally impacting the provisioning of another member&#39;s Pipeline.</p><h4>AWS Connector</h4><p>Add or select the Harness <a href="/article/m5vkql35ca-aws-connector-settings-reference">AWS Connector</a> that will be used for this step. The AWS Connector will include the credentials needed to perform the provisioning.</p><p>The credentials required for provisioning depend on what you are provisioning.</p><p>For example, if you wanted to give full access to create and manage EKS clusters, you could use a policy like this:</p><pre class="hljs json">{<br/>     &#34;Version&#34;: &#34;2012-10-17&#34;,<br/>     &#34;Statement&#34;: [<br/>         {<br/>             &#34;Effect&#34;: &#34;Allow&#34;,<br/>             &#34;Action&#34;: [<br/>                 &#34;autoscaling:*&#34;,<br/>                 &#34;cloudformation:*&#34;,<br/>                 &#34;ec2:*&#34;,<br/>                 &#34;eks:*&#34;,<br/>                 &#34;iam:*&#34;,<br/>                 &#34;ssm:*&#34;<br/>             ],<br/>             &#34;Resource&#34;: &#34;*&#34;<br/>         }<br/>     ]<br/> }</pre><p></p><div class="note-callout">Ensure that the credentials include the <code>ec2:DescribeRegions</code> policy described in <a href="/article/m5vkql35ca-aws-connector-settings-reference">AWS Connector</a>.</div><p>See <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-servicerole.html" target="_blank">AWS CloudFormation service role</a> from AWS.</p><h4>Region</h4><p>Select the region for the resources you are provisioning.</p><h4>Template File</h4><p>You can add your template in the following ways:</p><ul><li><strong>Inline:</strong> just enter the template in <strong>Template File</strong>. You can use CloudFormation-compliant JSON or YAML.</li><li><strong>AWS S3:</strong> enter the URL of the S3 bucket containing the template file. This can be a public or private URL. If you use a private URL, the AWS credentials in the <strong>AWS Connector</strong> setting are used for authentication. Ensure that the credentials include the <strong>AmazonS3ReadOnlyAccess</strong> policy and the <code>ec2:DescribeRegions</code> policy described in <a href="/article/m5vkql35ca-aws-connector-settings-reference">AWS Connector</a>.</li><li><strong>Remote:</strong> select a Git repo where you template is located. You&#39;ll add or select a Harness Git Connector for the repo. See <a href="https://newdocs.helpdocs.io/category/xyexvcc206">Code Repo Connectors</a>.</li></ul><h5>Expression and Secret Support in Templates</h5><p>Harness expressions and secrets can be used in templates. They are resolved at runtime.</p><p>See:</p><ul><li><a href="/article/osfw70e59c-add-use-text-secrets">Add and Reference Text Secrets</a></li><li><a href="/article/lml71vhsim-harness-variables">Built-in and Custom Harness Variables Reference</a></li></ul><h4>Stack Name</h4><p>Enter a name for the CloudFormation stack Harness will create.</p><p>This is the same as the <code>--stack-name</code> option in the <code>aws cloudformation create-stack</code> command.</p><pre>aws cloudformation create-stack --stack-name test --template-body file://eks.yml</pre><h4>Option: CloudFormation Parameter Files</h4><p>You can use CloudFormation parameters files to specify input parameters for the stack.</p><p>This is the same as using the AWS CloudFormation CLI <code>create-stack</code> option <code>--parameters</code> and a JSON parameters file...</p><pre>aws cloudformation create-stack --stackname startmyinstance<br/>--template-body file:///some/local/path/templates/startmyinstance.json<br/>--parameters https://your-bucket-name.s3.amazonaws.com/params/startmyinstance-parameters.json</pre><p></p><p>...where the JSON file contains parameters such as these:</p><pre>[<br/>  {<br/>    &#34;ParameterKey&#34;: &#34;KeyPairName&#34;,<br/>    &#34;ParameterValue&#34;: &#34;MyKey&#34;<br/>  }, <br/>  {<br/>    &#34;ParameterKey&#34;: &#34;InstanceType&#34;,<br/>    &#34;ParameterValue&#34;: &#34;m1.micro&#34;<br/>  }<br/>]</pre><p></p><p>In <strong>Cloud Formation Parameter Files</strong>, click <strong>Add</strong>.</p><p>In <strong>Parameter File Connector</strong>, select your Git platform, and the select or add a Git Connector. See <a href="https://newdocs.helpdocs.io/category/xyexvcc206">Code Repo Connectors</a> for steps on adding a Git Connector.</p><p>For AWS S3, see <a href="/article/98ezfwox9u-add-aws-connector">Add an AWS Connector</a>.</p><p>In <strong>Parameter File Details</strong>, enter the following:</p><ul><li><strong>Identifier:</strong> enter an Identifier for the file. This is just a name that indicates what the parameters are for.</li><li><strong>Repo Name:</strong> if the Git Connector does not have the repo path, enter it here.</li><li><strong>Git Fetch Type:</strong> select <strong>Latest from Branch</strong> or use a Git commit Id or tag.</li><li><strong>Parameter File Details:</strong> enter the path to the file from the root of the repo. To add multiple files, click <strong>Add Path File</strong>.</li></ul><p>Here&#39;s an example:</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/6jfl7i6a5u/1654207949340/clean-shot-2022-06-02-at-15-12-18.png"/></figure><h5>Encrypted Text Secrets and Expressions in Parameter Files and Settings</h5><p>Harness expressions and secrets can be used in parameter files and in the <strong>Parameter File Details</strong> settings. They are resolved at runtime.</p><p>See:</p><ul><li><a href="/article/osfw70e59c-add-use-text-secrets">Add and Reference Text Secrets</a></li><li><a href="/article/lml71vhsim-harness-variables">Built-in and Custom Harness Variables Reference</a></li></ul><p></p><h4>Option: CloudFormation Parameters Overrides</h4><p>You can override parameters added in <strong>Parameter File Details</strong>.</p><p>In <strong>CloudFormation Parameters Overrides</strong>, click <strong>Specify Inline Parameters</strong>.</p><p>In <strong>CloudFormation Parameters Overrides</strong>, click <strong>Retrieve Names from template</strong> to retrieve the parameters from the JSON file. You can also manually enter the names and values.</p><p>For each parameter you want to override, enter a new values in <strong>Value</strong>.</p><p>Harness text secrets are supported. See <a href="/article/osfw70e59c-add-use-text-secrets">Add and Reference Text Secrets</a>.</p><h4>Option: Role ARN</h4><p>Enter the AWS Role ARN to use when creating the stack. Use an existing AWS Identity and Access Management (IAM) service role that CloudFormation can assume.</p><p>This is the same as the role you would use when creating a stack using the AWS console <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-console-add-tags.html" target="_blank">Permissions</a> setting or CLI.</p><p>See <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-servicerole.html" target="_blank">AWS CloudFormation service role</a> from AWS.</p><h4>Option: Specify Capabilities</h4><p>To acknowledge the capabilities in the CloudFormation template, click in <strong>Specify Capabilities</strong> and select capabilities.</p><p>This acknowledges that the template contains certain capabilities (for example, <code>CAPABILITY_AUTO_EXPAND</code>), giving AWS CloudFormation the specified capabilities before it creates the stack. This is the same as using the <code>--capabilities</code> option in the <code>aws cloudformation create-stack</code> CLI command. See <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/create-stack.html" target="_blank">create-stack</a>.</p><h4>Option: Tags</h4><p>Tags are arbitrary key-value pairs that can be used to identify your stack for purposes such as cost allocation.</p><p>A <strong>Key</strong> consists of any alphanumeric characters or spaces. Tag keys can be up to 127 characters long.</p><p>A <strong>Value</strong> consists of any alphanumeric characters or spaces. Tag values can be up to 255 characters long.</p><p>Enter the tags in JSON or YAML (lowercase is required):</p><pre class="hljs json">[{<br/>    &#34;key&#34;: &#34;string&#34;,<br/>    &#34;value&#34;: &#34;string&#34;<br/>},{<br/>    &#34;key&#34;: &#34;string&#34;,<br/>    &#34;value&#34;: &#34;string&#34;<br/>}]</pre><h4>Option: Continue Based on Stack Statuses</h4><p>In <strong>Continue Based on Stack Statuses</strong>, you can add the stack states that allow provisioning.</p><div class="note-callout">Harness checks if the stack is in <code>ROLLBACK_COMPLETE</code> state before the deployment. If present, Harness deletes the stack and then triggers the deployment.</div><p></p><h4>Option: Advanced Settings</h4><p>In <strong>Advanced</strong>, you can use the following options:</p><ul><li><a href="/article/i36ibenkq2-step-skip-condition-settings">Step Skip Condition Settings</a></li><li><a href="/article/htrur23poj-step-failure-strategy-settings">Step Failure Strategy Settings</a></li><li><a href="/article/nnuf8yv13o-select-delegates-with-selectors">Select Delegates with Selectors</a></li></ul><p></p>