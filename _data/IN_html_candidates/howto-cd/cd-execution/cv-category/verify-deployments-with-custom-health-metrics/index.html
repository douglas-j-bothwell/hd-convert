<p>Harness offers support for all major APM vendors and log providers, but there are cases where a customized APM or log provider is needed. The Custom Health Source lets you customize APMs and log providers of your choice.</p><p>This topic covers how to add and configure Custom Health as a Health Source for the Verify step.</p><p>In this topic:</p><ul><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#before_you_begin">Before You Begin</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#review_cv_setup_options">Review: CV Setup Options</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_1_add_verify_step">Step 1: Add Verify Step</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_2_enter_a_name_and_timeout">Step 2: Enter a Name and Timeout</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_3_select_a_continuous_verification_type">Step 3: Select a Continuous Verification Type</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_4_create_a_monitored_service">Step 4: Create a Monitored Service</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_5_add_health_sources">Step 5: Add Health Sources</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_7_select_duration">Step 7: Select Duration</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_8_specify_artifact_tag">Step 8: Specify Artifact Tag</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#option_advanced_settings">Option: Advanced Settings</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#step_9_deploy_and_review_results">Step 9: Deploy and Review Results</a><ul><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#summary">Summary</a></li><li><a href="https://ngdocs.harness.io/article/n67y68fopr-verify-deployments-with-custom-health-metrics#console_view">Console View</a></li></ul></li></ul><h3>Before You Begin</h3><p><a href="/article/g21fb5kfkg-connect-to-monitoring-and-logging-systems#step_add_custom_health">Add Custom Health as a Verification Provider</a></p><h3>Review: CV Setup Options</h3><p>To use the Verify step, you will need a Harness Service Reliability Management Monitored Service. In the simplest terms, a Harness Monitored Service is a Service and Environment combination that Harness monitors for:</p><ul><li>Any changes, such as deployments, infrastructure changes, and incidents</li><li>Any health trend deviations using logs and metrics obtained from APM and Logging tools, respectively</li></ul><p>No matter where you set up the Monitored Service, once it&#39;s set up, it&#39;s available to both Service Reliability Management and CD modules.</p><p>In this topic, we set up the Harness Monitored Service as part of the Verify step setup.</p><h3>Step 1: Add Verify Step</h3><p>There are two ways to add the Verify step:</p><ul><li><strong>When selecting the stage deployment strategy:</strong><br/>The <strong>Verify</strong> step can be enabled in a CD stage the first time you open the <strong>Execution</strong> settings and select the deployment strategy. When you select the deployment strategy you want to use, there is also an <strong>Enable Verification</strong> option. Select the <strong>Enable Verification</strong> option.<br/>Harness will automatically add the <strong>Verify</strong> step. For example, here is a stage where Canary strategy and the <strong>Enable Verification</strong> option were selected.<figure><a href="https://files.helpdocs.io/i5nl071jo5/articles/3xhqq9xllp/1629841311860/clean-shot-2021-08-24-at-14-41-30.png"><img src="https://files.helpdocs.io/i5nl071jo5/articles/3xhqq9xllp/1629841311860/clean-shot-2021-08-24-at-14-41-30.png"/></a></figure></li><li><strong>Add the Verify step to an existing Execution setup:</strong> You can also add the Verify step to the Execution section of a CD stage in a Pipeline you previously created. Simply click <strong>Add Step</strong> after the deployment step, and then select <strong>Verify</strong>.<figure><a href="https://files.helpdocs.io/i5nl071jo5/articles/3xhqq9xllp/1629841332662/clean-shot-2021-08-24-at-14-42-00.png"><img src="https://files.helpdocs.io/i5nl071jo5/articles/3xhqq9xllp/1629841332662/clean-shot-2021-08-24-at-14-42-00.png"/></a></figure></li></ul><h3>Step 2: Enter a Name and Timeout</h3><p>In <strong>Name</strong>, enter a name for the step.</p><p>In <strong>Timeout</strong>, enter a timeout value for the step.</p><p>You can use:</p><ul><li><code>w</code> for weeks</li><li><code>d</code> for days</li><li><code>h</code> for hours</li><li><code>m</code> for minutes</li><li><code>s</code> for seconds</li><li><code>ms</code> for milliseconds</li></ul><p>The maximum is <code>53w</code>. Timeouts can be set at the Pipeline level also.</p><h3>Step 3: Select a Continuous Verification Type</h3><p>In <strong>Continuous Verification Type</strong>, select a type that matches your <a href="/article/3xhqq9xllp-verify-deployments-with-the-verify-step#step_3_select_a_continuous_verification_type">deployment strategy</a>.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/916vrl4l76/1630648542919/screenshot-2021-09-03-at-11-25-26-am.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h3>Step 4: Create a Monitored Service</h3><p>In <strong>Monitored Service</strong>, click <strong>Click to autocreate a monitored service</strong>.</p><p>Harness automatically creates a Monitored Service using a concatenation of the Service and Environment names. For example, a Service named <code>todolist</code> and an Environment named <code>dev</code> will result in a Monitored Service named <code>todolist_dev</code>.</p><p>If the stage Service or Environment settings are <a href="https://ngdocs.harness.io/article/f6yobn7iq0-runtime-inputs">Runtime Inputs</a>, the Monitored Service and Health Sources settings will show up in the <strong>Runtime Input</strong> settings when you run the Pipeline.</p><h3>Step 5: Add Health Sources</h3><p>A Health Source is basically a mapping of a Harness Service to the service in a deployment environment monitored by an APM or logging tool.</p><p>In <strong>Health Sources</strong>, click <strong>Add</strong>. The <strong>Add New Health Source</strong> settings appear.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/n67y68fopr/1646708421099/screenshot-2022-03-03-at-9-51-00-am.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><ol><li>In <strong>Select health source type</strong>, select <strong>Custom Health</strong>.</li><li>In <strong>Health Source Name</strong>, enter a name for the Health Source. For example Quickstart.</li><li>In <strong>Connect Health Source</strong>, click <strong>Select Connector</strong>.</li><li>In <strong>Connector</strong> settings, you can either choose an existing connector or click <strong>New Connector.</strong></li><li>Click <strong>Apply Selected</strong>. The Connector is added to the Health Source.</li><li>In <strong>Select Feature</strong>, select the feature to be monitored. You can either select <strong>Custom Health Metrics</strong> or <strong>Custom Health Logs</strong>.</li><li>Click <strong>Next</strong>.</li></ol><h4>Option: Custom Health Metrics</h4><ol><li>If you select Custom Health Metrics, the <strong>Customize Health Source</strong> settings appear as:<figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/n67y68fopr/1646979328011/screenshot-2022-03-11-at-11-44-19-am.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Click <strong>Map Metric(s) to Harness Services</strong>.</li><li>In <strong>Metric Name</strong>, enter the name of the metric.</li><li>In <strong>Group Name</strong>, click <strong>Add New</strong> and enter a name for the metric group.</li><li>Click <strong>Query specifications and mapping.</strong></li><li>In <strong>Query Type</strong> you can choose either <strong>Service Based (used for Health Score and SLI)</strong> or <strong>Host Based (used for CV)</strong>.</li></ol><div class="note-callout">If you select the query type as <strong>Host Based</strong> (Continuous Verification), the verification won&#39;t happen for SLI and Health Score (Service Based), and vice versa.</div><ol><li style="counter-increment:li 10" start="11">In <strong>Request Method</strong>, you can select <strong>GET</strong> or <strong>POST</strong>. If you select POST, you need to define the body format.</li><li>In <strong>Path</strong>, enter the complete path of the metric.</li><li>In <strong>Start and End Time Placeholders</strong>, enter the following:<ol><li>In <strong>Start time placeholder</strong>, enter the start time placeholder in the metric path.</li><li>In <strong>Unit</strong>, select the preferred unit of measurement.</li><li>In <strong>End time placeholder</strong>, enter the end time placeholder in the metric path.</li><li>In <strong>Unit</strong>, select the preferred unit of measurement.</li></ol></li><li>Click <strong>Fetch Records</strong> to retrieve records from the provided URL.</li><li>Click <strong>Metric values and charts</strong>.</li><li>In <strong>Timestamp Format</strong>, enter a static value in dd/mm/yy format.</li><li>Click <strong>Assign</strong>. Select the services for which you want to apply the metric. You can select <strong>Health Score</strong> or <strong>SLI</strong> or both options.</li></ol><div class="note-callout">The subsequent steps depend on the service you select in this step.</div><ol><li style="counter-increment:li 17" start="18">In <strong>Risk Category</strong>, select a risk type. Available options for risk types are:<ul><li>Errors</li><li>Infrastructure</li><li>Performance/Throughput</li><li>Performance/Other</li><li>Performance/Response Time</li></ul></li><li>In <strong>Deviation compared to Baseline</strong>, select one of the options based on the selected risk type. Available options are:<ul><li><strong>Higher value is higher risk</strong> - Select this option if a high value of the selected risk type is a risk.</li><li><strong>Lower value is higher risk</strong> - Select this option if lower value of the selected risk type is a risk.</li></ul></li><li>Click <strong>Submit</strong>.</li></ol><h4>Option: Custom Health Logs</h4><ol><li>If you select Custom Health Logs, the <strong>Customize Health Source</strong> settings appear as:<figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/n67y68fopr/1649658730596/screenshot-2022-04-11-at-12-01-50-pm.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Click <strong>Query specifications and mapping</strong>.</li><li>In <strong>Query Name</strong>, enter a name for the query. For example Custom Log Query.</li><li>In <strong>Request Method</strong>, you can select <strong>GET</strong> or <strong>POST</strong>. If you select POST, you need to define the body format.</li><li>In <strong>Path</strong>, enter the complete path of the metric. For example,<code>v2/logs/events/search</code>.</li><li>In <strong>Start and End Time Placeholders</strong>, enter the following:<ol><li>In <strong>Start time placeholder</strong>, enter the start time placeholder in the metric path. For example, start_time.</li><li>In <strong>Unit</strong>, select the preferred unit of measurement. For example, Milliseconds.</li><li>In <strong>End time placeholder</strong>, enter the end time placeholder in the metric path. For example, end_time.</li><li>In <strong>Unit</strong>, select the preferred unit of measurement. For example, Milliseconds.</li></ol></li><li>In <strong>Body</strong>, enter the request body. For example,<code>{&#34;filter&#34;:{&#34;query&#34;:&#34;,&#34;from&#34;:start_time,&#34;to&#34;:end_time}}</code>.</li><li>Click <strong>Fetch Records</strong> to retrieve records from the provided URL.<figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/n67y68fopr/1650435208583/screenshot-2022-04-19-at-4-25-20-pm.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Once the response is retrieved, click <strong>JSON path selection</strong>.<ol><li>In <strong>Log Message JSON path</strong>, click the plus icon to select the path to the log message from the data source. For example,<code>$.data.[*].attributes.message</code>.</li><li>In <strong>Timestamp Field/Locator JSON</strong> Path, click the plus icon to select the path to the log message from the data source. For example,<code>$.data.[*].attributes.timestamp</code>.</li><li>In <strong>Provide Service Instance to map to Harness Service Instance</strong>, click the plus icon to select the Service instance from the data source. For example,<code>$.data.[*].attributes.tags.[4]</code>.<figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/n67y68fopr/1650436254882/screenshot-2022-04-19-at-4-25-58-pm.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol></li><li>Click <strong>Submit</strong>.</li></ol><h3>Step 7: Select Duration</h3><p>Select how long you want Harness to analyze and monitor the APM data points. Harness waits for 2-3 minutes to allow enough time for the data to be sent to the APM tool before it analyzes the data. This wait time is standard with monitoring tools.</p><div class="note-callout">The recommended <strong>Duration</strong> is <strong>15 min</strong> for APM and infrastructure providers.</div><h3>Step 8: Specify Artifact Tag</h3><p>In <strong>Artifact Tag</strong>, use a <a href="https://newdocs.helpdocs.io/article/lml71vhsim-harness-variables">Harness expression</a> to reference the artifact in the stage Service settings.</p><p>The expression <code>&lt;+serviceConfig.artifacts.primary.tag&gt;</code> refers to the primary artifact.</p><h3>Option: Advanced Settings</h3><p>In <strong>Advanced</strong>, you can select the following options:</p><ul><li><a href="/article/i36ibenkq2-step-skip-condition-settings">Step Skip Condition Settings</a></li><li><a href="/article/htrur23poj-step-failure-strategy-settings">Step Failure Strategy Settings</a></li><li><a href="/article/nnuf8yv13o-select-delegates-with-selectors">Select Delegates with Selectors</a></li></ul><p>See <a href="/article/3xhqq9xllp-verify-deployments-with-the-verify-step#option_advanced_settings">Advanced Settings</a>.</p><h3>Step 9: Deploy and Review Results</h3><p>When you are done setting up the <strong>Verify</strong> step, click <strong>Apply Changes</strong>.</p><p>Now you can run the Pipeline. Click <strong>Run</strong>.</p><p>In <strong>Run Pipeline</strong>, select the tag for the artifact if a tag wasn&#39;t added in the <strong>Artifact Details</strong> settings.</p><p>Click <strong>Run Pipeline</strong>.</p><p>When the Pipeline is running, click the <strong>Verify</strong> step.</p><p>The verification takes a few minutes.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/n67y68fopr/1647496700380/screenshot-2022-03-17-at-11-27-41-am.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h4>Summary</h4><p>The <strong>Summary</strong> section shows the number of metrics and logs that are in violation.</p><h4>Console View</h4><p>Click <strong>Console View</strong> or simply click <strong>View Details</strong> in <strong>Summary</strong> to take a deeper look at <span style="background-color:#ffffff" data-hd-highlight="#ffffff">verification</span>.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/n67y68fopr/1647496735822/screenshot-2022-03-17-at-11-28-00-am.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>If you have more than one Health Source, you can use the <strong>Health Source</strong> dropdown to select each one.</p><p>You can use the search option to search for any specific metric you want.</p>