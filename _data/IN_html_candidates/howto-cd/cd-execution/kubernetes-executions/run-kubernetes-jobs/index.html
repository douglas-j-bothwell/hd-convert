<p>Kubernetes <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/" target="_blank">Jobs</a> create one or more pods to carry out commands. For example, a calculation or a backup operation.</p><p>In a Harness Kubernetes CD stage, you define Jobs in the Service <strong>Manifests</strong>. Next you add the <strong>Apply</strong> step to your Harness Workflow to execute the Job.</p><p>In this topic, we will show you how to execute a Job in a Harness Kubernetes deployment as part of the main deployment.</p><div class="note-callout">Typically, Jobs are not part of the main deployment. You can exclude them from the main deployment and simply call them at any point in the stage using the Apply step. For steps on ignoring the Job as part of the main deployment and executing it separately, see <a href="/article/00el61pzok-deploy-manifests-separately-using-apply-command">Deploy Manifests Separately using Apply Step</a>.</div><p>In this topic:</p><p><a href="#before_you_begin">Before You Begin</a></p><ul><li><a href="#review_apply_step">Review: Apply Step</a></li><li><a href="#step_1_add_job_manifest">Step 1: Add Job Manifest</a></li><li><a href="#step_2_define_target_cluster">Step 2: Define Target Cluster</a></li><li><a href="#step_3_add_the_job_to_the_execution_using_the_apply_step">Step 3: Add the Job to the Execution using the Apply Step</a></li><li><a href="#option_skip_dry_run">Option: Skip Dry Run</a></li><li><a href="#option_skip_steady_state_check">Option: Skip Steady State Check</a></li><li><a href="#step_4_deploy_the_job">Step 4: Deploy the Job</a></li><li><a href="#option_showing_job_output">Option: Showing Job Output</a></li><li><a href="#summary">Summary</a></li></ul><p></p><h3>Before You Begin</h3><ul><li><strong>​Kubernetes Jobs:</strong> We assume you are familiar with <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/" target="_blank">Kubernetes Jobs</a>.</li><li><strong>Apply step:</strong> The Harness Apply step allows you to deploy any resource you have set up in the Service <strong>Manifests</strong> section at any point in your stage. See <a href="/article/00el61pzok-deploy-manifests-separately-using-apply-command">Deploy Manifests Separately using Apply Step</a>.</li><li><strong>Ignoring Manifests:</strong> You can annotate a manifest to have Harness ignore it when performing its main deployment operations. Then you can use the Apply step to execute the manifest wherever you want to run it in the stage. See <a href="/article/jyv7jbr8pg-ignore-a-manifest-file-during-deployment">Ignore a Manifest File During Deployment</a>.</li><li><strong>Delete Jobs before rerunning deployments:</strong> Once you&#39;ve deployed the Job, you must delete it before deploying a Job of the same name to the same namespace.</li></ul><h3>Review: Apply Step</h3><p>CD stages include an <strong>Apply</strong> step that allows you to deploy <em>any resource</em> you have set up in the Service <strong>Manifests</strong> section.</p><p>For details on what you can deploy in different Harness deployment types, see <a href="/article/efnlvytc6l-what-can-i-deploy-in-kubernetes">What Can I Deploy in Kubernetes?</a>.</p><p>The Apply step can deploy <em>all workload types</em>, including Jobs in any deployment type.</p><p>You can add an Apply step anywhere in your Harness stage. This makes the Apply step useful for running Kubernetes Jobs.</p><p>Here are some Job examples:</p><ul><li>Run independent but related work items in parallel: sending emails, rendering frames, transcoding files, or scanning database keys.</li><li>Create a new pod if the first pod fails or is deleted due to a node hardware failure or node reboot. </li><li>Create a Job that cleans up the configuration of an environment, to create a fresh environment for deployment.</li><li>Use a Job to spin down the replica count of a service, to save on cost.</li></ul><div class="note-callout">Any workload deployed with the <strong>Apply</strong> step is not rolled back by Harness.</div><div class="note-callout"><strong>Delete Jobs before rerunning deployments:</strong> Once you&#39;ve deployed the Job, you must delete it before deploying a Job of the same name to the same namespace.</div><h3>Step 1: Add Job Manifest</h3><p>In a CD stage, click Service.</p><p>In <strong>Manifests</strong>, add your manifests as described in <a href="/article/ssbq0xh0hx-define-kubernetes-manifests">Add Kubernetes Manifests</a>.</p><p>Include your Job manifest in the folder you specify in <strong>Manifests</strong>.</p><p>For example, here&#39;s a Manifests section that points to the <strong>templates</strong> folder.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/onwcu7pian/1633040041341/image.png"/></figure><p>In the templates folder, there is a folder named <strong>jobs</strong> and a <strong>job.yaml</strong> manifest.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/onwcu7pian/1633040172250/clean-shot-2021-09-30-at-15-15-41.png"/></figure><h3>Step 2: Define Target Cluster</h3><p>Jobs do not require any changes to the way you specify the target cluster in Harness.</p><p>For steps on setting up the target cluster, see <a href="/article/0ud2ut4vt2-define-your-kubernetes-target-infrastructure">Define Your Kubernetes Target Infrastructure</a>.</p><h3>Step 3: Add the Job to the Execution using the Apply Step</h3><p>The Apply step can be used in any Kubernetes deployment strategy.</p><p>In the stage <strong>Execution</strong>, click <strong>Add Step</strong> wherever you want to deploy you Job.</p><p>In the <strong>Apply Step</strong>, in <strong>File Path</strong>, enter the path to the Job manifest <u>relative</u> to the path entered in the Service <strong>Manifests</strong> section.</p><p>For example, the path in <strong>Manifests</strong> is <code>default-k8s-manifests/Manifests/Files/templates</code> and the Job manifest is in the subfolder of <code>templates</code> named <code>jobs/job.yaml</code>.</p><p>In the <strong>Apply Step</strong>, in <strong>File Path</strong>, enter <code>jobs/job.yaml</code>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/onwcu7pian/1633040598627/clean-shot-2021-09-30-at-15-23-04.png"/></figure><h3>Option: Skip Dry Run</h3><p>By default, Harness uses the <code>--dry-run</code> flag on the kubectl apply command, which prints the object that would be sent to the cluster without really sending it.</p><p>If the <strong>Skip Dry Run</strong> option is selected, Harness will not use the <code>--dry-run</code> flag.</p><h3>Option: Skip Steady State Check</h3><p>If you select this option, Harness will not check that the workload (Job) has reached steady state.</p><h3>Step 4: Deploy the Job</h3><p>In your Pipeline, click <strong>Save</strong>, <strong>Run</strong>, and then <strong>Run Pipeline</strong>.</p><p>Let&#39;s look at the output of the execution.</p><p>In the execution, click the Apply step, and then click <strong>Console View</strong>.</p><p>In <strong>Fetch Files</strong>, you&#39;ll see that Harness successfully fetched the job.yaml:</p><pre>...<br/>Successfully fetched following files:<br/>- configmaps/configmap.yaml<br/>- service.yaml<br/>- jobs/job.yaml<br/>- namespace.yaml<br/>- deployment.yaml<br/>...</pre><p></p><p>In <strong>Initialize</strong>, you can see Harness render the manifest and perform a dry run:</p><pre>Initializing..<br/>Release Name: [release-b6f492c6530a10cd8fd1792890fc42e05641051b]<br/>Found following files to be applied in the state<br/>- jobs/job.yaml<br/><br/>Rendering manifest files using go template<br/>Only manifest files with [.yaml] or [.yml] extension will be processed<br/><br/>Manifests [Post template rendering] :<br/>---<br/>apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/>  name: pi<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>      - name: pi<br/>        image: perl<br/>        command: [&#34;perl&#34;,  &#34;-Mbignum=bpi&#34;, &#34;-wle&#34;, &#34;print bpi(2000)&#34;]<br/>      restartPolicy: Never<br/>  backoffLimit: 4<br/><br/>Validating manifests with Dry Run<br/>kubectl --kubeconfig=config apply --filename=manifests-dry-run.yaml --dry-run<br/>job.batch/pi created (dry run)<br/><br/>Done.</pre><p>In <strong>Prepare</strong>, you can see Harness process the manifest before applying it:</p><pre>Manifests processed. Found following resources: <br/><br/>Kind                Name                                    Versioned <br/>Job                 pi                                      false  </pre><p></p><p>In <strong>Apply</strong>, you can see the <code>kubectl apply</code>:</p><pre>kubectl --kubeconfig=config apply --filename=manifests.yaml --record<br/>job.batch/pi created<br/><br/>Done.</pre><p></p><p>In <strong>Wait for Steady State</strong>, you can see Harness wait for the Job to reach steady state. In Harness, this is a <a href="/article/efnlvytc6l-what-can-i-deploy-in-kubernetes">managed workload</a> because Harness verifies it has reached steady state and fails the Pipeline if it does not.</p><pre>kubectl --kubeconfig=config get events --namespace=default --output=custom-columns=KIND:involvedObject.kind,NAME:.involvedObject.name,NAMESPACE:.involvedObject.namespace,MESSAGE:.message,REASON:.reason --watch-only<br/>kubectl --kubeconfig=config get jobs pi --namespace=default --output=jsonpath=&#39;{.status}&#39;<br/><br/>Status : pi   &#39;map[]&#39;<br/>Event  : pi   Job    pi     default     Created pod: pi-xfshh   SuccessfulCreate<br/>Event  : pi   Pod   pi-xfshh   default   Successfully assigned default/pi-xfshh to gke-doc-account-default-pool-d910b20f-25cj   Scheduled<br/>Event  : pi   Pod   pi-xfshh   default   Pulling image &#34;perl&#34;   Pulling<br/><br/>Status : pi   &#39;map[startTime:2021-09-30T22:51:33Z active:1]&#39;<br/><br/>Status : pi   &#39;map[startTime:2021-09-30T22:51:33Z active:1]&#39;<br/>Event  : pi   Pod   pi-xfshh   default   Successfully pulled image &#34;perl&#34; in 12.344900106s   Pulled<br/><br/>Status : pi   &#39;map[active:1 startTime:2021-09-30T22:51:33Z]&#39;<br/><br/>Status : pi   &#39;map[startTime:2021-09-30T22:51:33Z active:1]&#39;<br/>Event  : pi   Pod   pi-xfshh   default   Created container pi   Created<br/>Event  : pi   Pod   pi-xfshh   default   Started container pi   Started<br/><br/>Status : pi   &#39;map[startTime:2021-09-30T22:51:33Z active:1]&#39;<br/>Event  : pi   Job   pi    default   Job completed   Completed<br/><br/>Status : pi   &#39;map[conditions:[map[type:Complete status:True lastProbeTime:2021-09-30T22:52:04Z lastTransitionTime:2021-09-30T22:52:04Z]] startTime:2021-09-30T22:51:33Z completionTime:2021-09-30T22:52:04Z succeeded:1]&#39;</pre><p></p><h3>Option: Showing Job Output</h3><p>To view Job output after the Apply step, you can use a simple script in a Shell Script step:</p><pre>echo<br/><br/>pods=$(kubectl get pods -n &lt;+infra.kubernetes.namespace&gt; --selector=job-name=my-job --output=jsonpath=&#39;{.items[*].metadata.name}&#39;)<br/><br/>kubectl logs -n &lt;+infra.kubernetes.namespace&gt; $pods<br/><br/>echo</pre><p></p><p>In the case of the Job used in this topic, the output will be π to 2000 places:</p><pre>Console View<br/>Executing command ...<br/>3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275901<br/>Command completed with ExitCode (0)</pre><p></p><p>If you need to show the logs during job execution rather than after the Apply step, then modify the script and run the step in parallel with Apply.</p><p>Alternatively, if you have your cluster logs going to a log service you can generate a URL to that system that shows the job logs in parallel as well.</p><h3>Summary</h3><p>Using the Apply step, you are able to configure, manage, and deploy a Kubernetes Job.</p><p></p><p></p>