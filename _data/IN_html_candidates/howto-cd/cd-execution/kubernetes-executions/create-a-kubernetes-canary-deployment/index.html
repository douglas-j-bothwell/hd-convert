<p>This topic will walk you through creating a Canary deployment in Harness for a Deployment workload.</p><div class="note-callout">Harness Canary and <a href="/article/mog5tnk5pi-create-a-kubernetes-blue-green-deployment">Blue/Green</a> stage steps only support Kubernetes Deployment workloads. The <a href="/article/xsla71qg8t-create-a-kubernetes-rolling-deployment">Rolling Deployment</a> step supports all other workloads except Jobs. The <a href="/article/00el61pzok-deploy-manifests-separately-using-apply-command">Apply step</a> can deploy any workloads or objects.</div><h3>Before You Begin</h3><ul><li><a href="/article/knunou9j30-kubernetes-cd-quickstart">Kubernetes CD Quickstart</a></li><li><a href="/article/ssbq0xh0hx">Add Kubernetes Manifests</a></li><li><a href="/article/0ud2ut4vt2">Define Your Kubernetes Target Infrastructure</a></li></ul><h3>Review: What Workloads Can I Deploy?</h3><p>Stages using Harness Canary and Blue/Green steps only support <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank">Kubernetes Deployment workloads</a>.</p><p>The Rolling Deployment step supports all workloads except Jobs.</p><p>The <a href="/article/00el61pzok">Apply Step</a> can deploy any workloads or objects.</p><p>In Harness, a workload is a Deployment, StatefulSet, or DaemonSet object deployed and managed to steady state.</p><h4>Multiple Managed Workloads</h4><p>With the Rolling Deployment step, you can deploy multiple managed workloads.</p><p>For Canary and Blue/Green steps, only one managed object may be deployed per step by default.</p><p>You can deploy additional objects using the <a href="/article/00el61pzok-deploy-manifests-separately-using-apply-command">Apply Step</a>, but it&#39;s typically used for deploying Jobs controllers.</p><h3>Review: Harness Canary Deployments</h3><div class="note-callout">While you can add multiple steps to a Kubernetes Canary stage, you should simply use the Canary and Primary step groups generated by Harness. Kubernetes deployments have built-in controls for rolling out in a controlled way. The Canary group is a way to test the new build, run your verification, then roll out to the Primary group.</div><p>A Harness Kubernetes Canary deployment is a little different than a typical Canary deployment.</p><p>This is a standard Canary deployment:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620432106415/image.png"/></figure><p>Harness does this a little different:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/325x7awntc/1616629921936/image.png"/></figure><p>In a typical Canary deployment, all nodes in a single environment are incrementally updated in small phases, with each phase requiring a verification/gate to proceed to the next phase.</p><p>This typical method isn&#39;t needed for Kubernetes because Kubernetes includes Rolling Update. Rolling Update is a built-in control for rolling out in a controlled way. It incrementally updates pod instances with new ones. New pods are scheduled on nodes with available resources.</p><p>A Harness Kubernetes Canary deployment uses two phases, a Canary and a Primary Deployment group:</p><ol><li><strong>Group 1:</strong> Harness creates a Canary version of the Kubernetes Deployment object defined in your Service Definition <strong>Manifests</strong> section. Once that Deployment is verified, the Canary Delete step deletes it by default.<br/>Harness provides a Canary group as a way to test the new build, run your verification, then rollout to the following Primary Deployment group.</li><li><strong>Group 2:</strong> run the actual deployment using a Kubernetes Rolling Update with the number of pods you specify in the <strong>Manifests</strong> files (for example, <code>replicas: 3</code>).</li></ol><p>When you add a Canary Strategy to a stage, Harness automatically generates the steps for Canary and Primary Deployment groups.</p><div class="note-callout">If you&#39;re new to Kubernetes RollingUpdate deployments, see <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/" target="_blank">Performing a Rolling Update</a> from Kubernetes. That guide summaries Rolling Update and provides an interactive online tutorial.</div><div class="tip-callout">Although it isn&#39;t covered here, you can also scale your Workloads between the Canary and Rolling steps if you like. You simply add a new Phase and use the Scale step. See <a href="/article/jxe5z9domw-scale-kubernetes-replicas-with-the-scale-command">Scale Kubernetes Pods</a>.</div><h3>Visual Summary</h3><p>Here&#39;s a short video walking through a simple Canary deployment:</p><p></p><div class="hd--embed" data-provider="YouTube" data-thumbnail="https://i.ytimg.com/vi/UL0ie46c9No/hqdefault.jpg"><iframe width="200" height="150" src="https://www.youtube.com/embed/UL0ie46c9No?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>This video uses a publicly available manifest on Kubernetes GitHub account: <code>https://github.com/kubernetes/website/blob/master/content/en/examples/application/nginx-app.yaml</code>.</p><h3>Step 1: Define the Service and Infrastructure</h3><p>Create your CD Pipeline stage.</p><p>To set up your Service and Infrastructure in the stage, follow the steps in these topics:</p><ul><li><a href="/article/ssbq0xh0hx-define-kubernetes-manifests">Add Kubernetes Manifests</a></li><li><a href="/article/0ud2ut4vt2-define-your-kubernetes-target-infrastructure">Define Your Kubernetes Target Infrastructure</a></li></ul><p>Once the Service and Infrastructure are set up, you can add the execution steps.</p><h3>Step 2: Add the Execution Steps</h3><p>In the stage&#39;s <strong>Execution</strong>, click <strong>Add Step</strong>, and select the <strong>Canary</strong> strategy.</p><p>Harness adds all the steps you need to perform the Canary strategy:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620424198706/image.png"/></figure><p>That&#39;s it. Harness will perform the Canary and Rollout steps using your manifests and artifacts.</p><p>Let&#39;s look at the default settings for the Canary Deployment step.</p><h3>Review: Canary Deployment Group</h3><p>Click the <strong>Canary Deployment</strong> step.</p><h4>Canary Deployment Step</h4><p>In this step, you define how many pods are deployed for a Canary test of the configuration files in your Service Definition <strong>Manifests</strong> section.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620428095793/image.png"/></figure><ul><li>If you selected <strong>Instance Count</strong>, this is simply the number of pods.</li><li>If you selected <strong>Percentage</strong>, enter a percentage of the pods defined in your Service Definition <strong>Manifests</strong> files to deploy.</li></ul><p>For example, if you have <code>replicas: 4</code> in a manifest and you enter <strong>50</strong> for <strong>Percentage</strong>, then 2 pods are deployed in this step.</p><p>If you have <code>replicas: 3</code> in a manifest in Service, and you enter <strong>50</strong> for <strong>Percentage</strong>, then Harness rounds up and 2 pods are deployed in this step.</p><div class="note-callout"><strong>Skip Dry Run:</strong> By default, Harness uses the <code>--dry-run</code> flag on the <code>kubectl apply</code> command during the <strong>Initialize</strong> step of this command, which prints the object that would be sent to the cluster without really sending it. If the <strong>Skip Dry Run</strong> option is selected, Harness will not use the <code>--dry-run</code> flag.</div><h4>Canary Delete Step</h4><p>Since the <strong>Canary Deployment</strong> step was successful, it is no longer needed. The <strong>Canary Delete</strong> step is used to clean up the workload deployed by the <strong>Canary Deployment</strong> step. See <a href="/article/922mtcvank-kubernetes-delegate-step">Canary Delete Step</a>.</p><p>For step on deleting other Kubernetes resources, you can use the standard <strong>Delete</strong> step. See <a href="/article/eaj0xuegln-delete-kubernetes-resources">Delete Kubernetes Resources</a>.</p><h3>Review: Primary Deployment Rolling Update</h3><p>The Primary Deployment group runs the actual deployment as a rolling update with the number of pods you specify in the Service Definition <strong>Manifests</strong> files (for example, <code>replicas: 3</code>).</p><p>Click <strong>Rolling Deployment</strong>. For details on its settings, see <a href="/article/2bwlugh9gi-kubernetes-rollout-step">Kubernetes Rollout Step</a>.</p><p>Similar to application-scaling, during a rolling update of a Deployment, the Kubernetes service will load-balance the traffic only to available pods (an instance that is available to the users of the application) during the update.</p><p>Rolling updates allow an update of a Deployment to take place with zero downtime by incrementally updating pod instances with new ones. The new pods are scheduled on nodes with available resources. The rolling update Deployment uses the number of pods you specified in the Service Definition <strong>Manifests</strong> (number of replicas).</p><h3>Example: Canary Deployment</h3><p>Let&#39;s look at how the stage steps deploy the workload.</p><h4 id="canary_deployment_step_in_deployment">Canary Deployment Step in Deployment</h4><p>Let&#39;s look at an example where the <strong>Canary Deployment</strong> step is configured to deploy a <strong>Percentage</strong> of <strong>50</strong>. Here is the step in the Harness <strong>Deployments</strong> page:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620429339429/image.png"/></figure><p>You can see <strong>Percentage</strong> is <strong>2</strong> in <strong>Input</strong>.</p><p>In <strong>Details</strong> you can see the logs for the step.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620429489860/image.png"/></figure><p>Let&#39;s look at the <strong>Prepare</strong>, <strong>Apply</strong>, and <strong>Wait</strong> <strong>for Steady State</strong> sections of the step&#39;s deployment log, with comments added:</p><h5>Prepare</h5><p>Here is the log from the Prepare section:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620429820679/image.png"/></figure><p>The name of the Deployment workload in the Service Definition <strong>Manifests</strong> file is <strong>my-nginx</strong><strong>.</strong></p><p>As you can see, Harness appends the name with <strong>-canary</strong>, <strong>my-nginx-canary</strong>. This is to identify Canary Deployment step workloads in your cluster.</p><p>The next section is <strong>Apply</strong>.</p><h5>Apply</h5><p>Here you will see the manifests in the Service Definition <strong>Manifests</strong> section applied using kubectl as a single file, <strong>manifests.yaml</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620429938655/image.png"/></figure><p>Next, Harness logs the steady state of the pods.</p><h5>Wait for Steady State</h5><p>Harness displays the status of each pod deployed and confirms steady state.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620430281416/image.png"/></figure><h5>Wrap Up</h5><p>The Wrap Up log is long and describes all of the container and pod information for the step, using the kubectl command:</p><pre class="hljs nginx">kubectl --kubeconfig=config describe --filename=manifests.yaml</pre><h4 id="primary_step_in_deployment">Primary Step in Deployment</h4><p>Let&#39;s look at an example where the <strong>Primary Deployment</strong> section deploys the Service Definition <strong>Manifests</strong> objects. Here is the step in the Harness <strong>Deployments</strong> page:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620430353940/image.png"/></figure><p>Before we look at the logs, let&#39;s look at the Service Definition <strong>Manifests</strong> files it&#39;s deploying.</p><p>Here is the Deployment object YAML from our Service <strong>Manifests</strong> section:</p><pre>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: my-nginx<br/>  labels:<br/>    app: nginx<br/>spec:<br/>  replicas: 3<br/>...</pre><p></p><p>Let&#39;s look at the <strong>Initialize</strong>, <strong>Prepare</strong>, and <strong>Apply</strong> stages of the <strong>Rollout Deployment</strong>.</p><h5>Initialize</h5><p>In the <strong>Initialize</strong> section of the <strong>Rollout Deployment</strong> step, you can see the same object descriptions as the Service Definition <strong>Manifests</strong> section:<br/></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620430494980/image.png"/></figure><p>Now that Harness has ensured that manifests can be used, it will process the manifests.</p><h5>Prepare</h5><p>In the <strong>Prepare</strong> section, you can see that Harness versions release (for more information, see <a href="/article/zahb65jgmy-kubernetes-releases-and-versioning">Kubernetes Releases and Versioning</a>).</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620430527037/image.png"/></figure><p>Now Harness can apply the manifests.</p><h5>Apply</h5><p>The Apply section shows the kubectl commands for applying your manifests.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/i5p4feil89/1620430579892/image.png"/></figure><p>Now that the manifests are applied, you can see the container and pod details described in <strong>Wrap Up</strong>.</p><h5>Wrap Up</h5><p>Wrap Up is long and uses a kubectl describe command to provide information on all containers and pods deployed:</p><pre>kubectl --kubeconfig=config get events --namespace=default --output=custom-columns=KIND:involvedObject.kind,NAME:.involvedObject.name,NAMESPACE:.involvedObject.namespace,MESSAGE:.message,REASON:.reason --watch-only</pre><p></p><p>Here is a sample from the output that displays the Kubernetes RollingUpdate:</p><pre class="hljs makefile">kubectl --kubeconfig=config rollout status Deployment/my-nginx --namespace=default --watch=true<br/><br/>Status : my-nginx deployment &#34;my-nginx&#34; successfully rolled out</pre><p></p><p>As you look through the description in <strong>Wrap Up</strong> you can see label added:</p><pre class="hljs cs">add label: harness.io/track=stable </pre><p></p><p>You can use the <code>harness.io/track=stable</code> label with the values <code>canary</code> or <code>stable</code> as a selector for managing traffic to these pods, or for testing the pods. For more information, see  <a href="/article/zahb65jgmy-kubernetes-releases-and-versioning">Kubernetes Releases and Versioning</a>.</p><p>The stage is deployed.</p><p>Now that you have successfully deployed your artifact to your Kubernetes cluster pods using your Harness Pipeline, look at the completed workload in the deployment environment of your Kubernetes cluster.</p><p>Or you can simply connect to your cluster in a terminal and see the pod(s) deployed:</p><pre class="hljs ruby">john_doe@cloudshell:~ (project-15454)$ kubectl get pods<br/>NAME                                                        READY     STATUS    RESTARTS   AGE<br/>my-nginx-7df7559456-xdwg5                 1/1       Running   0          9h</pre><p id="blue_green_workflows_and_deployments"></p><h3>Rollback</h3><p>See <a href="/article/rt449t1xhy-kubernetes-rollback">Kubernetes Rollback</a>.</p><h3>Notes</h3><ul><li>Harness does not roll back Canary deployments because your production is not affected during Canary. Canary catches issues before moving to production. Also, you might want to analyze the Canary deployment. The Canary Delete step is useful to perform cleanup when required.</li></ul><h3>Next Steps</h3><ul><li><a href="/article/xsla71qg8t-create-a-kubernetes-rolling-deployment">Create a Kubernetes Rolling Deployment</a></li><li><a href="/article/mog5tnk5pi-create-a-kubernetes-blue-green-deployment">Create a Kubernetes Blue/Green Deployment</a></li></ul><p></p>