<p>Harness supports OpenShift for Kubernetes deployments. This topic reviews OpenShift support in the Harness Delegate and Pipelines.</p><h3>Review: Kubernetes Delegate and OpenShift</h3><p>OpenShift has very locked down settings by default and so you can either customize the Harness Delegate YAML to make it adhere to a stricter security posture and/or use a non-root Delegate image. You also have the options to loosen restrictions when installing the Delegate.</p><h4>Using a Delegate Outside the Cluster</h4><p>Harness supports OpenShift using a Delegate running externally to the Kubernetes cluster.</p><p>Harness does support running Delegates internally for OpenShift 3.11 or greater, but the cluster must be configured to allow images to run as root inside the container in order to write to the filesystem.</p><p>Typically, OpenShift is supported through an external Delegate installation. The Delegate is installed <u>outside</u> of the target Kubernetes cluster. Next, you create a Kubernetes Cluster Connector, use its <strong>Master URL</strong> and <strong>Service Account Token</strong> settings, and select the external Delegate.</p><p>The following script is a quick method for obtaining the service account token. Run this script wherever you run kubectl to access the cluster.</p><p>Set the <code>SERVICE_ACCOUNT_NAME</code> and <code>NAMESPACE</code> values to the values in your infrastructure.</p><pre class="hljs routeros">SERVICE_ACCOUNT_NAME=default<br/>NAMESPACE=mynamepace<br/>SECRET_NAME=$(kubectl get sa &#34;${SERVICE_ACCOUNT_NAME}&#34; --namespace &#34;${NAMESPACE}&#34; -o json | jq -r &#39;.secrets[].name&#39;)<br/>TOKEN=$(kubectl get secret &#34;${SECRET_NAME}&#34; --namespace &#34;${NAMESPACE}&#34; -o json | jq -r &#39;.data[&#34;token&#34;]&#39; | base64 -D)<br/>echo $TOKEN</pre><p></p><p>Once configured, OpenShift is used by Harness as a typical Kubernetes cluster.</p><h4>Using a Delegate Inside the Cluster</h4><p>Harness supports running Delegates internally in the target cluster for OpenShift 3.11 or greater.</p><p>The cluster must be configured to allow images to run as root inside the container in order to write to the filesystem. You can overcome this requirement using disk permissions.</p><p>For example, you can set the securityContext appropriately in your pod spec of the Delegate where the user and group IDs align with what is specified in the image:</p><pre>...<br/>  securityContext:<br/>    runAsUser: 1000<br/>    runAsGroup: 3000<br/>    fsGroup: 2000<br/>...</pre><p></p><p>In addition, you should use the <strong>non-root-openshift</strong> or <strong>non-root-ubi</strong> Delegate image, available on <a href="https://hub.docker.com/r/harness/delegate/tags" target="_blank">Docker Hub</a>.</p><h3>Review: Deployment Strategy Support</h3><p>In addition to standard workload type support in Harness (see <a href="/article/efnlvytc6l-what-can-i-deploy-in-kubernetes">What Can I Deploy in Kubernetes?</a>), Harness supports <a href="https://docs.openshift.com/container-platform/4.1/applications/deployments/what-deployments-are.html" target="_blank">DeploymentConfig</a>, <a href="https://docs.openshift.com/enterprise/3.0/architecture/core_concepts/routes.html" target="_blank">Route</a>, and <a href="https://docs.openshift.com/enterprise/3.2/architecture/core_concepts/builds_and_image_streams.html#image-streams" target="_blank">ImageStream</a> across Canary, Blue Green, and Rolling deployment strategies.</p><p>Please use <code>apiVersion: apps.openshift.io/v1</code> and not <code>apiVersion: v1</code>.</p><h3>Review: Harness Supports List Objects</h3><p>You can leverage Kubernetes list objects as needed without modifying your YAML for Harness.</p><p>When you deploy, Harness will render the lists and show all the templated and rendered values in the log.</p><p>Harness supports:</p><ul><li>List</li><li>NamespaceList</li><li>ServiceList</li><li>For Kubernetes deployments, these objects are supported for all deployment strategies (Canary, Rolling, Blue/Green).</li><li>For Native Helm, these objects are supported for Rolling deployments.</li></ul><p>If you run <code>kubectl api-resources</code> you should see a list of resources, and <code>kubectl explain</code> will work with any of these.</p><h3>Adding OpenShift Templates</h3><p>OpenShift templates are added in the <strong>Manifests</strong> section of a Deploy Stage Service.</p><details><summary>Add an OpenShift Template</summary><div><p>In your CD stage, click <strong>Service</strong>.</p><p>In <strong>Service Definition</strong>, select <strong>Kubernetes</strong>.</p><p>In <strong>Manifests</strong>, click <strong>Add Manifest</strong>.</p><p>In <strong>Specify Manifest Type</strong>, select <strong>OpenShift Template</strong>, and then click <strong>Continue.</strong></p><p>In <strong>Specify OpenShift Template Store</strong>, select the Git provider where your template is located.</p><p>For example, click <strong>GitHub</strong>, and then select or create a new GitHub Connector. See <a href="https://ngdocs.harness.io/article/zbhehjzsnv-connect-to-code-repo">Connect to Code Repo</a>.</p><p>Click <strong>Continue</strong>. <strong>Manifest Details</strong> appears.</p><p>In <strong>Manifest Identifier</strong>, enter an Id for the manifest. It must be unique. It can be used in Harness expressions to reference this template&#39;s settings.</p><p>For example, if the Pipeline is named <strong>MyPipeline</strong> and <strong>Manifest Identifier</strong> were <strong>myapp</strong>, you could reference the <strong>Branch</strong> setting using this expression:</p><p><code>&lt;+pipeline.stages.MyPipeline.spec.serviceConfig.serviceDefinition.spec.manifests.myapp.spec.store.spec.branch&gt;</code></p><p>In <strong>Git Fetch Type</strong>, select <strong>Latest from Branch</strong> or <strong>Specific Commit Id/Git Tag</strong>, and then enter the branch or commit Id/<a href="https://git-scm.com/book/en/v2/Git-Basics-Tagging" target="_blank">tag</a> for the repo.</p><p>In <strong>Template</strong> <strong>File Path</strong>, enter the path to the template <u>file</u>. The Connector you selected already has the repo name, so you simply need to add the path from the root of the repo to the file.</p><p>Click <strong>Submit</strong>. The template is added to <strong>Manifests</strong>.</p></div></details><h3>OpenShift Param Files</h3><p>OpenShift Param Files are added in the <strong>Manifests</strong> section of a Deploy Stage Service.</p><details><summary>Add an OpenShift Param File</summary><div><p>In your CD stage, click <strong>Service</strong>.</p><p>In <strong>Service Definition</strong>, select <strong>Kubernetes</strong>.</p><p>In <strong>Manifests</strong>, click <strong>Add Manifest</strong>.</p><p>In <strong>Specify Manifest Type</strong>, select <strong>OpenShift Param</strong>, and then click <strong>Continue.</strong></p><p>In <strong>Specify OpenShift Param Store</strong>, select the Git provider where your param file is located.</p><p>For example, click <strong>GitHub</strong>, and then select or create a new GitHub Connector. See <a href="https://ngdocs.harness.io/article/zbhehjzsnv-connect-to-code-repo">Connect to Code Repo</a>.</p><p>Click <strong>Continue</strong>. <strong>Manifest Details</strong> appears.</p><p>In <strong>Manifest Identifier</strong>, enter an Id for the param file. It must be unique. It can be used in Harness expressions to reference this param file&#39;s settings.</p><p>In <strong>Git Fetch Type</strong>, select <strong>Latest from Branch</strong> or <strong>Specific Commit Id/Git Tag</strong>, and then enter the branch or commit Id/<a href="https://git-scm.com/book/en/v2/Git-Basics-Tagging" target="_blank">tag</a> for the repo.</p><p>In <strong>Paths</strong>, enter the path(s) to the param <u>file(s)</u>. The Connector you selected already has the repo name, so you simply need to add the path from the root of the repo to the file.</p><p>Click <strong>Submit</strong>. The template is added to <strong>Manifests</strong>.</p></div></details><h3>Notes</h3><ul><li>Make sure that you update your version to <code>apiVersion: apps.openshift.io/v1</code> and not <code>apiVersion: v1</code>.</li><li>The token does not need to have global read permissions. The token can be scoped to the namespace.</li><li>The Kubernetes containers must be OpenShift-compatible containers. If you are already using OpenShift, then this is already configured. But be aware that OpenShift cannot simply deploy any Kubernetes container. You can get OpenShift images from the following public repos: <a href="https://hub.docker.com/u/openshift" target="_blank">https://hub.docker.com/u/openshift</a> and <a href="https://access.redhat.com/containers" target="_blank">https://access.redhat.com/containers</a>.</li><li>Useful articles for setting up a local OpenShift cluster for testing: <a href="https://computingforgeeks.com/setup-openshift-origin-local-cluster-on-centos/">How To Setup Local OpenShift Origin (OKD) Cluster on CentOS 7</a>, <a href="https://chrisphillips-cminion.github.io/kubernetes/2019/07/08/OpenShift-Redirect.html" target="_blank">OpenShift Console redirects to 127.0.0.1</a>.</li></ul><p></p><p></p>