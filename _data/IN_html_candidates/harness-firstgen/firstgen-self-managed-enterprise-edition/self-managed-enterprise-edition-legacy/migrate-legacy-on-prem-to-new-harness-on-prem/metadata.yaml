type: article
article_id: bh6jeu9ud8
user_id: mfr0nxh4be
category_id: gul20j54zg
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: Migrate Legacy Connected On-Prem to New KOTS-based Harness On-Prem
slug: migrate-legacy-on-prem-to-new-harness-on-prem
description: If you are an existing Harness On-Prem customer using the legacy version
  of On-Prem, this topic will guide you through migrating your data into the new,
  KOTS-based Harness On-Prem. This topic assumes…
short_version: If you are an existing Harness On-Prem customer using the legacy version
  of On-Prem, this topic will guide you through migrating your data into the new,
  KOTS-based Harness On-Prem. This topic assumes…
tags: []
show_toc: true
is_private: false
is_published: false
is_featured: false
stale_status:
  is_stale: false
  reason: ""
  source: API
  triggered_at: 2022-04-25T20:42:46.485916Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Migrate Legacy Connected On-Prem to New KOTS-based Harness On-Prem
  description: ""
  short_version: ""
  body: '<p>If you are an existing Harness On-Prem customer using the legacy version
    of On-Prem, this topic will guide you through migrating your data into the new,
    KOTS-based Harness On-Prem.</p><p>This topic assumes you have already installed
    the new Harness On-Prem version.</p><p>In this topic:</p><ul><li><a href="#before_you_begin">Before
    You Begin</a></li><li><a href="#step_1_mongodump_from_source_on_prem">Step 1:
    Mongodump from Source On-Prem</a></li><li><a href="#step_2_restore_data_on_destination_on_prem">Step
    2: Restore Data on Destination On-Prem</a></li></ul><h3>Before You Begin</h3><p>This
    topic is for migrating data to existing On-Prem installations. If you have not
    installed On-Prem, see <a href="/article/gng086569h-harness-on-premise-versions">Harness
    On-Premise Overview</a>.</p><h3>Step 1: Mongodump from Source On-Prem</h3><p>You
    obtain the source On-Prem data using the <a href="https://docs.mongodb.com/manual/reference/program/mongodump/"
    target="_blank">mongodump</a> utility.</p><p>Let&#39;s look at some example scripts.</p><p>These
    examples must be modified according to the type of installation.</p><p>The <code>MONGO_URI</code>
    value might be different in each installation. This value will be present in either
    the environment variable of the Docker container or in the <strong>harness-manager</strong>
    ConfigMap in the Kubernetes-based installation.</p><p>Here is an example using
    a legacy, 3 Box Docker On-Prem installation.</p><pre>#!/usr/bin/env bash<br/><br/>set
    -e<br/>set -x<br/><br/># Get this information from the environment variable <br/>MONGO_URI=&#34;&lt;MONGO_URI&gt;&#34;<br/><br/><br/>#Get
    mongoDB dump<br/><br/>mongo_uri=$(echo ${MONGO_URI} | sed &#39;s/\\//g&#39;)<br/><br/>mkdir
    -p $destination/$current_date<br/>docker exec -i mongoContainer mongodump --uri=&#34;${mongo_uri}&#34;
    --out /data/db/backup/dump<br/>docker cp -a mongoContainer:/data/db/backup/dump
    $destination/$current_date<br/>cd $destination/$current_date/ &amp;&amp; tar -cvzf
    mongo.tar dump &amp;&amp; cd -<br/>rm -rf $destination/$current_date/dump</pre><p>Here
    is an example using the legacy, Kubernetes-based installation:</p><pre>#!/usr/bin/env
    bash<br/><br/>set -x<br/>set -e<br/><br/>destination=${1:-.}<br/><br/>if [[ -z
    &#34;${2}&#34; ]]; then<br/>  namespace=default<br/>else<br/>  namespace=$2<br/>fi<br/><br/>current_date=$(date
    &#34;+%Y.%m.%d-%H.%M.%S&#34;)<br/><br/>mkdir -p $destination/$current_date/dump<br/><br/>kubectl
    exec -it -n $namespace mongodb-replicaset-chart-0 -- mongodump --uri=&#34;mongodb://admin:CA8FMywpbM@mongodb-replicaset-chart-0.mongodb-replicaset-chart,mongodb-replicaset-chart-1.mongodb-replicaset-chart,mongodb-replicaset-chart-2.mongodb-replicaset-chart:27017/harness?replicaSet=rs0&amp;authSource=admin&#34;
    --out /data/db/backup/dump<br/><br/>kubectl cp -n $namespace mongodb-replicaset-chart-0:/data/db/backup/dump
    $destination/$current_date/dump<br/>#Do not include the admin database to be copied
    over to the target<br/>cd $destination/$current_date/ &amp;&amp; tar -cvzf mongo.tar
    dump &amp;&amp; cd -<br/>rm -rf $destination/$current_date/dump/</pre><p></p><h3>Step
    2: Restore Data on Destination On-Prem</h3><p>Harness includes a restore script
    file in the new, KOTS-based Harness On-Prem. The file is named restore_harness.sh.
    You can get the file using the KOTS admin tool.</p><p>Run the restore script in
    the new KOTS-based Harness On-Prem installation using the output from the mongodump
    utility you ran in the previous step:</p><pre>bash restore_harness.sh dump harness</pre><p></p><p>You
    can open the file to see its script.</p><p></p><p></p>'
  slug: migrate-legacy-on-prem-to-new-harness-on-prem
  tags: []
  is_live: true
