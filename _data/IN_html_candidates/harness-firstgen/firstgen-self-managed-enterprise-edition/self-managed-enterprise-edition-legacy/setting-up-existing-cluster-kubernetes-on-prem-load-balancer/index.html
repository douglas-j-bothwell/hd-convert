<div class="note-callout">Currently, this feature is in development. This topic will be updated until the feature is released to a general audience.</div><p>For Existing Cluster Kubernetes On-Prem, a load balancer is used to access the Harness Manager (UI) using a web browser.</p><p>When you configure Harness in the KOTS admin console, you provide the load balancer URL to use for the connection to the Harness Manager.</p><p>You can set up the Load Balancer for your existing cluster in any way you like. Harness uses the popular Kustomize plugin to manage the load balancer Service for the cluster.</p><p>This topic describes how to set up the load balancer using the Harness kustomization for a new version of Harness.</p><p>In this topic:</p><ul><li> <a href="#using_node_port">Using NodePort?</a></li><li> <a href="#step_1_set_up_static_external_ip">Step 1: Set Up Static External IP</a></li><li> <a href="#step_2_set_up_dns">Step 2: Set Up DNS</a></li><li> <a href="#step_3_install_kots">Step 3: Install KOTS</a></li><li> <a href="#step_4_patch_resource_config_using_overlay">Step 4: Patch Resource Config using Overlay</a></li><li> <a href="#step_5_set_service_type">Step 5: Set Service Type</a><ul><li> <a href="#option_create_load_balancer">Option: Create LoadBalancer</a></li><li> <a href="#option_create_node_port">Option: Create NodePort</a></li></ul></li><li> <a href="#step_6_create_and_deploy_new_version_of_application">Step 6: Create and Deploy New Version of Application</a></li></ul><h3>Using NodePort?</h3><p>If you are creating the load balancer&#39;s Service type using NodePort, create a load balancer that points to any port in range 30000-32767 on the node pool on which the Kubernetes cluster is running.</p><p>You can skip steps 1 and 2 and go directly to <a href="#step_3_install_kots">Step 3: Install KOTS</a>.</p><h3>Step 1: Set Up Static External IP</h3><p>You should have a static IP reserved for the Ingress controller you use to expose Harness outside of the Kubernetes cluster.</p><p>For example, in the GCP console, click <strong>VPC network</strong>, and then click <strong>External IP Addresses</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/voxht9rqkr/1592599157533/image.png"/></figure><p>For more information, see <a href="https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address" target="_blank">Reserving a static external IP address</a>.</p><h3>Step 2: Set Up DNS</h3><p>Set up DNS to resolve the domain name you want to use for Harness On-Prem to the static IP address you reserved in the previous step.</p><p>For example, the domain name <strong>harness.abc.com</strong> would resolve to the static IP:</p><pre>host harness.abc.com<br/>harness.abc.com has address 192.0.2.0</pre><p>The above DNS setup can be tested by running <code>host &lt;domain_name&gt;</code>.</p><h3>Step 3: Install KOTS</h3><p>Point kubectl to the cluster where Harness is deployed.</p><p>Run the following command:</p><pre>kubectl kots download --namespace harness --slug harness</pre><div class="note-callout">This example assumes we are installing Harness in <strong>harness</strong> namespace. Please change the namespace according to your configuration.</div><p>This should download a folder named <strong>harness</strong> in your current directory.</p><h3>Step 4: Patch Resource Config using Overlay</h3><p>In the <strong>harness</strong> folder, open the file <strong>kustomization.yaml</strong>:</p><pre>vi harness/overlays/midstream/kustomization.yaml </pre><p>In the <code>resources</code> section add <code>nginx-service.yaml</code>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/voxht9rqkr/1593536677136/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Save the file.</p><h3>Step 5: Set Service Type</h3><p>In the same folder, midstream, create a new file named <strong>nginx-service.yaml</strong>:</p><pre>vi harness/overlays/midstream/nginx-service.yaml</pre><p>Edit the file using one of the following options.</p><div class="note-callout">Any annotation can be added in <code>metadata.annotations</code>.</div><h4>Option: Create LoadBalancer</h4><p>Edit <strong>nginx-service.yaml</strong> by pasting the following YAML:</p><pre>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: harness-ingress-controller<br/>  namespace: harness<br/>spec:<br/>  type: LoadBalancer<br/>  sessionAffinity: None<br/>  ports:<br/>  - name: http-ingress-controller<br/>    port: 80<br/>    protocol: TCP<br/>    targetPort: 80<br/>  selector:<br/>    app: nginx-ingress<br/>    app.kubernetes.io/component: controller<br/>    release: nginx-ingress-controller-chart</pre><p></p><h4>Option: Create NodePort</h4><p>Edit <strong>nginx-service.yaml</strong> by pasting the following YAML:</p><pre>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-ingress-controller-chart-controller<br/>  annotations: <br/>    harness.io/managed: &#34;true&#34; <br/>    #You can add custom annotations here<br/><br/>spec:<br/>  type: NodePort<br/>  nodePort: &lt;port where your load balancer is pointing to&gt;<br/>  selector:<br/>    app: nginx-ingress<br/>    app.kubernetes.io/component: controller<br/>    release: nginx-ingress-controller-chart</pre><p></p><h4>Review: Delete and Recreate the Manager Pods</h4><p>If you running this setup after you have already installed Harness, you need to delete the Harness Manager pods. Kubernetes will recreate them automatically.</p><p>Find the name of Harness manager pods:</p><p><code>kubectl get pods -o=name -n harness | grep harness-manager</code></p><p>The output will be something like this:</p><pre>pod/harness-manager-79fdf979f7-5gpfj<br/>pod/harness-manager-79fdf979f7-l7fcc</pre><p>You can also find these in your cloud platform&#39;s console:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/voxht9rqkr/1593538400359/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>In the following command, replace <code>&lt;pod_name&gt;</code> with each pod name and run the command:</p><p><code>kubectl delete pod &lt;pod_name&gt; &lt;pod_name&gt; -n harness</code></p><p>For example:</p><p><code>kubectl delete pod harness-manager-79fdf979f7-5gpfj harness-manager-79fdf979f7-l7fcc -n harness</code></p><h3>Step 6: Create and Deploy New Version of Application</h3><p>Run the following command to upload the Kubernetes manifests from the local filesystem to create a new version of the application:</p><pre>kubectl kots upload --namespace harness --slug harness ./harness<br/> • Uploading local application to Admin Console ✓</pre><p>Once the upload is complete, go to <code>http://localhost:8800/app/harness/version-history</code>.</p><p>You should see a new version.</p><p>Using the KOTS admin tool, check the diff and deploy the new version.</p><p>Open <code>https://&lt;LB_IP_Address&gt;/#/onprem-signup</code> in your browser. The Harness Manager UI loads.</p><p></p><p></p><p></p>