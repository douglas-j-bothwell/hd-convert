<p>This document describes the Disaster Recovery strategy for Harness <a href="/article/vf4cy95mst-harness-connected-on-premise-setup">Docker Connected On-Prem using a 3 node architecture</a>.</p><p>In this topic:</p><ul><li> <a href="#harness_docker_connected_on_prem_architecture">Harness Docker Connected On-Prem Architecture</a></li><li> <a href="#recovery_option_1_3_data_centers_active_active_strategy">Recovery Option 1: 3 Data Centers (Active/Active Strategy)</a><ul><li> <a href="#infrastructure_requirements">Infrastructure Requirements </a></li><li> <a href="#network_requirements">Network Requirements </a></li><li> <a href="#failure_tolerance">Failure Tolerance </a></li><li> <a href="#recovery_options">Recovery Options</a></li><li> <a href="#data_loss">Data Loss</a></li></ul></li><li> <a href="#recover_option_2_2_data_centers_active_passive_strategy">Recover Option 2: 2 Data Centers (Active/Passive Strategy)</a><ul><li> <a href="#infrastructure_requirements_2">Infrastructure Requirements</a></li><li> <a href="#failure_tolerance_2">Failure Tolerance </a></li><li> <a href="#recovery_scenarios">Recovery Scenarios</a><ul><li> <a href="#individual_node_failure">Individual Node Failure</a></li><li> <a href="#planned_migration_to_another_dc">Planned Migration to Another DC</a></li><li> <a href="#recovery_for_dc_failure">Recovery for DC Failure</a></li><li> <a href="#data_loss_2">Data Loss</a></li></ul></li></ul></li><li> <a href="#conclusion">Conclusion</a></li></ul><h3>Harness Docker Connected On-Prem Architecture</h3><p>Here is the high-level architecture of the Harness Docker Connected On-Prem (3 Node Architecture).</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9khk7u1c3x/1587596878170/image.png"/></figure><p></p><ul><li>All Harness microservices are running on every node. </li><li>Some of the hHarness microservices are stateful and share state across nodes while others are stateless. </li><li><ul><li>With 3 nodes, every microservice is running in a HA configuration. </li><li>The system is resilient to up to 2 failures per microservice in either of the 2 nodes. </li><li>The system can function without any service interruption up to 1 node failure. </li></ul></li><li>In addition to the HA for this On-Premise setup, we can also achieve a Disaster Recovery setup in case of a data center (DC) failure.</li></ul><h3>Recovery Option 1: 3 Data Centers (Active/Active Strategy)</h3><p>This section describes Disaster Recovery options for the Harness <a href="https://docs.harness.io/article/vf4cy95mst-harness-connected-on-premise-setup">Docker Connected On-Prem</a> (3 Node Architecture).</p><p>This option uses the following architecture:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9khk7u1c3x/1587600433465/image.png"/></figure><p>The requirements below are in addition to the basic infrastructure and network requirements specified in <a href="/article/vf4cy95mst-harness-connected-on-premise-setup">Docker Connected On-Prem Setup</a>.</p><h4>Infrastructure Requirements </h4><ul><li>3 separate DCs with network connectivity between them.</li><li>1 VM in every DC.</li><li>Harness Ambassador should be running on the node in the primary DC.</li><li>Global Server Load Balancing (GSLB)/Load Balancer that can connect to each node in the 3 DCs.</li></ul><h4>Network Requirements </h4><ul><li>MUST have low network latency among 3 DCs.</li><li>Harness Ambassador should have SSH-based connectivity to the other 2 nodes in the other 2 DCs.</li></ul><h4>Failure Tolerance </h4><p>This setup can tolerate: </p><ul><li>Any microservice failure on up to 2 nodes.</li><li>Any 1 node failure (complete AZ/DC failure). </li></ul><h4>Recovery Options</h4><p>When the DCs recover, there are 2 options to recover the Harness setup.</p><ul><li>Contact Harness Support — Harness Support will restart the microservices on each box using the Harness Ambassador, and restore the setup. If the primary DC has recovered, you will have to restart the Harness Ambassador for Harness Support to help bring up the setup. </li></ul><p>Start/Stop Scripts — Use the local start/stop scripts on the Harness Ambassador to bring up Harness on the 3 boxes. See <a href="/article/prry6nu01y-docker-connected-start-stop">Docker Connected Start/Stop Scripts</a>.</p><h4>Data Loss</h4><p>This setup prevents data loss up to a 2 node failure. The system will resume from where it last left off before the failure.</p><p>For all 3 node failures, data loss will be based on the cadence of the data backup that was set up.</p><h3>Recover Option 2: 2 Data Centers (Active/Passive Strategy)</h3><p>In case the infrastructure or network requirements specified in the 3 DC-based architecture are not available, Harness can support an active/passive Disaster Recovery setup.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9khk7u1c3x/1620840140704/plf-xgz-x-25-kf-d-ieo-qayrm-1-shzr-qp-4-kb-u-1-q-ekdw-w-0-u-97-pz-fna-uw-nsfn-tbok-qxnrq-dquts-0-l-8-vz-72-sr-zs-fedal-vr-fn-4-j-8-azc-wl-3-y-cix-ckryu-xos-bh-gwmrebmv-6-l-zj-7-c-vc-frn"/></figure><p>The requirements below are in addition to the basic infrastructure and network requirements specified in <a href="/article/vf4cy95mst-harness-connected-on-premise-setup">Docker Connected On-Prem Setup</a>.</p><h4>Infrastructure Requirements</h4><ul><li>2 separate data centers (DCs) with 3 nodes in each DC.</li><li>Harness Ambassador should be running on 1 node in each DC.</li><li>Backup storage set up in a third location that has to be configured as per <a href="/article/dvl3hzjuhw-harness-docker-connected-on-prem-backup-strategy">Connected On-Prem Backup and Restore Strategy</a>. Both full and incremental backups are recommended. </li><li>GSLB/Load Balancer that can connect to each node in the 2 DCs.</li></ul><h4>Failure Tolerance </h4><p>This setup can tolerate the following: </p><ul><li>Any node failure within a DC.</li><li>Any 1 DC failure.</li></ul><h4>Recovery Scenarios</h4><p>This section describes common recovery scenarios.</p><h5>Individual Node Failure</h5><p>This setup can tolerate 1 node failure in the primary DC.</p><p>For 2 node failure in the primary DC, the system will become inoperative.</p><p>The recovery strategy mentioned in this scenario is the same as in the 3 DC architecture.</p><p>There are 2 options to recover the Harness setup:</p><ul><li>When restarting microservices on any particular node, use the following steps:<br/>a) <a href="https://docs.docker.com/config/daemon/#check-whether-docker-is-running">Ensure Docker daemon is running on the box</a>.  <ul><li>Run the following scripts, located in the <strong>$HOME/harness-scripts</strong> folder on the node:<br/><code>$ bash run_mongo.sh</code><br/><code>$ bash start_harness.sh </code></li></ul></li><li>When restarting microservices on all boxes, use the following steps:<ul><li> <a href="https://docs.docker.com/config/daemon/#check-whether-docker-is-running">Ensure Docker daemon is running on the box</a>.</li><li>Run the following script in the harness-ambassador-scripts folder, located at <strong>$HOME/harness-ambassador-scripts/&lt;CUSTOMER-NAME&gt;</strong> on the Ambassador node:<br/><code>bash start_harness.sh </code></li></ul></li></ul><p>See <a href="/article/prry6nu01y-docker-connected-start-stop">Docker Connected Start/Stop Scripts</a>.</p><h5>Planned Migration to Another DC</h5><ol><li>For a planned crossover to another data center, full backup is the preferred option to migrate the setup.</li><li>Please create the backup using the system&#39;s backup instructions.</li><li>Next, gracefully shut down the system by running the following script in the harness-<strong>ambassador-scripts</strong> folder, located at <strong>$HOME/harness-ambassador-scripts/&lt;CUSTOMER-NAME&gt;</strong> on the Ambassador node:<br/><code>bash stop_harness.sh</code><br/>See <a href="/article/prry6nu01y-docker-connected-start-stop">Docker Connected Start/Stop Scripts</a>.</li><li>Restore on the target system using the restore steps described in <a href="/article/dvl3hzjuhw-harness-docker-connected-on-prem-backup-strategy">Connected On-Prem Backup and Restore Strategy</a>.</li><li>Restart the system using the start/stop scripts.</li><li>Reconfigure the GSLB to point to the 3 nodes in DC2.</li></ol><p></p><h5>Recovery for DC Failure</h5><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9khk7u1c3x/1620840141141/ofiw-6-x-tgsw-ol-nca-tx-2-ij-1-lvs-6-k-y-ziz-3-c-6-d-7-ds-tss-ptippa-pg-7-s-1-ku-6-zof-uz-qiyrxcne-uxd-qa-7-i-8-l-5-r-uzrq-w-6-rgu-9-o-hkg-foxm-cc-9-ule-fpmiak-npv-2-p-gy-6-lfv-a-7-xc-chbqlye-jhv-s-1"/></figure><p>For primary DC failure, you need to perform the following steps to bring back the system:</p><ol><li>Copy the backup files onto the specified directory locations on the primary node in DC2.</li><li>Follow the restore steps mentioned in <a href="/article/dvl3hzjuhw-harness-docker-connected-on-prem-backup-strategy">Connected On-Prem Backup and Restore Strategy</a>.</li><li>Restart the system using the start/stop scripts described in <a href="/article/prry6nu01y-docker-connected-start-stop">Docker Connected Start/Stop Scripts</a>.</li><li>Reconfigure the GSLB to point to the 3 nodes in DC2.</li></ol><p></p><h5>Data Loss</h5><p>The maximum data loss depends on the backup strategy. If backup strategy has been configured to be taken every 3 hours, maximum data loss will be for 3 hours.</p><h3>Conclusion</h3><p>All of the options mentioned above achieve Disaster Recovery for the Harness Docker Connected On-Prem.</p><p>Active/Active Disaster Recovery strategy is always preferred over an Active/Passive strategy. </p><p>For achieving HA across data centers, Harness recommends <a href="#recovery_option_1_3_data_centers_active_active_strategy">Recovery Option 1: 3 Data Centers (Active/Active Strategy)</a>.</p><p>For this method, it is important to note that there is a stringent requirement of low latency among data centers.</p><p></p><p></p>