type: article
article_id: wfk9o0tsjb
user_id: mfr0nxh4be
category_id: f6rh2cdvx9
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: AWS AMI Quickstart
slug: aws-ami-deployments
description: Use existing AMIs and ASGs to deploy new ASGs and instances to EC2 via
  Harness.
short_version: Use existing AMIs and ASGs to deploy new ASGs and instances to EC2
  via Harness.
tags:
- AMI
- ASG
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: ""
  source: API
  triggered_at: 2022-07-06T17:18:49.88464Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: AWS AMI Quickstart
  description: Use existing AMIs and ASGs to deploy new ASGs and instances to EC2
    via Harness.
  short_version: Use existing AMIs and ASGs to deploy new ASGs and instances to EC2
    via Harness.
  body: '<p>This quickstart shows you how to use existing Amazon Machine Images (AMIs)
    and AWS Auto Scaling Groups (ASGs) to deploy new ASGs and instances to Amazon
    Elastic Compute Cloud (EC2) via Harness.</p><h3>Objectives</h3><p>You&#39;ll learn
    how to:</p><ul><li>Set up the AWS IAM and EC2 for the Harness Shell Script Delegate.</li><li>Install
    the Harness Shell Script Delegate.</li><li>Connect Harness with AWS.</li><li>Specify
    the AMIs to use for your new instances.</li><li>Specify the ASG to use as a template
    for new ASGs.</li><li>Set the number of instances to deploy.</li><li>Create and
    deploy an AMI Basic Workflow.</li></ul><p></p><h3>Before You Begin</h3><ul><li>Review
    <a href="/article/4o7oqwih6h-harness-key-concepts">Harness Key Concepts</a> to
    establish a general understanding of Harness.</li><li><strong>AWS IAM role</strong>
    — Create an AWS IAM role that has the <strong>AmazonEC2FullAccess</strong> policy.
    You will apply this role to the EC2 instance you use to host the Harness Shell
    Script Delegate. This policy gives the Delegate access to the AWS EC2 API.<br/>See
    <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-iam.html#creating-an-iam-group"
    target="_blank">Creating an IAM Group and Users</a> and <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_ec2_region.html"
    target="_blank">Amazon EC2: Allows Full EC2 Access Within a Specific Region, Programmatically
    and in the Console</a> from AWS.</li><li>Attach this IAM role to the EC2 instance
    you create for the Harness Delegate next.</li><li><strong>EC2 Instance for Harness
    Shell Script Delegate</strong> — The EC2 instance for the Harness Delegate must
    meet the following requirements:<ul><li>Linux/UNIX server.</li><li>​Minimum 1
    CPU.</li><li>Minimum 8GB RAM. For example, an AWS EC2 instance type such as m5a.xlarge
    has 16GB of RAM, 8 for the Delegate and 8 for the remaining operations.</li><li>Minimum
    6GB Disk space.</li><li>Create the EC2 Instance in the target region, VPC, and
    subnet.</li></ul></li><li><strong>AMI and Base ASG</strong> — Pick an existing
    AMI and ASG for Harness to use when creating new instances and ASGs. Harness will
    use the existing ASG as a template, but it will not resize it all.</li><li><strong>Tag
    your AMI</strong> — Tag the existing AMI you picked with <strong>Name: AMI-Tutorial</strong>.
    You will use this tag to select the AMI in Harness. You can also enter the AMI
    ID in Harness if you don&#39;t want to tag the instance.</li></ul><h3>Visual Summary</h3><p>The
    following diagram shows the very simple topology for this tutorial:</p><p></p><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580412806715/image.png"/></figure><p>You
    will install the Harness Shell Script Delegate on an EC2 instance in your AWS
    account, select an AMI for creating instances, a base ASG for creating a new ASG,
    and then deploy the number of new instances you need.</p><h3 id="step_2_install_and_launch_the_ecs_delegate">Step
    1: Install and Launch the Shell Script Delegate</h3><p>First we&#39;ll install
    the Harness Shell Script Delegate on the EC2 instance you set up with the IAM
    role you created for Harness AMI deployments.</p><p>Install the Delegate in the
    same subnet as your base Auto Scaling Group, using the same security group and
    the same key pair.</p><p>To install the Delegate on your EC2 instance:</p><ol><li>Sign
    into the Harness Manager.</li><li>Click <strong>Setup</strong>, and then click
    <strong>Harness Delegates</strong>.</li><li>Click <strong>Download Delegate</strong>,
    and then click <strong>Shell Script</strong>.</li><li>Enter a name for the Delegate,
    and select the <strong>Primary</strong> Profile.</li><li>Click <strong>Copy Download
    Link</strong>.<br/><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/wfk9o0tsjb/1589494626430/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Log
    into your EC2 instance, paste the Shell Script Delegate command, and hit <strong>Enter</strong>.</li><li>Once
    the Delegate is downloaded, unzip it (<code>tar -zxvf harness-delegate.tar.gz</code>),
    change directories into the <strong>harness-delegate</strong> folder and run the
    start command: <code>./start.sh</code>. Ignore any warning about the ulimit.</li></ol><p>The
    Delegate will start and in a few moments you will see it listed in the <strong>Harness
    Delegates</strong> page.</p><p><strong>Delegate Selectors</strong> — Add a Delegate
    Selector to the Delegate so you can use this Delegate when you create a Harness
    AWS Cloud Provider. This will ensure the IAM role applied to the Delegate is used
    by your AWS Cloud Provider.</p><ol><li>In the Delegate listing on the <strong>Harness
    Delegates</strong> page, click <strong>Edit</strong> next to <strong>Selectors</strong>.</li><li>Type
    in <strong>AWS-Tutorial</strong>, press <strong>Enter</strong>, and then click
    <strong>Submit</strong>. The Selector is added to the Delegate.</li></ol><h3 id="step_3_add_a_aws_cloud_provider">Step
    2: Add a AWS Cloud Provider</h3><p>In this section, we will add a Harness AWS
    Cloud Provider to your Harness account to connect to AWS EC2.</p><div class="tip-callout">As
    Harness provides first-class support for <a href="/article/q6ti811nck-cloud-watch-verification-overview">CloudWatch</a>,
    you can also use the same AWS Cloud Provider for your CloudWatch connection.</div><p
    id="permissions"><strong>Permissions:</strong> The AWS Cloud Provider will assume
    the IAM Role associated with the Delegate you installed in your VPC.</p><ol><li>In
    the Harness Manager, click <strong>Setup</strong>, and then click <strong>Cloud
    Providers</strong>.</li><li>Click <strong>Add Cloud Provider</strong>. The <strong>Cloud
    Provider</strong> dialog appears. Enter the following settings:</li></ol><p></p><table><tbody><tr><td><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/wfk9o0tsjb/1585931602288/image.png"/></figure></td><td><ul><li><strong>Type:</strong>
    Select <strong>Amazon Web Services</strong>.</li><li><strong>Display Name:</strong>
    Enter <strong>AWS-Tutorial</strong>.</li><li><strong>Credentials:</strong> Select
    <strong>Assume IAM Role on Delegate</strong>.</li><li><strong>Delegate Selector:</strong>
    Select the Delegate Selector you added to your Delegate, <strong>AWS-Tutorial</strong>.</li></ul></td></tr></tbody></table><ol><li
    style="counter-increment:li 2" start="3">Click <strong>Test</strong> and then
    <strong>Submit</strong>.</li></ol><p>Now that the hard part is done, you can quickly
    set up your AMI deployment in just a few minutes.</p><h3 id="step_5_add_your_artifact_and_ecs_specs">Step
    3: Add Your AMI and User Data</h3><p>Next we&#39;ll add the AMI to use when creating
    you new instances. We&#39;ll start by creating a Harness Application.</p><p>An
    Application in Harness represents a logical group of one or more entities, including
    Services, Environments, Workflows, Pipelines, Triggers, and Infrastructure Provisioners.
    Applications organize all of the entities and configurations in Harness CD. For
    more information, see <a href="/article/4o7oqwih6h-harness-key-concepts">Harness
    Key Concepts</a>.</p><ol><li>In Harness, click <strong>Setup</strong>, and then
    click <strong>Add Application</strong>. The Application settings appear.</li><li>Enter
    the name <strong>AMI-Tutorial</strong> and click <strong>Submit</strong>. The
    new Application is added.</li><li>In your new Application, click <strong>Services</strong>.
    The <strong>Services</strong> page appears.</li><li>In the <strong>Services</strong> page,
    click <strong>Add Service</strong>. The <strong>Add</strong> <strong>Service</strong> settings
    appear. Enter the following settings and then click <strong>Submit</strong>:</li></ol><p></p><div
    class="hd--html"><table class="table table-responsive" border="0" bordercolor="#eee"><tbody><tr><td
    width="60%"><figure><a class="lightbox" href="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580423288601/image.png"><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580423288601/image.png"/></a></figure></td><td><ul><li><strong>Name:</strong>
    Enter <strong>AMI Tutorial</strong>.</li><li><strong>Deployment Type:</strong>
    Select <strong>Amazon Machine Image</strong>.</li></ul></td></tr></tbody></table></div><p>The
    new Service is listed.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580425228036/image.png"/></figure><p>Next,
    we&#39;ll select the AMI to use when creating your instances.</p><ol><li>From
    the <strong>Service Overview</strong> section, click <strong>Add Artifact Source</strong>,
    then click <strong>Amazon AMI</strong>.</li><li>In <strong>Artifact Source</strong>,
    enter the following settings and click <strong>Submit</strong>.</li></ol><p></p><table><tbody><tr><td><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580424653761/image.png"/></figure></td><td><ul><li><strong>Cloud
    Provider:</strong> Select the AWS Cloud Provider you added earlier, <strong>AWS-Tutorial</strong>.</li><li><strong>Region:</strong>
    Select the AWS region where your AMI is located.</li><li><strong>AWS Tags:</strong>
    Add the tag that is used by your AMI, such as <strong>Name: AMI-Tutorial</strong>.</li></ul><p></p><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580424805950/image.png"/></figure></td></tr></tbody></table><p></p><p>Optionally,
    in <strong>AmiResource Filters</strong>, you can add AMI ID filters to locate
    the AMI resource. These are key/value pairs that prepend <code>ami‑image:</code> to
    the AMI ID. For example: <code>ami‑image:ami‑0981c1b27d2d4f749</code>.</p><p></p><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580426255931/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>In
    the Service&#39;s <strong>Deployment Specification</strong> section, you can select
    the <strong>User Data</strong> link to enter configuration scripts and directives
    that your AWS instance will run upon launch.</p><p>The resulting <strong>User
    Data</strong> container corresponds to the AWS Launch Instance wizard&#39;s <strong>Advanced Details</strong> &gt; <strong>User
    data</strong> container.</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/rd6ghl00va/1559281150871/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/rd6ghl00va/1559281150871/image.png"/></a></figure><p>You
    can enter the same shell scripts and cloud-init directives that AWS will accept
    through its own UI. For details about scripting requirements, formatting, and
    options, see Amazon&#39;s EC2 <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html#user-data-shell-scripts">User Data
    and Shell Scripts</a> documentation. When Harness creates a new instance, it will
    apply your defined User Data.</p><p>For this tutorial we&#39;ll skip <strong>User
    Data</strong>.</p><p>Next, you can select the base ASG to use when Harness creates
    a new ASG for your new AMI instances.</p><h3 id="step_6_define_your_target_ecs_cluster">Step
    4: Select the Base ASG</h3><p>Now that we&#39;ve added an AMI Service to your
    Application, we&#39;ll define an Environment where your AMI instances will be
    deployed. </p><p>In an Environment, you specify the base AWS Auto Scaling Group
    (ASG) as an Infrastructure Definition. Harness will use the existing ASG as a
    template, but it will not resize it all.</p><ol><li>Use the breadcrumb navigation
    to jump to <strong>Environments</strong>.<figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580426544002/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Click
    <strong>Add Environment</strong>. The <strong>Environment</strong> settings appear.
    Enter the following settings and click <strong>Submit</strong>:</li></ol><p></p><div
    class="hd--html"><table class="table table-responsive" border="0" bordercolor="#eee"><tbody><tr><td
    width="60%"><figure><a class="lightbox" href="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580426629296/image.png"><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580426629296/image.png"/></a></figure></td><td><ul><li><strong>Name:</strong>
    Enter <strong>AMI Tutorial</strong>.</li><li><strong>Environment Type:</strong>
    Select <strong>Non-Production</strong>.</li></ul></td></tr></tbody></table></div><p>One
    you click <strong>Submit</strong>, the new Environment page appears. Next we will
    add an Infrastructure Definition to identify the related ASG information.</p><p>An <a
    href="https://docs.harness.io/article/n39w05njjv-environment-configuration#add_an_infrastructure_definition">Infrastructure
    Definition</a> for an AMI deployment specifies the base ASG for deployments, as
    well as options such as Target Groups and Load Balancers.</p><p>When you create
    the Harness Workflow later, you will pick this Infrastructure Definition to use
    for deployment.</p><ol><li>Click <strong>Add Infrastructure Definition</strong>.
    The <strong>Infrastructure Definition</strong> dialog appears. Enter the following
    settings and click <strong>Submit</strong>:</li></ol><div class="hd--html"><table
    class="table table-responsive" border="0" bordercolor="#eee"><tbody><tr><td width="60%"><figure><a
    class="lightbox" href="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580427424011/image.png"><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580427424011/image.png"/></a></figure></td><td><ul><li><strong>Name:</strong>
    Enter <strong>AMI Tutorial</strong>.</li><li><strong>Cloud Provider Type:</strong>
    Select <strong>Amazon Web Services</strong>.</li><li><strong>Deployment Type:</strong>
    Select <strong>Amazon Machine Image</strong>.</li><li>Select the <strong>Use Already
    Provisioned Infrastructure</strong> setting.</li><li><strong>Cloud Provider:</strong>
    Select the Cloud Provider you added earlier, <strong>AMI-Tutorial</strong>.</li><li><strong>Region:</strong>
    Select the region where you base ASG is located.</li><li><strong>Auto Scaling
    Group:</strong> Select your base ASG, such as <strong>AMI-Tutorial</strong>.</li></ul><p>You
    can leave the rest of the settings.</p></td></tr></tbody></table></div><p>This
    is the last required step to set up the deployment Environment in Harness. With
    both the Service and Environment set up, you can now proceed to creating a deployment
    Workflow.</p><h3 id="step_7_build_a_canary_deployment">Step 5: Build an AMI Basic
    Deployment</h3><p>This section walks you through creating an AMI Basic Workflow
    in Harness. By default, Harness AMI Basic Workflows have two default deployment
    steps:</p><ul><li><strong>​Setup AutoScaling Group</strong> — Specify how many
    instances to launch, their resizing order, and their steady state timeout.</li><li><strong>​Deploy
    Service</strong> — Specify the number/percentage of instances to deploy within
    the ASG you&#39;ve deploying.</li></ul><ol><li>Use the breadcrumb navigation to
    jump to <strong>Workflows</strong>, and then click <strong>Add Workflow</strong>.
    The Workflow settings appear. Enter the following settings and click <strong>Submit</strong>.</li></ol><p></p><table><tbody><tr><td><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580429018235/image.png"/></figure></td><td><ul><li><strong>Name:</strong>
    Enter <strong>AMI Tutorial</strong>.</li><li><strong>Workflow Type:</strong> Select
    <strong>Basic Deployment</strong>.</li><li><strong>Environment:</strong> Select
    the Environment you created, <strong>AMI Tutorial</strong>.</li><li><strong>Service:</strong>
    Select the Service you created, <strong>AMI Tutorial</strong>.</li><li><strong>Infrastructure
    Definition:</strong> Select the Infrastructure Definition you created, <strong>AMI
    Tutorial</strong>.</li></ul></td></tr></tbody></table><p>The new Basic Workflow
    appears with the pre-configured steps.</p><ol><li style="counter-increment:li
    1" start="2">Click the <strong>AWS AutoScaling Group Setup</strong> step. This
    step configures the defaults for the new ASG. Enter the following settings and
    click <strong>Submit</strong>.</li></ol><p></p><table><tbody><tr><td><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580429829847/image.png"/></figure></td><td><ul><li><strong>Auto
    Scaling Group Name:</strong> Enter <strong>My-AMI-Tutorial</strong>.</li><li><strong>Instances:</strong>
    Select <strong>Fixed</strong>.</li><li><strong>Max Instances:</strong> Enter <strong>6</strong>.</li><li><strong>Min
    Instances:</strong> Enter <strong>1</strong>.</li><li><strong>Desired Instances:</strong>
    Enter <strong>1</strong>.</li></ul><p>You can leave the rest of the settings.</p></td></tr></tbody></table><ol><li>Click
    <strong>Upgrade AutoScaling Group</strong>. This step defines the number of instances
    to deploy in the new ASG, as either a count or percentage. Enter the following
    settings and click <strong>Submit</strong>.</li></ol><p></p><table><tbody><tr><td><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580430416425/image.png"/></figure></td><td><ul><li><strong>Desired
    Instances:</strong> Enter <strong>2</strong>.</li><li><strong>Instance Unit Type:</strong>
    Leave the default, <strong>Count</strong>.</li></ul></td></tr></tbody></table><div
    class="note-callout">The <strong>Desired Instances</strong> value in the <strong>AWS
    AutoScaling Group Setup</strong> step is used when calculating percentages in
    the <strong>Desired Instances</strong> field here in <strong>Upgrade AutoScaling
    Group</strong>. For example, if <strong>Desired Instances</strong> in the <strong>AWS
    AutoScaling Group Setup</strong> is 4 and you set <strong>Desired instances</strong> here
    to 25%, then it will deploy 1 instance.</div><p>Your AMI Basic Workflow is complete.
    You can run the Workflow to deploy the new instances to the new ASG.</p><div class="note-callout"><strong>What
    happens to the old ASG instances?</strong> Every new AMI/ASG deployment creates
    a new ASG. The instances in ASGs used by previous deployments are downsized to
    a max count of 3. Additional instances are detached.</div><h3 id="step_8_deploy_and_review">Step
    6: Deploy and Review</h3><p>Now that the Basic Workflow for AMI is set up, you
    can click Deploy in the Workflow to deploy it.</p><ol><li>Click the <strong>Deploy</strong>
    button. The Deploy settings appear. Enter the following settings:</li></ol><p></p><div
    class="hd--html"><table class="table table-responsive" border="0" bordercolor="#eee"><tbody><tr><td
    width="60%"><p></p><figure><a class="lightbox" href="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580430758372/image.png"><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580430758372/image.png"/></a></figure></td><td><ul><li><strong>Artifacts
    &gt; AMI Tutorial:</strong> Select <strong>Image: AMI-Tutorial</strong>.</li><li><strong>Send
    notification to me only:</strong> Enable this setting if you are doing this tutorial
    using your corporate Harness account. Enabling this setting will ensure that other
    users won&#39;t be notified on this deployment.</li></ul></td></tr></tbody></table></div><p></p><ol><li
    style="counter-increment:li 1" start="2">Click <strong>Submit</strong>. The deployment
    executes.</li></ol><p>Here&#39;s a example of what the deployment looks like typically:</p><p></p><figure><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580448204178/ami-tutorial.gif"/></figure><p>To
    see the completed deployment, log into your AWS EC2 console. The base ASG, new
    ASG, and new instances are listed:</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/k02sp0blo3/1580432556672/image.png"/></figure><p>You
    now have two new instances built using the AMI you provided and managed by the
    new ASG you created.</p><h3>Next Steps</h3><p>In this tutorial, you learned how
    to:</p><ul><li>Set up the AWS IAM and EC2 for the Harness Shell Script Delegate.</li><li>Install
    the Harness Shell Script Delegate.</li><li>Connect Harness with AWS.</li><li>Specify
    the AMIs to use for your new instances.</li><li>Specify the ASG to use as a template
    for new ASGs.</li><li>Set the number of instances to deploy.</li><li>Create and
    deploy an AMI Basic Workflow.</li></ul><p>Read the following related How-tos:</p><ul><li><a
    href="/article/ox5ewy2sf4-ami-deployments-overview">AMI Deployments Overview</a>.</li><li><a
    href="/article/xerirloz9a-add-a-trigger-2">Triggers</a> show you how to automate
    deployments in response to different events.</li><li><a href="/article/78g32khjcu-cloud-formation-provisioner">CloudFormation
    Provisioner</a> will show you how to add provisioning as part of your Workflow.</li></ul><p></p>'
  slug: aws-ami-deployments
  tags:
  - AMI
  - ASG
  is_live: true
