type: article
article_id: kuiuc6x257
user_id: slcpusem6b
category_id: tj4mzq0vw2
author:
  name: Archana Singh
  profile_image: https://www.gravatar.com/avatar/e323facc5a711ac44c46e58dcb52aa3e?d=mm&s=150
title: Set Up Cost Visibility for Kubernetes Using an Existing Delegate
slug: enable-continuous-efficiency-for-kubernetes
description: Describes how to enable Continuous Efficiency for Kubernetes.
short_version: Describes how to enable Continuous Efficiency for Kubernetes.
tags:
- continuous efficiency
- Kubernetes
- Kubernetes Cluster
- Enable Continuous Efficiency
- Clusterrole and clusterbinding
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2021-05-12T17:21:31.165594Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Set Up Cost Visibility for Kubernetes Using an Existing Delegate
  description: Describes how to enable Continuous Efficiency for Kubernetes.
  short_version: Describes how to enable Continuous Efficiency for Kubernetes.
  body: '<p>Harness Cloud Cost Management (CCM) monitors the cloud costs of your Kubernetes
    clusters, namespaces, nodes, workloads, and labels. This topic describes how to
    connect your Kubernetes to CCM using an existing Harness Delegate.</p><p>In this
    topic:</p><ul><li><a href="https://docs.harness.io/article/kuiuc6x257-enable-continuous-efficiency-for-kubernete#before_you_begin">Before
    You Begin</a></li><li><a href="https://docs.harness.io/article/kuiuc6x257-enable-continuous-efficiency-for-kubernetes#review_is_harness_delegate_running_in_your_cluster">Review:
    Is Harness Delegate Running in Your Cluster?</a></li><li><a href="https://docs.harness.io/article/kuiuc6x257-enable-continuous-efficiency-for-kubernete#prerequisites">Prerequisites</a></li><li><a
    href="https://docs.harness.io/article/kuiuc6x257-enable-continuous-efficiency-for-kubernetes#step_enable_cloud_cost_management">Step:
    Enable Cloud Cost Management</a></li><li><a href="https://docs.harness.io/article/kuiuc6x257-enable-continuous-efficiency-for-kubernetes#troubleshooting">Troubleshooting</a></li><li><a
    href="https://docs.harness.io/article/kuiuc6x257-enable-continuous-efficiency-for-kubernetes#next_steps">Next
    Steps</a></li></ul><h3>Before You Begin</h3><p></p><ul><li><a href="/article/rr85306lq8-continuous-efficiency-overview">Cloud
    Cost Management Overview</a></li><li><a href="/article/hrdw3foy2r-enable-ce-by-adding-a-delegate">Set
    Up Cost Visibility for Kubernetes</a></li><li><a href="/article/0hn6vdpeqz-install-kubernetes-delegate">Install
    the Harness Kubernetes Delegate</a></li><li><a href="/article/l68rujg6mp-add-kubernetes-cluster-cloud-provider">Add
    Kubernetes Cluster Cloud Provider</a></li></ul><h3>Review: Is Harness Delegate
    Running in Your Cluster?</h3><p>Before connecting your Kubernetes cluster to Harness
    CCM, review the following:</p><ul><li><strong>Provide</strong> <strong>CCM Permissions
    to Harness Delegate</strong>: If the Delegate is already running in the Kubernetes
    cluster that you want to monitor, the Service account you used to install and
    run the Harness Kubernetes Delegate is granted a special <code>ClusterRole</code> for
    accessing the resource metrics. For more information, see <a href="/article/kuiuc6x257-enable-continuous-efficiency-for-kubernetes#step_2_provide_ccm_permissions_to_harness_delegate">Provide
    CCM Permissions to Harness Delegate</a>.</li></ul><p></p><ul><li><strong>Use Single
    Harness Delegate to Access Multiple Kubernetes Clusters</strong>: You can use
    a single Harness Delegate to access multiple Kubernetes clusters. To do so, you
    need to enter specific credentials manually. For more information, see <a href="https://harness.helpdocs.io/article/l68rujg6mp-add-kubernetes-cluster-cloud-provider#option_2_enter_manually">Enter
    manually</a>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/kuiuc6x257/1606977710944/screenshot-2020-12-03-at-12-11-05-pm.png"
    style="max-height:55%;max-width:55%" data-hd-height="55%" data-hd-width="55%"/></figure></li></ul><p></p><h3>Prerequisites</h3><ul><li>Each
    Kubernetes cluster you want to monitor must have a Harness Delegate and Cloud
    Provider associated with it. For more information, see <a href="https://harness.helpdocs.io/article/0hn6vdpeqz-install-kubernetes-delegate">Install
    the Harness Kubernetes Delegate</a> and <a href="https://harness.helpdocs.io/article/l68rujg6mp-add-kubernetes-cluster-cloud-provider">Add
    Kubernetes Cluster Cloud Provider</a>.</li><li>Before enabling CCM for Kubernetes,
    you must ensure the utilization data for pods and nodes is available. To do so,
    perform the following steps:</li></ul><h4>Step 1: Install Kubernetes Metrics Server</h4><p>Metrics
    Server must be running on the Kubernetes cluster where your Harness Kubernetes
    Delegate is installed.</p><div class="note-callout">Metrics Server is installed
    by default on GKE and AKS clusters, however, you need to install it on the AWS
    EKS cluster.</div><ol><li>Metrics Server is a cluster-wide aggregator of resource
    usage data. It collects resource metrics from kubelets and exposes them in the
    Kubernetes API server through Metrics API. CCM polls the utilization data every
    minute on the Delegate. The metrics are aggregated for 20 minutes and then CCM
    keeps one data point per 20 minutes. For more information, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html"
    target="_blank">Installing the Kubernetes Metrics Server</a> from AWS.<br/><br/>To
    install metrics server on your EKS clusters, run the following command:<br/><br/><pre>kubectl
    apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml</pre></li></ol><h4>Step
    2: Provide CCM Permissions to Harness Delegate</h4><p>Bind the cluster-admin ClusterRole
    to a user account. Next, you will use this user account to create a ClusterRole
    and bind it to the Service account used by the Delegate.</p><ol><li>Bind a user
    account to the user in cluster-admin ClusterRole. You will use this user account
    to create a ClusterRole and bind it to the Harness Kubernetes Delegate Service
    account later.<br/><br/><pre>kubectl create clusterrolebinding cluster-admin-binding
    \<br/>--clusterrole cluster-admin \<br/>--user &lt;firstname.lastname@example.com&gt;</pre></li><li>Obtain
    the Service account name and namespace used by the Harness Kubernetes Delegate.
    By default, when you installed the Kubernetes Delegate, the following were used:<br/><br/><pre>name:
    default<br/>namespace: harness-delegate</pre><br/>If you have changed these, obtain
    the new name and namespace.</li><li>Download the <a href="https://raw.githubusercontent.com/harness/continuous-efficiency/master/config/ce-default-k8s-cluster-role.yaml">ce-default-k8s-cluster-role.yaml</a>
    file from Harness.<br/><br/>The <code>Subjects</code> section of the ClusterRoleBinding
    is configured with the default Delegate Service account name (<code>default</code>)
    and namespace (<code>harness-delegate</code>).<br/><br/>If you have changed these
    defaults, update the ce-default-k8s-cluster-role.yaml file before running it.</li><li>Once
    you have downloaded the file, connect to your Kubernetes cluster and run the following
    command in your Kubernetes cluster:<br/><br/><pre>kubectl apply -f ce-default-k8s-cluster-role.yaml</pre></li><li>Verify
    that you have all the required permissions for the Service account using the following
    commands:<br/><pre>kubectl auth can-i watch pods <br/>--as=system:serviceaccount:&lt;your-namespace&gt;:&lt;your-service-account&gt;
    <br/>--all-namespaces<br/>kubectl auth can-i watch nodes <br/>--as=system:serviceaccount:&lt;your-namespace&gt;:&lt;your-service-account&gt;
    <br/>--all-namespaces</pre><br/><pre>kubectl auth can-i get nodemetrics <br/>--as=system:serviceaccount:&lt;your-namespace&gt;:&lt;your-service-account&gt;
    <br/>--all-namespaces<br/>kubectl auth can-i get podmetrics <br/>--as=system:serviceaccount:&lt;your-namespace&gt;:&lt;your-service-account&gt;
    <br/>--all-namespaces</pre><br/>Here is an example showing the commands and output
    using the default Delegate Service account name and namespace:<br/><br/><pre>$
    kubectl auth can-i watch pods --as=system:serviceaccount:harness-delegate:default
    --all-namespaces<br/>yes<br/>$ kubectl auth can-i watch nodes --as=system:serviceaccount:harness-delegate:default
    --all-namespaces                                                                    <br/>yes<br/>$
    kubectl auth can-i watch nodemetrics --as=system:serviceaccount:harness-delegate:default
    --all-namespaces                                                              <br/>yes<br/>$
    kubectl auth can-i watch podmetrics --as=system:serviceaccount:harness-delegate:default
    --all-namespaces <br/>yes</pre></li></ol><h3>Step: Enable Cloud Cost Management</h3><p>To
    enable CCM in your cloud environment, you simply need to enable it on the Harness
    Kubernetes Cloud Provider that connects to your target cluster.</p><div class="note-callout">Once
    you enable CCM, for the first cluster the data is available within a few minutes
    for viewing and analysis. However, you will not see the idle cost because of the
    lack of utilization data. CCM generates the last 30 days of the cost data based
    on the first events.<br/><br/>From the second cluster onwards, it takes about
    2–3 hours for the data to be available for viewing and analysis.</div><ol><li>In
    <strong>Cloud Cost Management</strong>, click <strong>Settings</strong>.</li><li>Select
    the Kubernetes cluster for which you want to enable Cloud Cost Management.</li><li>In
    <strong>Display Name</strong>, enter the name that will appear in CCM Explorer
    to identify this cluster. Typically, this is the cluster name.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/kuiuc6x257/1592669680297/screenshot-2020-06-20-at-9-35-15-pm.png"
    style="max-height:60%;max-width:60%" data-hd-height="60%" data-hd-width="60%"/></figure></li><li>In
    <strong>Cluster Details</strong>, select:<ol><li><strong>Inherit from selected
    Delegate</strong>: (Recommended) Select this option if the Kubernetes cluster
    is the same cluster where the Harness delegate was installed. <ol><li><strong>Delegate
    Name</strong>: Select the Delegate.</li></ol></li><li><strong>Enter manually</strong>:
    In this option, the Cloud Provider uses the credentials that you enter manually.
    The Delegate uses these credentials to send deployment tasks to the cluster. The
    Delegate can be outside or within the target cluster.<div class="note-callout">Use
    this option, if you wish to use a single Delegate to access multiple Kubernetes
    clusters. To do so, you need to enter specific credentials manually. For more
    information, see <a href="https://harness.helpdocs.io/article/l68rujg6mp-add-kubernetes-cluster-cloud-provider#option_2_enter_manually">Enter
    manually</a>.</div><ol><li><strong>Master Url</strong>: The Kubernetes master
    node URL. The easiest method to obtain the master URL is using kubectl:<br/><code>kubectl
    cluster-info</code></li></ol></li></ol></li><li>Click <strong>Next</strong>.</li><li>Select
    the checkbox <strong>Enable Cloud Cost Management</strong> and click <strong>Submit</strong>.<figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/kuiuc6x257/1619514583855/screenshot-2021-04-27-at-1-49-11-pm.png"
    style="max-height:70%;max-width:70%" data-hd-height="70%" data-hd-width="70%"/></figure></li></ol><p>The
    Kubernetes Cloud Provider is now listed under <strong>Efficiency Enabled</strong>.
    Once CCM has data, the cluster is listed in <strong>Cost Explorer</strong>. The
    cluster is identified by the <strong>Display Name</strong> you used in the Kubernetes
    Cloud Provider.</p><div class="note-callout">When you enable Kubernetes with CCM,
    Kubernetes utilization events are automatically collected via the Harness Delegate.
    This information is used to show you historical cost data for your resources.
    The cost is calculated based on the publicly available catalog price information.<br/><br/>If
    a CCM AWS connector is created, then for the EKS clusters the pricing data is
    used from the CUR report instead of publicly available catalog price information.</div><h3>Troubleshooting</h3><ol><li>If
    the Cloud Provider listed in Setup is listed with the following error message,
    you need to review the steps earlier in this topic.<pre>No Delegate has all the
    requisites to access the cluster &lt;cluster-name&gt;.</pre><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/kuiuc6x257/1590147120062/screenshot-2020-05-22-at-5-01-43-pm.png"
    style="max-height:70%;max-width:70%" data-hd-height="70%" data-hd-width="70%"/></figure></li><li>If
    the Cloud Provider listed in Setup is listed with the following <strong>Invalid
    request</strong> error message, you need to download the <a href="https://raw.githubusercontent.com/harness/continuous-efficiency/master/config/ce-default-k8s-cluster-role.yaml">ce-default-k8s-cluster-role.yaml</a>
    file from Harness again. The <code>Subjects</code> section of the ClusterRoleBinding
    is configured with the default Delegate Service account name (<code>default</code>)
    and namespace (<code>harness-delegate</code>). If you have changed these defaults,
    update the <code>ce-default-k8s-cluster-role.yaml</code> file before running it.
    See <a href="/article/kuiuc6x257-enable-continuous-efficiency-for-kubernetes#step_2_provide_ccm_permissions_to_harness_delegate">Step
    2: Provide CCM Permissions to Harness Delegate</a>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/kuiuc6x257/1600330427832/screenshot-2020-09-17-at-1-43-30-pm.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><h3>Next
    Steps</h3><ul><li><a href="/article/eeekdk75q2-explorer-walkthrough">Cost Explorer
    Walkthrough</a></li><li><a href="/article/4rq26sszja-analyze-cost-trends-across-clusters">Analyze
    Cost for Kubernetes</a></li><li><a href="/article/v7eaaq98vo-perform-root-cause-analysis">Perform
    Root Cost Analysis</a></li></ul><p></p>'
  slug: enable-continuous-efficiency-for-kubernetes
  tags:
  - continuous efficiency
  - Kubernetes
  - Kubernetes Cluster
  - Enable Continuous Efficiency
  - Clusterrole and clusterbinding
  is_live: true
