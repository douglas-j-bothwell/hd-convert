type: article
article_id: am3dmoxywy
user_id: wz6xkfcc9i
category_id: o9x167at52
author:
  name: Chakravarthy Tenneti
  profile_image: https://www.gravatar.com/avatar/790db061bb8f8fb094e4d4b19a390f3b?d=mm&s=150
title: Add a HashiCorp Vault Secrets Manager
slug: add-a-hashi-corp-vault-secrets-manager
description: To store and use encrypted secrets (such as access keys), you can add
  a HashiCorp Vault Secrets Manager.
short_version: To store and use encrypted secrets (such as access keys), you can add
  a HashiCorp Vault Secrets Manager.
tags:
- HashiCorp Vault
- Vault
- Secrets management
- Secrets Manager
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2022-08-03T22:39:21.91281Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Add a HashiCorp Vault Secrets Manager
  description: To store and use encrypted secrets (such as access keys), you can add
    a HashiCorp Vault Secrets Manager.
  short_version: To store and use encrypted secrets (such as access keys), you can
    add a HashiCorp Vault Secrets Manager.
  body: '<div class="tip-callout">This content is for Harness <a href="https://docs.harness.io/article/1fjmm4by22">FirstGen</a>.
    Switch to <a href="/article/s65mzbyags-add-hashicorp-vault">NextGen</a>.</div><p>To
    store and use encrypted secrets (such as access keys), you can add a HashiCorp
    Vault Secrets Manager.</p><h3>Before You Begin</h3><ul><li>See <a href="/article/4o7oqwih6h-harness-key-concepts">Harness
    Key Concepts</a>.</li><li>See <a href="/article/au38zpufhr-secret-management">Secrets
    Management Overview</a>.</li><li>Make sure that the Harness Delegate is able to
    connect to the Vault URL.</li></ul><h3>Step 1: Configure Secrets Manager</h3><ol><li>Select
    <strong>Security</strong> &gt; <strong>Secrets Management</strong>. The <strong>Secrets
    Management</strong> page appears.</li><li>Click <strong>Configure Secrets Managers</strong>.
    In the resulting <strong>Secrets Managers</strong> page, the <strong>Status</strong>
    column indicates the <strong>Default</strong> provider.</li><li>Click <strong>Add
    Secrets Manager</strong>. The <strong>Configure Secrets Manager</strong> dialog
    appears.</li><li>Select <strong>HashiCorp Vault</strong> or <strong>HashiCorp
    Vault Secrets Engine - SSH</strong> from the drop down list.<ol><li>For HashiCorp
    Vault, enter the following information — <strong>Display Name,</strong> <strong>Vault
    URL,</strong> and <strong>Base Secret Path.</strong><br/>For more information,
    see <a href="https://www.vaultproject.io/docs/index.html" target="_blank">Vault
    documentation</a>.</li><li>For <strong>HashiCorp Vault Secrets Engine - SSH</strong>,
    in <strong>Vault URL</strong>, enter the Vault URL for the Vault server running
    the Secrets Engine.<br/>See <a href="/article/8y73f4o4ph-add-hashi-corp-vault-signed-ssh-certificate-keys">Add
    HashiCorp Vault Signed SSH Certificate Keys</a>.</li></ol></li><li>Select the
    <strong>Delegate Selector</strong> under Authentication.</li><li>Select the Authentication
    Type — <strong>Token,</strong> <strong>App Role,</strong> <strong>Vault Agent,
    or</strong> <strong>Kubernetes Auth</strong>.</li></ol><h3>Option: Namespace</h3><p>Enter
    the root URL for the Vault namespace you want to use for new and existing secrets.</p><p>For
    example, <strong>education</strong> or <strong>education/training</strong>.</p><p>If
    you do not enter a value, the default namespace is used.</p><p>The App Role ID
    or Token you use to authenticate in this Harness Secret Manager must be able to
    access the namespace.</p><p>For more information, see <a href="https://learn.hashicorp.com/tutorials/vault/namespaces"
    target="_blank">Secure Multi-Tenancy with Namespaces</a> from HashiCorp.</p><h3>Option:
    Token</h3><p>For Harness, the <strong>Token</strong> option requires <a href="https://www.vaultproject.io/docs/concepts/tokens#periodic-tokens"
    target="_blank">periodic tokens</a> (tokens that have renewal options).</p><p>To
    create a periodic token, make sure to specify a period in the token creation command:</p><pre>vault
    token create -policy=harness -period=768h</pre><p>Next, use the new token with
    Harness.</p><p>If you want to verify the renewal manually, use the command:</p><pre>vault
    token lookup &lt;token_id&gt;</pre><p>You will see an additional period field
    specifying the period of the token. To verify renewal, wait until the period expires
    and run the lookup command again.</p><h3>Option: App Role Method</h3><p>The App
    Role option enables the Harness Vault Secrets Manager to authenticate with Vault-defined
    roles.</p><p>The Vault AppRole method allows multiple roles to be defined, corresponding
    to different applications, and each with different levels of access. To authenticate
    with Vault, the application is assigned a static Role ID and a dynamically generated
    Secret ID, which are both required to log in and fetch a Vault token.</p><div
    class="note-callout">The SecretId should not expire and it should be valid until
    it is manually revoked. This SecretId is needed to generate new tokens when the
    older tokens expire.</div><p>The App Role ID and Secret ID you supply will be
    used by Harness to fetch a Vault Auth Token dynamically at configured intervals
    set in Renewal Interval.</p><p>For more information, see <a href="https://www.vaultproject.io/docs/auth/approle.html#roleid">RoleID</a>
    and <a href="https://www.hashicorp.com/blog/authenticating-applications-with-vault-approle">Authenticating
    Applications with HashiCorp Vault AppRole</a> from HashiCorp.</p><div class="note-callout">If
    you encounter errors, setting <a href="https://www.vaultproject.io/api-docs/auth/approle#token_num_uses"
    target="_blank">token_num_uses</a> to <code>0</code> can often resolve problems.</div><h4>Permissions</h4><p>The
    Vault AppRole ID or the Periodic Token used in either of the authentication options
    needs to have an ACL policy attached for Harness to use it. Typically, you create
    the policy first, then create the AppRole or Periodic Token and attach the policy.</p><div
    class="tip-callout">In the policy examples below: If you&#39;ve created a <a href="#read_only_vault">Read-only
    Vault Secrets Manager</a>, this secrets manager needs only read and list permissions
    on Vault. It does not need—and cannot assume—create, update, or delete permissions.</div><p>If
    the secrets are in the Secret Engine named “secret”, the following permissions
    are required in the policy.</p><pre>path &#34;secret/*&#34; {<br/>    capabilities
    = [&#34;create&#34;, &#34;update&#34;, &#34;list&#34;, &#34;read&#34;, &#34;delete&#34;]<br/>}</pre><p>If
    the secrets are in a subfolder, such as secrets/harness, the policy will look
    like this:</p><pre>path &#34;secret/harness/*&#34; {<br/>capabilities = [&#34;create&#34;,
    &#34;list&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;]<br/>}<br/>path
    &#34;secret/harness&#34; {<br/>   capabilities = [&#34;list&#34;, &#34;read&#34;]<br/>}</pre><div
    class="note-callout">These examples apply only for a <strong>v1</strong> secret
    engine. If you are planning to use a secret engine with version 2 (versioned secret
    engine), then the policies are different as explained <a href="https://www.vaultproject.io/docs/secrets/kv/kv-v2">here</a>.
    Go through this link to understand the correct permissions required for your use
    case.</div><p>If the Vault Secrets Manager needs to renew tokens, the following
    permissions are needed:</p><pre>path &#34;auth/token/renew-self&#34;<br/>{<br/>
    capabilities = [&#34;read&#34;, &#34;update&#34;]<br/>}</pre><h3>Option: Vault
    Agent</h3><div class="note-callout">For a detailed walkthrough, see <a href="https://community.harness.io/t/hashicorp-vault-2022-review-how-to-integrate-harness-with-vault-using-vault-agent-delegate/11710"
    target="_blank">How to integrate Harness with Vault using Vault Agent (Delegate)</a>
    from Harness Community.</div><p>This option enables the Harness Vault Secrets
    Manager to authenticate with the Auto-Auth functionality of the <a href="https://www.vaultproject.io/docs/agent/autoauth"
    target="_blank">Vault Agent</a>.</p><p>To authenticate with Vault Agent, make
    sure you have configured it on the required environment, with entries for <strong>method</strong>
    and <strong>sinks</strong>. For more information, see <a href="https://www.vaultproject.io/docs/agent">Vault
    Agent</a>.</p><p>In the <strong>Sink Path</strong> field, enter any sink path
    you have in your Vault Agent Configuration. This is the path of the encrypted
    file with tokens. The specified Delegate reads this file through file protocol
    (file://).</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/am3dmoxywy/1623304070244/screenshot-2021-06-10-at-9-44-26-am.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h3>Option:
    Kubernetes Auth</h3><div class="note-callout">Currently, this feature is behind
    the Feature Flag <code>ENABLE_K8S_AUTH_IN_VAULT</code>. Contact <a href="mailto:support@harness.io"
    target="_blank">Harness Support</a> to enable the feature.</div><p>This option
    uses a Kubernetes Service Account Token to authenticate with Vault. With this
    method of authentication, you can easily add a Vault token into a Kubernetes Pod.</p><p>To
    authenticate with Kubernetes Auth, make sure you have created a role in the vault
    inside <code>auth/kubernetes/role</code>. This role authorizes the &#34;vault-auth&#34;
    service account in the default namespace and it gives it the default policy. This
    is also where you&#39;ll find the <strong>service account name</strong> and <strong>namespace</strong> that
    will be used to access the vault endpoint.</p><figure><a href="https://files.helpdocs.io/i5nl071jo5/articles/s65mzbyags/1647314472462/screenshot-2022-03-14-at-3-36-28-pm.png"><img
    src="https://files.helpdocs.io/i5nl071jo5/articles/s65mzbyags/1647314472462/screenshot-2022-03-14-at-3-36-28-pm.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><p>For
    more information, see <a href="https://www.vaultproject.io/docs/auth/kubernetes#configuration">Kubernetes
    Auth Method</a>.</p><p>In <strong>Role Name</strong>, enter the role you have
    configured in the Vault.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/am3dmoxywy/1650550590712/screenshot-2022-04-21-at-7-45-51-pm.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>In <strong>Service
    Account Token Path </strong>enter the JSON Web Token (JWT) path. This is the path
    where the JWT token is mounted. The default path of this token is <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>.</p><p>For
    more information, see <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#service-account-tokens">Service
    Account Tokens</a>.</p><h3>Step 2: Select Secret Engine and Version</h3><p>Once
    you have entered the required fields, you can choose to <strong>Fetch the Secret
    Engine</strong> or <strong>Manually Enter Secret Engine</strong>.</p><h4>Fetch
    Secret Engine</h4><p>If you want Harness to automatically fetch secret engines,
    include this read permission for <strong>sys/mounts</strong> In the ACL policy.</p><pre>path
    &#34;sys/mounts&#34;{<br/> capabilities = [&#34;read&#34;]<br/>}</pre><p>Click
    <strong>Fetch Secret Engine</strong>.</p><p>Harness will populate the Secret Engine
    drop-down with the list of engines and their versions.</p><p>Select the engine
    you want to use.</p><h4>Manually enter Secret Engine</h4><p>If you don’t want
    to or cannot add the ACL policy (with read permission for sys/mounts) in the Secret
    Manager, perform the following steps:</p><ol><li>Identify the engine version of
    the Secret Manager in Vault.</li><li>In <strong>Secret Engine Name</strong>, enter
    the name of the Secret Engine.</li><li>In <strong>Version</strong>, select the
    engine version from the drop down list.</li></ol><div class="note-callout">You
    cannot change the Secret Engine later. Harness blocks editing this setting later
    because there might be secrets that are created/referenced in this secret engine.
    Changing the secret engine might break references to those secrets. To migrate
    secrets, see <a href="/article/prjsaaev0c-migrate-secrets-between-secrets-managers">Migrate
    Secrets between Secrets Managers</a>.</div><h3>Step 3: Renewal Interval</h3><p>In
    <strong>Renew Interval</strong>, you can (optionally) select how often Harness
    Delegate reloads the Vault access token.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/q7fqo7wt73/1585271766286/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><div
    class="note-callout">You can expect a delay during the Vault renewal. A periodic
    job runs to check if there has to be a renewal resulting in a delay of no more
    than 2 minutes.</div><h3>Review: Validating Non-Read Only Vault Secrets Managers</h3><p>To
    validate a non-read only Vault Secrets Manager, Harness creates a dummy secret
    in the secret engine.</p><div class="note-callout">The event for creating the
    dummy secret this will show up on <a href="/article/r5ytrnpcgr-audit-trail">Audit
    Trail</a> as if the user who initiated the creation of the Vault Secrets Manager
    created the secret. </div><p>The path of the secret is as follows:</p><p>v2 Secret
    Engine:</p><p><code>&lt;SECRET_ENGINE_NAME&gt;/data/&lt;BASE_PATH&gt;/harness_vault_validation#value</code></p><p>v1
    Secret Engine:</p><p><code>&lt;SECRET_ENGINE_NAME&gt;/&lt;BASE_PATH&gt;/harness_vault_validation#value</code></p><p>The
    secret can fail because of various reasons.</p><ol><li>Using the Token/App Role,
    the Vault authentication is not successful.</li><li>The following <strong>permission</strong> is
    not available in any of the policies attached to the Token/App Role. If this permission
    is not available, the user will not be able to fetch the list of secret engines
    from the customer vault and Harness will show a single option of Secret Engine
    named <strong>“secret”</strong> with version 2 which might be incorrect for the
    customer.Make sure to add the permission to a policy attached to the Token/App
    Role as follows:</li></ol><pre>         path “sys/mounts”{<br/>            capabilities
    = [&#34;read&#34;]<br/>            }    </pre><ol><li>3. The policy attached to
    the Token/AppRole does not provide the <strong>write </strong>permission in the
    specified path. Make sure you update the policies and permissions.</li></ol><h3>Step
    4: Read-only Vault</h3><p>If required by your organization&#39;s security practices,
    select the <strong>Read-only Vault</strong> check box. This selection authorizes
    Harness to read secrets from Vault, but not to create or manage secrets within
    Vault.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/4vqipye0vz/1580779701677/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Once
    you have filled out the dialog, click <strong>Submit</strong>.</p><h5>Read-only
    Limitations</h5><p>If you select <strong>Read-only Vault</strong>, there are several
    limitations on the resulting Harness Vault Secrets Manager. First, as shown by
    the above screenshot&#39;s disabled <strong>Use as Default Secrets Manager</strong>
    option, a read-only secrets manager cannot be Harness&#39; default secrets manager.</p><p>Also,
    a read-only Harness Vault Secrets Manager:</p><ul><li>Cannot be used in the <strong>Add
    Encrypted File</strong> dialog.</li><li>Cannot create inline secrets in the <strong>Add
    Encrypted Text</strong> modal.</li><li>Cannot migrate (deprecate) its secrets
    to another secrets manager. </li><li>Cannot have secrets migrated to it from another
    secrets manager.</li></ul><h3>Step 5: Usage Scope</h3><p>See <a href="/article/e4ikpd00f6-scope-secret-managers-to-applications-and-environments">Scope
    Secret Managers to Applications and Environments</a>.</p>'
  slug: add-a-hashi-corp-vault-secrets-manager
  tags:
  - HashiCorp Vault
  - Vault
  - Secrets management
  - Secrets Manager
  is_live: true
