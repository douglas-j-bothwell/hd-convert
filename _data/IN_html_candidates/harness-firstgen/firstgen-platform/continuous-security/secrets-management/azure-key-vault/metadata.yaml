type: article
article_id: 2nv0gy1wnh
user_id: x5amubrz4l
category_id: o9x167at52
author:
  name: Michael Katz
  profile_image: https://www.gravatar.com/avatar/17fb3fc86ca54443de0da47ef350d8f0?d=mm&s=150
title: Add an Azure Key Vault Secrets Manager
slug: azure-key-vault
description: Use Azure Key Vault to store and use encrypted secrets, such as access
  keys.
short_version: Use Azure Key Vault to store and use encrypted secrets, such as access
  keys.
tags:
- Azure
- Azure Key Vault
- Secrets management
- encrypted
- security
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2022-07-29T08:20:43.183606Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Add an Azure Key Vault Secrets Manager
  description: Use Azure Key Vault to store and use encrypted secrets, such as access
    keys.
  short_version: Use Azure Key Vault to store and use encrypted secrets, such as access
    keys.
  body: '<div class="tip-callout">This content is for Harness <a href="https://docs.harness.io/article/1fjmm4by22">FirstGen</a>.
    Switch to <a href="/article/53jrd1cv4i-azure-key-vault">NextGen</a>.</div><p>This
    topic outlines how to use <a href="https://docs.microsoft.com/en-us/azure/key-vault/key-vault-whatis"
    target="_blank">Azure Key Vault</a> to maintain your Harness secrets. It includes
    these sections:</p><ul><li><a href="#before_you_begin">Before You Begin</a></li><li><a
    href="#visual_overview">Visual Overview</a></li><li><a href="#step_1_create_azure_reader_role">Step
    1: Create Azure Reader Role</a><ul><li><a href="#azure_portal">Azure Portal</a></li><li><a
    href="#power_shell_command">PowerShell Command</a></li></ul></li><li><a href="#step_2_configure_secrets_manager_in_harness">Step
    2: Configure Secrets Manager in Harness</a></li><li><a href="#step_3_set_display_name">Step
    3: Set Display Name</a></li><li><a href="#step_4_select_environment">Step 4: Select
    Environment</a></li><li><a href="#step_5_enter_client_id_and_tenant_id">Step 5:
    Enter Client ID and Tenant ID</a></li><li><a href="#option_enter_subscription">Option:
    Enter Subscription</a></li><li><a href="#step_6_create_and_exchange_authentication_key">Step
    6: Create and Exchange Authentication Key</a></li><li><a href="#step_7_fetch_vault">Step
    7: Fetch Vault</a></li><li><a href="#step_8_usage_scope">Step 8: Usage Scope</a></li><li><a
    href="#step_9_save_the_secrets_manager">Step 9: Save the Secrets Manager</a></li><li><a
    href="#step_10_make_key_vaults_writable">Step 10: Make Key Vaults Writable</a></li><li><a
    href="#option_use_existing_azure_key_vault_secrets">Option: Use Existing Azure
    Key Vault Secrets</a></li><li><a href="#next_steps">Next Steps</a></li></ul><p></p><h3>Before
    You Begin</h3><ul><li>Review <a href="/article/au38zpufhr-secret-management">Secrets
    Management</a> for Harness&#39; overall approach to managing secrets.</li><li>Review
    Microsoft&#39;s documentation as necessary, starting with <a href="https://docs.microsoft.com/en-us/azure/key-vault/key-vault-overview"
    target="_blank">What Is Azure Key Vault?</a> and <a href="https://docs.microsoft.com/en-us/azure/key-vault/key-vault-whatis"
    target="_blank">Azure Key Vault Basic Concepts</a>.</li><li>We assume that you
    have an Azure account set up and ready to use.</li><li>Make sure that the Harness
    Delegate is able to connect to this URL: <code>https://&lt;vault_name&gt;.vault.azure.net</code><br/><code>&lt;vault_name&gt;</code>
    is the name of the vault selected from the dropdown while configuring the Azure
    Vault.</li></ul><p></p><h3>Visual Overview</h3><p>Azure Key Vault safeguards cryptographic
    keys and secrets, encrypting authentication keys, storage account keys, data encryption
    keys, .pfx files, and passwords.</p><p></p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585685297465/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure><p></p><h3>Step
    1: Create Azure Reader Role</h3><p>To enable Harness to later fetch your Azure
    vaults (in <a href="#step_7">Step 7</a> below), you must first set up a <strong>Reader</strong>
    role in Azure. You can do this two ways:</p><ul><li> <a href="#azure_portal">Azure
    Portal</a></li><li> <a href="#powershell_command">PowerShell Command</a></li></ul><p></p><h4>Azure
    Portal</h4><p>To create a <strong>Reader</strong> role in the Azure portal UI:</p><ol><li>Navigate
    to Azure&#39;s <strong>Subscriptions</strong> page.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585527735834/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Under
    <strong>Subscription name</strong>, select the subscription where your vaults
    reside.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585695399595/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure><div
    class="tip-callout"><strong>Tip:</strong> Copy and save the <strong>Subscription
    ID</strong>. You can paste this value into Harness Manager below at <a href="#subscription">Option: Enter
    Subscription</a>.</div></li><li>Select your <strong>Subscription’s Access control
    (IAM)</strong> property.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585528480442/image.png"
    style="max-height:35%;max-width:35%" data-hd-height="35%" data-hd-width="35%"/></figure></li><li>On
    the resulting <strong>Access control (IAM)</strong> page, select <strong>Add a
    role assignment</strong>.</li><li>In the resulting right pane, set the <strong>Role</strong>
    to <strong>Reader</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585529001796/image.png"
    style="max-height:35%;max-width:35%" data-hd-height="35%" data-hd-width="35%"/></figure></li><li>Accept
    the default value: <strong>Assign access to</strong>: <strong>Azure AD user</strong>,
    <strong>group, or service principal</strong>.</li><li>In the <strong>Select</strong>
    drop-down, select the name of your Azure App registration.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585529163155/image.png"
    style="max-height:35%;max-width:35%" data-hd-height="35%" data-hd-width="35%"/></figure></li><li>Click
    <strong>Save</strong>.</li><li>On the <strong>Access control (IAM)</strong> page,
    select the <strong>Role assignments</strong> tab. Make sure your new role now
    appears under the <strong>Reader</strong> group.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585529477508/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure></li></ol><div
    class="tip-callout">Microsoft Azure&#39;s <a href="https://docs.microsoft.com/en-us/azure/cost-management-billing/manage/add-change-subscription-administrator#to-assign-a-user-as-an-administrator"
    target="_blank">Manage subscriptions</a> documentation adds details about the
    above procedure, but focuses on the <strong>Administrator</strong> rather than
    the <strong>Reader</strong> role.</div><p></p><h4>PowerShell Command</h4><p>You
    can also create a <strong>Reader</strong> role programmatically via this PowerShell
    command, after gathering the required parameters:</p><pre>New-AzRoleAssignment
    -ObjectId &lt;object_id&gt; -RoleDefinitionName &#34;Reader&#34; -Scope /subscriptions/&lt;subscription_id&gt;</pre><p></p><p>For
    details and examples, see Microsoft Azure&#39;s <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-powershell#application-at-a-subscription-scope"
    target="_blank">Add or remove role assignments</a> documentation.</p><p></p><h3>Step
    2: Configure Secrets Manager in Harness</h3><p>To set up Azure Key Vault as a
    Harness Secrets Manager:</p><ol><li>In <strong>Security</strong>, select <strong>Secrets
    Management</strong>, and then click <strong>Configure Secrets Managers.</strong><br/>In
    the resulting <strong>Secrets Managers</strong> page, the <strong>Status</strong> column
    indicates the <strong>Default</strong> provider.</li><li>Click <strong>Add Secrets
    Manager</strong>. The <strong>Configure Secrets Manager</strong> settings appear.</li><li>Select <strong>Azure
    Key Vault</strong> from the drop-down list.<br/><br/>Key Vault stores and manages
    secrets as sequences of octets (8-bit bytes), with a maximum size of 25k bytes
    each. For more information, see <a href="https://docs.microsoft.com/en-us/azure/key-vault/secrets/about-secrets">Azure
    Key Vault secrets</a>.<div class="note-callout">If you set up Azure Key Vault
    as your <em>default</em> secrets manager in Harness, any secret that you save
    afterwards must be named according to <a href="https://docs.microsoft.com/en-us/azure/key-vault/about-keys-secrets-and-certificates"
    target="_blank">Azure Key Vault conventions</a>.</div></li></ol><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1635528886439/clean-shot-2021-10-29-at-10-34-36.png"/></figure><h3>Step
    3: Set Display Name</h3><p>In the <strong>Configure Secrets Manager</strong> dialog&#39;s
    <strong>Display Name</strong> field, enter an arbitrary name to identify this
    key vault within Harness Manager.</p><p></p><h3>Step 4: Select Environment</h3><p>Harness
    supports <a href="https://docs.microsoft.com/en-us/azure/azure-government/" target="_blank">Azure
    Government</a> (Gov Cloud) and Azure Global (global Azure) environments. You can
    read about their differences in <a href="https://docs.microsoft.com/en-us/azure/azure-government/compare-azure-government-global-azure"
    target="_blank">Compare Azure Government and global Azure</a> from Azure.</p><p>In
    <strong>Environment</strong>, select <strong>Azure Global</strong> or <strong>US
    Government</strong>. Most accounts use <strong>Azure Global</strong>.</p><h3>Step
    5: Enter Client ID and Tenant ID</h3><p>This dialog&#39;s <strong>Client ID</strong>
    and <strong>Tenant ID</strong> entries correspond to the fields highlighted below
    in the Azure UI:</p><p></p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585627547567/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure><p>To
    provide these values:</p><ol><li>In Azure, navigate to the <strong>Azure Active
    Directory</strong> &gt; <strong>App registrations</strong> page, then select your
    App registration. (For details, see Azure&#39;s <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-v1-add-azure-ad-app"
    target="_blank">Quickstart: Register an application with the Microsoft identity
    platform</a>.)</li><li>Copy the <strong>Application (client) ID</strong> for the
    Azure App registration you are using, and paste it into the Harness dialog&#39;s
    <strong>Client ID</strong> field.</li><li>Copy the <strong>Directory (tenant)
    ID</strong> of the Azure Active Directory (AAD) where you created your application,
    and paste it into the Harness dialog&#39;s <strong>Tenant ID</strong> field. (For
    details, see Microsoft Azure&#39;s <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in"
    target="_blank">Get values for signing in</a> topic.)</li></ol><p></p><h3>Option:
    Enter Subscription</h3><p>In the <strong>Subscription</strong> field, you can
    optionally enter your Azure Subscription ID (GUID).</p><p>To find this ID, navigate
    to Azure&#39;s <strong>Subscriptions</strong> page, as outlined above in <a href="#step_1">Step
    1: Create Azure Reader Role</a>. From the resulting list of subscriptions, copy
    the <strong>Subscription ID</strong> beside the subscription that contains your
    vaults.</p><p></p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585625743106/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure><div
    class="tip-callout">If you do not enter a GUID, Harness uses the default subscription
    for the <a href="#step_4">Client ID</a> you&#39;ve provided above.</div><p></p><h3>Step
    6: Create and Exchange Authentication Key</h3><p>Generate an authentication key
    in Azure, and add it to Harness Manager as an application password:</p><ol><li>Navigate
    to Azure&#39;s <strong>Certificates &amp; secrets</strong> page. (For details,
    see Microsoft Azure&#39;s <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal#get-application-id-and-authentication-key"
    target="_blank">Create a new application secret</a> documentation.)</li><li>In
    the resulting page’s <strong>Client secrets</strong> section, select <strong>New client
    secret</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585535715641/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure></li><li>Enter
    a <strong>Description</strong> and expiration option, then click <strong>Add</strong>.<figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585536012676/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure></li><li>Find
    your new key in the <strong>Client secrets</strong> section, and copy its value
    to your clipboard.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585536424303/image.png"
    style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure><div
    class="note-callout">This is your only chance to view this key&#39;s value in
    Azure. Store the value somewhere secure, and keep it on your clipboard.</div></li><li>Paste
    the key into Harness’ <strong>Key</strong> field.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585537408409/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><h3>Step
    7: Fetch Vault</h3><ol><li>Click <strong>Fetch Vault</strong>.<br/>After a slight
    delay, the <strong>Vault</strong> drop-down list populates with vaults corresponding
    to your client secret.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585627871495/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>From
    the <strong>Vault</strong> drop-down, select the vault to use.</li></ol><p></p><div
    class="note-callout">If these controls do not respond as expected, double-check
    whether you have successfully configured <a href="#step_1">Step 1: Create Azure
    Reader Role</a> above.</div><p></p><h3>Step 8: Usage Scope</h3><p>See <a href="https://docs.harness.io/article/e4ikpd00f6-scope-secret-managers-to-applications-and-environments">Scope
    Secret Managers to Applications and Environments</a>.</p><h3>Step 9: Save the
    Secrets Manager</h3><ol><li>If you choose to make Azure Key Vault your Harness
    default, select <strong>Use as Default Secrets Manager</strong>.</li><li>To save
    your configured Secrets Manager, click <strong>Submit</strong>.<div class="tip-callout">Harness
    does not validate your configuration upon save.</div></li></ol><p></p><h3>Step
    10: Make Key Vaults Writable</h3><p>For every key vault that you&#39;ll want to
    write to, you must follow this procedure:</p><ol><li>Navigate to Azure &#39;s
    <strong>Key vaults</strong> page.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585527923316/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Select
    the Vault instance that matches Harness Manager&#39;s <strong>Vault</strong> field.</li><li>Select
    <strong>Settings</strong> &gt; <strong>Access policies</strong>.</li><li>In the
    <strong>Access policies</strong> page’s main area, click <strong>Add access policy</strong>.</li><li>On
    the resulting <strong>Add access policy</strong> page, use the <strong>Configure
    from template</strong> drop-down to select <strong>Key &amp; Secret Management</strong>.<figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585554766441/image.png"
    style="max-height:75%;max-width:75%" data-hd-height="75%" data-hd-width="75%"/></figure></li><li>Click
    <strong>Select principal</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585554824993/image.png"
    style="max-height:75%;max-width:75%" data-hd-height="75%" data-hd-width="75%"/></figure></li><li>In
    the resulting <strong>Principal</strong> pane at right, enter the name of the
    App registration whose <strong>Client ID</strong>, <strong>Tenant ID</strong>,
    <strong>Key</strong>, and <strong>Vault</strong> you’ve entered (above) in Harness
    Manager.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nv0gy1wnh/1585554950689/image.png"
    style="max-height:35%;max-width:35%" data-hd-height="35%" data-hd-width="35%"/></figure></li><li>Click
    <strong>Select</strong> to select this App registration.</li><li>Repeat the above
    steps (as needed) to make your other vaults writable.</li></ol><p></p><h3>Option:
    Use Existing Azure Key Vault Secrets</h3><p>You can create a Harness secret that
    refers to an existing secret in Azure Key Vault, using that secret&#39;s name
    (for example: <code>azureSecret</code>). You can also specify the secret&#39;s
    version (for example: <code>azureSecret/05</code>).</p><p></p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/b4p6pj1jhd/1581146108813/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><h3>Next
    Steps</h3><ul><li>Refer back to <a href="/article/au38zpufhr-secret-management">Secrets
    Management</a> for other secrets storage options.</li></ul><p></p>'
  slug: azure-key-vault
  tags:
  - Azure
  - Azure Key Vault
  - Secrets management
  - encrypted
  - security
  is_live: true
