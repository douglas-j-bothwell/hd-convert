<p>This topic covers how Harness tracks Kubernetes deployment releases, and the labels Harness applies during deployments:</p><ul><li><a href="#releases_and_versioning">Releases and Versioning</a></li><li><a href="#harness_annotations_and_labels">Harness Annotations and Labels</a></li></ul><p>For a list of Harness built-in expressions, see <a href="/article/aza65y4af6-built-in-variables-list">Built-in Variables List</a>.</p><h3 id="releases_and_versioning">Releases and Versioning</h3><p>Every Harness deployment creates a new release with an incrementally increasing number. Release history is stored in the Kubernetes cluster in a ConfigMap. This ConfigMap is essential for release tracking, versioning and rollback.</p><p>By default, all the ConfigMap and <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank">Secrets</a> resources are versioned by Harness. Corresponding references in PodSpec are also updated with versions.</p><p>You can see the use of release numbers and versioning in the <strong>Deployments</strong> page details:</p><pre class="hljs css">INFO   2019-02-15 10:53:33    Kind                Name                                    Versioned <br/>INFO   2019-02-15 10:53:33    Namespace           default                                 false     <br/>INFO   2019-02-15 10:53:33    Secret              image-pull-secret                       false     <br/>INFO   2019-02-15 10:53:33    Secret              sample                                  true      <br/>INFO   2019-02-15 10:53:33    Deployment          nginx-deployment                        false     <br/>INFO   2019-02-15 10:53:33    <br/>INFO   2019-02-15 10:53:33    <br/>INFO   2019-02-15 10:53:33    Current release number is: 5<br/>INFO   2019-02-15 10:53:33    <br/>INFO   2019-02-15 10:53:33    Previous Successful Release is 4</pre><div class="note-callout">Versioning does not change how you use Secrets. You do not need to reference versions when using Secrets.</div><p>For cases where versioning is not required, the manifest entered in the Harness Service Manifests section should be annotated with <code>harness.io/skip-versioning: &#34;true&#34;</code>.</p><p>For example. you might want to skip versioning is for an ImagePullSecret because it never changes, or for TLS certs if they are referred to in <a href="https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/" target="_blank">Kubernetes container command args</a>.</p><p>Harness also uses a release name for tracking releases. You can supply a release name in an Environment&#39;s <a href="/article/v3l3wqovbe-infrastructure-definitions">Infrastructure Definition</a> <strong>Release Name</strong> field. By default, the value Harness uses is <code>release-${infra.kubernetes.infraId}</code>.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1568672670414/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><p>The <code>${infra.kubernetes.infraId}</code> expression is a unique identifier that identifies the combination of Service and Infrastructure Definition.</p><p>In the Infrastructure Definition <strong>Service Infrastructure Mapping</strong> below each listing has a unique identifier that can be referenced using <code>${infra.kubernetes.infraId}</code>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/u3rp89v80h/1624554401882/clean-shot-2021-06-24-at-10-06-02.png"/></figure><p></p><p>For a list of Harness built-in expressions, see <a href="/article/aza65y4af6-built-in-variables-list">Built-in Variables List</a>. See the <a href="/article/aza65y4af6-built-in-variables-list#infrastructure">Infrastructure</a> and <a href="/article/aza65y4af6-built-in-variables-list#kubernetes">Kubernetes</a> sections.</p><h4>Release Name is Reserved for Internal Harness ConfigMap</h4><p>The release name you enter in <strong>Release Name</strong> is reserved for the internal Harness ConfigMap used for tracking the deployment.</p><p>Do not create a ConfigMap that uses the same name as the release name. Your ConfigMap will override the Harness internal ConfigMap and cause a NullPointerException.</p><h4>Skipping Versioning and Rollback</h4><p>Skipping versioning (using <code>harness.io/skip-versioning: &#34;true&#34;</code>) effects rollback.</p><p>For example, if your Kubernetes Deployment object referred to <strong>v1</strong> of the configMap and then you deploy the Deployment along with config changes in the configMap resulting in a <strong>v2</strong> configMap, and the deployment then fails:</p><ul><li><strong>With versioning:</strong> the rollback of the deployment goes back to a version that refers to <strong>v1</strong>, effectively reverting your config changes.</li><li><strong>Without versioning:</strong> rollback of deployment goes to its previous revision (reverting buildNo, or other deployment information), but the reference to configMap is to a non-versioned one. The configMap was overwritten, so it now refers to the new config. If the configMap change caused the failure then rollback will also fail.</li></ul><h3 id="harness_annotations_and_labels">Harness Annotations and Labels</h3><p>Harness applies labels during Kubernetes deployment that you can use to select objects you defined in your Harness Service <strong>Manifests</strong> section. Annotations are a way to pass additional metadata for resources to Harness. For a description of Annotations, see <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/">Annotations</a> from Kubernetes.</p><h4 id="annotations">Quotes</h4><p>In both annotations and labels, <strong>boolean strings require quotes</strong>. For example:</p><p><code>harness.io/skip-versioning: &#34;true&#34;</code></p><p>Regular strings do not requires quotes.</p><h4 id="annotations">Annotations</h4><p>The following Annotations can be put on resource specifications in the Harness Service <strong>Manifests</strong> section.</p><div class="note-callout">Annotation values must use quotes.</div><table><tbody><tr><td><p><strong>Annotation</strong></p></td><td><p><strong>Value</strong></p></td><td><p><strong>Usage</strong></p></td></tr><tr><td><p><code>harness.io/skip-versioning</code></p></td><td><p><code>&#34;true&#34;|&#34;false&#34;</code></p></td><td><p>To exclude versioning of a resource (ConfigMap or Secret).</p></td></tr><tr><td><p><code>harness.io/skip-file-for-deploy</code></p></td><td><p>n/a</p></td><td><p>You might have manifest files for resources that you do not want to deploy as part of the main deployment.</p><p>Instead, you tell Harness to ignore these files and then apply them separately using the Harness Apply step.</p><p>Or you can simply ignore them until you wish to deploy them as part of the main deployment.</p><p>Use <code>harness.io/skip-file-for-deploy</code> at the top of the manifest file to ignore its objects.</p><p>See <a href="/article/vv25jkq4d7-ignore-a-manifest-file-during-deployment">Ignore a Manifest File During Deployment</a>.</p></td></tr><tr><td><p><code>harness.io/direct-apply</code></p></td><td><p><code>&#34;true&#34;|&#34;false&#34;</code></p></td><td><p>If more than one workload is present in the Service <strong>Manifests</strong> files, use this annotation to apply an <u>unmanaged workload</u>.</p><p>Apply an unmanaged workload by setting the annotation to <code>&#34;true&#34;</code>.</p><p>See <a href="/article/vv25jkq4d7-ignore-a-manifest-file-during-deployment">Ignore a Manifest File During Deployment</a> and <a href="/article/4vjgmjcj6z-deploy-manifests-separately-using-apply-step">Deploy Manifests Separately using Apply Step</a>.</p><p>Multiple workloads are supported in <a href="/article/dl0l34ge8l-create-a-kubernetes-rolling-deployment">Rolling Update</a> deployment strategies. Multiple workloads are not supported in <a href="/article/2xp0oyubjj-create-a-kubernetes-canary-deployment">Canary</a> and <a href="/article/ukftzrngr1-create-a-kubernetes-blue-green-deployment">Blue/Green</a>.</p></td></tr><tr><td><p><code>harness.io/primary-service</code></p></td><td><p><code>&#34;true&#34;|&#34;false&#34;</code></p></td><td><p>Identifies the primary Kubernetes service in a Blue/Green deployment.</p></td></tr><tr><td><p><code>harness.io/stage-service</code></p></td><td><p><code>&#34;true&#34;|&#34;false&#34;</code></p></td><td><p>Identifies the Kubernetes stage service in a Blue/Green deployment.</p></td></tr><tr><td><p><code>harness.io/managed</code></p></td><td><p><code>&#34;true&#34;|&#34;false&#34;</code></p></td><td><p><strong>Required</strong> for Harness to identify that a DestinationRule or VirtualService is managed.</p><p>This annotation is used to identify which DestinationRule or VirtualService Harness should update during traffic splitting when there are more than one.</p><p>Harness requires that the managed VirtualService have only one route in the <code>http</code> list in order to know which one to update.</p><p>If the DestinationRule/VirtualService uses <code>harness.io/managed: false</code>, that is the same as if <code>harness.io/managed</code> were omitted. In this case, Harness will not perform any traffic shifting.</p><p>See <a href="/article/1qfb4gh9e8-set-up-kubernetes-traffic-splitting">Set Up Kubernetes Traffic Splitting</a>.</p></td></tr></tbody></table><h5>Note on direct-apply</h5><p>See <a href="/article/6ujb3c70fh">What Can I Deploy in Kubernetes?</a>.</p><h4 id="labels">Labels</h4><p>The following labels are applied by Harness during deployment.</p><table><tbody><tr><td><p><strong>Label</strong></p></td><td><p><strong>Value</strong></p></td><td><p><strong>Usage</strong></p></td></tr><tr><td><p><code>harness.io/release-name</code></p></td><td><p><code>release name</code></p></td><td><p>Applied on pods. Harness uses a release name for tracking releases, rollback, etc. You can supply a release name in an Environment&#39;s <a href="https://docs.harness.io/article/n39w05njjv-environment-configuration#add_an_infrastructure_definition">Infrastructure Definition</a> <strong>Release Name</strong> field.</p><p>By default, the value Harness uses is <code>release-${infra.kubernetes.infraId}</code>.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/ttn8acijrz/1585691258342/image.png"/></figure><div class="note-callout">Use <code>release-${infra.kubernetes.infraId}</code> for the <strong>Release Name</strong> instead of just <code>${infra.kubernetes.infraId}</code>. Kubernetes service and pod names follow DNS-1035 and must consist of lowercase alphanumeric characters or &#39;-&#39;, start with an alphabetic character, and end with an alphanumeric character. Using <code>release-</code> as a prefix will prevent any issues.</div></td></tr><tr><td><p><code>harness.io/track</code></p></td><td><p><code>canary|stable</code></p></td><td><p>Applied on pods in a Canary deployment.</p></td></tr><tr><td><p><code>harness.io/color</code></p></td><td><p><code>blue|green</code></p></td><td><p>Applied on pods in a Blue/Green deployment.</p></td></tr></tbody></table><p id="ingress_rules"></p><h3 id="ingress_rules">Next Steps</h3><ul><li><a href="/article/ukftzrngr1-create-a-kubernetes-blue-green-deployment">Create a Kubernetes Blue/Green Deployment</a></li><li><a href="/article/vv25jkq4d7-ignore-a-manifest-file-during-deployment">Ignore a Manifest File During Deployment</a></li><li><a href="/article/4vjgmjcj6z-deploy-manifests-separately-using-apply-step">Deploy Manifests Separately using Apply Step</a></li><li><a href="/article/tot87l7e6k-set-up-kubernetes-ingress-rules">Set up Kubernetes Ingress Rules</a></li></ul><p></p>