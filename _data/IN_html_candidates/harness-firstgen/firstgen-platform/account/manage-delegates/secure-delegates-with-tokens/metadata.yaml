type: article
article_id: r61qs08x2p
user_id: mfr0nxh4be
category_id: gyd73rp7np
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: Secure Delegates with Tokens
slug: secure-delegates-with-tokens
description: Secure Delegate to Harness communication by replacing the default Delegate
  token with new tokens.
short_version: Secure Delegate to Harness communication by replacing the default Delegate
  token with new tokens.
tags: []
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: ""
  source: API
  triggered_at: 2022-07-06T18:58:21.835131Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Secure Delegates with Tokens
  description: Secure Delegate to Harness communication by replacing the default Delegate
    token with new tokens.
  short_version: Secure Delegate to Harness communication by replacing the default
    Delegate token with new tokens.
  body: '<p></p><div class="note-callout">Currently, this feature is behind a Feature
    Flag. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a>
    to enable the feature. Feature Flags can only be removed for Harness Professional
    and Essentials editions. Once the feature is released to a general audience, it&#39;s
    available for Trial and Community Editions.<br/><br/>See <a href="https://changelog.harness.io/?categories=fix,improvement,new"
    target="_blank">New features added to Harness</a> and <a href="https://changelog.harness.io/?categories=early-access"
    target="_blank">Features behind Feature Flags</a> (Early Access) for Feature Flag
    information.</div><p>Delegate tokens are used by Harness to encrypt communication
    between Harness Delegates and the Harness Manager. By default, when a new Harness
    account is created, all Harness Delegates in that account include the same token.</p><p>You
    can further secure Delegate to Harness communication by replacing the default
    Delegate token with new tokens. You can rotate and revoke Delegate tokens per
    your governance policies and replace revoked tokens with custom tokens when needed.</p><p>In
    this topic:</p><ul><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#before_you_begin">Before
    You Begin</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#step_1_generate_a_new_token">Step
    1: Generate a New Token</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#option_install_a_new_delegate_with_new_token">Option:
    Install a New Delegate with New Token</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#option_update_and_restart_existing_delegate">Option:
    Update and Restart Existing Delegate</a><ul><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#kubernetes_delegate">Kubernetes
    Delegate</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#shell_script_delegate">Shell
    Script Delegate</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#docker_delegate">Docker
    Delegate</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#ecs_task_delegate">ECS
    Task Delegate</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#helm_delegate">Helm
    Delegate</a></li></ul></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#option_revoke_tokens">Option:
    Revoke Tokens</a></li><li><a href="https://docs.harness.io/article/r61qs08x2p-secure-delegates-with-tokens#see_also">See
    Also</a></li></ul><p></p><h3>Before You Begin</h3><ul><li> <a href="/article/igftn7rrtg-delegate-installation-overview">Delegate
    Installation Overview</a></li><li> <a href="/article/0hn6vdpeqz-install-kubernetes-delegate">Install
    the Harness Kubernetes Delegate</a></li><li> <a href="/article/8o4cwqj1kv-install-shellscript-delegate">Install
    the Harness Shell Script Delegate</a></li><li> <a href="/article/oiy5fxawzq-install-ecs-delegate">Install
    the Harness ECS Delegate</a></li><li> <a href="/article/6n7fon8rit-using-the-helm-delegate">Install
    the Harness Helm Delegate</a></li><li> <a href="/article/hnvvwbhbdu-install-docker-delegate">Install
    the Harness Docker Delegate</a></li></ul><h3>Step 1: Generate a New Token</h3><p>In
    Harness, click <strong>Setup</strong>.</p><p>Click <strong>Harness Delegates</strong>.</p><p>Click
    <strong>Delegate Tokens</strong>.</p><p>Here you can see, create, and revoke all
    Delegate tokens.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/r61qs08x2p/1624043645534/clean-shot-2021-06-18-at-12-13-20.png"/></figure><p>Enter
    a name for the new token, and then click <strong>Generate New Token</strong>.</p><p>The
    new token is created and its value is copied to your system clipboard. The new
    token also appears in the list using the name you gave it.</p><p>Save the new
    token value. You cannot retrieve the token value after this.</p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/r61qs08x2p/1624043698796/clean-shot-2021-06-18-at-12-14-36.png"/></figure><p>Now
    you can update the Delegate(s) with the new token.</p><h3>Option: Install a New
    Delegate with New Token</h3><p>When you install a new Delegate, you can select
    the token to use:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/r61qs08x2p/1624045651857/clean-shot-2021-06-18-at-12-47-19.png"/></figure><p>Once
    the new Delegate has registered with Harness, you can remove any Delegates using
    the old tokens, and revoke the old tokens.</p><h3>Option: Update and Restart Existing
    Delegate</h3><p>You can update an existing Delegate with the new token value and
    then restart the Delegate.</p><h4>Kubernetes Delegate</h4><p>The Delegate is set
    up using the <strong>harness-delegate.yaml</strong> you downloaded originally.</p><p>Edit
    the <strong>harness-delegate.yaml</strong> you downloaded originally with the
    new token and then run <code>kubectl apply -f harness-delegate.yaml</code> to
    restart the Delegate pods.</p><p>Paste the token in the Delegate settings in the
    spec:</p><pre>...<br/>env:<br/>        - name: ACCOUNT_ID<br/>          value:
    AQ8xh0000000005bSM8Fg<br/>        - name: ACCOUNT_SECRET<br/>          value:
    [enter new token here]<br/>        - name: MANAGER_HOST_AND_PORT<br/>          value:
    https://app.harness.io<br/>...</pre><p></p><p>Run <code>kubectl apply -f harness-delegate.yaml</code></p><p>The
    Delegate pods get restarted automatically. The pods will restart and take the
    updated settings.</p><h4>Shell Script Delegate</h4><p>The Delegate is set up using
    the <strong>config-delegate.yml</strong> you downloaded originally.</p><p>Stop
    the Delegate: <code>./stop.sh</code></p><p>Paste the token in the Delegate settings:</p><pre>...<br/>accountId:
    lnFZRF0000000nMALw<br/>accountSecret: [enter new token here]<br/>managerUrl: https://app.harness.io/api/<br/>...</pre><p></p><p>Restart
    the Delegate: <code>./start.sh</code></p><p></p><h4>Docker Delegate</h4><p>Docker
    doesn&#39;t provide a way to modify an environment variable in a running container
    because the OS doesn&#39;t provide a way to modify an environment variable in
    a running process. You need to destroy and recreate the container.</p><p>Destroy
    and recreate the container using the <strong>launch-harness-delegate.sh</strong>
    you downloaded originally.</p><p>Paste the token in the Delegate settings:</p><pre>#!/bin/bash
    -e<br/><br/>sudo docker pull harness/delegate:latest<br/><br/>sudo docker run
    -d --restart unless-stopped --hostname=$(hostname -f) \<br/>-e ACCOUNT_ID=kmpySm00000006NL73w
    \<br/>-e ACCOUNT_SECRET=[enter new token here] \<br/>-e MANAGER_HOST_AND_PORT=https://app.harness.io/
    \<br/>...</pre><p></p><p>Create a new container: <code>./launch-harness-delegate.sh</code></p><p>You
    can verify that the environment variable has the new token using <code>docker
    exec [container ID] env</code>.</p><h4>ECS Task Delegate</h4><p>Update the Delegate
    by updating the existing ECS task and container instances.</p><p>Stop the Delegate
    task:</p><pre>aws ecs stop-task --task [task ID or full ARN of the task]</pre><p></p><p>Paste
    the token in the Delegate settings:</p><pre>...<br/>      &#34;cpu&#34;: 1,<br/>      &#34;environment&#34;:
    [<br/>        {<br/>          &#34;name&#34;: &#34;ACCOUNT_ID&#34;,<br/>          &#34;value&#34;:
    &#34;Ws0x0000008z4g&#34;<br/>        },<br/>        {<br/>          &#34;name&#34;:
    &#34;ACCOUNT_SECRET&#34;,<br/>          &#34;value&#34;: &#34;[enter new token
    here]&#34;<br/>        },<br/>        {<br/>          &#34;name&#34;: &#34;DELEGATE_CHECK_LOCATION&#34;,<br/>          &#34;value&#34;:
    &#34;delegate.txt&#34;<br/>        },<br/><br/>...</pre><p></p><p>Start the Delegate
    task:</p><pre>aws ecs start-task \<br/>    --task-definition [family and revision
    (family:revision ) or full ARN of the task definition] \<br/>    --container-instances
    [container instance IDs or full ARN entries for the container instances]</pre><h4>Helm
    Delegate</h4><p>The Delegate is set up using the Helm Values YAML file, <strong>harness-delegate-values.yaml</strong>,
    you downloaded originally.</p><p>Stop the Helm Delegate.</p><p>Paste the token
    in the Delegate settings in the harness-delegate.yaml file:</p><pre># Account
    Id to which the delegate will be connecting<br/>accountId: XIC000000Ox-cQ<br/><br/>#
    Secret identifier associated with the account<br/>accountSecret: [enter new token
    here]<br/><br/># Short 6 character identifier of the account<br/>accountIdShort:
    xicobc<br/><br/>delegateName: helm-example<br/>...</pre><p></p><p>Install the
    Helm Delegate using the Helm Values YAML (in this example, the name is <strong>helm-delegate-doc</strong>):</p><p><code>helm
    install --name helm-delegate-doc harness/harness-delegate -f harness-delegate-values.yaml</code></p><p>If
    you are installing into a specific namespace, you will need the <code>--namespace</code> parameter
    also:</p><p><code>helm install harness-helm-repo/harness-delegate --name helm-delegate-doc
    -f harness-delegate-values.yaml --namespace doc-example</code></p><h3>Option:
    Revoke Tokens</h3><p>To revoke unused token, in Harness, click <strong>Setup</strong>.</p><p>Click
    <strong>Harness Delegates</strong>.</p><p>Click <strong>Delegate Tokens</strong>.</p><p>Here
    you can see, create, and revoke all Delegate tokens.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/r61qs08x2p/1624043645534/clean-shot-2021-06-18-at-12-13-20.png"/></figure><p>Select
    the token you want to revoke, and click <strong>Revoke</strong>.</p><p>Click <strong>Confirm</strong>.
    The token is revoked. The Harness Manager will not accept connections from any
    Delegates using this revoked token.</p><h3>See Also</h3><ul><li><a href="/article/2uhtcqzaio-approve-or-reject-harness-delegates">Approve
    or Reject Harness Delegates</a></li></ul><p></p>'
  slug: secure-delegates-with-tokens
  tags: []
  is_live: true
