<p>The Terraform Provision and Terraform Apply steps in a Workflow can be executed as a dry run, just like running the <a href="https://www.terraform.io/docs/commands/plan.html" target="_blank">terraform plan</a> command.</p><p>The dry run will refresh the state file and generate a plan, but not apply the plan. You can then set up an Approval step to follow the dry run, followed by the Terraform Provision or Terraform Apply step to apply the plan.</p><p>This topic covers using the Terraform Provision and Terraform Apply steps for <u>dry runs</u> only. For steps on applying plans without a dry run, see <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a> and <a href="/article/jaxppd8w9j-using-the-terraform-apply-command">Using the Terraform Apply Command</a>.</p><h3>Before You Begin</h3><p>This topic assumes you have read the following:</p><ul><li> <a href="/article/hh52ews03d-terraform-provisioning-with-harness">Terraform Provisioning with Harness</a></li><li> <a href="/article/llp7a6lr1c-terraform-delegates">Set Up Your Harness Account for Terraform</a></li><li> <a href="/article/ux2enus2ku-add-terraform-scripts">Add Terraform Scripts</a></li><li> <a href="/article/a2f2bh35el-mapgcp-kube-terraform-infra">Map Dynamically Provisioned Infrastructure using Terraform</a></li><li> <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a></li></ul><div class="note-callout"><strong>What the difference between the Terraform Provision or Terraform Apply step?</strong> The Terraform Provision step is used to provision infrastructure and is added in the <strong>Pre-deployment Steps</strong> of a Workflow. The Terraform Apply can be placed anywhere in the Workflow.</div><h3>Visual Summary</h3><p>The following graphic shows a common use of a Terraform dry run in deployments.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/xthfj92dys/1586471873769/image.png"/></figure><ol><li>The dry run is used to verify the provisioning.</li><li>An Approval step to ensure that the Terraform plan is working correctly.</li><li>The plan is run and the infrastructure is provisioned.</li><li>The app is deployed to the provisioned infrastructure.</li></ol><p>In a Harness Workflow it looks something like this:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/xthfj92dys/1586472654242/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h3>Limitations</h3><p>The Terraform Plan is stored in the default Harness Secrets Manager as encrypted text. This is because plans often contain variables that store secrets.</p><p>The Terraform plan size must not exceed the secret size limit for secrets in your default Secret Manager. AWS Secrets Manager has a limitation of 64KB. Other supported Secrets Managers support larger file size.</p><p>See <a href="/article/uuer539u3l-add-a-secrets-manager">Add a Secrets Manager</a>.</p><h3>Step 1: Set Terraform Step as Plan</h3><p>This step assumes you are familiar with adding the <a href="/article/uxwih21ps1-terraform-provisioner-step">Terraform Provision</a> and <a href="/article/jaxppd8w9j-using-the-terraform-apply-command">Terraform Apply</a> steps.</p><p>To perform a dry run of your Terraform Provision and Terraform Apply steps, you simply select the <strong>Set as Terraform Plan</strong> option.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/xthfj92dys/1586469919868/image.png"/></figure><p>That&#39;s it. Now this Terraform Provision or Terraform Apply step will run like a <code>terraform plan</code> command.</p><p>The dry run will refresh the state file and generate a plan but it is not applied. You can then set up an Approval step to follow the dry run, followed by a Terraform Provision or Terraform Apply step to apply the plan.</p><p>In the subsequent Terraform Provision or Terraform Apply steps, you will select the <strong>Inherit following configurations from Terraform Plan</strong> option to apply the plan.</p><p>This is just like running the <code>terraform plan</code> command before a <code>terraform apply</code> command.</p><div class="note-callout">You can use expressions after a Terraform plan step (Terraform Apply step with <strong>Set as Terraform Plan</strong> enabled) to see the number of resources added, changed, or destroyed. For details, go to <a href="/article/aza65y4af6-built-in-variables-list#terraform_plan_and_terraform_destroy_changes">Terraform Plan and Terraform Destroy Changes</a>.</div><h3>Option: Export Terraform Plan to Apply Step</h3><div class="note-callout">This option supports <a href="https://www.terraform.io/upgrade-guides/0-12.html" target="_blank">Terraform version 12</a> only.</div><p>When you use <strong>Set as Terraform Plan</strong> in the Terraform Provision or Terraform Apply steps and then use <strong>Inherit following configurations from Terraform Plan</strong> in a subsequent Terraform Provision or Terraform Apply step, Harness does the following:</p><p>Harness runs the Terraform provision again and points to the plan, runs a Terraform refresh, then a plan, and finally executes the new plan.</p><p>Technically, this is a different plan. If you want use the <u>actual plan</u> because of security or audit requirements, use <strong>Export Terraform Plan to Apply Step</strong> in the previous Terraform Provision step along with <strong>Set as Terraform Plan</strong>.</p><h5>Notes</h5><ul><li>If the <strong>Export Terraform Plan to Apply Step</strong> option is enabled in two <u>consecutive</u> Terraform Provision steps, the second Terraform Provision step overwrites the plan from the first Terraform Provision step.</li><li>Harness uses the <a href="/article/uuer539u3l-add-a-secrets-manager">Harness Secret Manager</a> you have selected as your default in the export process. As a result, the size of the plan you can export is limited to the size of secret that Secret Manager allows.</li></ul><div class="note-callout">If Harness detects that a Terraform plan produces no changes then the actual generated Terraform plan file is not be uploaded to the Secret Manager regardless of whether the Terraform Apply step has <strong>Export Terraform Plan to Apply Step</strong> enabled.</div><p></p><h3>Step 2: Add Approval Step</h3><p>Harness Workflow Approval steps can be done using Jira, ServiceNow, or the Harness UI. You can even use custom shell scripts. See <a href="/article/0ajz35u2hy-approvals">Approvals</a>.</p><p>Add the Approval step after the Terraform Provision or Terraform Apply step where you selected the <strong>Set as Terraform Plan</strong> option.</p><ol><li style="counter-increment:li 0" start="1">To add the Approval step, click <strong>Add Step</strong>, and select <strong>Approval</strong>.</li><li>In the <strong>Approval</strong> step, select whatever approval options you want, and then click <strong>Submit</strong>.</li></ol><p>Next, we&#39;ll add a Terraform Provision or Terraform Apply step after the Approval step to actually run the Terraform Infrastructure Provisioner script.</p><div class="note-callout">If the Approval step takes a long time to be approved there is the possibility that a new commit occurs in the Git repo containing for Terraform script. To avoid a problem, when the Workflow performs the dry run, it saves the commit ID of the script file. Later, after the approval, the Terraform Provision step will use the commit ID to ensure that it executes the script that was dry run.</div><h3>Step 3: Add Terraform Step to Apply Plan</h3><p>For the Terraform Provision or Terraform Apply step that actually runs the Terraform Infrastructure Provisioner script (<code>terraform apply</code>), all you need to do is select the <strong>Inherit following configurations from Terraform Plan</strong> option.</p><p>When you select this option, the Terraform Provision or Terraform Apply step inherits the settings of the Terraform Provision or Terraform Apply step that preceded it.</p><ol><li>After the Approval step, click <strong>Add Step</strong>.</li><li>Select a <strong>Terraform Provision</strong> or <strong>Terraform Apply</strong> step.</li><li>In <strong>Name</strong>, enter a name for the step to indicate that it will perform the provisioning. For example, <strong>Apply Provisioning</strong>.</li><li>In <strong>Provisioner</strong>, select the Harness Terraform Infrastructure Provisioner you want to run. This is the same Terraform Infrastructure Provisioner you selected in the previous Terraform Provision or Terraform Apply step.</li><li>Select the <strong>Inherit following configurations from Terraform Plan</strong> option.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/xthfj92dys/1586472892374/image.png"/></figure></li><li>Click <strong>Submit</strong>.</li></ol><p>You do not need to enter any more settings. The Terraform Provision or Terraform Apply step inherits the settings of the Terraform Provision or Terraform Apply step that preceded it.</p><p>Your Workflow now looks something like this:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/xthfj92dys/1586472654242/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h3>Step 4: Deploy</h3><p>Deploy your Workflow and see the <code>terraform plan</code> executed in the first Terraform Provision or Terraform Apply step. Next, approve the Approval step. Finally, see the <code>terraform apply</code> executed as part of the final Terraform Provision or Terraform Apply step.</p><h3>Review: Terraform Plan Output Variable</h3><p>If you select the <strong>Set as Terraform Plan</strong> option, you can display the output of the plan using the variable expression <code>${terraformApply.tfplan}</code>. For example, you can display the plan output in a <a href="/article/1fjrjbau7x-capture-shell-script-step-output">Shell Script</a> step.</p><p>For help in parsing the plan output, see <a href="https://community.harness.io/t/parsing-terraform-plan-output/545" target="_blank">Parsing Terraform Plan Output</a> on Harness Community.</p><div class="note-callout">The <code>${terraformApply.tfplan}</code> expression does not support plan files larger than 15MB.</div><h3>Review: Terraform Plan File Output Variable</h3><p></p><div class="note-callout">Currently, this feature is behind the Feature Flag <code>OPTIMIZED_TF_PLAN</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature.</div><p>If you select the <strong>Set as Terraform Plan</strong> option, you can display the output of the plan using the variable expression <code>${terraformPlan.jsonFilePath()}</code>.</p><p>The <code>${terraformPlan.jsonFilePath()}</code> expression outputs the path to the Terraform plan <u>file</u> on the Harness Delegate that executed the step.</p><p>For example, you can display the plan output in a <a href="/article/1fjrjbau7x-capture-shell-script-step-output">Shell Script</a> step:</p><pre># Terraform Apply<br/>#### Using OPA <br/>opa exec --decision terraform/analysis/authz --bundle policy/ ${terraformPlan.jsonFilePath()}<br/><br/>#### Using OPA daemon<br/>curl localhost:8181/v0/data/terraform/analysis/authz -d @${terraformPlan.jsonFilePath()}</pre><p></p><p>If you use the Terraform Destroy step, you can use the expression <code>${terraformPlan.destroy.jsonFilePath()}</code> to output plan used by that step.</p><p></p><h3>Next Steps</h3><p>Removing provisioned infrastructure is a common Terraform-related task. You can add this task to your Harness Workflow and automate it. See <a href="/article/4egyxnse9r-terraform-destroy">Remove Provisioned Infra with Terraform Destroy</a>.</p><p></p>