<p>This topic describes how to use a Harness Terraform Infrastructure Provisioner to create a Harness Infrastructure Definition. When you select the <strong>Map Dynamically Provisioned Infrastructure</strong> option in an Infrastructure Definition, you select an Infrastructure Provisioner and then map its outputs to required settings.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619468898144/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Once you are done, you add the Infrastructure Definition to a Workflow as its deployment target. Finally, you add a Terraform Provisioner step to that Workflow to provision the infrastructure.</p><p>When the Workflow runs, it provisions the infrastructure using the Terraform Provisioner step and then deploys to the provisioned infrastructure using the Infrastructure Definition.</p><p>This topic describes how to map Terraform script outputs for all of the supported platforms.</p><p>In this topic:</p><ul><li> <a href="#before_you_begin">Before You Begin</a></li><li> <a href="#visual_summary">Visual Summary</a></li><li> <a href="#limitations">Limitations</a></li><li> <a href="#step_add_the_infrastructure_definition">Step: Add the Infrastructure Definition</a></li><li> <a href="#option_1_map_an_agnostic_kubernetes_cluster">Option 1: Map an Agnostic Kubernetes Cluster</a></li><li> <a href="#option_2_map_a_gcp_kubernetes_infrastructure">Option 2: ​Map a GCP Kubernetes Infrastructure​</a></li><li> <a href="#option_3_map_an_aws_ami_infrastructure">Option 3: ​Map an AWS AMI Infrastructure​</a></li><li> <a href="#option_4_map_an_aws_ecs_infrastructure">Option 4: ​Map an AWS ECS Infrastructure​</a></li><li> <a href="#option_5_map_an_aws_lambda_infrastructure">Option 5: ​Map an AWS Lambda Infrastructure​</a></li><li> <a href="#option_6_map_a_secure_shell_ssh_infrastructure">Option 6: ​Map a Secure Shell (SSH) Infrastructure</a></li><li> <a href="#option_7_map_an_azure_web_app">Option 7: Map an Azure Web App</a></li><li> <a href="#next_steps">Next Steps</a></li></ul><h3>Before You Begin</h3><ul><li>Get an overview how how Harness supports Terraform — <a href="/article/hh52ews03d-terraform-provisioning-with-harness">Terraform Provisioning with Harness</a>.</li><li>Ensure you have your Harness account settings prepared for Terraform — <a href="/article/llp7a6lr1c-terraform-delegates">Set Up Your Harness Account for Terraform</a>.</li><li>Create a Harness Terraform Infrastructure Provisioner — <a href="/article/ux2enus2ku-add-terraform-scripts">Add Terraform Scripts</a>.</li></ul><h3>Visual Summary</h3><p>This topic describes step 2 in the Harness Terraform Provisioning implementation process:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/ux2enus2ku/1586284265080/image.png"/></figure><p>Once you have completed this topic, you can move onto steps 3 through 6 in <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provisioner Step</a>.</p><h3>Limitations</h3><p>Harness Terraform Infrastructure Provisioner are only supported in Canary and Multi-Service Workflows. For AMI/ASG and ECS deployments, Terraform Infrastructure Provisioners are also supported in Blue/Green Workflows.</p><h3>Step: Add the Infrastructure Definition</h3><p>As noted above, ensure you have done <a href="/article/llp7a6lr1c-terraform-delegates">Set Up Your Harness Account for Terraform</a> and <a href="/article/ux2enus2ku-add-terraform-scripts">Add Terraform Scripts</a> before using the Terraform Infrastructure Provisioner to create the Infrastructure Definition.</p><p>To use a Terraform Infrastructure Provisioner to create an Infrastructure Definition, do the following:</p><ol><li>In the same Harness Application where you created the Terraform Infrastructure Provisioner, in an existing Environment, click <strong>Infrastructure Definition</strong>. The <strong>Infrastructure Definition</strong> dialog appears.</li><li>In <strong>Name</strong>, enter the name for the Infrastructure Definition. You will use this name to select the Infrastructure Definition when you set up Workflows and Workflow Phases.</li><li>In <strong>Cloud Provider Type</strong>, select the type of Cloud Provider to use to connect to the target platform, such as Amazon Web Services, Kubernetes Cluster, etc.</li><li>In <strong>Deployment Type</strong>, select the same type of deployment as the Services you plan to deploy to this infrastructure.<br/>It is Deployment Type that determines which Services can be scoped in <strong>Scope to specific Services</strong> and in Workflow and Phase setup.</li><li>Click <strong>Map Dynamically Provisioned Infrastructure</strong>.</li><li>In <strong>Provisioner</strong>, select your Terraform Infrastructure Provisioner.</li><li>In the remaining settings, map the required fields to your Terraform script outputs. The required fields are described in the option sections below.</li></ol><p>You map the Terraform script outputs using this syntax, where <code>exact_name</code> is the name of the output:</p><pre class="hljs java">${terraform.<em style="box-sizing:inherit">exact_name</em>}</pre><p></p><div class="note-callout">When you map a Terraform script output to a Harness Infrastructure Definition setting, the variable for the output, <code>${terraform.exact_name​}</code>, can be used anywhere in the Workflow that uses that Terraform Provisioner.</div><p></p><h3>Option 1: Map an Agnostic Kubernetes Cluster</h3><div class="note-callout">Provisioning Kubernetes is supported with the Kubernetes Cluster Cloud Provider and Google Cloud Platform Cloud Provider, but not the Azure Cloud Provider.</div><p>Harness supports platform-agnostic Kubernetes cluster connections using its <a href="/article/l68rujg6mp-add-kubernetes-cluster-cloud-provider">Kubernetes Cluster Cloud Provider</a>.</p><p>When you set up an Infrastructure Definition using a Kubernetes Cluster Cloud Provider you can map your Terraform script outputs to the required Infrastructure Definition settings.</p><p>The agnostic Kubernetes deployment type requires mapping for the <strong>Namespace</strong> and <strong>Release Name</strong> settings.</p><p>The following example shows the Terraform script outputs used for the mandatory platform-agnostic Kubernetes deployment type fields:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/a2f2bh35el/1594407007297/image.png"/></figure><p>For information on Kubernetes deployments, see <a href="/article/pc6qglyp5h-kubernetes-deployments-overview">Kubernetes How-tos</a>.</p><h3>Option 2: ​Map a GCP Kubernetes Infrastructure​</h3><p>The GCP Kubernetes deployment type requires the <strong>Cluster Name</strong> and <strong>Namespace</strong> settings.</p><div class="note-callout">Provisioning Kubernetes is supported with the Kubernetes Cluster Cloud Provider and Google Cloud Platform Cloud Provider, but not the Azure Cloud Provider.</div><p>The following example shows the Terraform script outputs used for the mandatory Kubernetes deployment type fields:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1568843935341/image.png"/></figure><p>For information on Kubernetes deployments, see <a href="/article/pc6qglyp5h-kubernetes-deployments-overview">Kubernetes How-tos</a>.</p><h4>Cluster Name Format</h4><p>If the cluster is multi-zonal, ensure the resolved value of the Terraform output mapped to <strong>Cluster Name</strong> uses the format <code>region/name</code>.</p><p>If the cluster is single-zone, ensure the resolved value of the Terraform output mapped to <strong>Cluster Name</strong> uses the format <code>zone/name</code>. If you use a <code>region/name</code> format, it will result in a 404 error.</p><p>See <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/types-of-clusters" target="_blank">Types of clusters</a> from GCS.</p><h3>Option 3: ​Map an AWS AMI Infrastructure​</h3><div class="note-callout">AMI deployments are the only type that supports Terraform and CloudFormation Infrastructure Provisioners in Blue/Green deployments.</div><p>The AWS AutoScaling Group deployment type requires the Region and Base Auto Scaling Group fields. The following example shows the Terraform script outputs used for all of the fields:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1568843233697/image.png"/></figure><p>For detailed information on AMI deployments, see <a href="/article/rd6ghl00va-ami-deployment">AMI Basic Deployment</a>. Here is what each of the output values are:</p><ul><li><strong>Region</strong> - The target AWS region for the AMI deployment.</li><li><strong>Base Auto Scaling Group</strong> - An existing Auto Scale Group that Harness will copy to create a new Auto Scaling Group for deployment by an AMI Workflow. The new Auto Scaling Group deployed by the AMI Workflow will have unique max and min instances and desired count.</li><li><strong>Target Groups</strong> - The target group for the load balancer that will support your Auto Scale Group. The target group is used to route requests to the Auto Scale Groups you deploy. If you do not select a target group, your deployment will not fail, but there will be no way to reach the Auto Scale Group.</li><li><strong>Classic Load Balancers</strong> - A classic load balancer for the Auto Scale Group you will deploy.</li><li>For Blue/Green Deployments only:<ul><li><strong>Stage Classic Load Balancers</strong> - A classic load balancer for the stage Auto Scale Group you will deploy.</li><li><strong>Stage Target Groups</strong> - The staging target group to use for Blue Green deployments. The staging target group is used for initial deployment of the Auto Scale Group and, once successful, the Auto Scale Group is registered with the production target group (<strong>Target Groups</strong> selected above).</li></ul></li></ul><p></p><div class="note-callout">Harness recommends you use Launch Templates instead of Launch Configurations. With Launch Templates, the AMI root volume size parameter is overwritten as specified in the Launch Template. This prevents conflicts between devices on a base Launch Configuration and the AMI Harness creates.</div><p></p><h3>Option 4: ​Map an AWS ECS Infrastructure​</h3><p>The ECS deployment type requires the <strong>Region</strong> and <strong>Cluster</strong> fields. The following example shows the Terraform script outputs used for the mandatory ECS deployment type fields:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1568842169542/image.png"/></figure><p>For information on ECS deployments, see <a href="/article/5z2kw34d7x-aws-ecs-deployments-overview">AWS ECS Deployments Overview</a>.</p><h3>Option 5: ​Map an AWS Lambda Infrastructure​</h3><p>The Lambda deployment type requires the IAM Role and Region fields. The following example shows the Terraform script outputs used for the mandatory and optional Lambda deployment type fields:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1568847962282/image.png"/></figure><h3>Option 6: ​Map a Secure Shell (SSH) Infrastructure</h3><p>The Secure Shell (SSH) deployment type requires the <strong>Region</strong> and <strong>Tags</strong> fields. The following example shows the Terraform script outputs used for the mandatory SSH deployment type fields:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1568840005938/image.png"/></figure><h3>Option 7: Map an Azure Web App</h3><p></p><div class="note-callout">Currently, this feature is behind a Feature Flag. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature. Feature Flags can only be removed for Harness Professional and Essentials editions. Once the feature is released to a general audience, it is available for Trial and Community Editions.</div><p></p><p>The Azure Web App deployment requires the Subscription and Resource Group in the Infrastructure Definition.</p><p>The Web App name and Deployment Slots are mapped in the Deployment Slot Workflow step.</p><p>In the following example, <code>${terraform.webApp}</code> is used for both the Web App name and Target Slot.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/a2f2bh35el/1612213634599/image.png"/></figure><p>See <a href="/article/lluikqw7q7-azure-web-app-deployments-overview">Azure Web App Deployments Overview</a>.</p><details><summary>Here&#39;s an example Terraform script for this type of deployment:</summary><div><pre class="hljs json">variable &#34;subscription_id&#34; {<br/>}<br/>variable &#34;client_id&#34; {<br/>}<br/>variable &#34;client_secret&#34; {<br/>}<br/>variable &#34;tenant_id&#34; {<br/>}<br/><br/># Configure the Azure Provider<br/>provider &#34;azurerm&#34; {<br/>  # Whilst version is optional, we /strongly recommend/ using it to pin the version of the Provider being used<br/>  version = &#34;=2.4.0&#34;<br/>  subscription_id = var.subscription_id<br/>  client_id       = var.client_id<br/>  client_secret   = var.client_secret<br/>  tenant_id       = var.tenant_id<br/>  features {}<br/>}<br/><br/>resource &#34;azurerm_resource_group&#34; &#34;main&#34; {<br/>  name     = &#34;my-terraform-resourceGroup-test&#34;<br/>  location = &#34;West Europe&#34;<br/>}<br/><br/>resource &#34;azurerm_app_service_plan&#34; &#34;main&#34; {<br/>  name                = &#34;AppServicePlan-Terraform-test&#34;<br/>  location            = azurerm_resource_group.main.location<br/>  resource_group_name = azurerm_resource_group.main.name<br/>  kind                = &#34;Linux&#34;<br/>  reserved            = true<br/><br/>  sku {<br/>    tier = &#34;Standard&#34;<br/>    size = &#34;S1&#34;<br/>  }<br/>}<br/><br/>resource &#34;azurerm_app_service&#34; &#34;main&#34; {<br/>  name                = &#34;WebApp-Terraform-test&#34;<br/>  location            = azurerm_resource_group.main.location<br/>  resource_group_name = azurerm_resource_group.main.name<br/>  app_service_plan_id = azurerm_app_service_plan.main.id<br/><br/>  site_config {<br/>    linux_fx_version = &#34;DOCKER|mcr.microsoft.com/appsvc/staticsite:latest&#34;<br/>    always_on        = &#34;true&#34;<br/>  }<br/>  <br/>  app_settings = {<br/>    &#34;production_key&#34; = &#34;production_value&#34;<br/>     WEBSITES_ENABLE_APP_SERVICE_STORAGE = false<br/>  }<br/><br/>  connection_string {<br/>    name  = &#34;Database&#34;<br/>    type  = &#34;SQLServer&#34;<br/>    value = &#34;Server=some-server.mydomain.com;Integrated Security=SSPI&#34;<br/>  }<br/>}<br/><br/>resource &#34;azurerm_app_service_slot&#34; &#34;example&#34; {<br/>  name                = &#34;terraformStage&#34;<br/>  app_service_name    = azurerm_app_service.main.name<br/>  location            = azurerm_resource_group.main.location<br/>  resource_group_name = azurerm_resource_group.main.name<br/>  app_service_plan_id = azurerm_app_service_plan.main.id<br/><br/>  site_config {<br/>    linux_fx_version = &#34;DOCKER|mcr.microsoft.com/appsvc/staticsite:latest&#34;<br/>    always_on        = &#34;true&#34;<br/>  }<br/>  <br/>  app_settings = {<br/>    &#34;stage_key&#34; = &#34;stage_value&#34;<br/>     WEBSITES_ENABLE_APP_SERVICE_STORAGE = false<br/>  }<br/><br/>  connection_string {<br/>    name  = &#34;Database&#34;<br/>    type  = &#34;SQLServer&#34;<br/>    value = &#34;Server=some-server.mydomain.com;Integrated Security=SSPI-stage&#34;<br/>  }<br/>}<br/><br/>output &#34;subId&#34; {<br/>  value = &#34;${var.subscription_id}&#34;<br/>}<br/><br/>output &#34;resourceGroup&#34; {<br/>  value = &#34;${azurerm_resource_group.main.name}&#34;<br/>}<br/><br/>output &#34;webApp&#34; {<br/>  value = &#34;${azurerm_app_service.main.name}&#34;<br/>}<br/><br/>output &#34;deploymentSlot&#34; {<br/>  value = &#34;${azurerm_app_service_slot.example.name}&#34;<br/>}</pre></div></details><h3>Next Steps</h3><p>Now that the Infrastructure Definition is mapped to the Terraform outputs in your script, the provisioned infrastructure can be used as a deployment target by a Harness Workflow. But the Terraform script must still be run to provision this infrastructure.</p><p>To run the Terraform script in your Harness Infrastructure Provisioner and create the infra you defined in Infrastructure Definition, you add a a Terraform Provisioner step to your Workflow.</p><p>For steps on adding the Terraform Provisioner step, see <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provisioner Step</a>.</p><p></p>