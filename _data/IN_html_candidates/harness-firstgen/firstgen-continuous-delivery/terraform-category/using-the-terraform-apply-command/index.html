<p>This topic describes how to use the Terraform Apply step to perform Terraform operations at any point in your Workflow.</p><h3>Before You Begin</h3><p>Before reading about the Terraform Apply step, we recommend you read about the Harness Terraform Infrastructure Provisioner and related Terraform Provision step in <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a>. This will help you see the scope of Terraform support in Harness.</p><p>Also, setting up the Terraform Apply step is nearly identical to setting up the Terraform Provision step, and this document will not repeat the steps. </p><h3>Review: Terraform Apply Overview</h3><p>The Terraform Apply step performs a <a href="https://www.terraform.io/docs/commands/apply.html">terraform apply</a> command using the Terraform template (config.tf) you set up in a Harness Terraform Infrastructure Provisioner.</p><p>Terraform Apply can be applied as an independent step to any Workflow. Terraform Apply steps can also be used together to perform multiple operations on the same infrastructure and Terraform workspace.</p><p>The Terraform Apply step is separate from the Terraform Provision step used in Pre-deployment steps in a Workflow, although you can have both in the same Workflow and have both run operations on the same infrastructure and Terraform workspace.</p><h4>Terraform Apply and Workflow Rollback</h4><p>Terraform Apply is intended for ad hoc provisioning anywhere in a Workflow. Consequently, the Terraform Apply step does not participate in a Workflow rollback when the Workflow fails.</p><p>Any provisioning performed by Terraform Apply is not rolled back. Only provisioning performed by the <a href="/article/uxwih21ps1-terraform-provisioner-step">Terraform Provision Step</a> is rolled back.</p><p>To delete the ad hoc provisioned infrastructure in the case of a Workflow failure, add the Terraform Destroy step to the Workflow <strong>Rollback Steps</strong> section. See <a href="/article/4egyxnse9r-terraform-destroy">Remove Provisioned Infra with Terraform Destroy</a>.</p><h4>What Can I do with Terraform Apply?</h4><p>Terraform Apply can be used to perform the many tasks offered by <a href="https://www.terraform.io/docs/providers/">Terraform Providers</a>. For example:</p><ul><li>Provision infrastructure.</li><li>Execute scripts on local and remote hosts.</li><li>Copy files from one server to another.</li><li>Query AWS for resource information.</li><li>Push files to Git.</li><li>Read data from APIs as JSON. </li><li>Read image metadata from a Docker registry.</li><li>Create a certificates for a development environment.</li><li>Create DNS records.</li><li>Inject containers with sensitive information such as passwords.</li></ul><h4>Terraform Apply and Terraform Provision Steps</h4><p>Harness also includes a Terraform Provision step that uses a Harness Infrastructure Provisioner to provision target deployment infrastructure, but the Terraform Provision step has the following limitations: </p><ul><li>Supported in Canary and Multi-Service Workflows only.</li><li>Support for AMI Blue/Green Workflows only.</li><li>May be applied in a Workflow&#39;s Pre-deployment Steps only and is intended to provision deployment target infrastructure.</li></ul><p>The Terraform Apply step can be applied anywhere in your Workflow and can be used to perform most Terraform operations.</p><h4>Using Terraform Apply with Terraform Provision</h4><p>While it is not necessary to use the Terraform Apply step with the standard Terraform Provision step in your Workflow, using them together can be an efficient method for provisioning and managing resources. </p><p>This scenario might involve the following steps:</p><ol><li>The target environment is dynamically provisioned using the Terraform Provision step in the Pre-Deployment steps of your Workflow. </li><li>The Workflow deploys your application to the dynamically provisioned target infrastructure. </li><li>The Terraform Apply step performs operations on the deployed hosts, services, etc. </li></ol><p>For information on the Terraform Provision step, see <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a>.</p><h4>Target Platform Roles and Policies</h4><p>If you use the Terraform Apply step to provision infrastructure on a target platform, such as AWS, the provisioning is performed by the Harness Delegate(s) in one of two ways:</p><ul><li>Provisioning is performed by the Delegate(s) associated with the Harness Cloud Provider specified in the Workflow Infrastructure Definition.</li><li>Provisioning is performed by the Delegate(s) selected in the Terraform Apply step&#39;s <strong>Delegate Selector</strong> settings, described below.</li></ul><p>The platform roles and policies needed to provision infrastructure must be present on the platform account used with the Delegate via Cloud Provider or the roles assigned to the Delegate host.</p><p>For example, if you want to provision AWS ECS resources, you would add the IAM roles and policies needed for creating AWS ECS resources to the account used by the Harness AWS Cloud Provider.</p><p>For a list of these roles and policies, see the related Terraform module for your target platform. For example, the <a href="https://registry.terraform.io/modules/infrablocks/ecs-cluster/aws/latest#required-permissions" target="_blank">Terraform AWS ECS Cluster Required Permissions</a>.</p><h3>Step 1: Create your Terraform Configuration File</h3><p>In this example, we create an AWS EC2 instance as a completely separate function of a Basic Workflow whose primary function is to deploy an application package in EC2.</p><p>This example shows the independence of the Terraform Apply step, and how it can be used to augment any Workflow and perform independent functions.</p><div class="note-callout">This procedure assumes you have read about the Harness Terraform Infrastructure Provisioner and related Terraform Provision step in <a href="/article/hh52ews03d-terraform-provisioning-with-harness">Terraform Provisioning with Harness</a>. This will help you see the scope of Terraform support in Harness.</div><p>Create your Terraform configuration file (config.tf) in your Git repo. The file used in this example creates an AWS EC2 instance using an AMI:</p><pre>variable &#34;region&#34; {}<br/>variable &#34;access_key&#34; {}<br/>variable &#34;secret_key&#34; {}<br/>variable &#34;tag&#34; {}<br/><br/>provider &#34;aws&#34; {<br/>  region  = &#34;${var.region}&#34;<br/>  access_key = &#34;${var.access_key}&#34;<br/>  secret_key = &#34;${var.secret_key}&#34;<br/>}<br/><br/>resource &#34;aws_instance&#34; &#34;tf_instance&#34; {<br/>   subnet_id     = &#34;subnet-05788710b1b06b6b1&#34;<br/>   security_groups = [&#34;sg-05e7b8bxxxxxxxxx&#34;]<br/>   key_name        = &#34;doc-delegate1&#34;<br/>   ami           = &#34;ami-0080e4c5bc078760e&#34;<br/>   instance_type = &#34;t2.micro&#34;<br/>   associate_public_ip_address = &#34;true&#34;<br/>  tags {<br/>    Name = &#34;${var.tag}&#34;<br/>   }<br/>}</pre><p></p><p>The access and secret keys will be provided when you add the Terraform Apply step to your Workflow. In Harness, you create secrets in Harness <a href="/article/au38zpufhr-secret-management">Secrets Management</a> and then you can use them in other Harness components.</p><div class="note-callout">You can also use a Terraform Apply step with the <a href="https://www.terraform.io/docs/providers/vault/index.html">HashiCorp Vault</a> provider to access Vault credentials for a Terraform configuration.</div><h3>Step 2: Add a Terraform Infrastructure Provisioner</h3><p>In Harness, add a Terraform Infrastructure Provisioner that uses the Terraform configuration file. This process is described in detail in the <a href="/article/ux2enus2ku-add-terraform-scripts">Add Terraform Scripts</a> topic.</p><p>Later, when you are adding the Terraform Apply step that uses this Terraform Infrastructure Provisioner, the inputs for your config.tf file are added. You can add tfvar files also. See <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a>.</p><p>Once your Terraform Infrastructure Provisioner is added, you can use it in the Terraform Apply step in your Workflow.</p><h3>Step 3: Add Terraform Apply to the Workflow</h3><p>In your Workflow, in any section, click <strong>Add Command</strong>. The <strong>Add Command</strong> dialog appears.</p><p>In <strong>Add Command</strong>, select <strong>Terraform Apply</strong>. The <strong>Terraform Apply</strong> settings appear.</p><p>The steps for filling out the dialog are the same as those for the Terraform Provision step described in <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a>.</p><p>You simply select the Terraform Infrastructure Provisioner you set up earlier using the Terraform script, fill in the input values, and select other settings like Workspace.</p><p>Refer to <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a> for details on each setting.</p><p>Let&#39;s look at an example where the Terraform Apply step is added as an independent step to a Workflow that deploys an application package (TAR file) to an EC2 instance.</p><p>The Workflow will deploy the application package as intended, and it will also execute the Terraform Apply step to create a separate EC2 instance.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/jaxppd8w9j/1620840163880/lou-8-o-my-7-ja-5-e-5-ib-y-1-w-pqqsu-4-v-pdltpb-3-yll-cs-zgf-bwtl-vt-ec-iftz-9-t-4-sdel-ub-9-e-ux-xn-9-gf-j-6-o-iqug-8-q-d-8-wetaal-gfyiil-dz-kx-bqak-sec-11-jyc-xj-hnuo-8-plx-bafbn-6-gm-3-k-5-rr" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><p>The steps for installing the application package are described in the <a href="/article/6pwni5f9el">Traditional Deployments</a> guide. Let&#39;s look at the Terraform Apply Step.</p><p>The Terraform script listed earlier will create an EC2 instance. This script is used by the Terraform Infrastructure Provisioner that the Terraform Apply step will use.</p><p>In the Terraform Apply step you supply the values for the input variables in the Terraform script.</p><p>Click <strong>Populate Variables</strong> and Harness will pull all of the input variables from the Terraform script you added to the Terraform Infrastructure Provisioner you selected.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/jaxppd8w9j/1620948448203/image.png"/></figure><p>It can table a moment to populate the variables.</p><p>You can see that the AWS access and secret keys are inputs in this configuration. You can use <a href="https://docs.harness.io/article/au38zpufhr-secret-management">Harness Secrets Management</a> to provide encrypted text secrets in the Terraform Apply step.</p><p>When the Workflow is deployed, you can see the traditional deployment of the application package succeed and the Terraform Apply step executed successfully.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/jaxppd8w9j/1620840164231/5-g-1-q-zxm-lkpp-fs-ccwqu-qyf-nsb-5-o-we-5-a-o-1-lg-2-gkw-fu-31-al-8-lrp-2-oat-5-f-9-w-whx-9-li-7-h-d-jvghr-6-cy-3-blbow-xisyri-yyyqh-fn-i-0-tz-my-svk-dfea-qzh-esczr-4-y-4-z-xd-veyimq-kcgh-oa"/></figure><p></p><p>Here is the Terraform Apply step output (with some lines omitted):</p><pre>Branch: master<br/>Normalized Path: create<br/>terraform init <br/>Initializing provider plugins...<br/>...<br/>* provider.aws: version = &#34;~&gt; 2.23&#34;<br/><br/>Terraform has been successfully initialized!<br/>...<br/>terraform apply -input=false tfplan<br/><br/>aws_instance.tf_instance: Creating...<br/>  ami:                          &#34;&#34; =&gt; &#34;ami-0080e4c5bc078760e&#34;<br/>  arn:                          &#34;&#34; =&gt; &#34;&lt;computed&gt;&#34;<br/>  ...<br/>  instance_type:                &#34;&#34; =&gt; &#34;t2.micro&#34;<br/>	...<br/>  key_name:                     &#34;&#34; =&gt; &#34;doc-delegate1&#34;<br/>  ...<br/>  security_groups.#:            &#34;&#34; =&gt; &#34;1&#34;<br/>  security_groups.2062602533:   &#34;&#34; =&gt; &#34;sg-05e7b8bxxxxxxxxx&#34;<br/>  source_dest_check:            &#34;&#34; =&gt; &#34;true&#34;<br/>  subnet_id:                    &#34;&#34; =&gt; &#34;subnet-05788710b1b06b6b1&#34;<br/>  tags.%:                       &#34;&#34; =&gt; &#34;1&#34;<br/>  tags.Name:                    &#34;&#34; =&gt; &#34;doctfapply&#34;<br/>  tenancy:                      &#34;&#34; =&gt; &#34;&lt;computed&gt;&#34;<br/>  volume_tags.%:                &#34;&#34; =&gt; &#34;&lt;computed&gt;&#34;<br/>  vpc_security_group_ids.#:     &#34;&#34; =&gt; &#34;&lt;computed&gt;&#34;<br/><br/>aws_instance.tf_instance: Still creating... (10s elapsed)<br/><br/>aws_instance.tf_instance: Still creating... (20s elapsed)<br/><br/>aws_instance.tf_instance: Still creating... (30s elapsed)<br/><br/>aws_instance.tf_instance: Creation complete after 31s (ID: i-0b20b148aec6c9239)<br/><br/>Apply complete! Resources: 1 added, 0 changed, 1 destroyed.<br/><br/>terraform output --json &gt; /home/ec2-user/harness-delegate/./repository/terraform/lnFZRF6jQO6tQnB9znMALw/Z3B5PqktSViUQgNCjhR5vQ/terraform/create/terraform-eoOIwEfCTw-dTJ8RLC_tcg-99TFSMfVRfOIbqJreffg6g.tfvars<br/><br/>Waiting: [15] seconds for resources to be ready<br/><br/>Script execution finished with status: SUCCESS</pre><p></p><p>The output looks like a standard <code>terraform apply</code> output.</p><p>As you can see, the Terraform config.tf file was run on the Delegate using Terraform and created the AWS EC2 instance. This was all performed as an auxiliary step to the Workflow, showing the independence of the Terraform Apply step.</p><h3>Option: AWS Cloud Provider, Region, Role ARN</h3><p></p><div class="note-callout">Currently, this feature is behind the Feature Flag <code>TERRAFORM_AWS_CP_AUTHENTICATION</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature.</div><p>If you want to use a specific AWS role for this step&#39;s provisioning, you can select the AWS Cloud Provider, Region, and Role ARN. You can select any of these options, or all of them.</p><p>These options allow you to use different roles for different Terraform steps, such as one role for the Terraform Plan step and a different role for the Terraform Provision or Apply steps.</p><ul><li><strong>AWS Cloud Provider:</strong> the AWS Cloud Provider selected here is used for authentication.<br/>At a minimum, select the <strong>AWS Cloud Provider</strong> and <strong>Role ARN</strong>. When used in combination with the AWS Cloud Provider option, the Role ARN is assumed by the Cloud Provider you select.<br/>The <strong>AWS Cloud Provider</strong> setting can be templated.<div class="note-callout">You need to select an AWS Cloud Provider even if the Terraform Infrastructure Provisioner you selected uses a manually-entered template body. Harness needs access to the AWS API via the credentials in the AWS Cloud Provider.</div></li><li><strong>Region:</strong> the AWS region where you will be provisioning your resources. If not region is specified, Harness uses <code>us-east-1</code>.</li><li><strong>Role ARN:</strong> enter the Amazon Resource Name (ARN) of an AWS IAM role that Terraform assumes when provisioning. This allows you to tune the step for provisioning a specific AWS resource. For example, if you will only provision AWS S3, then you can use a role that is limited to S3.<br/>At a minimum, select the <strong>AWS Cloud Provider</strong> and <strong>Role ARN</strong>. When used in combination with the AWS Cloud Provider option, the Role ARN is assumed by the Cloud Provider you select.<br/>You can also use <a href="/article/9dvxcegm90-variables">Harness variable expressions</a> in <strong>Role ARN</strong>. For example, you can create a Service or Workflow variable and then enter its expression in <strong>Role ARN</strong>, such as <code>${serviceVariables.roleARN}</code> or <code>${workflow.variables.roleArn}</code>.</li></ul><h4>Environment Variables</h4><p>If you use the <strong>AWS Cloud Provider</strong> and/or <strong>Role ARN</strong> options, do not add the following environment variables in the step&#39;s <strong>Environment Variables</strong> settings:</p><ul><li><code>AWS_ACCESS_KEY_ID</code></li><li><code>AWS_SECRET_ACCESS_KEY</code></li><li><code>AWS_SESSION_TOKEN</code></li></ul><p>Harness generates these keys using the the <strong>AWS Cloud Provider</strong> and/or <strong>Role ARN</strong> options. If you also add these in <strong>Environment Variables</strong>, the step will fail.</p><h3>Option: Inherit Configurations from Terraform Plan</h3><p>You can use the <strong>Inherit following configurations from Terraform Plan</strong> setting to inherit the Terraform plan from a prior Terraform Provision step that has the <strong>Set as Terraform Plan</strong> option selected.</p><p>Harness runs the Terraform provision again and points to the plan, runs a Terraform refresh, then a plan, and finally executes the new plan. Technically, this is a different plan.</p><p>If you want use the <u>actual plan</u> because of security or audit requirements, in the prior Terraform Provision step select both the <strong>Set as Terraform Plan</strong> and <strong>Export Terraform Plan to Apply Step</strong>.</p><p>If you want to avoid the Terraform refresh, in your Terraform Infrastructure Provisioner, enable the <strong>Skip Terraform Refresh when inheriting Terraform plan</strong> setting. See <a href="/article/ux2enus2ku-add-terraform-scripts#option_2_skip_terraform_refresh_when_inheriting_terraform_plan">Skip Terraform Refresh When Inheriting Terraform Plan</a>.</p><h3>Option: Remote and Local State with Terraform Apply Step</h3><p>In <strong>Backend Configuration (Remote State)</strong>, Harness enables you to use Terraform remote and local state files, and you can use multiple Terraform Apply steps with the same state files.</p><p>The general guidelines for using the same remote or local state files are:</p><ul><li><strong>Remote state files</strong>: to use the same remote state file, Terraform Apply steps must use the <strong>Backend Configuration (Remote state)</strong> setting.</li><li><strong>Local state files:</strong> to use the same local state file, Terraform Apply steps must use the same Environment, Terraform Infrastructure Provisioner, and workspace. The Environment is specified when you create the Workflow that will contain the Terraform Apply step(s). </li></ul><h4>Using Remote State with Terraform Apply</h4><p>To use the same remote state file, Terraform Apply steps must use the <strong>Backend Configuration (Remote state)</strong> setting and the same Terraform Infrastructure Provisioner.</p><p>You add the backend configs (remote state variables) for remote state in the <strong>Backend Configuration (Remote state)</strong> settings.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/jaxppd8w9j/1620948895310/image.png"/></figure><p>If you have two Terraform Apply steps that use the same Terraform Infrastructure Provisioner and the same workspace, then they are both using the same remote state file. </p><p>A workspace is really a different state file. If you have two Terraform Apply steps that use the same Terraform Infrastructure Provisioner but different workspaces, then they are using separate state files.</p><p>For example, if you have a Pipeline with a Build Workflow containing a Terraform Apply step followed by a Canary Workflow containing a Terraform Apply step, in order for both steps to use the same remote state file, the following criteria must be met:</p><ul><li>Both Terraform Apply steps must use the same Infrastructure Provisioner.</li><li>Both Terraform Apply steps must use the same workspace.</li></ul><h4>Using Local State with Terraform Apply</h4><p>If you do not use the <strong>Backend Configuration (Remote state)</strong> setting, by default, Terraform uses the local backend to manage <a href="https://www.terraform.io/docs/state/">state</a> in a local <a href="https://www.terraform.io/docs/configuration/syntax.html">Terraform language</a> file named terraform.tfstate on the disk where you are running Terraform (typically, the Harness Delegate(s)). </p><p>An individual local state file is identified by Harness using a combination of the Harness Environment, Terraform Infrastructure Provisioner, and workspace settings.</p><p>In fact, the local state is stored by Harness using an entity ID in the format EnvironmentID+ProvisionerID+WorkspaceName. This combination uses the Environment selected for the Workflow (or empty), and the Provisioner and workspace (or empty) selected in the <strong>Terraform Apply</strong> step.</p><p>For two Terraform Apply steps to use the <em>same</em> local state file, they must use the same criteria:</p><ul><li>Environment (via their Workflow settings).</li><li>Terraform Infrastructure Provisioner.</li><li>Workspace.</li></ul><p>For example, let&#39;s imagine one Terraform Apply step in a Build Workflow with no Environment set up and another Terraform Apply step in a Canary Workflow that uses an Environment.</p><p>The local backend state file that was created in the first Terraform Apply step is not used by the second Terraform Apply step because they do not use the same Environment. In fact, the Build Workflow uses no Environment.</p><p>Consequently, a <a href="https://docs.harness.io/article/9pvvgcdbjh-terrform-provisioner#terraform_destroy">Terraform Destroy</a> step in the Canary Workflow would not affect the Terraform local state created by the Build Workflow. In this case, it is best to use a separate Terraform Infrastructure Provisioner for each Terraform Apply step.</p><p>In order for a Terraform Destroy step to work, the <strong>Provisioner</strong> and <strong>Workspace</strong> settings in it must match those of the Terraform Apply step whose operation(s) you want destroyed. Consequently, it must also be part of a Workflow using the same Environment.</p><h3>Option: Additional Settings</h3><p>There are additional settings for Targets, Workspace, Delegate Selectors, and Terraform Environment Variables.</p><p>These are the same settings you will find in the Terraform Provision step.</p><p>For details on these features, see <a href="/article/uxwih21ps1-terraform-provisioner-step">Provision using the Terraform Provision Step</a>.</p><h3>Option: Local State and Delegates</h3><p>If the local state file criteria described above are met, Harness ensures that the same local state file is used regardless of which Harness Delegate performs the deployment.</p><p>You might have multiple Delegates running and a Workflow containing a Terraform Apply step that uses a local state file. Harness manages the local state file to ensure that if different Delegates are used for different deployments of the Workflow, the same local state file is used. </p><p>This allows you to deploy a Workflow, or even multiple Workflows, using the same local state file and not worry about which Delegate is used by Harness.</p><p>If you like, you can ensure that Terraform Apply steps use the same Delegate using the <a href="https://docs.harness.io/article/9pvvgcdbjh-terrform-provisioner">Delegate Selector</a> setting in the Terraform Apply steps.</p><h3>Option: Terraform Environment Variables</h3><p>If the Terraform script used in the Terraform Infrastructure Provisioner you selected uses environment variables, you can provide values for those variables here.</p><p>For any environment variable, provide a name, type, and value.</p><p>Click <strong>Add</strong>.</p><p>Enter a name, type, and value for the environment variable. For example: <strong>TF_LOG</strong>, <strong>Text</strong>, and <code>TRACE</code>.</p><p>If you select Encrypted Text, you must select an existing Harness <a href="/article/ygyvp998mu-use-encrypted-text-secrets">Encrypted Text secret</a>.</p><p>You can use Harness <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow variables</a> and <a href="/article/9dvxcegm90-variables">expression variables</a> for the name and value.</p><h3>Terraform Plan Human Readable</h3><p>Harness provides expressions to view the plan in a more human readable format:</p><ul><li><code>${terraformApply.tfplanHumanReadable}</code></li><li><code>${terraformDestroy.tfplanHumanReadable}</code></li></ul><h3>Next Steps</h3><ul><li><a href="/article/o22jx8amxb-add-an-infra-provisioner">Infrastructure Provisioners Overview</a></li><li><a href="/article/au38zpufhr-secret-management">Secrets Management</a></li></ul><p> </p>