type: article
article_id: 4ohedfzz1c
user_id: mfr0nxh4be
category_id: 5mu8983wa0
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: Verify Deployments with Stackdriver Logging
slug: 3-verify-deployments-with-stackdriver
description: How to add Stackdriver to a Harness Workflow, enabling Harness to analyze
  Stackdriver data to verify, rollback, and improve deployments.
short_version: Harness can analyze Stackdriver data to verify, rollback, and improve
  deployments.
tags:
- Stackdriver
- Verification Provider
- verification
- Deployment Verification
- Workflow
- APM
- application performance monitoring
- log
- risk analysis
- expression
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2021-05-12T17:22:47.747863Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Verify Deployments with Stackdriver Logging
  description: How to add Stackdriver to a Harness Workflow, enabling Harness to analyze
    Stackdriver data to verify, rollback, and improve deployments.
  short_version: Harness can analyze Stackdriver data to verify, rollback, and improve
    deployments.
  body: '<p>Harness can analyze Stackdriver data and analysis to verify, rollback,
    and improve deployments. To apply this analysis to your deployments, you set up
    Stackdriver as a verification step in a Harness Workflow.</p><p>This topic covers
    how to set up Stackdriver Logs in a Harness Workflow, and provides a summary of
    Harness verification results.</p><div class="tip-callout">In order to obtain the
    names of the host(s), pod(s), or container(s) where your service is deployed,
    the verification provider should be added to your workflow <em>after</em> you
    have run at least one successful deployment.</div><h3 id="deployment_verification_setup">In
    this topic:</h3><ul><li><a href="#before_you_begin">Before You Begin</a></li><li><a
    href="#visual_summary">Visual Summary</a></li><li><a href="#step_1_set_up_the_deployment_verification">Step
    1: Set up the Deployment Verification</a></li><li><a href="#step_2_search_keywords">Step
    2: Search Keywords</a></li><li><a href="#step_3_host_name_field">Step 3: Host
    Name Field</a></li><li><a href="#step_4_message_field">Step 4: Message Field</a></li><li><a
    href="#step_5_algorithm_sensitivity">Step 5: Algorithm Sensitivity</a></li><li><a
    href="#step_6_baseline">Step 6: Baseline</a></li><li><a href="#step_7_confirm_your_settings">Step
    7: Confirm Your Settings</a></li><li><a href="#review_harness_expression_support_in_cv_settings">Review:
    Harness Expression Support in CV Settings</a></li><li><a href="#step_8_view_verification_results">Step
    8: View Verification Results</a></li><li><a href="#next_steps">Next Steps</a></li></ul><p></p><h3>Before
    You Begin</h3><ul><li>Set up a Harness Application, containing a Service and Environment.
    See <a href="/article/bucothemly-application-configuration">Create an Application</a>.</li><li>See
    the <a href="/article/jn0axefdat-stackdriver-and-harness-overview">Stackdriver
    Verification Overview</a>.</li></ul><p></p><h3>Visual Summary</h3><p>Here&#39;s
    an example of a completed Stackdriver setup for verification.</p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/4ohedfzz1c/1588116243487/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><h3>Step
    1: Set up the Deployment Verification</h3><p></p><p>To verify your deployment
    with Stackdriver, do the following:</p><ol><li>Ensure that you have added Google
    Cloud Platform as a Cloud Provider provider, as described in <a href="/article/dysdvm3vo7-stackdriver-connection-setup">Connect
    to Stackdriver</a>.</li><li>In your Workflow, under <strong>Verify Service</strong>,
    click <strong>Add Step</strong>.</li><li>In the resulting <strong>Add Step</strong> settings,
    select <strong>Log Analysis</strong> &gt; <strong>Stackdriver</strong>.</li><li>Click
    <strong>Next</strong>. The <strong>Configure </strong><strong>Stackdriver</strong>
    settings appear.</li><li>In <strong>GCP Cloud Provider</strong>, select the <a
    href="/article/whwnovprrb-cloud-providers#google_cloud_platform_gcp">Google Cloud
    Platform (GCP) Cloud Provider</a> you set up in Harness.<br/>You can also enter
    variable expressions, such as: <code>${serviceVariable.stackdriver_connector_name}</code>.</li></ol><div
    class="note-callout">If the <strong>GCP Cloud Provider</strong> field contains
    an expression, the <strong>Region</strong> field must also use an expression.</div><ol><li
    style="counter-increment:li 5" start="6">In <strong>Region</strong>, select the
    GCP <a href="https://cloud.google.com/compute/docs/regions-zones/">region</a>
    where the application is hosted. The Stackdriver API uses a service-specific notion
    of location. Harness uses the name of a region. You can find the region in Stackdriver
    Metrics Explorer by selecting the <strong>location</strong> column:<figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/9yowx4ouu0/1584736919293/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure>You
    can also enter a variable expression for the region, such as <code>${env.name}</code>.<div
    class="note-callout">Because Harness does not currently support multi-region load
    balancers, you must add a Stackdriver step for each region. If the <strong>GCP
    Cloud Provider</strong> field contains an expression, the <strong>Region</strong>
    field must also use an expression.</div></li><li>Select <strong>Log Verification</strong>.</li></ol><p></p><h3>Step
    2: Search Keywords</h3><p>Enter search keywords for your query. You can use the
    same filters you have in GCP <strong>Logs Viewer</strong>.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/g5l03na9zo/1560883046458/image.png"/></figure><p>Simply
    copy a filer entry into <strong>Search Keywords</strong>:</p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/g5l03na9zo/1560883473078/image.png"/></figure><p>To
    use multiple filter entries, you can place an <strong>AND</strong> between them
    or use multiline entries. For example:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/g5l03na9zo/1560883576302/image.png"/></figure><p>For
    advanced filter examples, see <a href="https://cloud.google.com/logging/docs/view/filters-library"
    target="_blank">Advanced filters library</a> from GCP.</p><h4>Troubleshooting
    queries</h4><p>Once you try to verify the deployment and you can encounter an
    error as follows:</p><p><code>Execution logs are not available for old executions.</code></p><p><strong>Solution</strong></p><p>Update
    your query to include the required statement (<code>jsonPayload.message:*</code>
    in this case), as follows:</p><pre>resource.type=&#34;k8s_container&#34; resource.labels.cluster_name=&#34;guse4-kube-poc&#34;
    resource.labels.namespace_name=&#34;rc&#34; <br/>resource.labels.container_name=&#34;hello-container&#34;
    <br/>jsonPayload.message:* <br/>severity=&#34;ERROR&#34;</pre><p></p><h3>Step
    3: Host Name Field</h3><p>Enter the log field that contains the name of the host
    for which you want logs. You can enter a pod ID or name.</p><p>For example, the
    query in <strong>Search Keywords</strong> looks for pods labelled <code>nginx-deployment</code>:</p><pre>resource.type=&#34;container&#34;<br/>resource.labels.pod_id:&#34;nginx-deployment-&#34;</pre><p>In
    <strong>Host Name Field</strong>, you would enter <strong>pod_id</strong> because
    it is the log field containing the pod name. In a log, this field will be in the
    resource section:</p><pre>...<br/> resource: {<br/>  labels: {<br/>   cluster_name:  &#34;doc-example&#34;    <br/>   container_name:  &#34;harness-delegate-instance&#34;    <br/>   instance_id:  &#34;1733097732247470454&#34;    <br/>   namespace_id:  &#34;harness-delegate&#34;    <br/><strong>   pod_id:  &#34;harness-sample-k8s-delegate-wverks-0&#34;    <br/></strong>   project_id:  &#34;exploration-161417&#34;    <br/>   zone:  &#34;us-central1-a&#34;    <br/>  }<br/>  type:  &#34;container&#34;   <br/>
    }<br/>...</pre><p></p><h3>Step 4: Message Field</h3><p>Enter the field by which
    the messages are usually indexed. You can also enter variable expressions, such
    as: <code>${serviceVariable.message_field}</code>.</p><h4>Troubleshooting Message
    Field Entries</h4><p>If you select <code>jsonPayload.message</code> as Message
    Field, but the queries return log messages that do not have the field <code>jsonPayload.message</code>,
    the workflow will fail.</p><p><strong>Solution</strong></p><p>Add a statement
    in your query to ensure that the query only fetches logs which always have <code>jsonPayload.message</code>
    field included, as follows.</p><p><code>jsonPayload.message:*</code></p><p></p><h3>Step
    5: Algorithm Sensitivity</h3><p>Select the Algorithm Sensitivity. See <a href="/article/0avzb5255b-cv-strategies-and-best-practices#algorithm_sensitivity_and_failure_criteria">CV
    Strategies, Tuning, and Best Practices</a>.</p><p></p><h3>Step 6: Baseline</h3><p>Select
    the baseline time unit for monitoring. For example, if you select <strong>For
    4 hours</strong>, Harness will collect the logs for the last 4 hours as the baseline
    for comparisons with future logs. If you select <strong>Custom Range</strong>
    you can enter a <strong>Start Time</strong> and <strong>End Time.</strong></p><p>When
    you are finished, the dialog will look something like this:</p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/4ohedfzz1c/1580934593943/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><h3>Step
    7: Confirm Your Settings</h3><p>Click <strong>Test</strong> to confirm your settings.
    In the testing assistant, select a host and click <strong>Run</strong>. When you
    have confirmed your settings, click <strong>Submit</strong>.</p><p>The Stackdriver
    verification step is added to your Workflow.</p><p></p><h3>Review: Harness Expression
    Support in CV Settings</h3><p>You can use expressions (<code>${...}</code>) for
    <a href="/article/7bpdtvhq92-workflow-variables-expressions">Harness built-in
    variables</a> and custom <a href="/article/eb3kfl8uls-service-configuration">Service</a>
    and <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow</a>
    variables in the settings of Harness Verification Providers.</p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/other/1586812006289/image.png" style="max-height:50%;max-width:50%"
    data-hd-height="50%" data-hd-width="50%"/></figure><p>Expression support lets
    you template your Workflow verification steps. You can add custom expressions
    for settings, and then provide values for those settings at deployment runtime.
    Or you can use Harness built-in variable expressions and Harness will provide
    values at deployment runtime automatically.</p><p></p><h3>Step 8: View Verification
    Results</h3><p>Once you have deployed your Workflow (or Pipeline) using the Stackdriver
    verification step, you can automatically verify performance across your deployment.
    For more information, see <a href="/article/m220i1tnia-workflow-configuration">Add
    a Workflow</a> and <a href="/article/zc1u96u6uj-pipeline-configuration">Add a
    Pipeline</a>.</p><h4>Workflow Verification</h4><p>To see the results of Harness
    machine-learning evaluation of your Stackdriver verification, in your Workflow
    or pipeline deployment you can expand the <strong>Verify Service</strong> step
    and then click the <strong>Stackdriver</strong> step.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/g5l03na9zo/1557785647550/image.png"/></figure><h4>Continuous
    Verification</h4><p>You can also see the evaluation in the <strong>Continuous
    Verification</strong> dashboard. The Workflow verification view is for the DevOps
    user who developed the Workflow. The <strong>Continuous Verification</strong>
    dashboard is where all future deployments are displayed for developers and others
    interested in deployment analysis.</p><p></p><h3>Next Steps</h3><ul><li><a href="/article/m0j49kz112-verify-deployments-with-stackdriver-metrics">Verify
    Deployments with Stackdriver Metrics</a></li><li><a href="/article/htvzryeqjw-configuration-as-code">Configuration
    as Code</a></li><li><a href="/article/ven0bvulsj-users-and-permissions">Users
    and Permissions</a></li><li><a href="/article/0avzb5255b-cv-strategies-and-best-practices#algorithm_sensitivity_and_failure_criteria">CV
    Strategies, Tuning, and Best Practices</a></li></ul><p></p>'
  slug: 3-verify-deployments-with-stackdriver
  tags:
  - Stackdriver
  - Verification Provider
  - verification
  - Deployment Verification
  - Workflow
  - APM
  - application performance monitoring
  - log
  - risk analysis
  - expression
  is_live: true
