<p>Harness can analyze Datadog metrics to verify, rollback, and improve deployments. To apply this analysis to your deployments, you set up Datadog as a verification step in a Harness Workflow.</p><p>Once you run a deployment, and Datadog preforms verification, Harness&#39; machine-learning verification analysis will assess the risk level of the deployment.</p><div class="tip-callout">In order to obtain the names of the host(s), pod(s), or container(s) where your service is deployed, the verification provider should be added to your workflow <em>after</em> you have run at least one successful deployment.</div><p>In this topic:</p><ul><li> <a href="#before_you_begin">Before You Begin</a></li><li> <a href="#limitations">Limitations</a></li><li> <a href="#visual_summary">Visual Summary</a></li><li> <a href="#step_1_set_up_the_deployment_verification">Step 1: Set Up the Deployment Verification</a></li><li> <a href="#step_2_datadog_metrics_server">Step 2: Datadog Metrics Server</a></li><li> <a href="#step_3_datadog_monitoring">Step 3: Datadog Monitoring</a></li><li> <a href="#step_4_infrastructure_metrics">Step 4: Infrastructure Metrics</a></li><li> <a href="#step_5_datadog_custom_metrics">Step 5: Datadog Custom Metrics</a></li><li> <a href="#step_6_expression_for_host_container_name">Step 6: Expression for Host/Container name</a></li><li> <a href="#step_7_analysis_time_duration">Step 7: Analysis Time duration</a></li><li> <a href="#step_8_baseline_for_risk_analysis">Step 8: Baseline for Risk Analysis</a></li><li> <a href="#step_9_algorithm_sensitivity">Step 9: Algorithm Sensitivity</a></li><li> <a href="#step_10_execute_with_previous_steps">Step 10: Execute with previous steps</a></li><li> <a href="#step_11_verify_your_settings">Step 11: Verify your Settings</a></li><li> <a href="#review_datadog_and_ecs">Review: Datadog and ECS</a></li><li> <a href="#review_harness_expression_support_in_cv_settings">Review: Harness Expression Support in CV Settings</a></li><li> <a href="#step_12_view_verification_results">Step 12: View Verification Results</a></li><li> <a href="#next_steps">Next Steps</a></li></ul><p></p><h3>Before You Begin</h3><ul><li>Set up a Harness Application, containing a Service and Environment. See  <a href="https://docs.harness.io/article/bucothemly-application-configuration">Create an Application</a>.</li><li>See the  <a href="/article/ong5rbbn49-datadog-verification-overview">Datadog Verification Overview</a>.</li><li>Make sure you <a href="/article/yqris5svub-1-datadog-connection-setup">Connect to Datadog</a>.</li></ul><p></p><h3>Limitations</h3><p>For Harness Workflows, Datadog metrics verification is supported only for infrastructure metrics and Datadog custom metrics, as described in this topic. </p><p>Harness does not provide out of the box support for Datadog APM traces because Datadog does not support API calls for those.</p><h3>Visual Summary</h3><p>Here&#39;s an example of a Datadog Metrics configuration for verification.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/vd4jgv41io/1580425259291/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><p></p><h3>Step 1: Set Up the Deployment Verification</h3><p>To verify your deployment with Datadog Metrics, do the following:</p><ol><li>Ensure that you have added Datadog as a verification provider, as described in <a href="/article/yqris5svub-1-datadog-connection-setup">Connect to Datadog</a>.</li><li>In your workflow, under <strong>Verify Service</strong>, click <strong>Add Verification</strong>.</li><li>In the resulting <strong>Add Step</strong> settings, select either <strong>Performance Monitoring</strong> &gt; <strong>Datadog Metrics.</strong></li><li>Click <strong>Next</strong>. The <strong>Datadog Metrics</strong> settings appear.</li></ol><p></p><h3>Step 2: Datadog Metrics Server</h3><p>Select the Datadog verification provider you added earlier in <a href="/article/yqris5svub-1-datadog-connection-setup">Datadog Connection Setup</a>.</p><p>You can also enter variable expressions, such as:</p><p> <code>${serviceVariable.datadog_connector_name}</code></p><h3>Step 3: Datadog Monitoring</h3><p>Here you can select any of the Datadog API metrics. For a list of the API metrics, see <a href="https://docs.datadoghq.com/integrations/docker_daemon/#data-collected" target="_blank">Data Collected</a> from Datadog.</p><h3>Step 4: Infrastructure Metrics</h3><p>Select the <a href="https://docs.datadoghq.com/integrations/docker_daemon/#metrics">Docker</a>, <a href="https://docs.datadoghq.com/agent/kubernetes/metrics/#kubernetes">Kubernetes</a>, and <a href="https://docs.datadoghq.com/integrations/ecs_fargate/#metrics">ECS</a> metrics to use.</p><h3>Step 5: Datadog Custom Metrics</h3><ol><li>In <strong>Hostname Identifier</strong>, enter the field name in Datadog for the host name.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/other/1565987415754/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/other/1565987415754/image.png"/></a></figure>This would be the hosts value used when searching:<figure><a href="https://files.helpdocs.io/kw8ldg1itf/other/1565987565920/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/other/1565987565920/image.png"/></a></figure></li><li>In <strong>Metric Type</strong>, select the metric to use. To use multiple types, click <strong>Add</strong>.</li><li>In <strong>Display Name</strong>, enter a name to identify this metric in the Harness dashboards.</li><li>In <strong>Group Name</strong>, enter the name of the service or request context to which the metric relates. For example, <strong>Login</strong>.</li><li>In <strong>Metric Name</strong>, enter the metric you want to use. These are the metrics you will see in the Datadog Metrics Explorer <strong>Graph</strong> menu:</li></ol><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1559933689526/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1559933689526/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><p></p><h3>Step 6: Expression for Host/Container name</h3><p>Enter an expression that evaluates to the host/container/pod name tagged in the Datadog events.</p><p>For example, in Datadog, a Kubernetes deployment might use the tag <strong>pod_name</strong> to identify the pod where the microservice is deployed.</p><p>Find the where the same name is identified in the deployment environment, and use that path as the expression.For example, locate the pod name in the Datadog <strong>Event Stream</strong> page:</p><ol><li>In <strong>Datadog</strong>, click <strong>Events</strong>.</li><li>Locate an event using a search query. For more information, see <a href="https://docs.datadoghq.com/graphing/event_stream/" target="_blank">Event Stream</a> from Datadog.</li><li>Expand the event by click the the ellipsis at the end of the event title.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536959856299/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536959856299/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure></li><li>Look through the event details and locate the tag that lists the pod name for the instance where the service is deployed. In our example, the tag is <strong>pod_name</strong>.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536959897787/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536959897787/image.png"/></a></figure></li><li>Next, look in the JSON for the host/container/pod in the deployment environment and identify the label containing the same hostname. The path to that label is what the expression should be in <strong>Expression for Host/Container name</strong>. The default expression is <strong>${host.hostName}</strong>. In most cases, this expression will work.</li></ol><h3>Step 7: Analysis Time Duration</h3><p>Set the duration for the verification step. If a verification step exceeds the value, the workflow <a href="/article/m220i1tnia-workflow-configuration#failure_strategy">Failure Strategy</a> is triggered. For example, if the Failure Strategy is <strong>Ignore</strong>, then the verification state is marked <strong>Failed</strong> but the workflow execution continues.</p><p>See <a href="https://docs.harness.io/article/0avzb5255b-cv-strategies-and-best-practices">CV Strategies, Tuning, and Best Practices</a>.</p><h3>Step 8: Baseline for Risk Analysis</h3><p>See <a href="https://docs.harness.io/article/0avzb5255b-cv-strategies-and-best-practices">CV Strategies, Tuning, and Best Practices</a>.</p><h3>Step 9: Algorithm Sensitivity</h3><p>See <a href="https://docs.harness.io/article/0avzb5255b-cv-strategies-and-best-practices#algorithm_sensitivity_and_failure_criteria">CV Strategies, Tuning, and Best Practices</a>.</p><h3>Step 10: Execute with Previous Steps</h3><p>Check this checkbox to run this verification step in parallel with the previous steps in <strong>Verify Service</strong>.</p><h3>Step 11: Verify your Settings</h3><ol><li>Click <strong>TEST</strong>. Harness verifies the settings you entered.</li><li>When you are finished, click <strong>SUBMIT</strong>. The Datadog verification step is added to your workflow.</li></ol><h3>Review: Datadog and ECS</h3><p>For <a href="/article/08whoizbps-ecs-deployments-overview">ECS-based deployments</a>, Datadog uses the container ID to fetch data for both metrics and logs. Harness can fetch the container ID if the Harness Delegate is running on same ECS cluster as the container or the Delegate must be in same AWS VPC and <strong>port 51678</strong> must be open for incoming traffic.</p><div class="note-callout">Getting the container ID is available when you are using some of the later versions of ECS agents in your container instances. AWS documentation does not explicitly mention what agent version is needed. Hence, Harness first looks the version up, and if it there, Harness can proceed. If it is not there, Harness queries the port as a backup to get the container ID.</div><h3>Review: Harness Expression Support in CV Settings</h3><p>You can use expressions (<code>${...}</code>) for <a href="/article/7bpdtvhq92-workflow-variables-expressions">Harness built-in variables</a> and custom <a href="/article/eb3kfl8uls-service-configuration">Service</a> and <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow</a> variables in the settings of Harness Verification Providers.</p><p>Expression support lets you template your Workflow verification steps. You can add custom expressions for settings, and then provide values for those settings at deployment runtime. Or you can use Harness built-in variable expressions and Harness will provide values at deployment runtime automatically.</p><h3>Step 12: View Verification Results</h3><p>Once you have deployed your workflow (or pipeline) using the Datadog verification step, you can automatically verify cloud application and infrastructure performance across your deployment. For more information, see <a href="/article/m220i1tnia-workflow-configuration">Add a Workflow</a> and <a href="/article/zc1u96u6uj-pipeline-configuration">Add a Pipeline</a>.</p><h4>Workflow Verification</h4><p>To see the results of Harness machine-learning evaluation of your Datadog verification, in your workflow or pipeline deployment you can expand the <strong>Verify Service</strong> step and then click the <strong>Datadog</strong> step.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/vd4jgv41io/1578090309650/image.png"/></figure><h4>Continuous Verification</h4><p>You can also see the evaluation in the <strong>Continuous Verification</strong> dashboard. The workflow verification view is for the DevOps user who developed the workflow. The <strong>Continuous Verification</strong> dashboard is where all future deployments are displayed for developers and others interested in deployment analysis.</p><p>To learn about the verification analysis features, see the following sections.</p><h5>Deployments</h5><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536957040995/image.png"/></figure></td><td><p><strong>Deployment info:</strong> See the verification analysis for each deployment, with information on its service, environment, pipeline, and workflows.</p><p><strong>Verification phases and providers:</strong> See the vertfication phases for each vertfication provider. Click each provider for logs and analysis.</p><p><strong>Verification timeline:</strong> See when each deployment and verification was performed.</p></td></tr></tbody></table><h5>Transaction Analysis</h5><table><tbody><tr><td><p><strong>Execution details:</strong> See the details of verification execution. Total is the total time the verification step took, and Analysis duration is how long the analysis took.</p><p><strong>Risk level analysis:</strong> Get an overall risk level and view the cluster chart to see events.</p><p><strong>Transaction-level summary:</strong> See a summary of each transaction with the query string, error values comparison, and a risk analysis summary.</p></td><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536957067207/image.png"/></figure></td></tr></tbody></table><h5>Execution Analysis</h5><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497249316/image.png"/></figure></td><td><p><strong>Event type:</strong> Filter cluster chart events by Unknown Event, Unexpected Frequency, Anticipated Event, Baseline Event, and Ignore Event.</p><p><strong>Cluster chart:</strong> View the chart to see how the selected event contrast. Click each event to see its log details.</p></td></tr></tbody></table><h5>Event Management</h5><table><tbody><tr><td><p><strong>Event-level analysis:</strong> See the threat level for each event captured.</p><p><strong>Tune event capture:</strong> Remove events from analysis at the service, workflow, execution, or overall level.</p><p><strong>Event distribution:</strong> Click the chart icon to see an event distribution including the measured data, baseline data, and event frequency.</p></td><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497306015/image.png"/></figure></td></tr></tbody></table><h3>Next Steps</h3><ul><li><a href="/article/htvzryeqjw-configuration-as-code">Configuration as Code</a></li><li><a href="/article/ven0bvulsj-users-and-permissions">Users and Permissions</a></li><li><a href="https://docs.harness.io/article/0avzb5255b-cv-strategies-and-best-practices#algorithm_sensitivity_and_failure_criteria">CV Strategies, Tuning, and Best Practice</a></li></ul><p></p>