type: article
article_id: h2crh8rvbr
user_id: wz6xkfcc9i
category_id: ep5nt3dyrb
author:
  name: Chakravarthy Tenneti
  profile_image: https://www.gravatar.com/avatar/790db061bb8f8fb094e4d4b19a390f3b?d=mm&s=150
title: Verify Deployments with Datadog as a Custom APM
slug: verify-deployments-with-datadog-as-a-custom-apm
description: 'To solve [problem], [solution] [benefit of feature]. In this topic:
  Before You Begin. Step 1: Set Up the Deployment Verification. Step 2: Metric Collections.
  Step 3: Metrics Name. Step 4: Metrics Typ…'
short_version: 'To solve [problem], [solution] [benefit of feature]. In this topic:
  Before You Begin. Step 1: Set Up the Deployment Verification. Step 2: Metric Collections.
  Step 3: Metrics Name. Step 4: Metrics Typ…'
tags: []
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2021-05-12T17:21:19.998767Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Verify Deployments with Datadog as a Custom APM
  description: ""
  short_version: ""
  body: '<p></p><p>To solve [problem], [solution] [benefit of feature].</p><p>In this
    topic:</p><ul><li><a href="#before_you_begin">Before You Begin</a></li><li><a
    href="#step_1_set_up_the_deployment_verification">Step 1: Set Up the Deployment
    Verification</a></li><li><a href="#step_2_metric_collections">Step 2: Metric Collections</a></li><li><a
    href="#step_3_metrics_name">Step 3: Metrics Name</a></li><li><a href="#step_4_metrics_type">Step
    4: Metrics Type</a></li><li><a href="#step_5_metrics_collection_url">Step 5: Metrics
    Collection URL</a></li><li><a href="#step_6_metrics_method">Step 6: Metrics Method</a></li><li><a
    href="#step_7_response_mapping">Step 7: Response Mapping</a></li><li><a href="#step_8_transaction_name">Step
    8: Transaction Name</a></li><li><a href="#step_9_name">Step 9: Name</a></li><li><a
    href="#step_10_metrics_value">Step 10: Metrics Value</a></li><li><a href="#step_11_timestamp">Step
    11: Timestamp</a></li><li><a href="#step_12_timestamp_format">Step 12: Timestamp
    Format</a></li><li><a href="#step_13_canary_analysis">Step 13: Canary Analysis</a></li><li><a
    href="#step_14_previous_analysis">Step 14: Previous Analysis</a></li><li><a href="#step_15_failure_criteria">Step
    15: Failure Criteria</a></li><li><a href="#step_16_data_collection_interval">Step
    16: Data Collection Interval</a></li><li><a href="#review_verification_results">Review:
    Verification Results</a></li></ul><p></p><h3>Before You Begin</h3><ul><li>See
    <a href="/article/e87u8c63z4-custom-verification-overview">Custom Verification
    Overview</a>.</li><li>See <a href="/article/nh868x8jim-connect-to-datadog-as-a-custom-apm">Connect
    to Datadog as a Custom APM</a>.</li></ul><p></p><h3>Step 1: Set Up the Deployment
    Verification</h3><ol><li>In Harness, open the <strong>Workflow</strong> that deploys
    the service you are monitoring with Datadog. You add verification steps after
    you have performed at least one successful deployment.</li><li>In the Workflow,
    in <strong>Verify Service</strong>, click <strong>Add Step</strong>.</li><li>In
    the resulting <strong>Add Step</strong> settings, select <strong>Performance Monitoring</strong> &gt; <strong>Custom Metrics</strong>.</li><li>Click
    <strong>Next</strong>. The <strong>Configure </strong><strong>Custom Metrics</strong>
    settings appear.</li><li>In the <strong>Metrics Data Server</strong> drop-down,
    select the Custom Verification Provider you set up already.</li><li>Set the <strong>Metric
    Type</strong> to either <strong>Infrastructure</strong> or <strong>Transaction</strong>.<br/><br/>Your
    settings will now look something like this:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/facqx6j76n/1581129706276/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><p></p><h3>Step
    2: Metric Collections</h3><ol><li>Beside <strong>Metric Collections</strong>,
    click <strong>Add</strong> to display the <strong>New Metrics Collection</strong>
    settings.<br/>All of the settings in <strong>New Metrics Collection</strong> are
    Harness settings for collecting and grouping metrics, except for the settings
    where you will map JSON response keys to Harness fields.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/facqx6j76n/1581129919342/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Fill
    out the <strong>New Metrics Collection</strong> settings using the following information.
    You will set up an API query for Harness to execute that returns a JSON response.
    Next, you will map the keys in the JSON response to the fields Harness needs to
    locate your metric values and host.</li></ol><h3>Step 3: Metrics Name</h3><p>Enter
    the name to use for your metric. This is not a Datadog value. It is simply the
    name used for metrics collected by Harness.</p><h3>Step 4: Metrics Type</h3><p>Enter
    the type of metric, such as <strong>Infra</strong>. These are Harness types, not
    Datadog&#39;s.</p><h4>Always Use Throughput with Error and Response Time Metrics</h4><p>Whenever
    you use the Error metric type, you should also add another metric for Throughput
    with the same Transaction Name. </p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/0qvier4m49/1606857927356/image.png"/></figure><p>Harness
    analyze errors as error percentage and without the throughput the error number
    does not provide much information.</p><p>The same setup should used with the Response
    Time metric also. Whenever you set up a Response Time metric, setup a Throughput
    metric with the same Transaction Name.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/0qvier4m49/1606857610464/image.png"/></figure><h3></h3><h3>Step
    5: Metrics Collection URL</h3><p>This is the API query that will return a JSON
    response.</p><p>The query for Metrics Collection URL follows this syntax:</p><pre
    class="hljs apache">query?query=&lt;METRIC_NAME&gt;{pod_name:<span class="hljs-variable"
    style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223, 80, 0)">${host}</span>}by{pod_name}.rollup(avg,60)&amp;from=<span
    class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223,
    80, 0)">${start_time_seconds}</span>&amp;to=<span class="hljs-variable" style="box-sizing:inherit;color:rgb(223,
    80, 0)" data-hd-color="rgb(223, 80, 0)">${end_time_seconds}</span></pre><p>The
    values in <code>${...}</code> braces are placeholders used for querying the data.
    These are substituted at runtime with real values.</p><p>Replace <code>&lt;METRIC_NAME&gt;</code>
    in the query with the correct metric name. The metric names are available in Datadog
    Metric Explorer:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556146780863/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556146780863/image.png"
    style="max-height:25%;max-width:25%" data-hd-height="25%" data-hd-width="25%"/></a></figure><p>For
    example, to search for the <code>kubernetes.memory.usage_pct metric</code>, your
    query would look like this:</p><pre class="hljs apache">query?query=kubernetes.memory.usage_pct{pod_name:<span
    class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223,
    80, 0)">${host}</span>}by{pod_name}.rollup(avg,60)&amp;from=<span class="hljs-variable"
    style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223, 80, 0)">${start_time_seconds}</span>&amp;to=<span
    class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223,
    80, 0)">${end_time_seconds}</span></pre><h3>Step 6: Metrics Method</h3><p>Select
    <strong>GET</strong> or <strong>POST</strong>.</p><h3>Step 7: Response Mapping</h3><p>In
    this section you will map the keys in the JSON response to Harness fields.</p><h3>Step
    8: Transaction Name</h3><p>Select either <strong>Fixed</strong>, or <strong>Dynamic</strong>
    depending on the transaction name. In our example, we will use <strong>Fixed</strong>.
    If you select <strong>Dynamic</strong>, you will see the <strong>Transaction Name
    Path</strong> and <strong>Regex to transform Transaction Name</strong> fields.</p><p>The
    Transaction Name Path is filled out in the same way as <strong>Name</strong> below.
    You use <strong>Regex to transform Transaction Name</strong> to truncate the value
    of the <strong>Transaction Name Path</strong>, if needed.</p><h3>Step 9: Name</h3><p>Enter
    a name to map to the metric name. For example, if the metric name is <code>kubernetes.memory.usage_pct</code>
    then use a name like <strong>KubeMemory</strong>.</p><h3>Step 10: Metrics Value</h3><p>Run
    the query using <strong>Guide from an example</strong> to see the JSON response
    and pick a key to map to <strong>Metrics Value</strong>.</p><p>In <strong>Guide
    from an example</strong>, specify the time range and host for the query. To specify
    the time range, click in the <strong>${startTime}</strong> and <strong>${endTime}</strong>
    calendars.</p><p>To specify the <strong>${host}</strong>, get the full name of
    a host from Datadog Metrics Explorer:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149198644/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149198644/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><p>To
    copy the name, click in the graph and click <strong>Copy tags to clipboard</strong>.</p><figure><a
    href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149404762/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149404762/image.png"
    style="max-height:25%;max-width:25%" data-hd-height="25%" data-hd-width="25%"/></a></figure><p>Next,
    paste the name in the <strong>${host}</strong> field.</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149478697/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149478697/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><p>Click
    <strong>Submit</strong>. The JSON results appear. Click the name of the field
    to map to <strong>Metrics Value</strong>.</p><h3>Step 11: Timestamp</h3><p>Use
    <strong>Guide from an example</strong> to query Datadog and return the JSON response.
    In the JSON response, click the key that includes the timestamp.</p><h3>Step 12:
    Timestamp Format</h3><p>Enter a timestamp format. The format follows the Java
    <a href="https://docs.oracle.com/javase/8/docs/api/java/text/SimpleDateFormat.html"
    target="_blank">SimpleDateFormat</a>. For example, a timestamp syntax might be
    <code>yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSX</code>. If you leave this field empty,
    Harness will use the default range of 1 hour previous (<code>now-1h</code>) to
    now.</p><p>Now that the Metric Collection is complete, click <strong>UPDATE</strong>
    to return to the rest of the <strong>Metrics Verification State</strong> settings.</p><h3>Step
    13: Canary Analysis</h3><p>Harness will compare the metrics received for the nodes
    deployed in each phase with metrics received for the rest of the nodes in the
    application. For example, if this phase deploys to 25% of your nodes, the metrics
    received from Custom APM during this deployment for these nodes will be compared
    with metrics received for the other 75% during the defined period of time.</p><h3>Step
    14: Previous Analysis</h3><p>Harness will compare the metrics received for the
    nodes deployed in each phase with metrics received for all the nodes during the
    previous deployment. For example, if this phase deploys V1.2 to node A, the metrics
    received from Custom APM during this deployment will be compared to the metrics
    for nodes A, B, and C during the previous deployment (V1.1). Previous Analysis
    is best used when you have predictable load, such as in a QA environment.</p><h3>Step
    15: Failure Criteria</h3><p>Specify the sensitivity of the failure criteria. When
    the criteria is met, the Workflow&#39;s Failure Strategy is triggered.</p><h3>Step
    16: Data Collection Interval</h3><p>Specify the frequency with which Harness will
    query Datadog, The value <strong>2</strong> is recommended.</p><p>Click <strong>SUBMIT</strong>.
    Now the Datadog custom verification step is added to the Workflow. Run your Workflow
    to see the results.</p><h3>Review: Verification Results</h3><p>Once you have deployed
    your Workflow (or Pipeline) using the Custom verification step, you can automatically
    verify cloud application and infrastructure performance across your deployment.</p><h4>Workflow
    Verification</h4><p>To see the results of Harness machine-learning evaluation
    of your Custom verification, in your Workflow or Pipeline deployment, you can
    expand the <strong>Verify Service</strong> step and then click the <strong>APM</strong>
    <strong>Verification</strong> step.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536097934172/image.png"/></figure><h4>Continuous
    Verification</h4><p>You can also see the evaluation in the <strong>Continuous
    Verification</strong> dashboard. The Workflow verification view is for the DevOps
    user who developed the workflow; the <strong>Continuous Verification</strong>
    dashboard is where all deployments are displayed for developers and others interested
    in deployment analysis.</p><p>To learn about the verification analysis features,
    see the following sections.</p><h5>Transaction Analysis</h5><table><tbody><tr><td><p><strong>Execution
    details:</strong> See the details of verification execution. Total is the total
    time the verification step took, and Analysis duration is how long the analysis
    took.</p><p><strong>Risk level analysis:</strong> Get an overall risk level and
    view the cluster chart to see events.</p><p><strong>Transaction-level summary:</strong>
    See a summary of each transaction with the query string, error values comparison,
    and a risk analysis summary.</p></td><td><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/xpftsz2cte/1535665317967/image.png"/></figure></td></tr></tbody></table><h5>Execution
    Analysis</h5><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497249316/image.png"/></figure></td><td><p><strong>Event
    type:</strong> Filter cluster chart events by Unknown Event, Unexpected Frequency,
    Anticipated Event, Baseline Event, and Ignore Event.</p><p><strong>Cluster chart:</strong>
    View the chart to see how the selected event contrasts with anticipated events.
    Click each event to see its log details.</p></td></tr></tbody></table><h5>Event
    Management</h5><table><tbody><tr><td><p><strong>Event-level analysis:</strong>
    See the threat level for each event captured.</p><p><strong>Tune event capture:</strong>
    Remove events from analysis at the Service, Workflow, Execution, or overall level.</p><p><strong>Event
    distribution:</strong> Click the chart icon to see an event distribution including
    the measured data, baseline data, and event frequency.</p></td></tr></tbody></table><p></p>'
  slug: verify-deployments-with-datadog-as-a-custom-apm
  tags: []
  is_live: true
