<p>You can add Azure Logs to Harness as a custom APM. This approach enables you to expand monitoring and cover specific log details of interest.</p><p>In this topic:</p><ul><li><a href="https://docs.harness.io/article/phpej1j6jx-azure-logs-as-custom-apm#before_you_begin">Before You Begin</a></li><li><a href="https://docs.harness.io/article/phpej1j6jx-azure-logs-as-custom-apm#custom_verification_provider_setup">Custom Verification Provider Setup</a></li><li><a href="https://docs.harness.io/article/phpej1j6jx-azure-logs-as-custom-apm#workflow_verification">Workflow Verification</a></li><li><a href="#workflow_verification_results">Workflow Verification Results</a></li><li><a href="#24_7_service_guard_setup">24/7 Service Guard Setup</a></li><li><a href="#continuous_verification_results">Continuous Verification Results</a></li></ul><h3>Before You Begin</h3><ul><li>See <a href="/article/4o7oqwih6h-harness-key-concepts">Harness Key Concepts</a>.</li><li>See <a href="/article/e87u8c63z4-custom-verification-overview">Custom Verification Overview</a>.</li></ul><p></p><h3>Custom Verification Provider Setup</h3><p>To add a Custom Metrics Provider using Azure Logs, do the following:</p><ol><li>In Harness Manager, click <strong>Setup</strong> &gt; <strong>Connectors</strong> &gt; <strong>Verification Providers</strong>.</li><li>Click <strong>Add Verification Provider</strong>. From the drop-down, select <strong>Custom Verification</strong>. This opens the <strong>Add APM Verification Provider</strong> settings.</li><li>In <strong>Display Name</strong>, give the Verification Provider an arbitrary name. (You will use this name to select this provider in a Workflow.)</li><li>In <strong>Type</strong>, select <strong>Custom Logs Provider</strong>, as shown later.</li><li>In <strong>Base UR</strong>L, enter the following: <a href="https://api.loganalytics.io/v1/">https://api.loganalytics.io/v1/</a>.</li><li>In <strong>Parameters</strong>, click <strong>Add Parameters</strong>, and add rows and values for the following HTTP parameters:<ul><li>client_id</li><li>tenant_id</li><li>client_secret</li></ul></li><li>In <strong>Validation Path</strong>, enter the Path to the query.</li><li>In <strong>Body</strong>, enter the query as follows: <code>{&#34;query&#34;:&#34;ContainerLog/take 10&#34;}</code>. This query will be used only for testing the connection.</li><li>Click <strong>Test</strong> to verify your Custom Verification Provider.</li><li>If the test succeeds, click <strong>Submit</strong> to save the Custom Verification Provider.</li></ol><p></p><h3>Workflow Verification</h3><p>Now that you have the Verification Provider set up, you can use it as a verification step in a Workflow. </p><p>Note: You can add verification steps to a Workflow after you have performed at least one successful deployment.</p><ol><li>In Harness, open the Workflow that deploys the service you are monitoring with Azure Logs. You add verification steps after you have performed at least one successful deployment.</li><li>In the <strong>Workflow</strong>, in <strong>Verify Service</strong>, click <strong>Add Step</strong>.</li><li>In the resulting <strong>Add Step</strong> settings, select <strong>Log Analysis</strong> &gt; <strong>Custom Log Verification</strong>.</li><li>Click <strong>Next</strong>. The <strong>Configure Custom Log Verification</strong> settings appear.</li><li>In <strong>Log Data Provider</strong>, select the Custom Verification Provider that you have already configured.</li><li>Click <strong>Add Log Collection</strong>. The Log Collection Details settings appear.</li></ol><p>Fill out the dialog. The dialog has the following fields.</p><table><tbody><tr><td><p><strong>Settings</strong></p></td><td><p><strong>Description</strong></p></td></tr><tr><td><p><strong>Display Name</strong></p></td><td><p>Enter a name for this Workflow Verification.</p></td></tr><tr><td><p><strong>Service</strong></p></td><td><p>Select the Harness Service that represents the production application you are monitoring with the custom log provider.</p></td></tr><tr><td><p><strong>Log Data Provider</strong></p></td><td><p>Select the Custom Logs Provider you added, described in  <a href="">Custom Verification Connection Setup</a>.</p></td></tr><tr><td><p><strong>Log Collection</strong></p></td><td><p>Once you have added log collection details, this section will list the collection settings.</p></td></tr><tr><td><p><strong>Request Method</strong></p></td><td><p>Select <strong>POST</strong>.</p></td></tr><tr><td><p><strong>Search URL</strong></p></td><td><p>Enter the API query that will return a JSON response. In the remaining settings, you will map the keys in the JSON response to Harness settings to identify where data such as the hostname and timestamp are located in the JSON response.</p><p>The <strong>Search URL</strong> is automatically filled with the URL from the Custom Log Provider you selected in <strong>Log Data Provider.</strong></p></td></tr><tr><td><p><strong>Search Body</strong></p></td><td><p>Enter the JSON query. <code>${host}</code> is a placeholder for the pod name and it is not a Workflow variable. It will be substituted at run time with the pod name that needs to be queried.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/phpej1j6jx/1595403955271/customversb.png"/></figure></td></tr><tr><td><p><strong>Response Type</strong></p></td><td><p>In <strong>Response Type</strong>, select <strong>JSON</strong>.</p></td></tr><tr><td><p><strong>Log Message JSON Path, Hostname JSON Path, and Timestamp JSON Path</strong></p></td><td><p>Use the <strong>Guide From Example</strong> links to select which returned columns map to the Log Message, Hostname (pod name), and Timestamp.</p><p></p><p></p></td></tr><tr><td><p><strong>Regex to Transform Hostname</strong></p></td><td><p>If the JSON value returned requires transformation in order to be used, enter the regex expression here. For example: If the value in the host name JSON path of the response is <code>pod_name:harness-test.pod.name</code> and the actual pod name is simply <code>harness-test.pod.name</code>, you can write a regular expression to remove the <code>pod_name</code> from the response value.</p></td></tr><tr><td><p><strong>Timestamp Format</strong></p></td><td><p>Set the format based on the results of <strong>Guide From Example</strong> for the Timestamp.</p></td></tr></tbody></table><h4>Common Settings</h4><p>Enter the following settings for the log providers.</p><table><tbody><tr><td><p><strong>Field</strong></p></td><td><p><strong>Description</strong></p></td></tr><tr><td><p><strong>Expression for Host/Container</strong></p></td><td><p>The expression entered here should resolve to a host/container name in your deployment environment. By default, the expression is <strong>${instance.host.hostName}</strong>.</p></td></tr><tr><td><p><strong>Analysis Time Duration</strong></p></td><td><p>Set the duration for the verification step. If a verification step exceeds the value, the workflow <a href="/article/m220i1tnia-workflow-configuration#failure_strategy">Failure Strategy</a> is triggered. For example, if the Failure Strategy is <strong>Ignore</strong>, then the verification state is marked <strong>Failed</strong> but the workflow execution continues.</p><p>Harness waits 2-3 minutes before beginning the analysis to avoid initial deployment noise. This is a standard with monitoring tools.</p></td></tr><tr><td><p><strong>Data Collection Interval</strong></p></td><td><p>Specify the frequency at which Harness will run the query. Harness recommends the value 2.</p></td></tr><tr><td><p><strong>Baseline for Risk Analysis</strong></p></td><td><p>See <a href="/article/0avzb5255b-cv-strategies-and-best-practices">CV Strategies, Tuning, and Best Practices</a>.</p></td></tr><tr><td><p><strong>Execute with previous steps</strong></p></td><td><p>Check this checkbox to run this verification step in parallel with the previous steps in <strong>Verify Service</strong>.</p></td></tr><tr><td><p><strong>Include instances from previous phases</strong></p></td><td><p>If you are using this verification step in a multi-phase deployment, select this checkbox to include instances used in previous phases when collecting data. Do not apply this setting to the first phase in a multi-phase deployment.</p></td></tr></tbody></table><h3>Workflow Verification Results</h3><p>Once you have deployed your Workflow (or Pipeline) using the Custom verification step, you can automatically verify cloud application and infrastructure performance across your deployment.</p><p>To see the results of Harness machine-learning evaluation of your Custom verification, in your Workflow or Pipeline deployment, you can expand the <strong>Verify</strong> step and then click the <strong>Log</strong> <strong>Verification</strong> step.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/phpej1j6jx/1595322868168/workflow-verification-azure-logs.png"/></figure><p></p><h3 id="24_7_service_guard_setup">24/7 Service Guard Setup</h3><p>To set up 24/7 Service Guard for Azure custom logs, do the following:</p><ol><li>Ensure that you have added your Custom Verification provider as a Harness Verification Provider, as described in  <a href="/article/i6f2irsz9v-2-24-7-service-guard-for-app-dynamics#verification_provider_setup">Verification Provider Setup</a>.</li><li>In your Harness Application, ensure that you have added a Service, as described in  <a href="https://docs.harness.io/article/eb3kfl8uls-service-configuration">Services</a>. For 24/7 Service Guard, you do not need to add an Artifact Source to the Service, or configure its settings. You simply need to create a Service and name it. It will represent your application for 24/7 Service Guard.</li><li>In your Harness Application, click <strong>Environments</strong>.</li><li>In <strong>Environments</strong>, ensure that you have added an Environment for the Service you added. For steps on adding an Environment, see  <a href="https://docs.harness.io/article/n39w05njjv-environment-configuration">Environments</a>.</li><li>Click the Environment for your Service. Typically, the <strong>Environment Type</strong> is <strong>Production</strong>.</li><li>In the <strong>Environment</strong> page, locate <strong>24/7 Service Guard</strong>.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/ps716zaurs/1553127693787/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/ps716zaurs/1553127693787/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure></li><li>In <strong>24/7 Service Guard</strong>, click <strong>Add Service Verification</strong>, and then click <strong>Custom Log Verification</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/8rrqkoawzm/1574283389885/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure>The <strong>Custom Log Verification</strong> dialog appears.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/8rrqkoawzm/1574283829320/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Fill out the dialog. The dialog has the following fields.</p><div class="note-callout">For 24/7 Service Guard, the queries you define to collect logs are specific to the application or service you want monitored. Verification is application/service level. This is unlike Workflows, where verification is performed at the host/node/pod level.</div><p></p><table><tbody><tr><td><p><strong>Settings</strong></p></td><td><p><strong>Description</strong></p></td></tr><tr><td><p><strong>Display Name</strong></p></td><td><p>Enter a name for this 24/7 Service Guard monitoring. This name will identify the monitoring in the <strong>Environment</strong> page and in <strong>24/7 Service Guard</strong> under <strong>Continuous Verification</strong>.</p></td></tr><tr><td><p><strong>Service</strong></p></td><td><p>Select the Harness Service that represents the production application you are monitoring with the custom log provider.</p></td></tr><tr><td><p><strong>Log Data Provider</strong></p></td><td><p>Select the Custom Logs Provider you added, described in  <a href="/article/9xvrgqy2dd-1-custom-verification-connection-setup">Custom Verification Connection Setup</a>.</p></td></tr><tr><td><p><strong>Log Collection</strong></p></td><td><p>Once you have added log collection details, this section will list the collection settings.</p></td></tr><tr><td><p><strong>Request Method</strong></p></td><td><p>Select <strong>POST</strong>.</p></td></tr><tr><td><p><strong>Search URL</strong></p></td><td><p>Enter the API query that will return a JSON response. In the remaining settings, you will map the keys in the JSON response to Harness settings to identify where data such as the hostname and timestamp are located in the JSON response.</p><p>The <strong>Search URL</strong> is automatically filled with the URL from the Custom Log Provider you selected in <strong>Log Data Provider.</strong></p><p>For some custom logging tools, you will need to augment your Base URL with <code>query</code> or some other setting.</p></td></tr><tr><td><p><strong>Search Body</strong></p></td><td><p>You can enter any JSON search input for your query. For example, here is a log query.</p><p>Make sure you include the application name in the query and NOT  <code>${host}</code> as a placeholder for the pod name. </p><p>In the following example, you can include a query for the application name in this part: <code>where Name startswith \&#34;xxxxxx\&#34; </code>where xxxxxx is the query phrase for your application.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/phpej1j6jx/1595320575887/azure-capmsbody.png"/></figure><p></p></td></tr><tr><td><p><strong>Response Type</strong></p></td><td><p>In <strong>Response Type</strong>, select <strong>JSON</strong>.</p></td></tr><tr><td><p><strong>Log Message JSON Path</strong></p></td><td><p>To use <strong>Guide From Example</strong>, your <strong>Search URL</strong> or <strong>Search Body</strong> must contain the start and end time placeholders <code>${start_time}</code> and <code>${end_time}</code>.</p><p>Where the start and end time placeholders are required depends on your custom logs provider. For example, some providers will need them in the Search Body and other in the Search URL.</p><p>Click <strong>Guide From Example</strong>. A popup appears, preset for you to query the provider.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/8rrqkoawzm/1574297520745/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>You can change the start and end times. By default, they are set for the last 30 minutes.</p><p>Click <strong>SEND</strong>. The JSON response is displayed.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/8rrqkoawzm/1574297533878/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Click the <strong>message</strong> field. The JSON path is added to <strong>Log Message JSON Path</strong>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/8rrqkoawzm/1574296918543/image.png"/></figure></td></tr><tr><td><p><strong>Regex to Transform Hostname</strong></p></td><td><p>If the JSON value returned requires transformation in order to be used, enter the regex expression here. For example: If the value in the host name JSON path of the response is <code>pod_name:harness-test.pod.name</code> and the actual pod name is simply <code>harness-test.pod.name</code>, you can write a regular expression to remove the <code>pod_name</code> from the response value.</p></td></tr><tr><td><p><strong>Timestamp JSON Path</strong></p></td><td><p>Click <strong>Guide From Example</strong> to locate the JSON path for the timestamp, and click the timestamp label.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/8rrqkoawzm/1574297666764/image.png"/></figure></td></tr><tr><td><p><strong>Timestamp Format</strong></p></td><td><p>Enter a timestamp format. Set the format based on the results of <strong>Guide From Example</strong> for the timestamp.</p></td></tr><tr><td><p><strong>Enable 24/7 Service Guard</strong></p></td><td><p>Select <strong>Enable 24/7 Service Guard</strong> to enable monitoring.</p></td></tr></tbody></table><p></p><h3>Continuous Verification Results</h3><p>You can also see the evaluation in the <strong>Continuous Verification</strong> dashboard. The Workflow verification view is for the DevOps user who developed the workflow; the <strong>Continuous Verification</strong> dashboard is where all deployments are displayed for developers and others interested in deployment analysis.</p><p>To learn about the verification analysis features, see the following sections.</p><h5>Transaction Analysis</h5><p><strong>Execution details:</strong> See the details of verification execution. Total is the total time the verification step took, and Analysis duration is how long the analysis took.</p><p><strong>Risk level analysis:</strong> Get an overall risk level and view the cluster chart to see events.</p><p><strong>Transaction-level summary:</strong> See a summary of each transaction with the query string, error values comparison, and a risk analysis summary.</p><h5>Execution Analysis</h5><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497249316/image.png"/></figure></td><td><p><strong>Event type:</strong> Filter cluster chart events by Unknown Event, Unexpected Frequency, Anticipated Event, Baseline Event, and Ignore Event.</p><p><strong>Cluster chart:</strong> View the chart to see how the selected event contrasts with anticipated events. Click each event to see its log details.</p></td></tr></tbody></table><h5>Event Management</h5><table><tbody><tr><td><p><strong>Event-level analysis:</strong> See the threat level for each event captured.</p><p><strong>Tune event capture:</strong> Remove events from analysis at the Service, Workflow, Execution, or overall level.</p><p><strong>Event distribution:</strong> Click the chart icon to see an event distribution including the measured data, baseline data, and event frequency.</p></td><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497306015/image.png"/></figure></td></tr></tbody></table><p></p>