type: article
article_id: facqx6j76n
user_id: mfr0nxh4be
category_id: ep5nt3dyrb
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: 5 - Datadog as a Custom APM
slug: 3-datadog-as-a-custom-apm
description: Use Datadog with non-Kubernetes deployment types, such as AWS ECS.
short_version: Use Datadog with non-Kubernetes deployment types, such as ECS.
tags:
- Datadog
- Metrics Provider
- API key
- Verification Provider
- verification
- Workflow
- Deployment Verification
show_toc: true
is_private: false
is_published: false
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2021-05-12T17:22:46.227536Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: 5 - Datadog as a Custom APM
  description: Use Datadog with non-Kubernetes deployment types, such as AWS ECS.
  short_version: Use Datadog with non-Kubernetes deployment types, such as ECS.
  body: '<p>Currently, Datadog-Harness integration is for Kubernetes deployments only.
    To use Datadog with other deployment types, such as ECS, use the following example
    of how to use the Custom Metrics Provider with Datadog.</p><h3 id="custom_verification_provider">Custom
    Verification Provider Setup</h3><p>To add a Custom Metrics Provider using Datadog,
    do the following:</p><ol><li>In Harness Manager, click <strong>Setup</strong>
    &gt; <strong>Connectors</strong> &gt; <strong>Verification Providers</strong>.</li><li>Click <strong>Add
    Verification Provider</strong>, and click <strong>Custom Verification</strong>.
    The <strong>Metrics Data Provider</strong> dialog appears.</li><li>In <strong>Type</strong>,
    select <strong>Metrics Data Provider</strong>.</li><li>In <strong>Display Name</strong>,
    give the Verification Provider a name. You will use this name to select this provider
    in a Workflow.</li><li>In <strong>Base URL</strong>, enter <code>https://app.datadoghq.com/api/v1/</code>.</li><li>In <strong>Parameters</strong>,
    click <strong>Add Parameters</strong>, and add the following parameters.</li></ol><table><tbody><tr><td><p><strong>Key</strong></p></td><td><p><strong>Value</strong></p></td><td><p><strong>Encrypted
    Value</strong></p></td></tr><tr><td><p>api_key</p></td><td><p>Enter the API key.</p></td><td><p>Checked</p></td></tr><tr><td><p>application_key</p></td><td><p>Enter
    the application key.</p></td><td><p>Checked</p></td></tr></tbody></table><p>If
    you need help obtaining the API and Application keys, see the following:</p><table><tbody><tr><td><p><strong>API
    Key</strong></p></td><td><p>To create an API key in Datadog, do the following:</p><ol><li>In <strong>Datadog</strong>,
    mouseover <strong>Integrations</strong>, and then click <strong>APIs</strong>.<div
    class="hd--html"><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948073865/image.png"></a><a
    href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948073865/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948073865/image.png"
    data-hd-height="50%" data-hd-width="50%" style="box-sizing: inherit; border: 1px
    solid grey; vertical-align: middle; margin: 5px; padding: 5px !important; max-width:
    50%; height: auto !important; max-height: 50%;"/></a></figure></div>The <strong>APIs</strong> page
    appears.<div class="hd--html"><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948132206/image.png"></a><a
    href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948132206/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948132206/image.png"
    data-hd-height="50%" data-hd-width="50%" style="box-sizing: inherit; border: 1px
    solid grey; vertical-align: middle; margin: 5px; padding: 5px !important; max-width:
    50%; height: auto !important; max-height: 50%;"/></a></figure></div></li><li>In <strong>API
    Keys</strong>, in <strong>New API key</strong>, enter the name for the new API
    key, such as <strong>Harness</strong>, and then click <strong>Create API key</strong>.</li><li>Copy
    the API key and, in <strong>Harness</strong>, paste it into the <strong>Value</strong> field.</li></ol></td></tr><tr><td><p><strong>Application
    Key</strong></p></td><td><p>To create an application key in Datadog, do the following:</p><ol><li>In <strong>Datadog</strong>,
    mouseover <strong>Integrations</strong>, and then click <strong>APIs</strong>.
    The <strong>APIs</strong> page appears.<div class="hd--html"><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948211513/image.png"></a><a
    href="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948211513/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/rougsx3tir/1536948211513/image.png"
    data-hd-height="50%" data-hd-width="50%" style="box-sizing: inherit; border: 1px
    solid grey; vertical-align: middle; margin: 5px; padding: 5px !important; max-width:
    50%; height: auto !important; max-height: 50%;"/></a></figure></div></li><li>In <strong>Application
    Keys</strong>, in <strong>New application key</strong>, enter a name for the application
    key, such as <strong>Harness</strong>, and click <strong>Create Application Key</strong>.</li><li>Copy
    the API key and, in <strong>Harness</strong>, paste it into the <strong>Value</strong> field.</li></ol></td></tr></tbody></table><ol><li
    style="counter-increment:li 8" start="9">In <strong>Validation Path</strong>,
    enter <code>metrics?from=1527102292</code>. This is the epoch seconds value used
    to ensure an HTTP 200 response with the credentials validated.</li></ol><p>When
    you are finished, the dialog will look something like this:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556137336699/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556137336699/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><h3
    id="workflow_verification">Workflow Verification</h3><p>Now that you have the
    Verification Provider set up, you can use it as a verification step in a Workflow.
    In the procedure below, we will provide information on how to select the Datadog
    metrics you need.</p><ol><li>In Harness, open the <strong>Workflow</strong> that
    deploys the service you are monitoring with Datadog. You add verification steps
    after you have performed at least one successful deployment.</li><li>In the Workflow,
    in <strong>Verify Service</strong>, click <strong>Add Step</strong>.</li><li>In
    the resulting <strong>Add Step</strong> settings, select <strong>Performance Monitoring</strong> &gt; <strong>Custom Metrics</strong>.</li><li>Click
    <strong>Next</strong>. The <strong>Configure </strong><strong>Custom Metrics</strong>
    settings appear.</li><li>In the <strong>Metrics Data Server</strong> drop-down,
    select the Custom Verification Provider you <a href="#custom_verification_provider">set
    up above</a>.</li><li>Set the <strong>Metric Type</strong> to either <strong>Infrastructure</strong>
    or <strong>Transaction</strong>.<br/><br/>Your settings will now look something
    like this:<br/><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/facqx6j76n/1581129706276/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Beside
    <strong>Metric Collections</strong>, click <strong>Add</strong> to display the
    <strong>New Metrics Collection</strong> settings.<br/><br/>All of the settings
    in <strong>New Metrics Collection</strong> are Harness settings for collecting
    and grouping metrics, except for the settings where you will map JSON response
    keys to Harness fields.<br/><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/facqx6j76n/1581129919342/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Fill
    out the <strong>New Metrics Collection</strong> settings using the following information.
    You will set up an API query for Harness to execute that returns a JSON response.
    Next, you will map the keys in the JSON response to the fields Harness needs to
    locate your metric values and host.</li></ol><ul><li><strong>Metrics Name</strong> –
    Enter the name to use for your metric. This is not a Datadog value. It is simply
    the name used for metrics collected by Harness.</li><li><strong>Metrics Type</strong> –
    Enter the type of metric, such as <strong>Infra</strong>. These are Harness types,
    not Datadog&#39;s.</li><li><strong>Metrics Collection URL</strong> – This is the
    API query that will return a JSON response.</li></ul><p>The query for Metrics
    Collection URL follows this syntax:</p><pre class="hljs apache">query?query=&lt;METRIC_NAME&gt;{pod_name:<span
    class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223,
    80, 0)">${host}</span>}by{pod_name}.rollup(avg,60)&amp;from=<span class="hljs-variable"
    style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223, 80, 0)">${start_time_seconds}</span>&amp;to=<span
    class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223,
    80, 0)">${end_time_seconds}</span></pre><p>The values in <code>${...}</code> braces
    are placeholders used for querying the data. These are substituted at runtime
    with real values.</p><p>Replace <code>&lt;METRIC_NAME&gt;</code> in the query
    with the correct metric name. The metric names are available in Datadog Metric
    Explorer:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556146780863/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556146780863/image.png"
    style="max-height:25%;max-width:25%" data-hd-height="25%" data-hd-width="25%"/></a></figure><p>For
    example, to search for the <code>kubernetes.memory.usage_pct metric</code>, your
    query would look like this:</p><pre class="hljs apache">query?query=kubernetes.memory.usage_pct{pod_name:<span
    class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223,
    80, 0)">${host}</span>}by{pod_name}.rollup(avg,60)&amp;from=<span class="hljs-variable"
    style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223, 80, 0)">${start_time_seconds}</span>&amp;to=<span
    class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223,
    80, 0)">${end_time_seconds}</span></pre><ul><li><strong>Metrics Method</strong>
    – Select <strong>GET</strong> or <strong>POST</strong>.</li><li><strong>Response
    Mapping</strong> – In this section you will map the keys in the JSON response
    to Harness fields.</li><li><strong>Transaction Name</strong> – Select either <strong>Fixed</strong>,
    or <strong>Dynamic</strong> depending on the transaction name. In our example,
    we will use <strong>Fixed</strong>. If you select <strong>Dynamic</strong>, you
    will see the <strong>Transaction Name Path</strong> and <strong>Regex to transform
    Transaction Name</strong> fields. The Transaction Name Path is filled out in the
    same way as <strong>Name</strong> below. You use <strong>Regex to transform Transaction
    Name</strong> to truncate the value of the <strong>Transaction Name Path</strong>,
    if needed.</li><li><strong>Name</strong> – Enter a name to map to the metric name.
    For example, if the metric name is <code>kubernetes.memory.usage_pct</code> then
    use a name like <strong>KubeMemory</strong>.</li><li><strong>Metrics Value</strong> –
    Run the query using <strong>Guide from an example</strong> to see the JSON response
    and pick a key to map to <strong>Metrics Value</strong>.</li></ul><p>In <strong>Guide
    from an example</strong>, specify the time range and host for the query. To specify
    the time range, click in the <strong>${startTime}</strong> and <strong>${endTime}</strong> calendars.</p><p>To
    specify the <strong>${host}</strong>, get the full name of a host from Datadog
    Metrics Explorer:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149198644/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149198644/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><p>To
    copy the name, click in the graph and click <strong>Copy tags to clipboard</strong>.</p><figure><a
    href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149404762/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149404762/image.png"
    style="max-height:25%;max-width:25%" data-hd-height="25%" data-hd-width="25%"/></a></figure><p>Next,
    paste the name in the <strong>${host}</strong> field.</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149478697/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/qxo546rm6h/1556149478697/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><p>Click <strong>Submit</strong>.
    The JSON results appear. Click the name of the field to map to <strong>Metrics
    Value</strong>.</p><ul><li><strong>Timestamp</strong> – Use <strong>Guide from
    an example</strong> to query Datadog and return the JSON response. In the JSON
    response, click the key that includes the timestamp.</li><li><strong>Timestamp
    Format</strong> – Enter a timestamp format. The format follows the Java <a href="https://docs.oracle.com/javase/8/docs/api/java/text/SimpleDateFormat.html"
    target="_blank">SimpleDateFormat</a>. For example, a timestamp syntax might be <code>yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSX</code>.
    If you leave this field empty, Harness will use the default range of 1 hour previous
    (<code>now-1h</code>) to now.</li></ul><p>Now that the Metric Collection is complete,
    click <strong>UPDATE</strong> to return to the rest of the <strong>Metrics Verification
    State</strong> settings.</p><ul><li><strong>Canary Analysis</strong> – Harness
    will compare the metrics received for the nodes deployed in each phase with metrics
    received for the rest of the nodes in the application. For example, if this phase
    deploys to 25% of your nodes, the metrics received from Custom APM during this
    deployment for these nodes will be compared with metrics received for the other
    75% during the defined period of time.</li><li><strong>Previous Analysis</strong>
    – Harness will compare the metrics received for the nodes deployed in each phase
    with metrics received for all the nodes during the previous deployment. For example,
    if this phase deploys V1.2 to node A, the metrics received from Custom APM during
    this deployment will be compared to the metrics for nodes A, B, and C during the
    previous deployment (V1.1). Previous Analysis is best used when you have predictable
    load, such as in a QA environment.</li><li><strong>Failure Criteria</strong> –
    Specify the sensitivity of the failure criteria. When the criteria is met, the
    Workflow&#39;s Failure Strategy is triggered.</li><li><strong>Data Collection
    Interval</strong> - Specify the frequency with which Harness will query Datadog,
    The value <strong>2</strong> is recommended.</li></ul><p>Click <strong>SUBMIT</strong>.
    Now the Datadog custom verification step is added to the Workflow. Run your Workflow
    to see the results.</p><h3>Verification Results</h3><p>Once you have deployed
    your Workflow (or Pipeline) using the Custom verification step, you can automatically
    verify cloud application and infrastructure performance across your deployment.</p><h4>Workflow
    Verification</h4><p>To see the results of Harness machine-learning evaluation
    of your Custom verification, in your Workflow or Pipeline deployment, you can
    expand the <strong>Verify Service</strong> step and then click the <strong>APM</strong>
    <strong>Verification</strong> step.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536097934172/image.png"/></figure><h4>Continuous
    Verification</h4><p>You can also see the evaluation in the <strong>Continuous
    Verification</strong> dashboard. The Workflow verification view is for the DevOps
    user who developed the workflow; the <strong>Continuous Verification</strong>
    dashboard is where all deployments are displayed for developers and others interested
    in deployment analysis.</p><p>To learn about the verification analysis features,
    see the following sections.</p><h5>Transaction Analysis</h5><table><tbody><tr><td><p><strong>Execution
    details:</strong> See the details of verification execution. Total is the total
    time the verification step took, and Analysis duration is how long the analysis
    took.</p><p><strong>Risk level analysis:</strong> Get an overall risk level and
    view the cluster chart to see events.</p><p><strong>Transaction-level summary:</strong>
    See a summary of each transaction with the query string, error values comparison,
    and a risk analysis summary.</p></td><td><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/xpftsz2cte/1535665317967/image.png"/></figure></td></tr></tbody></table><h5>Execution
    Analysis</h5><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497249316/image.png"/></figure></td><td><p><strong>Event
    type:</strong> Filter cluster chart events by Unknown Event, Unexpected Frequency,
    Anticipated Event, Baseline Event, and Ignore Event.</p><p><strong>Cluster chart:</strong>
    View the chart to see how the selected event contrasts with anticipated events.
    Click each event to see its log details.</p></td></tr></tbody></table><h5>Event
    Management</h5><table><tbody><tr><td><p><strong>Event-level analysis:</strong>
    See the threat level for each event captured.</p><p><strong>Tune event capture:</strong>
    Remove events from analysis at the Service, Workflow, Execution, or overall level.</p><p><strong>Event
    distribution:</strong> Click the chart icon to see an event distribution including
    the measured data, baseline data, and event frequency.</p></td><td><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497306015/image.png"/></figure></td></tr></tbody></table><p></p><h3>Next
    Step</h3><ul><li><a href="/article/a14rx2n07o-appdynamics-custom">6 – AppDynamics
    as a Custom APM</a></li></ul><p></p>'
  slug: 3-datadog-as-a-custom-apm
  tags:
  - Datadog
  - Metrics Provider
  - API key
  - Verification Provider
  - verification
  - Workflow
  - Deployment Verification
  is_live: true
