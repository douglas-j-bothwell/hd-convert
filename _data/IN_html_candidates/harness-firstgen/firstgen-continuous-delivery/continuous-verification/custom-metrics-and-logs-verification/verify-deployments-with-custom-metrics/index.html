<p></p><p>This topic describes how to add a custom APM (metrics) verification step in a Harness Workflow. For more information about Workflows, see <a href="/article/m220i1tnia-workflow-configuration">Add a Workflow</a>.</p><p>Once you run a deployment and your custom metrics provider obtains its data, Harness machine-learning verification analysis will assess the risk level of the deployment using the data from the provider.</p><div class="tip-callout">In order to obtain the names of the host(s), pod(s), or container(s) where your service is deployed, the verification provider should be added to your Workflow <em>after</em> you have run at least one successful deployment.</div><p>In this topic:</p><ul><li> <a href="#before_you_begin">Before You Begin</a></li><li> <a href="#step_1_set_up_the_deployment_verification">Step 1: Set Up the Deployment Verification</a></li><li> <a href="#step_2_metrics_name">Step 2: Metrics Name</a></li><li> <a href="#step_3_metrics_type">Step 3: Metrics Type</a></li><li> <a href="#step_4_metrics_collection_url">Step 4: Metrics Collection URL</a></li><li> <a href="#step_5_metrics_method">Step 5: Metrics Method</a></li><li> <a href="#step_6_response_mapping_transaction_name">Step 6: Response Mapping Transaction Name</a></li><li> <a href="#step_7_name">Step 7: Name</a></li><li> <a href="#step_8_transaction_name_path">Step 8: Transaction Name Path</a></li><li> <a href="#step_9_regex_to_transform_transaction_name">Step 9: Regex to transform Transaction Name</a></li><li> <a href="#step_10_metrics_value">Step 10: Metrics Value</a></li><li> <a href="#step_11_hostname_json_path">Step 11: Hostname JSON path</a></li><li> <a href="#step_12_timestamp">Step 12: Timestamp</a></li><li> <a href="#step_13_timestamp_format">Step 13: Timestamp Format</a></li><li> <a href="#step_14_custom_thresholds">Step 14: Custom Thresholds</a></li><li> <a href="#step_15_expression_for_host_container">Step 15: Expression for Host/Container</a></li><li> <a href="#step_16_analysis_time_duration">Step 16: Analysis Time Duration</a></li><li> <a href="#step_17_data_collection_interval">Step 17: Data Collection Interval</a></li><li> <a href="#step_18_baseline_for_risk_analysis">Step 18: Baseline for Risk Analysis</a></li><li> <a href="#step_19_execute_with_previous_steps">Step 19: Execute with previous steps</a></li><li> <a href="#step_20_failure_criteria">Step 20: Failure Criteria</a></li><li> <a href="#step_21_include_instances_from_previous_phases">Step 21: Include instances from previous phases</a></li><li> <a href="#step_22_wait_interval_before_execution">Step 22: Wait interval before execution</a></li><li> <a href="#review_additional_notes">Review: Additional Notes</a></li></ul><p></p><h3>Before You Begin</h3><ul><li>See <a href="/article/e87u8c63z4-custom-verification-overview">Custom Verification Overview</a>.</li><li>See <a href="/article/iocufp9eb2-connect-to-custom-verification-for-custom-metrics">Connect to Custom Verification for Custom Metrics</a>.</li></ul><p></p><h3>Step 1: Set Up the Deployment Verification</h3><p>To verify your deployment with a custom metric or log provider, do the following:</p><ol><li>Ensure that you have added Custom Metrics Provider as a verification provider, as described in <a href="/article/iocufp9eb2-connect-to-custom-verification-for-custom-metrics">Connect to Custom Verification for Custom Metrics</a>.</li><li>In your workflow, under <strong>Verify Service</strong>, click <strong>Add Verification</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535478536625/image.png"/></figure></li><li>In the resulting <strong>Add Step</strong> settings, select <strong>Performance Monitoring</strong> &gt; <strong>Custom Metrics</strong>.</li><li>Click <strong>Next</strong>. The <strong>Configure </strong><strong>Custom Metrics</strong> settings appear.</li><li>In <strong>Metrics Data Provider</strong>, select the custom metric provider you added, described in <a href="/article/iocufp9eb2-connect-to-custom-verification-for-custom-metrics">Connect to Custom Verification for Custom Metrics</a>.</li><li>In <strong>Metrics Type</strong>, select <strong>Infrastructure</strong> or <strong>Transaction</strong>.</li><li>Add a <strong>Metric Collections</strong> section.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/d959kzrl39/1580940988572/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><p></p><h3>Step 2: Metrics Name</h3><p>Enter a name for the type of error you are collecting, such as <strong>HttpErrors</strong>.</p><h3>Step 3: Metrics Type</h3><p>For the <strong>Infrastructure</strong> Metrics Type, select the type of metric you want to collect:</p><ul><li><strong>Infra</strong> -–Infrastructure metrics, such as CPU, memory, and HTTP errors.</li><li><strong>Value</strong> – <a href="https://docs.newrelic.com/docs/apm/new-relic-apm/apdex/apdex-measure-user-satisfaction" target="_blank">Apdex</a> (measures user satisfaction with response time).</li><li><strong>Lower Value</strong> – Values below the average.</li></ul><p>For the <strong>Transaction</strong> Metrics Type, select the type of metric you want to collect:</p><ul><li>Error</li><li>Response Time</li><li>Throughput</li></ul><h4>Always Use Throughput with Error and Response Time Metrics</h4><p>Whenever you use the Error metric type, you should also add another metric for Throughput with the same Transaction Name.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/0qvier4m49/1606857927356/image.png"/></figure><p>Harness analyze errors as error percentage and without the throughput the error number does not provide much information.</p><p>The same setup should used with the Response Time metric also. Whenever you set up a Response Time metric, setup a Throughput metric with the same Transaction Name.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/0qvier4m49/1606857610464/image.png"/></figure><h3>Step 4: Metrics Collection URL</h3><p>Enter a query for your verification. You can simply make the query in your Verification Provider and paste it in this field. For example, in New Relic Insights, you might have the following query:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536084078382/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536084078382/image.png"/></a></figure><p>You can paste the query into the <strong>Metrics Collection URL</strong> field:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536084138311/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536084138311/image.png"/></a></figure><p>For information on New Relic Insights NRSQL, see <a href="https://docs.newrelic.com/docs/insights/nrql-new-relic-query-language/nrql-resources/nrql-syntax-components-functions" target="_blank">NRQL syntax, components, functions</a> from New Relic.The time range for a query (<strong>SINCE</strong> clause in our example) should be less than 5 minutes to avoid overstepping the time limit for some verification providers.</p><p>Most often, when you create your query, you will include a hostname placeholder in the query, <code>${host}</code>. This placeholder will be used later when setting up the <strong>Metrics Value</strong> and other settings that use <strong>Guide from an example</strong>.</p><p>For example, if your query is:</p><p><code>SELECT count(host) FROM Transaction SINCE 30 MINUTES AGO COMPARE WITH 1 WEEK AGO WHERE host = &#39;37c444347ac2&#39; TIMESERIES</code></p><p>Then you replace the host name with the <code>${host}</code> placeholder and paste the query into <strong>Metrics Collection URL</strong>:</p><p><code>SELECT count(host) FROM Transaction SINCE 30 MINUTES AGO COMPARE WITH 1 WEEK AGO WHERE host = &#39;${host}&#39; TIMESERIES</code></p><p>Make sure the <code>${start_time_seconds}</code> and <code>${end_time_seconds}</code> parameters are included in the query.</p><p>These variables define a 1-minute interval from the time the Workflow Verification starts. To modify the time interval, click <strong>Edit Step</strong> &gt; <strong>APM</strong> &gt; <strong>Custom</strong> and update the Data Collection Interval in minutes field.</p><p>An example part of the query with these values appears as follows:</p><p><code>from=${start_time_seconds}&amp;to=${end_time_seconds}</code></p><p>For verification providers that accept values in milliseconds, you can use the <code>${start_time}</code> and <code>${end_time}</code> variables.</p><p></p><h3>Step 5: Metrics Method</h3><p>Select <strong>GET</strong> or <strong>POST</strong>. If you select POST, the <strong>Metric Collection Body</strong> field appears.</p><p></p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/d959kzrl39/1580949428977/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/d959kzrl39/1580949428977/image.png" style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></a></figure><p>In <strong>Metric Collection Body</strong>, enter the JSON body to send as a payload when making a REST call to the APM Provider. The requirements of the JSON body will depend on your APM provider.</p><p>You can use variables you created in the Service and Workflow in the JSON, as well as <a href="/article/9dvxcegm90-variables">Harness built-in variables</a>.</p><h3>Step 6: Response Mapping Transaction Name</h3><p>These settings are for specifying which JSON fields in the responses to use.</p><p>Select <strong>Fixed</strong> or <strong>Dynamic</strong>.</p><p><strong>Fixed:</strong> Use this option when all metrics are for the same transaction. For example, a single login page.</p><p><strong>Dynamic:</strong> Use this option when the metrics are for multiple transactions.</p><h3>Step 7: Name</h3><p>Fixed</p><p>Enter the name with which you want to identify the transaction.</p><h3>Step 8: Transaction Name Path</h3><p>Dynamic</p><p>This is the JSON label for identifying a transaction name. In the case of our example New Relic Insights query, the FACET clause is used to group results by the attribute <strong>transactionName</strong>. You can obtain the field name that records the <strong>transactionName</strong> by using the <strong>Guide from an example</strong> feature:</p><ol><li>Click <strong>Guide from an example</strong>. The <strong>Select Key from Example</strong> popover appears.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/d959kzrl39/1580949200459/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/d959kzrl39/1580949200459/image.png" style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></a></figure>The Metrics URL Collection is based on the query you entered in the <strong>Metric Collection URL field</strong> earlier.</li><li>In <strong>${host}</strong>, select a host to query. Click the query next to <strong>GET</strong> to see how the host you selected replaces the <code>${host}</code> placeholder in your query.</li><li>Click <strong>SEND</strong>. The query is executed and the JSON is returned.</li><li>Locate the field name that is used to identify transactions. In our New Relic Insights query, it is the <strong>facets.name</strong> field.<br/>If no metrics are found, you will see a <code>METRIC DATA NOT FOUND</code> error.<br/> In New Relic Insights, you can find the name in the JSON of your query results.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095120978/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095120978/image.png" style="max-height:25%;max-width:25%" data-hd-height="25%" data-hd-width="25%"/></a></figure></li><li>Click the field <strong>name</strong> under facets. The field path is added to the <strong>Transaction Name Path</strong> field.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095167499/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095167499/image.png"/></a></figure></li></ol><h3>Step 9: Regex to transform Transaction Name</h3><p>Dynamic</p><p>Enter a regex expression here to obtain the specific name from the transaction path.</p><p>For example, if your Transaction Name Path JSON evaluated to a value such as <code>name : TxnName</code>, you can write a regex to remove everything other than <code>TxnName</code>.</p><p>For example <code>(name:(.*),)</code> or <code>(?&lt;=:).*(?=,)</code>.</p><h3>Step 10: Metrics Value</h3><p>Specify the value for the event count. This is used to filter and aggregate data returned in a SELECT statement. To find the correct label for the value, do the following:</p><ol><li>Click <strong>Guide from an example</strong>. The example popover appears.<br/>The Metrics URL Collection is based on the query you entered in the <strong>Metric Collection URL field</strong> earlier. The <strong>${host}</strong> field refers to the <code>${host}</code> variable in your query.</li><li>Click <strong>Submit</strong>. The query is executed and the JSON is returned.<br/>If no metrics are found, you will see a <code>METRIC DATA NOT FOUND</code> error.</li><li>Locate the field name that is used to count events. In our New Relic Insights query, it is the <strong>facets.timeSeries.results.count</strong> field.<br/>In New Relic Insights, you can find the name in the JSON of your query results.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095067758/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095067758/image.png" style="max-height:25%;max-width:25%" data-hd-height="25%" data-hd-width="25%"/></a></figure></li><li>Click the name of the field <strong>count</strong>. The field path is added to the <strong>Metrics Value</strong> field.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095193376/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095193376/image.png"/></a></figure></li></ol><h3>Step 11: Hostname JSON path</h3><p>(Displayed if <code>${host}</code> is present in the <strong>Metrics Collection URL query</strong>)</p><p>Use <strong>Guide from an example</strong> to select a host and query your APM. Click the name of the hostname JSON label in the response.</p><p>If there is no hostname in the response, leave this setting empty.</p><h3>Step 12: Timestamp</h3><p>Specify the value for the timestamp in the query. To find the correct label for the value, do the following:</p><ol><li>Click <strong>Guide from an example</strong>. The <strong>Select Key from Example</strong> popover appears.<br/>The Metrics URL Collection is based on the query you entered in the <strong>Metric Collection URL field</strong> earlier.</li><li>Click <strong>Submit</strong>. The query is executed and the JSON is returned.</li><li>Locate the field name that is used for the time series <strong>endTimeSeconds</strong>. In our New Relic Insights query, it is the <strong>facets.timeSeries.endTimeSeconds</strong> field.<br/>In New Relic Insights, you can find the name in the JSON of your query results.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095482626/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095482626/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure></li><li>Click the name of the field <strong>endTimeSeconds</strong>. The field path is added to the <strong>Timestamp</strong> field.<figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095551864/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/27w7uso9r4/1536095551864/image.png"/></a></figure></li></ol><h3>Step 13: Timestamp Format</h3><p>Enter the format of the timestamp included in the query <em>request</em> (not response), set in <strong>Timestamp</strong>. The format follows the <a href="https://docs.oracle.com/javase/8/docs/api/java/text/SimpleDateFormat.html" target="_blank">Java SimpleDateFormat</a>. For example, a timestamp syntax might be <strong>yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSX</strong>. If you leave this field empty, Harness will use the default range of 1 hour previous (now-1h) to now.</p><p>When you are done, the settings will look something like this:</p><p></p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/d959kzrl39/1580941536467/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Click <strong>Test</strong> and then click <strong>Add</strong>.</p><h3>Step 14: Custom Thresholds</h3><p>In the <strong>Configure </strong><strong>Custom Metrics</strong> dialog, you can access the <strong>Custom Thresholds</strong> section once you have configured at least one Metrics Collection. You can use Custom Thresholds to define two types of rules that override normal verification behavior:</p><ul><li><strong>Ignore Hints</strong> that instruct Harness to skip certain metrics/value combinations from verification analysis.</li><li><strong>Fast-Fail Hints</strong> that cause a Workflow to enter a failed state.</li></ul><p>For details about defining Custom Thresholds, see <a href="/article/z2n6mnf7u0-custom-thresholds">Apply Custom Thresholds to Deployment Verification</a>.</p><div class="tip-callout">In deployment, where a Fast-Fail Hint moves a Workflow to a failed state, the Workflow&#39;s Details panel for that Verification step will indicate the corresponding threshold.</div><h3>Step 15: Expression for Host/Container</h3><p>The expression entered here should resolve to a host/container name in your deployment environment. By default, the expression is <strong>${instance.host.hostName}</strong>.</p><h3>Step 16: Analysis Time Duration</h3><p>Set the duration for the verification step. If a verification step exceeds the value, the workflow <a href="/article/m220i1tnia-workflow-configuration#failure_strategy">Failure Strategy</a> is triggered. For example, if the Failure Strategy is <strong>Ignore</strong>, then the verification state is marked <strong>Failed</strong> but the workflow execution continues.</p><p>Harness waits 2-3 minutes before beginning the analysis to avoid initial deployment noise. This is a standard with monitoring tools.</p><h3>Step 17: Data Collection Interval</h3><p>Specify the frequency at which Harness will run the query. Harness recommends the value 1 (1 minute).</p><div class="note-callout">If the data collection interval is greater than 1 minute, Harness expects a response with multiple timestamped rows to be returned (1 per minute). This is to avoid losing granularity.</div><h3>Step 18: Baseline for Risk Analysis</h3><p>See <a href="/article/0avzb5255b-cv-strategies-and-best-practices">CV Strategies, Tuning, and Best Practices</a>.</p><h3>Step 19: Execute with previous steps</h3><p>Check this checkbox to run this verification step in parallel with the previous steps in <strong>Verify Service</strong>.</p><h3>Step 20: Failure Criteria</h3><p>Specify the sensitivity of the failure criteria. When the criteria is met, the workflow <strong>Failure Strategy</strong> is triggered.</p><h3>Step 21: Include instances from previous phases</h3><p>If you are using this verification step in a multi-phase deployment, select this checkbox to include instances used in previous phases when collecting data. Do not apply this setting to the first phase in a multi-phase deployment.</p><h3>Step 22: Wait interval before execution</h3><p>Set how long the deployment process should wait before executing the verification step.</p><h3>Review: Additional Notes</h3><ul><li>Depending on the custom metric provider you select, you might need to provide different information to the <strong>Metric Collections</strong> section. For example, you might need to provide a hostname for the <strong>Guide from an example</strong> popover to use to retrieve data. The hostname will be the host/container/pod/node name where the artifact is deployed. In you look in the JSON for the deployment environment, the hostname is typically the <strong>name</strong> label under the <strong>host</strong> label.</li><li>The <strong>Compare With Previous Run</strong> option is used for Canary deployments where the second phase is compared to the first phase, and the third phase is compared to the second phase, and so on. Do not use this setting in a single phase workflow or in the first phase of a multi-phase workflow.</li></ul><p></p>