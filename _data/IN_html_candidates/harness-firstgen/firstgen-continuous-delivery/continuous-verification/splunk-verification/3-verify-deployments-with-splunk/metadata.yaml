type: article
article_id: zi7doy7zn8
user_id: mfr0nxh4be
category_id: wnxi7xc4a4
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: Verify Deployments with Splunk
slug: 3-verify-deployments-with-splunk
description: How to add Splunk to a Harness Workflow, where Harness can analyze Splunk
  metrics to verify, rollback, and improve deployments.
short_version: Harness can analyze Splunk data to verify, rollback, and improve deployments.
tags:
- Splunk
- Deployment Verification
- Workflow
- Verification Provider
- verification
- risk analysis
- Kubernetes
- fields.conf
- Splunk Connect
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2021-08-30T16:23:08.335197Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Verify Deployments with Splunk
  description: How to add Splunk to a Harness Workflow, where Harness can analyze
    Splunk metrics to verify, rollback, and improve deployments.
  short_version: Harness can analyze Splunk data to verify, rollback, and improve
    deployments.
  body: '<p></p><p>The following procedure describes how to add Splunk as a verification
    step in a Harness workflow. For more information about workflows, see <a href="/article/m220i1tnia-workflow-configuration">Add
    a Workflow</a>.</p><p>Once you run a deployment and Splunk preforms verification,
    Harness&#39; machine-learning verification analysis will assess the risk level
    of the deployment.</p><div class="tip-callout">In order to obtain the names of
    the host(s), pod(s), or container(s) where your service is deployed, the verification
    provider should be added to your workflow <strong>after</strong> you have run
    at least one successful deployment.</div><p>In this topic:</p><ul><li> <a href="#before_you_begin">Before
    You Begin</a></li><li> <a href="#visual_summary">Visual Summary</a></li><li> <a
    href="#step_1_set_up_the_deployment_verification">Step 1: Set Up the Deployment
    Verification</a></li><li> <a href="#step_2_splunk_server">Step 2: Splunk Server</a></li><li>
    <a href="#step_3_search_keywords">Step 3: Search Keywords</a></li><li> <a href="#step_4_field_name_for_host_container">Step
    4: Field name for Host/Container</a></li><li> <a href="#step_5_expression_for_host_container_name">Step
    5: Expression for Host/Container name</a></li><li> <a href="#step_6_analysis_time_duration">Step
    6: Analysis Time duration</a></li><li> <a href="#step_7_baseline_for_risk_analysis">Step
    7: Baseline for Risk Analysis</a></li><li> <a href="#step_8_execute_with_previous_steps">Step
    8: Execute with previous steps</a></li><li> <a href="#option_use_guide_from_example_host_field">Option:
    Use Guide from Example - Host field</a></li><li> <a href="#option_use_guide_from_example_kubernetes">Option:
    Use Guide from Example - Kubernetes</a></li><li> <a href="#review_harness_expression_support_in_cv_settings">Review:
    Harness Expression Support in CV Settings</a></li><li> <a href="#step_9_view_verification_results">Step
    9: View Verification Results</a></li><li> <a href="#next_steps">Next Steps</a></li></ul><p></p><h3>Before
    You Begin</h3><ul><li>See the <a href="/article/dujtd6ek5p-splunk-verification-overview">Splunk
    Verification Overview</a>.</li><li>See <a href="/article/feiv05dmnk-2-24-7-service-guard-for-splunk">Monitor
    Applications 24/7 with Splunk</a>.</li></ul><p></p><h3>Visual Summary</h3><p>Here&#39;s
    an example configuration of the Splunk Deployment Verification.</p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1580890057431/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><h3>Step
    1: Set Up the Deployment Verification</h3><p>To verify your deployment with Splunk,
    do the following:</p><ol><li>Ensure that you have added Splunk as a verification
    provider, as described in <a href="/article/1ruyqq4q4p-1-splunk-connection-setup">Splunk
    Connection Setup</a>.</li><li>In your Workflow, under <strong>Verify Service</strong>,
    click <strong>Add Verification</strong>.</li><li>In the resulting <strong>Add
    Step</strong> settings, select <strong>Log Analysis</strong> &gt; <strong>Splunk</strong>.<figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1580889752023/image.png"
    style="max-height:75%;max-width:75%" data-hd-height="75%" data-hd-width="75%"/></figure></li><li>Click
    <strong>Next</strong>. The <strong>Configure </strong><strong>Splunk</strong>
    settings appear.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1580890057431/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><p>These
    settings include the following fields.</p><p></p><h3>Step 2: Splunk Server</h3><p>Select
    the Harness Verification Provider you configured using your Splunk account.</p><p>You
    can templatize the <strong>Splunk Server</strong> setting by clicking the <strong>[T]</strong>
    button. This puts the expression <code>${Splunk_Server}</code> in the <strong>Splunk
    Server</strong> setting. You can change the variable name in the expression.</p><p>When
    you templatize the <strong>Splunk Server</strong> setting, it creates a <a href="/article/m220i1tnia-workflow-configuration#add_workflow_variables">Workflow
    variable</a>, which is a parameter that must be given a value when the Workflow
    is deployed.</p><p>The following diagram shows the templatized <strong>Splunk
    Server</strong> setting, the Workflow variable it creates, and how you can provide
    a value when you deploy the Workflow.</p><p></p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1575660030607/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1575660030607/image.png"/></a></figure><h3>Step
    3: Search Keywords</h3><p>Enter a search term or query. To search for all exceptions,
    use asterisks (*) around <strong>exception</strong>, for example, <strong>*exception*</strong>.
    For more information, see <a href="http://docs.splunk.com/Documentation/Splunk/7.2.0/SearchTutorial/Startsearching#Retrieve_events_from_the_index"
    target="_blank">Retrieve events from the index</a> from Splunk.</p><p>When you
    enter a search such as <strong>*exception*</strong>, at runtime Harness will generate
    a query containing your search and information Harness needs to perform verification,
    such as the information following <strong>*exception*</strong> below:</p><pre
    class="hljs sql">search *exception* host = ip-172-31-81-88 | bin _time span=1m
    |  <br/>cluster t=0.9999 showcount=t labelonly=t|<br/>table _time, _raw,cluster_label,
    host |<br/>stats latest(_raw) as _raw count as cluster_count by _time,cluster_label,host</pre><p>If
    you want more flexibility in your search, or to repurpose Splunk searches you
    already have, you can click <strong>Advanced Query</strong> and enter whatever
    you like in <strong>Search Keywords</strong>. For example, you could replace <strong>*exception*</strong>
    with an existing Splunk search like <code>search index=*prod *exception*</code>.</p><p>Note
    that you will specify host field name and host/pod/container name in other settings
    so you do not need to include them in the search query.</p><h3>Step 4: Field name
    for Host/Container</h3><p>Typically, you will enter <strong>host</strong>. You
    can enter <strong>host</strong> into the Splunk <strong>Search</strong> field
    to see the host for your Harness deployment:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539722168224/image.png"><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539722168224/image.png"/></a></figure><h3>Step
    5: Expression for Host/Container name</h3><p>See <a href="#guide_from_example">Guide
    From Example</a>.</p><h3>Step 6: Analysis Time duration</h3><p>Set the duration
    for the verification step. If a verification step exceeds the value, the workflow
    <a href="/article/m220i1tnia-workflow-configuration#failure_strategy">Failure
    Strategy</a> is triggered. For example, if the Failure Strategy is <strong>Ignore</strong>,
    then the verification state is marked <strong>Failed</strong> but the workflow
    execution continues.</p><p>See <a href="/article/0avzb5255b-cv-strategies-and-best-practices#analysis_time_duration">CV
    Strategies, Tuning, and Best Practices</a>.</p><h3>Step 7: Baseline for Risk Analysis</h3><p><strong>Canary
    Analysis</strong> - Harness will compare the metrics received for the nodes deployed
    in each phase with metrics received for the rest of the nodes in the application.
    For example, if this phase deploys to 25% of your nodes, the metrics received
    from Splunk during this deployment for these nodes will be compared with metrics
    received for the other 75% during the defined period of time.</p><p><strong>Previous
    Analysis</strong> - Harness will compare the metrics received for the nodes deployed
    in each phase with metrics received for all the nodes during the previous deployment.
    For example, if this phase deploys V1.2 to node A, the metrics received from Splunk
    during this deployment will be compared to the metrics for nodes A, B, and C during
    the previous deployment (V1.1).</p><p>See <a href="/article/0avzb5255b-cv-strategies-and-best-practices">CV
    Strategies, Tuning, and Best Practices</a>.</p><h3>Step 8: Execute with previous
    steps</h3><p>Check this checkbox to run this verification step in parallel with
    the previous steps in <strong>Verify Service</strong>.</p><h3>Option: Use Guide
    from Example - Host field</h3><div class="tip-callout">This section uses a <strong>host</strong>
    field for the <strong>Expression for Host/Container name</strong> field. For Kubernetes,
    see <a href="/article/zi7doy7zn8-3-verify-deployments-with-splunk#kubernetes_and_splunk">Kubernetes
    and Splunk</a>.</div><p>In the Splunk verification step dialog, you can see the
    <strong>Guide From Example</strong> option next to the <strong>Expression for
    Host/Container name</strong> field. This option lets you select the host(s), pod(s),
    or container(s) for Harness to use when performing verification.</p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1620840167229/os-faw-swpvf-mft-lwy-msu-pz-rkbh-5-cvtkzxw-6-h-zcj-ze-1-vkg-p-4-bk-r-2-zd-4-ap-rmzta-wrj-fy-liew-8-lrqfke-a-86-pt-yjy-ehot-0-qhjf-2-s-skh-1-lma-r-5-qn-kay-bpo-lei-2-bff-a-4-y-1-jc-c-8-jh-d-0-d-o-b"/></figure><p>You
    select the host, pod, or container in <strong>Guide From Example</strong>, and
    an expression is added to the <strong>Expression for Host/Container name</strong>
    field. The default expression is <code>${instance.host.hostName}</code>. Typically,
    you can simply use <code>${instance.host.hostName}</code>.</p><p></p><div class="note-callout">For
    AWS EC2 hostnames, use the expression <code>${instance.hostName</code>}.</div><div
    class="tip-callout">In order to obtain the names of the host(s) pod(s), or container(s)
    where your service is deployed, the verification provider should be added to your
    workflow <strong>after</strong> you have run at least one successful deployment.
    Then the <strong>Guide From Example</strong> feature can display the host or container
    name(s) for you to select.</div><p>To ensure that you pick the right name when
    using <strong>Guide From Example</strong>, you can use a host name in Splunk as
    a guide.</p><p>To use <strong>Guide From Example</strong> for a host or container
    name expression, do the following:</p><ol><li>In <strong>Splunk</strong>, click
    <strong>App: Search &amp; Reporting</strong>, and then click <strong>Search &amp;
    Reporting</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539722552708/image.png"/></figure></li><li>In
    <strong>Search</strong>, enter <strong>host</strong> to see a list of the available
    hosts being tracked.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539722643235/image.png"/></figure></li><li>Click
    the name of your host to add it to the search, select a date range, and click
    the search icon. The event log entries for the host appear.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539722827759/image.png"/></figure>The
    name of the host can be seen in the event message, next to <strong>host =</strong>.
    The expression that you provide in the <strong>Expression for Host/Container Name</strong>
    field in the Harness <strong>Splunk</strong> dialog should evaluate to the name
    here.</li></ol><div class="tip-callout">You might have a different label than
    <strong>host</strong>, such as <strong>pod_name</strong>. You simply use the label
    that identifies the host or container.</div><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1564512060240/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><ol><li
    style="counter-increment:li 3" start="4">In your Harness workflow <strong>Splunk</strong>
    dialog, click <strong>Guide From Example</strong>. The <strong>Expression for
    Host Name</strong> popover appears.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539723342286/image.png"/></figure>The
    dialog shows the service, environment, and service infrastructure used for this
    workflow.</li><li>In <strong>Host</strong>, click the name of the host to use
    when testing verification. Match the hostname from the Splunk Search to the hostname
    in the <strong>Expression for Host Name</strong> popover:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539723500152/image.png"/></figure></li><li>Click
    <strong>SUBMIT</strong>. The YAML for the host appears. Look for the <strong>host</strong>
    section.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1620840167372/b-3-lm-uswo-g-8-jm-i-2-juqt-irxe-bnwyvs-na-px-wbie-0-rc-ldi-6-wlu-wkw-es-wu-5-umvp-tgm-u-7-x-xpl-uw-0-kf-5-ws-q-0-vy-sa-j-z-9-r-wc-4-ne-b-6-nvm-55-vi-sa-pl-8-yls-7-vlrk-7-gye-1-ks-5-fw-y-4-z-f-7-qh-zp-3-d"/></figure>You
    want to use a <strong>hostName</strong> label in the <strong>host</strong> section.
    Do not use a <strong>hostName</strong> label outside of that section.<figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539723845042/image.png"/></figure></li><li>Click
    the <strong>hostName</strong> label. The variable name is added to the <strong>Expression
    for Host/Container name</strong> field.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539723948325/image.png"/></figure></li><li>At
    the bottom of the Splunk dialog, click <strong>TEST</strong>. A new <strong>Expression
    for Host Name</strong> popover appears.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539724012320/image.png"/></figure></li><li>In
    <strong>Host</strong>, select the same host you selected last time, and then click
    <strong>RUN</strong>. Verification information for the host is found. In there
    is no verification data for the selected node, the test will display connection
    information only.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539713783157/image.png"/></figure></li><li>Click
    back in the <strong>Splunk</strong> dialog and click <strong>SUBMIT</strong>.
    The Splunk verification step is added to your workflow.</li></ol><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539724080988/image.png"/></figure><p></p><h3>Option:
    Use Guide from Example - Kubernetes</h3><p>In the <strong>Guide From Example</strong>
    section above we used a <strong>host</strong> example for the <strong>Expression
    for Host/Container name</strong> field, but if the Workflow is deploying Kubernetes,
    you will likely use <strong>pod</strong> or <strong>pod_name</strong> or a custom
    label.</p><p>For Kubernetes deployments, your Splunk account must perform Kubernetes
    log collection. This is typically done using <a href="https://github.com/splunk/splunk-connect-for-kubernetes"
    target="_blank">Splunk Connect for Kubernetes</a>. For information on using Splunk
    Connect, see <a href="https://www.splunk.com/blog/2018/12/17/deploy-splunk-enterprise-on-kubernetes-splunk-connect-for-kubernetes-and-splunk-insights-for-containers-beta-part-1.html"
    target="_blank">Deploy Splunk Enterprise on Kubernetes</a> on the Splunk Blog.</p><p>In
    addition, the Splunk <a href="https://docs.splunk.com/Documentation/ITSI/4.2.1/Configure/fields.conf">fields.conf</a>
    file should contain the following fields in order to search Kubernetes logs in
    Splunk:</p><pre> [namespace]<br/> INDEXED = true<br/> <br/> [pod]<br/> INDEXED
    = true<br/> <br/> [container_name]<br/> INDEXED = true<br/> <br/> [container_id]<br/>
    INDEXED = true<br/> <br/> [cluster_name]<br/> INDEXED = true</pre><p>You can edit
    fields.conf in <code>$SPLUNK_HOME/etc/system/local/fields.conf</code> or in a
    custom app directory <code>$SPLUNK_HOME/etc/apps/myapp/local/fields.conf</code>.</p><p>Ensure
    that your Kubernetes deployment is set up to log what you need. See <a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/">Logging
    Architecture</a> from Kubernetes.</p><p></p><h3>Review: Harness Expression Support
    in CV Settings</h3><p>You can use expressions (<code>${...}</code>) for <a href="/article/7bpdtvhq92-workflow-variables-expressions">Harness
    built-in variables</a> and custom <a href="/article/eb3kfl8uls-service-configuration">Service</a>
    and <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow</a>
    variables in the settings of Harness Verification Providers.</p><p></p><figure><img
    src="https://files.helpdocs.io/kw8ldg1itf/other/1586812006289/image.png" style="max-height:50%;max-width:50%"
    data-hd-height="50%" data-hd-width="50%"/></figure><p>Expression support lets
    you template your Workflow verification steps. You can add custom expressions
    for settings, and then provide values for those settings at deployment runtime.
    Or you can use Harness built-in variable expressions and Harness will provide
    values at deployment runtime automatically.</p><p></p><h3>Step 9: View Verification
    Results</h3><p></p><p>Once you have deployed your workflow (or pipeline) using
    the Splunk verification step, you can automatically verify app performance across
    your deployment. For more information, see <a href="/article/m220i1tnia-workflow-configuration">Add
    a Workflow</a> and <a href="/article/zc1u96u6uj-pipeline-configuration">Add a
    Pipeline</a>.</p><h4>Workflow Verification</h4><p>After you add the Splunk verification
    step to your workflow, the next time you deploy the workflow you will see the
    Splunk verification step running:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539713954661/image.png"/></figure><p>To
    see the results of Harness machine-learning evaluation of your Splunk verification,
    in your workflow or pipeline deployment you can expand the <strong>Verify Service</strong>
    step and then click the <strong>Splunk</strong> step.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zi7doy7zn8/1578094173741/image.png"/></figure><h4>Continuous
    Verification</h4><p>You can also see the evaluation in the <strong>Continuous
    Verification</strong> dashboard. The workflow verification view is for the DevOps
    user who developed the workflow. The <strong>Continuous Verification</strong>
    dashboard is where all future deployments are displayed for developers and others
    interested in deployment analysis.</p><p>To learn about the verification analysis
    features, see the following sections.</p><h5>Transaction Analysis</h5><table><tbody><tr><td><p><strong>Execution
    details:</strong> See the details of verification execution. Total is the total
    time the verification step took, and Analysis duration is how long the analysis
    took.</p><p><strong>Risk level analysis:</strong> Get an overall risk level and
    view the cluster chart to see events.</p><p><strong>Transaction-level summary:</strong>
    See a summary of each transaction with the query string, error values comparison,
    and a risk analysis summary.</p></td><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/fq1ompej1b/1539724430957/image.png"/></figure></td></tr></tbody></table><h5>Execution
    Analysis</h5><table><tbody><tr><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/uw64fijctw/1535497249316/image.png"/></figure></td><td><p><strong>Event
    type:</strong> Filter cluster chart events by Unknown Event, Unexpected Frequency,
    Anticipated Event, Baseline Event, and Ignore Event.</p><p><strong>Cluster chart:</strong>
    View the chart to see how the selected event contrast. Click each event to see
    its log details.</p></td></tr></tbody></table><h5>Event Management</h5><table><tbody><tr><td><p><strong>Event-level
    analysis:</strong> See the threat level for each event captured.</p><p><strong>Tune
    event capture:</strong> Remove events from analysis at the service, workflow,
    execution, or overall level.</p><p><strong>Event distribution:</strong> Click
    the chart icon to see an event distribution including the measured data, baseline
    data, and event frequency.</p></td></tr></tbody></table><p></p><h3>Next Steps</h3><ul><li>
    <a href="/article/htvzryeqjw-configuration-as-code">Configuration as Code</a></li><li>
    <a href="/article/ven0bvulsj-users-and-permissions">Users and Permissions</a></li></ul><p></p>'
  slug: 3-verify-deployments-with-splunk
  tags:
  - Splunk
  - Deployment Verification
  - Workflow
  - Verification Provider
  - verification
  - risk analysis
  - Kubernetes
  - fields.conf
  - Splunk Connect
  is_live: true
