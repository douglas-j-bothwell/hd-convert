type: article
article_id: aedsdsw9cm
user_id: mfr0nxh4be
category_id: vbcmo6ltg7
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: AWS AMI Deployments Overview
slug: aws-ami-deployments-overview
description: A summary of Harness AWS AMI and ASG implementation.
short_version: A summary of Harness AWS AMI and ASG implementation.
tags:
- AMI overview
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: ""
  source: API
  triggered_at: 2022-07-18T21:48:51.88642Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: AWS AMI Deployments Overview
  description: A summary of Harness AWS AMI and ASG implementation.
  short_version: A summary of Harness AWS AMI and ASG implementation.
  body: '<p>This topic describes the concept of a Harness AWS AMI deployment by describing
    the high-level steps involved.</p><p>For a quick tutorial, see the <a href="/article/wfk9o0tsjb-aws-ami-deployments">AWS
    AMI Quickstart</a>.</p><p>For detailed instructions on using AWS AMI in Harness,
    see the <a href="/category/mizega9tt6-ami-deployments">AWS AMI How-tos</a>.</p><h3>Before
    You Begin</h3><p>Before learning about Harness AWS AMI deployments, you should
    have an understanding of <a href="/article/4o7oqwih6h-harness-key-concepts">Harness
    Key Concepts</a>.</p><h3>What Does Harness Need Before You Start?</h3><p>A Harness
    AWS AMI deployment requires the following:</p><ul><li>A working AWS AMI that Harness
    will use to create your instances.</li><li>A working Auto Scaling Group (ASG)
    that Harness will use as a template for the ASG that Harness will create. The
    template ASG is referred to as the <strong>base ASG</strong> in Harness documentation.</li><li>An
    AWS Instance or ECS cluster in which to install a Harness Delegate.</li><li>IAM
    Role for the Harness Cloud Provider connection to AWS.</li></ul><h3>What Does
    Harness Deploy?</h3><p>Harness takes the AMI and base ASG you provide, and creates
    a new ASG and populates it with instances using the AMI. You can specify the desired,
    min, and max instances for the new ASG, resize strategy, and other settings in
    Harness.</p><div class="note-callout">Harness specifically supports AWS <em>target</em> tracking
    scaling policies. For details, see AWS&#39; <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-scale-based-on-demand.html#as-scaling-types">Dynamic
    Scaling for Amazon EC2 Auto Scaling</a> topic.</div><h3>What Does a Harness AWS
    AMI Deployment Involve?</h3><p>The following list describes the major steps of
    a Harness AWS AMI deployment:</p><p></p><table><tbody><tr><td><p><strong>Step</strong></p></td><td><p><strong>Name</strong></p></td><td><p><strong>Description
    and Links</strong></p></td></tr><tr><td><p>1</p></td><td><p>Install the Harness
    Shell Script or ECS <strong>Delegate</strong> in your target EC2 subnet.</p></td><td><p>Typically,
    the Shell Script or ECS Delegate is installed in the same subnet where you will
    deploy your application(s).</p><p>This is the same subnet as your base ASG, using
    the same security group and the same key pair.</p></td></tr><tr><td><p>2</p></td><td><p>Add
    an <strong>AWS</strong> <strong>Cloud Provider</strong>.</p></td><td><p>An AWS Cloud
    Provider is a connection to your AWS account.</p><p>The AWS Cloud Provider is
    used to obtain the AMI Harness will use to create new instances, the base ASG
    Harness will uses a template, and to deploy the new instances.</p></td></tr><tr><td><p>3</p></td><td><p>Create
    the Harness <strong>Application</strong> for your AMI CD Pipeline.</p></td><td><p>The
    Harness Application represents a group of microservices, their deployment pipelines,
    and all the building blocks for those pipelines. Harness represents your release
    process using a logical group of one or more entities: Services, Environments,
    Workflows, Pipelines, Triggers, and Infrastructure Provisioners. Applications
    organize all of the entities and configurations in Harness CD.</p></td></tr><tr><td><p>4</p></td><td><p>Create
    the Harness <strong>Service</strong> using the Amazon Machine Image Deployment
    Type.</p></td><td><p>Add an AMI as an artifact in a Harness Service, add any AMI
    User Data, and any config variables and files.</p></td></tr><tr><td><p>5</p></td><td><p>Create
    the Harness <strong>Environment</strong> and Infrastructure Definition for your
    deployment, and any overrides.</p></td><td><p>Using the Harness AWS Cloud Provider
    you set up, you can select the base ASG and target environment for your deployment.</p><p>You
    can also override any Service settings, such as User Data values. This enables
    you to use a single Service with multiple Harness Environments.</p></td></tr><tr><td><p>6</p></td><td><p>Create
    the Basic, Canary, and Blue/Green deployments in Harness <strong>Workflows</strong>.</p></td><td><p>The
    Workflow deploys the new ASG and AMI instances defined in the Harness Service
    to the environment in the Harness Infrastructure Definition.</p></td></tr><tr><td><p>7</p></td><td><p>Deploy
    the Workflow.</p></td><td><p>Once you&#39;ve deployed a Workflow, learn how to
    improve your AWS AMI CD:</p><ul><li><a href="/article/m220i1tnia-workflow-configuration">Workflows</a></li><li><a
    href="/article/xerirloz9a-add-a-trigger-2">Triggers</a></li><li><a href="/article/o22jx8amxb-add-an-infra-provisioner">Infrastructure
    Provisioners Overview</a></li></ul></td></tr></tbody></table><h3>How Does Harness
    Downsize Old ASGs?</h3><p>Harness identifies the ASGs it deploys using the Harness
    Infrastructure Definition used to deploy it. During deployments, Harness tags
    the new ASG with an Infrastructure Definition ID.</p><p>It uses that ID to identify
    the previous ASG version(s), and downsize them as described below.</p><p>Harness
    upscales and downsizes in two states, setup and deploy.</p><ul><li><strong>Setup</strong>
    — The setup state is when your new ASG is created.</li><li><strong>Deploy</strong>
    — The deploy phase(s) is when your new ASG is upscaled to the number of new instances
    you requested. This is either a fixed setting (Min, Max, Desired) or the same
    number as the previous ASG.</li></ul><div class="note-callout">Instances are always
    tied to their ASG. A New ASG does not take instances from an old ASG.</div><p>During
    setup state:</p><ul><li>The previous ASG is kept with non-zero instance count.
    It is identified by its tag containing the Infrastructure Definition ID and the
    highest revision number, such as <strong>_7</strong>. Any older ASGs are downsized
    to 0.</li><li>New ASG is created with 0 count.</li><li>For old ASGs that have
    0 instances, Harness keeps the 3 last old ASGs and deletes the rest.</li></ul><p>During
    deploy phases:</p><ul><li>New ASG is upscaled to the number of new instances you
    requested.</li><li>Previous ASG is gradually downsized. In the case of a Canary
    deployment, the old ASG is downsized in the inverse proportion to the new ASG&#39;s
    upscale. If the new ASG is upscaled 25% in phase 1, the previous ASG is downsized
    25%.</li></ul><p>At the end of deployment:</p><ul><li>New ASG has the number of
    new instances you requested. In Canary, this is always 100%.</li><li>Previous
    ASG is downsized to 0.</li></ul><h4>Rollback</h4><p>If rollback occurs, the previous
    ASG is upscaled to its pre-setup number of instances using new instances.</p><h4>Don&#39;t
    Want a Previous ASG Downsized?</h4><p>As stated earlier, Harness identifies the
    ASGs it deploys using the Harness Infrastructure Definition used to deploy it.
    During deployments, Harness tags the new ASG with an Infrastructure Definition
    ID.</p><p>It uses that ID to identify the previous ASG version(s), and downsize
    them as described above.</p><p>If you do not want a previously deployed ASG to
    be downsized, then you must use a <u>new</u> Infrastructure Definition for future
    ASG deployments. A new ASG name is not enough.</p><h3>Next Steps</h3><p>Read the
    following topics to build on what you&#39;ve learned:</p><ul><li><a href="/article/wfk9o0tsjb-aws-ami-deployments">AWS
    AMI Quickstart</a></li><li><a href="/category/mizega9tt6-ami-deployments">AWS
    AMI How-tos</a></li></ul><p></p><p></p><p></p>'
  slug: aws-ami-deployments-overview
  tags:
  - AMI overview
  is_live: true
