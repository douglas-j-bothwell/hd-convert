type: article
article_id: ebq6gwgs5r
user_id: mfr0nxh4be
category_id: 4o8zim2tfr
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: Create an Azure VMSS Canary Deployment
slug: create-an-azure-vmss-canary-deployment
description: Currently, this feature is behind the Feature Flag AZURE_VMSS. Contact
  Harness Support to enable the feature.. A Canary virtual machine scale set (VMSS)
  deployment sets up a new VMSS using the image…
short_version: Currently, this feature is behind the Feature Flag AZURE_VMSS. Contact
  Harness Support to enable the feature.. A Canary virtual machine scale set (VMSS)
  deployment sets up a new VMSS using the image…
tags: []
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2021-11-15T22:35:09.682314Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Create an Azure VMSS Canary Deployment
  description: ""
  short_version: ""
  body: '<p></p><div class="note-callout">Currently, this feature is behind the Feature
    Flag <code>AZURE_VMSS</code>. Contact <a href="https://mail.google.com/mail/?view=cm&amp;fs=1&amp;tf=1&amp;to=support@harness.io"
    target="_blank">Harness Support</a> to enable the feature. </div><p></p><p>A Canary
    virtual machine scale set (VMSS) deployment sets up a new VMSS using the image
    you supplied in <a href="/article/c43hmoj6ic-add-your-azure-vm-image-for-deployment">Add
    Your Azure VM Image for Deployment</a> and the base VMSS template you selected
    in <a href="/article/2976rmk4kd-define-your-azure-vmss-target-infrastructure">Define
    Your Azure VMSS Target Infrastructure</a>.</p><p>The Canary Workflow deploys in
    two phases. The first phase creates the new VMSS and deploys a number/percentage
    of the desired instances. Once deployment is successful, the second phase deploys
    100% of the desired instances.</p><div class="note-callout">For other deployment
    strategies, see <a href="/article/74htogyjad-create-an-azure-vmss-basic-deployment">Create
    an Azure VMSS Basic Deployment</a>, and <a href="/article/9op1u6dgks-create-an-azure-vmss-blue-green-deployment">Create
    an Azure VMSS Blue/Green Deployment</a>.</div><p>In this topic:</p><ul><li> <a
    href="#before_you_begin">Before You Begin</a></li><li> <a href="#undefined">Visual
    Summary</a></li><li> <a href="#undefined">Supported Platforms and Technologies</a></li><li>
    <a href="#step_1_create_the_canary_workflow">Step 1: Create the Canary Workflow</a></li><li>
    <a href="#step_2_create_phase_1">Step 2: Create Phase 1</a></li><li> <a href="#step_3_azure_virtual_machine_scale_set_setup">Step
    3: Azure Virtual Machine Scale Set Setup</a></li><li> <a href="#option_use_variable_expressions_in_settings">Option:
    Use Variable Expressions in Settings</a></li><li> <a href="#step_4_upgrade_virtual_machine_scale_set">Step
    4: Upgrade Virtual Machine Scale Set</a></li><li> <a href="#step_5_create_phase_2">Step
    5: Create Phase 2</a></li><li> <a href="#step_6_upgrade_virtual_machine_scale_set">Step
    6: Upgrade Virtual Machine Scale Set</a></li><li> <a href="#step_7_deploy">Step
    7: Deploy</a></li><li> <a href="#option_templatize_the_workflow">Option: Templatize
    the Workflow</a></li><li> <a href="#configure_as_code">Configure As Code</a></li></ul><h3>Before
    You Begin</h3><ul><li> <a href="/article/1h0723zsvm-azure-virtual-machine-scale-set-deployments">Azure
    Virtual Machine Scale Set Deployments Overview</a></li><li> <a href="/article/2976rmk4kd-define-your-azure-vmss-target-infrastructure">Define
    Your Azure VMSS Target Infrastructure</a></li><li> <a href="/article/c43hmoj6ic-add-your-azure-vm-image-for-deployment">Add
    Your Azure VM Image for Deployment</a></li><li><a href="/article/d5hob1zuip-connect-to-your-azure-vmss">Connect
    to Azure for VMSS Deployments</a></li><li> <a href="/article/h9tkwmkrm7-delegate-installation">Harness
    Delegate Overview</a></li><li> <a href="/article/4o7oqwih6h-harness-key-concepts">Harness
    Key Concepts</a></li></ul><h3 id="undefined">Visual Summary</h3><p>Here is a successful
    Canary VMSS deployment, showing both phases:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/ebq6gwgs5r/1602698622586/image.png"
    style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h3
    id="undefined">Supported Platforms and Technologies</h3><p>See <a href="/article/220d0ojx5y-supported-platforms">Supported
    Platforms and Technologies</a>.</p><h3>Step 1: Create the Canary Workflow</h3><p>In
    your Harness Application, click <strong>Workflows</strong>, and then click <strong>Add
    Workflow</strong>.</p><p>Enter the new Workflow&#39;s settings.</p><h4>Name</h4><p>Enter
    a name for the Workflow. You will use this name to locate the Workflow in Deployments
    and to add it to <a href="/article/zc1u96u6uj-pipeline-configuration">Pipelines</a>.</p><h4>Workflow
    Type</h4><p>Select <strong>Canary</strong>. See <a href="/article/325x7awntc-deployment-concepts-and-strategies">Deployment
    Concepts and Strategies</a>.</p><div class="note-callout">For other deployment
    strategies, see <a href="/article/74htogyjad-create-an-azure-vmss-basic-deployment">Create
    an Azure VMSS Basic Deployment</a>, and <a href="/article/9op1u6dgks-create-an-azure-vmss-blue-green-deployment">Create
    an Azure VMSS Blue/Green Deployment</a>.</div><h4>Environment</h4><p>Select the
    Environment you created in <a href="/article/2976rmk4kd-define-your-azure-vmss-target-infrastructure">Define
    Your Azure VMSS Target Infrastructure</a>.</p><p>Later, you will select the Harness
    Service and target Infrastructure Definition in each phase of the Workflow.</p><h4>Submit</h4><p>When
    you are done, click <strong>Submit</strong>.</p><p>When you add phases to the
    Canary Workflow, the deployment steps in the phases are generated automatically.</p><p>Next,
    we&#39;ll take a look at each step&#39;s settings and how you can change them.</p><h3>Step
    2: Create Phase 1</h3><p>The first phase of the Workflow will set up the new VMSS
    and scale it to a count/percentage of your desired instances.</p><ol><li>In <strong>Deployment
    Phases</strong>, click <strong>Add Phase</strong>.</li><li>In Workflow Phase,
    in <strong>Service</strong>, select the Service you created in <a href="/article/c43hmoj6ic-add-your-azure-vm-image-for-deployment">Add
    Your Azure VM Image for Deployment</a>.</li><li>In <strong>Infrastructure Definition</strong>,
    select the Infrastructure Definition you created in <a href="/article/2976rmk4kd-define-your-azure-vmss-target-infrastructure">Define
    Your Azure VMSS Target Infrastructure</a>.</li><li>Click <strong>Submit</strong>.</li></ol><p>The
    new phase&#39;s VMSS steps are added automatically.</p><h3>Step 3: Azure Virtual
    Machine Scale Set Setup</h3><p>The Azure Virtual Machine Scale Set Setup step
    is where you specify the default settings for the new VMSS.</p><p>In particular,
    you specify the min, max, and desired number of instances for the new VMSS.</p><p>These
    correspond to the <strong>Instance limits</strong> settings in <strong>Auto created
    scale condition</strong> in VMSS:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/74htogyjad/1602620781424/image.png"/></figure><p>Later,
    in the <strong>Upgrade Virtual Machine Scale Set</strong> step, you will upgrade
    the number of instances by a percentage or count of the desired instances.</p><h4>Name</h4><p>Enter
    a name for the Workflow step.</p><h4>Virtual Machine Scale Set Name</h4><p>Enter
    a name for the new VMSS. This is the name that will appear in the <strong>Virtual
    machine scale sets</strong> blade in Azure.</p><div class="note-callout">Hyphens
    in the names are converted to double underscores in Azure. For example, if you
    enter <code>doc-basic</code> the name in Azure will be <code>doc__basic</code>.</div><p>The
    first time you deploy, the name of the new VMSS is given the suffix <code>__1</code>.
    Each time you deploy a new VMSS using the same Harness Infrastructure Definition,
    the suffix is incremented, such as <code>__2</code>.</p><p>You can use the default
    name, which is a concatenation of the names of your Application, Service, and
    Environment: <code>${app.name}_${service.name}_${env.name}</code>.</p><div class="note-callout">For
    information on naming and versioning, see <a href="/article/w67zx6mv87-azure-vmss-versioning-and-naming">Azure
    VMSS Versioning and Naming</a>.</div><h4>Instances</h4><p>Select <strong>Fixed</strong>
    or <strong>Same as already running Default Instances</strong>.</p><p>For <strong>Same
    as already running Default instances</strong>, Harness determines if there is
    a previous VMSS deployment for the same Infrastructure Definition. If one is present,
    Harness takes the number of instances from there. If there is no previous deployment,
    Harness uses the default of 6.</p><p>If there is more than one scaling policy
    attached to the already running, previously deployed VMSS, Harness uses the policy
    named <strong>Auto created scale condition</strong> or <strong>Profile1</strong>.</p><p><strong>Fixed</strong>
    allows you to set the min, max, and desired number of instances for the new VMSS.</p><h4>Maximum
    Instances</h4><p>Specify maximum instance count.</p><h4>Minimum Instances</h4><p>Specify
    minimum instance count.</p><h4>Desired Instances</h4><p>Specify the desired instance
    count. This is the same as default instance count in VMSS:</p><blockquote>In case
    there is a problem reading the resource metrics and the current capacity is below
    the default capacity, then to ensure the availability of the resource, Autoscale
    will scale out to the default.</blockquote><blockquote>If the current capacity
    is already higher than the default capacity, Autoscale will not scale in.</blockquote><h4>Resize
    Strategy</h4><p>Select whether you want Harness to resize the new VMSS instances
    first, or after it has downsized the old instances.</p><h4>Auto Scaling Steady
    State Timeout</h4><p>Enter how long you want Harness to wait for this step to
    finish. If the step&#39;s execution exceeds this timeout, Harness fails the deployment.</p><h3>Option:
    Use Variable Expressions in Settings</h3><p>You can use <a href="/article/9dvxcegm90-variables">Harness
    variable expressions</a>, such as <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow
    variables</a>, in certain step settings.</p><p>When you deploy the Workflow, alone,
    in a Pipeline, or using a <a href="/article/xerirloz9a-add-a-trigger-2">Trigger</a>,
    you will be prompted to provide values for the variables.</p><p>To see if a Workflow
    variable can be used in a setting, enter <code>$</code> or <code>${workflow.variables</code>
    and see the available expressions.</p><h3>Step 4: Upgrade Virtual Machine Scale
    Set</h3><p>Use the Upgrade Virtual Machine Scale Set step to set the desired instances
    for the new VMSS in <strong>phase 1</strong>.</p><p>For a Canary deployment phase
    1, this is a subset of the available capacity.</p><p>You can select a percentage
    or count.</p><p>This is the same as the <strong>Scale mode</strong> settings in
    <strong>Auto created scale condition</strong> in VMSS:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/74htogyjad/1602620781424/image.png"/></figure><h4>Name</h4><p>Enter
    a name for the Workflow step.</p><h4>Desired Instances</h4><p>Set the number of
    instances that the VMSS will attempt to deploy and maintain for <strong>phase
    1</strong> of the Canary deployment. Typically, this is half or fewer of the available
    capacity.</p><ul><li>If you select <strong>Count</strong>, enter the actual number
    of instances.</li><li>If you select <strong>Percent</strong>, enter a percentage
    of the available capacity.</li></ul><p>Your setting cannot exceed your <strong>Maximum
    Instances</strong> setting in the Workflow&#39;s preceding <strong>Azure Virtual
    Machine Scale Set Setup</strong> step.</p><p>This setting corresponds to the <strong>Maximum</strong> setting
    in <strong>Instance limits</strong> in VMSS.</p><div class="note-callout">You
    can use <a href="/article/9dvxcegm90-variables">Harness variable expressions</a>,
    such as <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow
    variables</a>, in this setting.</div><h3>Step 5: Create Phase 2</h3><p>Phase 2
    of the Canary Workflow runs after phase 1 is successful. Phase 2 will upgrade
    the VMSS to the available capacity.</p><ol><li>In <strong>Deployment Phases</strong>,
    under <strong>Phase 1</strong>, click <strong>Add Phase</strong>.</li><li>In Workflow
    Phase, in <strong>Service</strong>, select the Service you created in <a href="/article/c43hmoj6ic-add-your-azure-vm-image-for-deployment">Add
    Your Azure VM Image for Deployment</a>.</li><li>In <strong>Infrastructure Definition</strong>,
    select the Infrastructure Definition you created in <a href="/article/2976rmk4kd-define-your-azure-vmss-target-infrastructure">Define
    Your Azure VMSS Target Infrastructure</a>.</li><li>Click <strong>Submit</strong>.</li></ol><p>The
    Upgrade Virtual Machine Scale Set step is added to the phase automatically.</p><h3>Step
    6: Upgrade Virtual Machine Scale Set</h3><p>The settings for the Upgrade Virtual
    Machine Scale Set step are the same as phase 1.</p><p>In phase 2, you increase
    the <strong>Desired Instances</strong> percentage/count to the full capacity:
    100% or total count.</p><p>That&#39;s all you have to do.</p><h3>Step 7: Deploy</h3><p>Now
    that the Canary Workflow is complete, you can deploy it to Azure.</p><ol><li>When
    you have set up your Workflow, click <strong>Deploy</strong>.</li><li>In <strong>Artifacts</strong>,
    select the image you supplied in <a href="/article/c43hmoj6ic-add-your-azure-vm-image-for-deployment">Add
    Your Azure VM Image for Deployment</a>.</li><li>Click <strong>Submit</strong>.</li></ol><h4>Phase
    1: Azure Virtual Machine Scale Set Setup</h4><p>In <strong>Azure Virtual Machine
    Scale Set Setup</strong>, you can see Harness set up the new VMSS.</p><h4>Phase
    1: Upgrade Virtual Machine Scale Set</h4><p>In <strong>Upgrade Virtual Machine
    Scale Set</strong>, you can see the new VMSS upscaled to its desired instances.</p><h4>Phase
    2: Upgrade Virtual Machine Scale Set</h4><p>In phase 2&#39;s <strong>Upgrade Virtual
    Machine Scale Set</strong> step, you can see the new VMSS upscaled to its full
    capacity.</p><pre>Checking the status of VMSS: [doc__canary__3] VM instances<br/>Virtual
    machine instance: [doc__canary__3_1] provisioning state: [Provisioning succeeded]<br/>Virtual
    machine instance: [doc__canary__3_1] provisioning state: [Provisioning succeeded]<br/>Virtual
    machine instance: [doc__canary__3_2] provisioning state: [Creating]<br/>Virtual
    machine instance: [doc__canary__3_3] provisioning state: [Creating]<br/>...<br/>All
    the VM instances of VMSS: [doc__canary__3] are provisioned successfully<br/>Attaching
    scaling policy to VMSS: [doc__canary__3] as number of Virtual Machine instances
    has reached to desired capacity</pre><p>Congratulations. Your deployment was successful.</p><div
    class="note-callout">For information on naming and versioning, see <a href="/article/w67zx6mv87-azure-vmss-versioning-and-naming">Azure
    VMSS Versioning and Naming</a>.</div><h3>Option: Templatize the Workflow</h3><p>You
    can parameterize the Workflow&#39;s settings to turn it into a template. When
    it is deployed, values are provided for the parameters.</p><p>See <a href="/article/bov41f5b7o-templatize-a-workflow-new-template">Templatize
    a Workflow</a>.</p><h3>Configure As Code</h3><p>To see how to configure the settings
    in this topic using YAML, configure the settings in the UI first, and then click
    the YAML editor button (<span style="color:#fb9e00" data-hd-color="#fb9e00"><strong>&lt;/&gt;</strong></span>).</p>'
  slug: create-an-azure-vmss-canary-deployment
  tags: []
  is_live: true
