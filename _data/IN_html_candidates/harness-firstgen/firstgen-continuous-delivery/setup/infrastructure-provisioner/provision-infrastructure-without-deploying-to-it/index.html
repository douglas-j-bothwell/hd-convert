<p>Typically, when you provision infrastructure using Harness, you do it as part of a deployment, as described in <a href="/article/9pvvgcdbjh-terrform-provisioner">Terraform How-tos</a>, <a href="/article/78g32khjcu-cloud-formation-provisioner">CloudFormation How-tos</a>, and <a href="/article/1m3p7phdqo-shell-script-provisioner">Shell Script Provisioner</a>.</p><p>Here&#39;s an illustration using Terraform:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594077538161/image.png"/></figure><p>Some Harness customers want to provision infrastructure without deploying to it. They only want to provision infrastructure and maintain the infrastructure separate from the Application development team.</p><p>A common example is when an infra team manages the Terraform and CloudFormation provisioned resources and configures the Harness Cloud Provider for App teams to leverage. Any resource requirements for those Cloud Providers can be managed through the infrastructure provisioning Workflows.</p><p>This topic explains how to perform Terraform provisioning without deploying any services to the provisioned infrastructure. The same steps can be applied using CloudFormation or Shell Script provisioners.</p><p>In this topic:</p><ul><li> <a href="#before_you_begin">Before You Begin</a></li><li> <a href="#review_harness_infrastructure_provisioning">Review: Harness Infrastructure Provisioning</a></li><li> <a href="#step_1_set_up_pre_deployment_steps">Step 1: Set Up Pre-deployment Steps</a></li><li> <a href="#step_2_remove_infra_using_variables">Step 2: Remove Infra Using Variables</a></li><li> <a href="#step_3_set_up_post_deployment_steps">Step 3: Set Up Post-deployment Steps</a></li><li> <a href="#option_git_based_terraform_setup">Option: Git-based Terraform Setup</a></li><li> <a href="#step_4_configure_overrides">Step 4: Configure Overrides</a></li><li> <a href="#step_5_run_the_workflow_and_view_outputs">Step 5: Run the Workflow and View Outputs</a></li><li> <a href="#next_steps">Next Steps</a></li></ul><h3>Before You Begin</h3><p>If you want to reproduce the steps in this topic, ensure you have the following:</p><ul><li>You must have a working Terraform of CloudFormation setup (scripts, templates, etc).</li><li>Configure a Harness <a href="/article/9pvvgcdbjh-terrform-provisioner">Terraform</a>. <a href="/article/78g32khjcu-cloud-formation-provisioner">CloudFormation</a>, or <a href="/article/1m3p7phdqo-shell-script-provisioner">Shell Script</a> Infrastructure Provisioner.</li><li>Harness Application.</li></ul><h3>Review: Harness Infrastructure Provisioning</h3><p>Please review the Harness documentation on provisioning infrastructure:</p><ul><li> <a href="/article/hh52ews03d-terraform-provisioning-with-harness">Terraform Provisioning with Harness</a></li><li> <a href="/article/qj0ems5hmg-cloud-formation-provisioning-with-harness">CloudFormation Provisioning with Harness</a></li><li> <a href="/article/drculfgwwn-shell-script-provisioning-with-harness">Shell Script Provisioning with Harness</a></li></ul><p>For those interested in provisioning a Kubernetes cluster, see <a href="/article/huajnezo0r-provision-kubernetes-infrastructures">Provision Kubernetes Infrastructures</a>.</p><h3>Step 1: Set Up Pre-deployment Steps</h3><p>Here are the Workflow pre-deployment steps we will create:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594074209821/image.png"/></figure><p>All of the following Workflow steps are added to the <strong>Pre-deployment Steps</strong> section.</p><ol><li>Create a Canary Workflow in your Harness Application. You don&#39;t need to have a Harness Service to create a Canary Workflow, so this Workflow can be leveraged freely.</li></ol><div class="note-callout"><strong>Deployment Strategies Supported</strong> — For most deployments, Harness Infrastructure Provisioners are only supported in Canary and Multi-Service types. For AMI/ASG and ECS deployments, Infrastructure Provisioners are also supported in Blue/Green deployments.</div><ol><li start="2" style="counter-increment:li 1">Add the <a href="/article/uxwih21ps1-terraform-provisioner-step">Terraform Provision Step</a> to the <strong>Pre-deployment Steps</strong> section.</li><li>Set the Terraform Provision step as the Terraform plan using the <strong>Set as Terraform Plan</strong> option. See <a href="/article/xthfj92dys-terraform-dry-run">Perform a Terraform Dry Run</a>.</li></ol><p>When you&#39;re done, the step will look something like this:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594073837991/image.png"/></figure><ol><li style="counter-increment:li 3" start="4">Add an Approval step after the Terraform plan step. See <a href="/article/qxki6o7y31-jira-based-approvals">Jira Approvals</a>, <a href="/article/9nkuhm8moo-service-now-ticketing-system">ServiceNow Approvals</a>, and <a href="/article/0ajz35u2hy-approvals">Harness UI Approvals</a>. When the Workflow is deployed, a user will need to verify that the Terraform plan is correct before applying the new resources via a Terraform Apply step.</li><li>Add the <a href="/article/jaxppd8w9j-using-the-terraform-apply-command">Terraform Apply Step</a> after the Approval step to provision the infrastructure. Ensure the <strong>Inherit following configurations from Terraform Plan</strong> option is selected.</li></ol><p>Your Workflow should now look something like this:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594074209821/image.png"/></figure><p></p><h3>Step 2: Remove Infra Using Variables</h3><p>We will be adding a Terraform Destroy step to the <strong>Post-deployment Steps</strong> of the Workflow later. This is added because some infrastructure engineers want to test out and view their infrastructure before actually applying it.</p><p>Before we do this, we&#39;ll add a Workflow variable that will allow us to control whether we run the destroy steps.</p><p>When the Workflow is deployed, you can select <strong>true</strong> or <strong>false</strong> for the destroy steps, thereby enabling or disabling the removal of the provisioned infrastructure.</p><ol><li>Create a <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow variable</a> named <strong>destroy</strong> and set its default value to <strong>true</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594075003556/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><p>Next, when you add the Terraform Destroy step in the <strong>Post-deployment Steps</strong>, you can set a condition on the step using this Workflow variable (described below).</p><h3>Step 3: Set Up Post-deployment Steps</h3><p>Now we will set up the steps to run after the infrastructure is provisioned.</p><p>Here is the Workflow Post-Deployment step we will create:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594076218806/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><ol><li>In <strong>Post-deployment Steps</strong>, add a <a href="/article/4egyxnse9r-terraform-destroy">Terraform Destroy</a> step.</li><li>Next, click more options (︙) in the <strong>Pre-deployment Steps</strong> heading, and in <strong>Execution</strong>, select <strong>Conditional</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594075378110/image.png"/></figure></li><li>In <strong>Define the skip conditions</strong> <strong>for</strong>, select <strong>Selected steps</strong>, and then click <strong>Add</strong>. To learn more, see <a href="/article/02i1k7nvsj-skip-workflow-steps">Skip Workflow Steps</a>.</li><li>In <strong>Skip</strong>, select the <strong>Terraform Destroy</strong> step, and in <strong>Skip condition</strong>, enter <code>${workflow.variables.destory}==true</code>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594075629540/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><p>When you deploy the Workflow, you can enter <code>true</code> to skip the Terraform Destroy step or <code>false</code> to run it.</p><p>An alternative method to using the conditional technique is just adding an Approval step before they Destroy step. This forces a developer to review the resources created in the respective platform console.</p><p>If something doesn’t look right, they can reject the approval, and Harness will rollback Terraform to the previous state. If the Approval is accepted, then Harness will run Terraform Destroy.</p><p>This Approval technique is designed for testing the Terraform configuration. The other method is more for continuous minor updates to an existing Terraform or CloudFormation configuration.</p><h3>Option: Git-based Terraform Setup</h3><p>Some development teams want to manage all of their Terraform configuration in Github. Any changes to Terraform happen in Github and can be traced via the commit.</p><p>In addition, there is an added benefit of defined variables. Users don’t have to pass in input based on a Workflow variable. Everything will be picked up via their tfvars file or hardcoded values in the Terraform.</p><p>By keeping the approval of changes at the GitHub level, development teams can manage their Terraform code and mitigate unapproved configurations before provisioning with Harness.</p><p>This reduces the number of approval steps required in the Workflow. It makes the Workflow execution more self-service and developers don’t have to rely on another team or another user to approve the Workflow because the configuration was approved via PR in Github.</p><p>See <a href="/article/3av5pc4goc-onboard-teams-using-git-ops">Onboard Teams Using GitOps</a>.</p><h3>Step 4: Configure Overrides</h3><p>In CloudFormation or Terraform, the most common way to override configuration is with Workflow Variables. These Workflow variables can be passed as inputs.</p><p>This technique can be very valuable when playing around with instance size, instance type, or the number of instances an infrastructure engineer wants to provision.</p><p>Some users leverage tfvars files as inputs so they don’t need to pass in variables at runtime. They can just edit a tfvars file and have Harness pull the desired configuration from it.</p><p>This option reduces the manual input into Harness. It also keeps everything in version control so the user can revert a change they didn’t like with the tfvars file.</p><h3>Step 5: Run the Workflow and View Outputs</h3><ol><li>Deploy the Canary Workflow. You will see the Workflow variable you added.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594076370263/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Enter <strong>true</strong> to skip the Terraform Destroy step or <strong>false</strong> to run it, and click <strong>Submit</strong>.</li></ol><p>The deployment goes through the Workflow steps, including any Approvals you added, and displays the logs.</p><p>You should be able to view the plan, apply, and destroy steps.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2nu5fwob4b/1594076433753/image.png"/></figure><p></p><h3>Next Steps</h3><ul><li>Review <a href="/article/9pvvgcdbjh-terrform-provisioner">Terraform documentation</a> on Harness.</li><li>Check out our Community article on Harness and Terraform:  <a href="https://community.harness.io/t/harness-terraform/232">Harness ❤️ Terraform</a></li></ul><p></p><p></p><p></p><p></p>