<p>The <strong>Rollback Deployment</strong> option initiates a rollback of your most-recent successful deployment. This allows rapid, predictable recovery from a deployment that succeeded on technical criteria, but that you want to undo for other reasons.</p><p></p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1575873345070/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><h3>Limitations</h3><ul><li>Post-deployment rollback is only supported in Workflows and Pipelines that deploy container images (Docker), AMI/ASG images, and traditional artifacts (ZIP, TAR, etc). Workflows and Pipelines that deploy only manifests or Helm charts with hardcoded artifacts in their specs are not supported.</li></ul><h3>Review: Platform and Workflow Support</h3><p>Rollback Deployment currently supports the following platforms and strategies:</p><ul><li><strong>Kubernetes</strong> deployments: Basic, Blue/Green, Canary, Rolling Workflows.</li><li><strong>SSH</strong> deployments: Blue/Green, Canary, and Basic Workflows.</li><li><strong>PCF (Pivotal Cloud Foundry)</strong> deployments: Blue/Green, Canary, and Basic Workflows.</li><li><strong>WinRM (IIS and .NET)</strong> deployments: Blue/Green, Canary, and Basic Workflows.</li><li><strong>ECS</strong> deployments: all Workflow types, and both EC2 and Fargate clusters.</li><li><strong>AMI/ASG</strong> deployments: Blue/Green, Canary, and Basic Workflows.</li></ul><p>Harness anticipates expanding this feature to other deployment platforms.</p><h3>Review: Required Permissions</h3><p>The Rollback Deployment option requires the following User Group Account and Application permissions:</p><ul><li><strong>Account:</strong> <code>Manage Applications</code></li><li><strong>Application:</strong> <code>Rollback Workflow</code></li></ul><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1621884272988/image.png"/></figure><p>You can also add the <strong>Rollback Workflow</strong> Application permission via the GraphQL API:</p><pre class="hljs graphql">mutation {<br/>  updateUserGroupPermissions(input: {<br/>    clientMutationId: &#34;123&#34;<br/>    userGroupId: &#34;Gh9IDnVrQOSjckFbk_NJWg&#34;<br/>    permissions: {<br/>      appPermissions: {<br/>        actions:[ROLLBACK_WORKFLOW]<br/>        permissionType: ALL<br/>        applications: {<br/>          filterType: ALL<br/>        }<br/>        deployments: {<br/>          filterTypes: NON_PRODUCTION_ENVIRONMENTS<br/>        }<br/>      }<br/>    }<br/>  }) {<br/>    clientMutationId<br/>  }<br/>}</pre><p></p><h4>Rollback Workflow added if Execute Workflow used Previously</h4><p>All User Groups that had the <strong>Execute Workflow</strong> permission enabled will now have <strong>Rollback Workflow</strong> enabled, also. You can disable it if needed.</p><h3>Step 1: Rollback a Deployment</h3><div class="note-callout">Before you begin, please review <a href="/article/2f36rsbrve-post-deployment-rollback#requirements_and_warnings">Requirements and Warnings</a>.</div><p>To initiate a post-deployment rollback:</p><ol><li>Open your <a href="/article/c3s245o7z8-main-and-services-dashboards#services_dashboard">Services Dashboard</a>.</li><li>In the <strong>Current Deployment Status</strong> panel, click the More Options ⋮ menu beside the most-recent deployment. Then select <strong>Rollback Deployment</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1575876328734/image.png" style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure><div class="tip-callout">The <strong>Rollback Deployment</strong> option appears only for the current deployment.</div></li><li>In the resulting confirmation dialog, verify the deployment&#39;s details. If everything looks correct, click <strong>Rollback</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1575876831731/image.png" style="max-height:75%;max-width:75%" data-hd-height="75%" data-hd-width="75%"/></figure>Harness then invokes the Workflow&#39;s configured <a href="/article/m220i1tnia-workflow-configuration#rollback_steps">Rollback Strategy</a>, executing the same Rollback Steps as if the deployment had failed.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1575877937059/image.png" style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure>Once the rollback completes, your deployed instances will be returned to the state they were in before the most-recent deployment.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1575878189942/image.png" style="max-height:100%;max-width:100%" data-hd-height="100%" data-hd-width="100%"/></figure></li></ol><p></p><h3>Requirements and Warnings</h3><div class="warning-callout"><strong>Rollback Deployment</strong> will execute Rollback Steps on your deployment according to the Workflow&#39;s current configuration. Make sure the Workflow (including any variables) has not been reconfigured since this most-recent deployment, or the rollback can have unpredictable results.</div><div class="note-callout">A deployment&#39;s <strong>Rerun</strong> option will be unavailable during, and following, a post-deployment rollback.</div><p>In order to use Post-Deployment rollback, the following requirements must be met:</p><ul><li>There must be at least two successful deployments of the Workflow.</li><li>The <strong>Workflow Type</strong> cannot be a <strong>Multi-Service Deployment.</strong><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1577475227154/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>A user&#39;s ability to invoke the <strong>Rollback Deployment</strong> option is based on their <a href="/article/ven0bvulsj-users-and-permissions">User Group</a> membership, and on corresponding role-based permissions.</li></ul><h3>AWS ASG Deployments</h3><p>If a Workflow uses an Infrastructure Definition that includes an AWS Cloud Provider and and ASG, then its Post-Deployment rollback is handled in the following way.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/2f36rsbrve/1663184131599/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>For each deployment, Harness calculates the percentage of instances that are deployed in every Workflow phase relative to the number of all instances that have been deployed. Harness uses this percentage to calculate the number of instances for rollback relative to all active instances at that moment.</p><p>Let&#39;s look at an example.</p><p>Let’s say before/during deployment, we have <code>i1,i2,...,i8</code> (8 instances) and we have a 4 phase Canary Workflow defined with these percentages:</p><ol><li>[Split: 10%] phase 1 (10%) - <code>i1</code></li><li>[Split: 20%] phase 2 (30%)- <code>i2,i3</code></li><li>[Split: 30%] phase 3 (60%)- <code>i4,i5</code></li><li>[Split: 40%] phase 4 (100%)- <code>i6,i7,i8</code></li></ol><p>During Post-Deployment rollback we have 15 instances, some old and some new.</p><p><code>i1, i2, i3, i4, i7, i8, i9, i10, i11, i12, i13, i14, i15, i16, i17</code></p><p>Here&#39;s how rollback works:</p><ol><li><strong>Rollback phase 4,</strong> Harness rolls backs <code>i7, i8, i9, i10, i11, i12</code>. For phase 4, Harness deployed 3 instances of 8, which is 37.5%. Harness will rollback 37.5% of all active instances: <br/>n = 15 * 37.5% = 5.625<br/>This is rounded to 6 (two old and four new).</li><li><strong>Rollback phase 3,</strong> Harness rolls back <code>i4, i13, i14, i15</code>. For phase 3, Harness deployed 2 instances of 8, which is 25%. Harness will rollback 25% of all active instances:<br/>n = 15 * 25% = 3.75<br/>This is rounded to 4 (one old and three new).</li><li><strong>Rollback phase 2,</strong> Harness rolls back <code>i2, i3, i16, i17</code>. For phase 2, Harness deployed 2 instances of 8, which is 25%. Harness will rollback 25% of all active instances:<br/>n = 15 * 25% = 3.75<br/>This is rounded to 4 (two old and two new).</li><li><strong>Rollback phase 1,</strong> Harness rolls back <code>i1</code>. In the last rollback phase, Harness rolls back all instances that are left (only i1).</li></ol><p></p><p></p><p></p>