<p>This topic describes how to use a Harness Terragrunt Infrastructure Provisioner to create a Harness Infrastructure Definition. When you select the <strong>Map Dynamically Provisioned Infrastructure</strong> option in an Infrastructure Definition, you select an Infrastructure Provisioner and then map its outputs to required settings.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619468898144/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Once you map the outputs, you add the Infrastructure Definition to a Workflow as its deployment target.</p><p>Finally, you add a Terraform Provision step to that Workflow&#39;s Pre-deployment section to provision that target infrastructure.</p><p>When the Workflow runs, it provisions the infrastructure and then deploys to it.</p><p>This topic describes how to map Terraform script outputs for all of the supported platforms.</p><div class="note-callout">If you just want to provision non-target infrastructure you don&#39;t need to map outputs in the Infrastructure Definition. See <a href="/article/a6onutvbem-terragrunt-provisioning-with-harness">Terragrunt Provisioning with Harness</a> and <a href="/article/jbzxpljhlo-provision-using-the-terragrunt-provision-step">Provision using the Terragrunt Provision Step</a>.</div><p>In this topic:</p><p></p><ul><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#before_you_begin">Before You Begin</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#visual_summary">Visual Summary</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#limitations">Limitations</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#step_1_add_terragrunt_configuration_files">Step 1: Add Terragrunt Configuration Files</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#step_2_add_the_infrastructure_definition">Step 2: Add the Infrastructure Definition</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#option_1_map_a_platform_agnostic_kubernetes_cluster">Option 1: Map a Platform Agnostic Kubernetes Cluster</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#option_2_map_a_gcp_kubernetes_infrastructure">Option 2: ​Map a GCP Kubernetes Infrastructure​</a><ul><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#cluster_name_format">Cluster Name Format</a></li></ul></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#option_3_map_an_aws_ami_infrastructure">Option 3: ​Map an AWS AMI Infrastructure​</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#option_4_map_an_aws_ecs_infrastructure">Option 4: ​Map an AWS ECS Infrastructure​</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#option_5_map_an_aws_lambda_infrastructure">Option 5: ​Map an AWS Lambda Infrastructure​</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#option_6_map_a_secure_shell_ssh_infrastructure">Option 6: ​Map a Secure Shell (SSH) Infrastructure</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#option_7_map_an_azure_web_app">Option 7: Map an Azure Web App</a></li><li><a href="https://docs.harness.io/article/tphb27opry-map-terragrunt-infrastructure#next_steps">Next Steps</a></li></ul><h3>Before You Begin</h3><ul><li>Get an overview how how Harness supports Terragrunt: <a href="/article/a6onutvbem-terragrunt-provisioning-with-harness">Terragrunt Provisioning with Harness</a>.</li><li>Ensure you have your Harness account settings prepared for Terragrunt: <a href="/article/ulhl7sjxva-set-up-your-harness-account-for-terragrunt">Set Up Your Harness Account for Terragrunt</a>.</li><li>Create a Harness Terragrunt Infrastructure Provisioner: <a href="/article/mkjxbkglih-add-terragrunt-configuration-files">Add Terragrunt Configuration Files</a>.</li></ul><h3>Visual Summary</h3><p>Here is a visual summary of how you use your and Terragrunt and Terraform files with Harness to provision target infra and then deploy to it:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/a6onutvbem/1618962617102/image.png"/></figure><p></p><p>Here&#39;s a 6 minute video walkthrough of Harness-Terragrunt integration:</p><p></p><div class="hd--embed" data-provider="YouTube" data-thumbnail="https://i.ytimg.com/vi/HYSi2LAaYdc/hqdefault.jpg"><iframe width="200" height="150" src="https://www.youtube.com/embed/HYSi2LAaYdc?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p></p><p></p><h3>Limitations</h3><p>Harness Terragrunt Infrastructure Provisioner are only supported in Canary and Multi-Service Workflows. For AMI/ASG and ECS deployments, Terragrunt Infrastructure Provisioners are also supported in Blue/Green Workflows.</p><p>Harness has the same support for Terraform Infrastructure Provisioners.</p><h3>Step 1: Add Terragrunt Configuration Files</h3><p>Following the steps in these topics to set up your Harness account for Terragrunt and then connect Harness with your Terragrunt config files using a Terragrunt Infrastructure Provisioner:</p><ol><li><a href="/article/ulhl7sjxva-set-up-your-harness-account-for-terragrunt">Set Up Your Harness Account for Terragrunt</a>.</li><li><a href="/article/mkjxbkglih-add-terragrunt-configuration-files">Add Terragrunt Configuration Files</a>.</li></ol><p></p><h3> Step 2: Add the Infrastructure Definition</h3><p>As noted above, ensure you have set up your Harness account for Terragrunt and adding a Terragrunt Infrastructure Provisioner before creating the Infrastructure Definition.</p><p>To use a Terragrunt Infrastructure Provisioner to create an Infrastructure Definition, do the following:</p><ol><li>In the same Harness Application where you created the Terragrunt Infrastructure Provisioner, in a new or existing Environment, click <strong>Infrastructure Definition</strong>. The <strong>Infrastructure Definition</strong> settings appear.</li><li>In <strong>Name</strong>, enter the name for the Infrastructure Definition. You will use this name to select the Infrastructure Definition when you set up Workflows and Workflow Phases.</li><li>In <strong>Cloud Provider Type</strong>, select the type of Cloud Provider to use to connect to the target platform, such as Amazon Web Services, Kubernetes Cluster, etc.</li><li>In <strong>Deployment Type</strong>, select the same type of deployment as the Services you plan to deploy to this infrastructure.</li><li>Click <strong>Map Dynamically Provisioned Infrastructure</strong>.</li><li>In <strong>Provisioner</strong>, select your Terragrunt Infrastructure Provisioner.</li><li>In the remaining settings, map the required fields to the script outputs of the Terraform module used by the Terragrunt configuration file of the Terragrunt Infrastructure Provisioner. The required fields are described in the option sections below.</li></ol><p>You map the Terraform script outputs using this syntax, where <code>exact_name</code> is the name of the output:</p><pre class="hljs java">${terragrunt.exact_name}</pre><div class="note-callout">When you map a Terraform script output to a Harness Infrastructure Definition setting, the variable for the output, <code>${terragrunt.exact_name​}</code>, can be used anywhere in the Workflow that uses that Terragrunt Infrastructure Provisioner.</div><h3>Option 1: Map a Platform Agnostic Kubernetes Cluster</h3><div class="note-callout">Provisioning Kubernetes is supported with the Kubernetes Cluster Cloud Provider and Google Cloud Platform Cloud Provider only. For Azure and AWS, use the Kubernetes Cluster Cloud Provider.</div><p>Harness supports platform-agnostic Kubernetes cluster connections using its <a href="https://docs.harness.io/article/l68rujg6mp-add-kubernetes-cluster-cloud-provider">Kubernetes Cluster Cloud Provider</a>.</p><p>When you set up an Infrastructure Definition using a Kubernetes Cluster Cloud Provider you can map your Terraform script outputs to the required Infrastructure Definition settings.</p><p>The agnostic Kubernetes deployment type requires mapping for the <strong>Namespace</strong> and <strong>Release Name</strong> settings.</p><p>The following example shows the Terraform script outputs used for the mandatory platform-agnostic Kubernetes deployment type fields:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619132329217/image.png"/></figure><h3>Option 2: ​Map a GCP Kubernetes Infrastructure​</h3><p>The GCP Kubernetes deployment type requires that you map the <strong>Cluster Name</strong> setting.</p><div class="note-callout">Provisioning Kubernetes is supported with the Kubernetes Cluster Cloud Provider and Google Cloud Platform Cloud Provider only. For Azure and AWS, use the Kubernetes Cluster Cloud Provider.</div><p>The following example shows the Terraform script outputs used for the mandatory GCP Kubernetes (GKE) deployment type field:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619132888035/image.png"/></figure><p></p><h4>Cluster Name Format</h4><p>If the cluster is multi-zonal, ensure the resolved value of the Terraform output mapped to <strong>Cluster Name</strong> uses the format <code>region/name</code>.</p><p>If the cluster is single-zone, ensure the resolved value of the Terraform output mapped to <strong>Cluster Name</strong> uses the format <code>zone/name</code>. If you use a <code>region/name</code> format, it will result in a 404 error.</p><p>See <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/types-of-clusters" target="_blank">Types of clusters</a> from GCS.</p><h3>Option 3: ​Map an AWS AMI Infrastructure​</h3><div class="note-callout">AMI deployments are the only type that supports Terraform and CloudFormation Infrastructure Provisioners in Blue/Green deployments.</div><p>The AWS AutoScaling Group deployment type requires the Region and Base Auto Scaling Group fields. The following example shows the Terraform script outputs used for all of the fields:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619133438014/image.png"/></figure><p>For detailed information on AMI deployments, see <a href="https://docs.harness.io/article/rd6ghl00va-ami-deployment">AMI Basic Deployment</a>. Here is what each of the output values are:</p><ul><li><strong>Region</strong> - The target AWS region for the AMI deployment.</li><li><strong>Base Auto Scaling Group</strong> - An existing Auto Scale Group that Harness will copy to create a new Auto Scaling Group for deployment by an AMI Workflow. The new Auto Scaling Group deployed by the AMI Workflow will have unique max and min instances and desired count.</li><li><strong>Target Groups</strong> - The target group for the load balancer that will support your Auto Scale Group. The target group is used to route requests to the Auto Scale Groups you deploy. If you do not select a target group, your deployment will not fail, but there will be no way to reach the Auto Scale Group.</li><li><strong>Classic Load Balancers</strong> - A classic load balancer for the Auto Scale Group you will deploy.</li><li>For Blue/Green Deployments only:<ul><li><strong>Stage Classic Load Balancers</strong> - A classic load balancer for the stage Auto Scale Group you will deploy.</li><li><strong>Stage Target Groups</strong> - The staging target group to use for Blue Green deployments. The staging target group is used for initial deployment of the Auto Scale Group and, once successful, the Auto Scale Group is registered with the production target group (<strong>Target Groups</strong> selected above).</li></ul></li></ul><div class="note-callout">Harness recommends you use Launch Templates instead of Launch Configurations. With Launch Templates, the AMI root volume size parameter is overwritten as specified in the Launch Template. This prevents conflicts between devices on a base Launch Configuration and the AMI Harness creates.</div><h3>Option 4: ​Map an AWS ECS Infrastructure​</h3><p>The ECS deployment type requires the <strong>Region</strong> and <strong>Cluster</strong> fields. The following example shows the Terraform script outputs used for the mandatory ECS deployment type fields:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619133698263/image.png"/></figure><p>For information on ECS deployments, see <a href="https://docs.harness.io/article/5z2kw34d7x-aws-ecs-deployments-overview">AWS ECS Deployments Overview</a>.</p><h3>Option 5: ​Map an AWS Lambda Infrastructure​</h3><p>The Lambda deployment type requires the IAM Role and Region fields. The following example shows the Terraform script outputs used for the mandatory and optional Lambda deployment type fields:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619134368076/image.png"/></figure><p>See <a href="/article/wy1rjh19ej-aws-lambda-deployments">AWS Lambda Quickstart</a>.</p><h3>Option 6: ​Map a Secure Shell (SSH) Infrastructure</h3><p>The Secure Shell (SSH) deployment type requires the <strong>Region</strong> and <strong>Tags</strong> fields. The following example shows the Terraform script outputs used for the mandatory SSH deployment type fields:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619134492998/image.png"/></figure><p>See <a href="/article/keodlyvsg5-traditional-ssh-quickstart">Traditional (SSH) Quickstart</a>.</p><h3>Option 7: Map an Azure Web App</h3><div class="note-callout">Currently, this feature is behind a Feature Flag. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature. Feature Flags can only be removed for Harness Professional and Essentials editions. Once the feature is released to a general audience, it is available for Trial and Community Editions.</div><p>The Azure Web App deployment requires the Subscription and Resource Group in the Infrastructure Definition.</p><p>The Web App name and Deployment Slots are mapped in the Deployment Slot Workflow step.</p><p>In the following example, <code>${terragrunt.webApp}</code> is used for both the Web App name and Target Slot.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/tphb27opry/1619134112422/image.png"/></figure><p>See <a href="/article/lluikqw7q7-azure-web-app-deployments-overview">Azure Web App Deployments Overview</a>.</p><h3>Next Steps</h3><p>Now that the Infrastructure Definition is mapped to the Terraform outputs, the provisioned infrastructure can be used as a deployment target by a Harness Workflow. But the Terragrunt file and Terraform script must still be run to provision this infrastructure.</p><p>To run the Terragrunt file in your Harness Infrastructure Provisioner and create the infra you defined in Infrastructure Definition, you add a a Terragrunt Provisioner step to the pre-deployment section of your Workflow.</p><p>For steps on adding the Terragrunt Provisioner step, see <a href="/article/jbzxpljhlo-provision-using-the-terragrunt-provision-step">Provision using the Terragrunt Provision Step</a>.</p><p></p>