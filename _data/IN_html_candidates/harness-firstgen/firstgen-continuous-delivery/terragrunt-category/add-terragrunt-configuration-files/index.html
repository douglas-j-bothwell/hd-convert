<p>This topic describes how to set up a Harness Infrastructure Provisioner for Terragrunt. You simply link Harness to the repo where your Terragrunt config files are located.</p><p>Once the Harness Infrastructure Provisioner is set up, you can use it in two ways:</p><ul><li>Define a deployment target in a Harness Infrastructure Definition. You add that Infrastructure Definition to a Workflow as the deployment target. Next, you add a Terragrunt Provision step to the same Workflow to build the target infrastructure. The Workflow provisions the infrastructure and then deploys to it.</li><li>Provision non-target infrastructure. You can also simply add the Terragrunt Provision step to a Workflow to provision non-target resources.<br/>In this topic, we will cover provisioning the target infrastructure for a deployment, but the steps to provision other resources are similar.</li></ul><p>In this topic:</p><ul><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#before_you_begin">Before You Begin</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#visual_summary">Visual Summary</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#step_1_add_a_terragrunt_provisioner">Step 1: Add a Terragrunt Provisioner</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#step_2_select_your_terragrunt_script_repo">Step 2: Select Your Terragrunt Script Repo</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#option_use_expressions_for_script_repository">Option: Use Expressions for Script Repository</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#step_3_select_secret_manager_for_terragrunt_plan">Step 3: Select Secret Manager for Terragrunt Plan</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#option_skip_terragrunt_refresh_when_inheriting_terraform_plan">Option: Skip Terragrunt Refresh When Inheriting Terraform Plan</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#step_4_complete_the_terragrunt_provisioner">Step 4: Complete the Terragrunt Provisioner</a></li><li><a href="https://docs.harness.io/article/mkjxbkglih-add-terragrunt-configuration-files#next_steps">Next Steps</a></li></ul><h3>Before You Begin</h3><ul><li>Get an overview how how Harness supports Terragrunt: <a href="/article/a6onutvbem-terragrunt-provisioning-with-harness">Terragrunt Provisioning with Harness</a>.</li><li>Ensure you have your Harness account settings prepared for Terragrunt: <a href="/article/ulhl7sjxva-set-up-your-harness-account-for-terragrunt">Set Up Your Harness Account for Terragrunt</a>.</li></ul><h3>Visual Summary</h3><p>Here is a visual summary of how you use your and Terragrunt and Terraform files with Harness to provision target infra and then deploy to it:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/a6onutvbem/1618962617102/image.png"/></figure><p></p><p>Here&#39;s a 6 minute video walkthrough of Harness-Terragrunt integration:</p><p></p><div class="hd--embed" data-provider="YouTube" data-thumbnail="https://i.ytimg.com/vi/HYSi2LAaYdc/hqdefault.jpg"><iframe width="200" height="150" src="https://www.youtube.com/embed/HYSi2LAaYdc?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>You can use Terragrunt in Harness to provision any infrastructure, not just the target infrastructure for the deployment.</p><p>In this use case, you simply add the Terragrunt Provision step to your Workflow and it runs some Terragrunt commands to provision some non-target resources in your infrastructure.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/a6onutvbem/1618962645543/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><h3>Step 1: Add a Terragrunt Provisioner</h3><p>To set up a Terragrunt Infrastructure Provisioner, do the following:</p><p>In your Harness Application, click <strong>Infrastructure Provisioners</strong>.</p><p>Click <strong>Add Infrastructure Provisioner</strong>, and then click <strong>Terragrunt</strong>. The <strong>Terragrunt Provisioner</strong> settings appear.</p><p>In <strong>Name</strong>, enter the name for this provisioner. You will use this name to select this provisioner in Harness Infrastructure Definitions and Workflows.</p><p>Click <strong>Next</strong>. The <strong>Script Repository</strong> section appears. This is where you provide the location of the root module in your Git repo.</p><h3>Step 2: Select Your Terragrunt Script Repo</h3><p>In <strong>Script Repository</strong>, in <strong>Git Repository</strong>, select the <a href="https://docs.harness.io/article/ay9hlwbgwa-add-source-repo-providers">Source Repo Provider</a> you added for the Git repo where your script is located. See <a href="/article/ulhl7sjxva-set-up-your-harness-account-for-terragrunt">Set Up Your Harness Account for Terragrunt</a>.</p><p>In <strong>Commit</strong>, select <strong>Latest from Branch</strong> or <strong>Specific Commit ID</strong>:</p><ul><li>If you selected <strong>Latest from Branch</strong>, in <strong>Git Repository Branch</strong>, enter the repo branch to use. For example, <strong>master</strong>. For master, you can also use a dot (<code>.</code>).</li><li>If you selected <strong>Specific Commit ID</strong>, in <strong>Commit ID</strong>, enter the Git commit ID to use.</li></ul><p>In <strong>Path to Terragrunt Root Module</strong>, enter the folder where the root module is located. Enter <code>.</code> for root.</p><h3>Option: Use Expressions for Script Repository</h3><p>You can also use expressions in the <strong>Git Repository Branch</strong> and <strong>Path to Terragrunt Root Module</strong> and have them replaced by Workflow variable values when the Terragrunt Provisioner is used by the Workflow.</p><p>For example, a Workflow can have variables for <strong>branch</strong> and <strong>path</strong>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/mkjxbkglih/1619126337320/image.png"/></figure><p>In <strong>Script Repository</strong>, you can enter variables as <code>${workflow.variables.branch}</code> and <code>${workflow.variables.path}</code>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/mkjxbkglih/1619126380700/image.png"/></figure><p>When the Workflow is deployed, you are prompted to provide values for the Workflow variables, which are then applied to the <strong>Script Repository</strong> settings.</p><p>This allows the same Terragrunt Provisioner to be used by multiple Workflows, where each Workflow can use a different branch and path for the <strong>Script Repository</strong>.</p><p>See <a href="/article/766iheu1bk-add-workflow-variables-new-template">Set Workflow Variables</a>.</p><h3>Step 3: Select Secret Manager for Terragrunt Plan</h3><p>In <strong>Terraform Plan Storage Configuration</strong>, select a Secrets Manager to use for encrypting/decrypting and saving the Terraform plan file.</p><p>See <a href="https://docs.harness.io/article/uuer539u3l-add-a-secrets-manager">Add a Secrets Manager</a>.</p><p>A Terraform plan is a sensitive file that could be misused to alter cloud provider resources if someone has access to it. Harness avoids this issue by never passing the Terraform plan file as plain text.</p><p>Harness only passes the Terraform plan between the Harness Manager and Delegate as an encrypted file using a Harness Secrets Manager.</p><p>When the <code>terraform plan</code> command is run on the Harness Delegate, the Delegate encrypts the plan and saves it to the Secrets Manager you selected. The encrypted data is passed to the Harness Manager.</p><p>When the plan is going to be applied, the Harness Manager passes the encrypted data to the Delegate.</p><p>The Delegate decrypts the encrypted plan and applies it using the <code>terraform apply</code> command.</p><h3>Option: Skip Terragrunt Refresh When Inheriting Terraform Plan</h3><p>To understand this setting, let&#39;s review some of the options available later when you will use this Terragrunt Infrastructure Provisioner with a <a href="/article/jbzxpljhlo-provision-using-the-terragrunt-provision-step">Terragrunt Provision</a> step in your Workflow.</p><p>When you add that step, you can run it as a Terragrunt plan using the <strong>Set as Terragrunt Plan</strong> setting.</p><p>Next, you have the option of exporting the Terragrunt plan from one Terragrunt step (using the <strong>Export Terragrunt Plan to Apply Step</strong> setting) and inheriting the Terraform plan in the next Terraform step (using the <strong>Inherit following configurations from Terraform Plan</strong> setting).</p><p>Essentially, these settings allow you to use your Terragrunt Provision step as a <code>terragrunt plan</code> (<a href="https://www.terraform.io/docs/commands/plan.html" target="_blank">Terraform plan dry run</a>).</p><p>During this inheritance, Harness runs a Terraform refresh, then a plan, and finally executes the new plan.</p><p>If do not want Harness to perform a refresh, enable the  <strong>Skip Terragrunt Refresh when inheriting Terraform plan</strong> option in your Terragrunt Infrastructure Provisioner.</p><p>When this setting is enabled, Harness will directly apply the plan without reconciling any state changes that might have occurred outside of Harness between <code>plan</code> and <code>apply</code>.</p><p>This setting is available because a Terraform refresh is not always an idempotent command. It can have some side effects on the state even when no infrastructure was changed. In such cases, terraform apply <code>tfplan</code> commands might fail.</p><h3>Step 4: Complete the Terragrunt Provisioner</h3><p>When you are done, the <strong>Terragrunt</strong> <strong>Provisioner</strong> will look something like this:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/mkjxbkglih/1619128485636/image.png"/></figure><p>Now you can use this provisioner in both Infrastructure Definitions and Workflows.</p><h3>Next Steps</h3><ul><li><strong>Infrastructure Definitions</strong> — Use the Terragrunt Infrastructure Provisioner to define a Harness Infrastructure Definition. You do this by mapping the script outputs from the Terraform module used by the Terragrunt configuration file to the required Harness Infrastructure Definition settings. Harness supports provisioning for many different platforms.<br/>See: <a href="/article/tphb27opry-map-terragrunt-infrastructure">Map Dynamically Provisioned Infrastructure using Terragrunt</a>.</li><li><strong>Workflows</strong> — Once you have created the Infrastructure Definition and added it to a Workflow, you add a Terragrunt Provisioner Step to the Workflow to run your Terragrunt and Terraform files and provision the infra.<br/>See: <a href="/article/jbzxpljhlo-provision-using-the-terragrunt-provision-step">Provision using the Terragrunt Provision Step</a>.</li></ul><p></p>