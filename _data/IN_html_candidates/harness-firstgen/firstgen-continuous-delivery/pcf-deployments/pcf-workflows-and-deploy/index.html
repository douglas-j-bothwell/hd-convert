<p>Workflows are the deployment steps that use the Harness PCF Services and Environments to deploy your PCF app to your target PCF space.</p><p>Workflow use different deployment methods, such as Basic, Canary, or Blue/Green. Workflows can involve a few steps or multiple phases each composed of several steps.</p><p>In this topic in the tutorial, you will build Canary and Blue/Green Workflows to deploy the applications described by your Harness Services to the infrastructure described by the PCF Environment.</p><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#basic_deployment">Basic Deployment</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#set_up_a_pcf_basic_deployment">Set up a PCF Basic Deployment</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#app_setup">App Setup</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#app_resize">App Resize</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#app_rollback">App Rollback</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#deploy_a_pcf_basic_workflow">Deploy a PCF Basic Workflow</a></li></ul></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#pcf_versioning_and_rollback">PCF Versioning and Rollback</a></li></ul></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#canary_deployments">Canary Deployments</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#set_up_a_pcf_canary_deployment">Set up a PCF Canary Deployment</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#deploy_a_pcf_canary_workflow">Deploy a PCF Canary Workflow</a></li></ul></li><li> <a href="#app_resizing_in_canary_deployments">App Resizing in Canary Deployments</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#blue_green_deployments">Blue/Green Deployments</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#pcf_service_routes">PCF Service Routes</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#set_up_a_pcf_blue_green_workflow">Set up a PCF Blue/Green Workflow</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#app_setup_2">App Setup</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#app_resize_2">App Resize</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#verify_staging">Verify Staging</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#swap_routes">Swap Routes</a></li></ul></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#deploy_a_pcf_blue_green_workflow">Deploy a PCF Blue/Green Workflow</a></li></ul></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#cf_command">CF Command</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#script">Script</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#script_variables">Script Variables</a></li></ul></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#delegate_tags">Delegate Tags</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#timeout">Timeout</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#cf_command_templates">CF Command Templates</a></li></ul></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#configure_pcf_workflow_as_code">Configure PCF Workflow as Code</a><ul><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#blue_green_workflow_using_code">Blue/Green Workflow using Code</a></li></ul></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#pcf_built_in_variables">PCF Built-in Variables</a></li><li> <a href="#harness_pcf_environment_variables">Harness PCF Environment Variables</a></li><li> <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#next_steps">Next Steps</a></li></ul><h3>Basic Deployment</h3><p>A PCF Workflow performing a Basic deployment simply takes your Harness PCF Service and deploys it to your PCF Infrastructure Definition. Once the PCF app is set up in the Workflow using the <strong>App Setup</strong> command, you can resize the number of instances specified in the Service manifest.yml or App Setup command using the <strong>App Resize</strong> command.</p><p>Here is an example of a successful PCF Basic deployment:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1573586441532/image.png"/></figure><p></p><h4>Set up a PCF Basic Deployment</h4><p>To set up a PCF Basic deployment, do the following:</p><ol><li>In your Harness Application, create your PCF Service, as described in <a href="/article/s3emmcgotl-services-for-pcf">2 - Services for PCF</a>.</li><li>Create your PCF Infrastructure Definition, as described in <a href="/article/ur8gjgayds-pcf-environments">3 - PCF Environments</a>.</li><li>In your Harness Application, click <strong>Workflows</strong>.</li><li>Click <strong>Add Workflow</strong>. The <strong>Workflow</strong> dialog appears.</li><li>Name your Workflow, and then, in <strong>Workflow Type</strong>, select <strong>Basic Deployment</strong>.</li><li>In <strong>Environment</strong>, select the Environment containing your target Infrastructure Definition.</li><li>In <strong>Service</strong>, select the PCF Service you want to deploy.</li><li>In <strong>Infrastructure Definition</strong>, select your target Infrastructure Definition.</li></ol><p>When you are done, the dialog will look something like this:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1573586803179/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p></p><p>Click <strong>Submit</strong>. The PCF Basic Workflow is created.</p><p>Next, we&#39;ll walk through the default steps in the Workflow.</p><h5>App Setup</h5><p>The App Setup command uses the manifest.yml in your Harness PCF Service to set up your app.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580331875931/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>The <strong>Match running instances</strong> setting can be used after your first deployment to override the <code>instances</code> setting in the manifest.yml.</p><p>To add routes in addition to the routes defined in the Service manifest, select routes in <strong>Additional Routes</strong>.</p><p>For information on using the <strong>Use App Autoscaler Plugin</strong> settings, see <a href="/article/6kt564f64q-using-cli-plugins-in-harness-pcf-deployments#app_autoscaler_cli_plugin">App Autoscaler CLI Plugin</a>.</p><h5>App Resize</h5><p>When you first create your PCF Workflow, the App Resize command is displayed as incomplete. Harness simply needs you to confirm or change the default number of desired instances, <strong>100 Percent</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580331898364/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>You can select to use a percentage of the number specified in your manifest.yml, or if you used the App Setup <strong>Match desired count with current running instances</strong> setting, the current number of running instances. You can also use a count to explicitly set the number of desired instances.</p><p>Click <strong>Advanced</strong> to see <strong>Desired Instances - Old Version</strong>. Here you can set the number of instances for the previous version of the app. By default, the app will downsize to the same number as the number of new app instances.</p><h5>App Rollback</h5><p>In <strong>Rollback Steps</strong>, you can see the <strong>App Rollback</strong> command.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1573587994622/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>There is nothing to set in this command. It is simply the command to rollback to the old version of the app in case of a deployment failure.</p><h5>Deploy a PCF Basic Workflow</h5><p>To deploy your PCF Basic Workflow, click <strong>Deploy</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1573588073794/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Select the artifact for your new app and click <strong>Submit</strong>. The Workflow is deployed.</p><p>The <strong>App Setup</strong> command output shows your app was created successfully:</p><pre>---------- Starting PCF App Setup Command<br/><br/># Fetching all existing applications <br/># No Existing applications found<br/><br/># Creating new Application<br/># Manifest File Content: <br/>---<br/>applications:<br/>- name: ExampleForDoc__PCF__basic__Staging__0<br/>  memory: ((PCF_APP_MEMORY))<br/>  instances: 0<br/>  path: /home/ubuntu/harness-delegate/./repository/pcfartifacts/BY3yUoB7Q3ibJicbwmgn8Q/1573586245429SampleWebApp.war<br/>  random-route: true<br/><br/># CF_HOME value: /home/ubuntu/harness-delegate/./repository/pcfartifacts/BY3yUoB7Q3ibJicbwmgn8Q<br/># Performing &#34;login&#34;<br/>API endpoint: api.run.pivotal.io<br/>Authenticating...<br/>OK<br/><br/>Targeted org Harness<br/>Targeted space AD00001863<br/><br/>API endpoint:   https://api.run.pivotal.io (API version: 2.142.0)<br/>User:           john.doe@harness.io<br/>Org:            Harness<br/>Space:          AD00001863<br/># Login Successful<br/># Performing &#34;cf push&#34;<br/>Pushing from manifest to org Harness / space AD00001863 as john.doe@harness.io...<br/>Using manifest file /home/ubuntu/harness-delegate/./repository/pcfartifacts/BY3yUoB7Q3ibJicbwmgn8Q/ExampleForDoc__PCF__basic__Staging__0_1.yml<br/>Getting app info...<br/>Creating app with these attributes...<br/>+ name:        ExampleForDoc__PCF__basic__Staging__0<br/>  path:        /home/ubuntu/harness-delegate/repository/pcfartifacts/BY3yUoB7Q3ibJicbwmgn8Q/1573586245429SampleWebApp.war<br/>+ instances:   0<br/>+ memory:      350M<br/>  routes:<br/>+   examplefordocpcfbasicstaging0-zany-waterbuck.cfapps.io<br/><br/>Creating app ExampleForDoc__PCF__basic__Staging__0...<br/>Mapping routes...<br/>Comparing local files to remote cache...<br/>Packaging files to upload...<br/>Uploading files...<br/> 0 B / 4.70 KiB    0.00% 4.70 KiB / 4.70 KiB  100.00% 4.70 KiB / 4.70 KiB  100.00% 4.70 KiB / 4.70 KiB  100.00% 4.70 KiB / 4.70 KiB  100.00% 4.70 KiB / 4.70 KiB  100.00% 4.70 KiB / 4.70 KiB  100.00% 1s<br/>Waiting for API to complete processing files...<br/>...<br/>There are no running instances of this process.<br/><br/># Application created successfully<br/># App Details: <br/>NAME: ExampleForDoc__PCF__basic__Staging__0<br/>INSTANCE-COUNT: 0<br/>ROUTES: [examplefordocpcfbasicstaging0-zany-waterbuck.cfapps.io]<br/><br/> ----------  PCF Setup process completed successfully<br/># Deleting any temporary files created</pre><p>Next, the <strong>App Resize</strong> command shows the app instances upsized to the new instance count, in our example, 1.</p><pre>---------- Starting PCF Resize Command<br/># Downsizing previous application version/s<br/># No Application is available for downsize<br/># Upsizing new application:<br/>APPLICATION-NAME: ExampleForDoc__PCF__basic__Staging__0<br/>CURRENT-INSTANCE-COUNT: 0<br/>DESIRED-INSTANCE-COUNT: 1<br/># Application upsized successfully <br/><br/># Application state details after upsize:  <br/>NAME: ExampleForDoc__PCF__basic__Staging__0<br/>INSTANCE-COUNT: 1<br/>ROUTES: [examplefordocpcfbasicstaging0-zany-waterbuck.cfapps.io]<br/><br/>Instance Details:<br/>Index: 0<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/>--------- PCF Resize completed successfully</pre><p>You PCF Basic Workflow is complete.</p><h4 id="pcf_versioning_and_rollback">PCF Versioning and Rollback</h4><p>As you can see the app name is <strong>ExampleForDoc__PCF__basic__Staging__0</strong>, and it has a suffix <strong>__0</strong>. The suffix identifies the version of the app. The next time this app is deployed the suffix will increase to <strong>__1</strong>.</p><p>You cannot disable the versioning suffix because it is used to identify the version of the app and perform rollbacks to previous versions, if needed.</p><h3>Canary Deployments</h3><p>PCF Canary deployments contain two or more phases that deploy app instances gradually, ensuring the stability of a small percentage of instances before rolling out to your desired instance count.</p><p>Here is an example of a successful PCF Canary deployment containing two phases:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572471685499/image.png"/></figure><p></p><h4>Set up a PCF Canary Deployment</h4><p>To explain PCF Canary Workflow steps and settings, we will create a Canary Workflow that deploys a new app to 50% of instances and, if it is successful, deploys it to 100% of instances.</p><p>The Canary Workflow will contains two phases:</p><ol><li>Phase 1:<ol><li><strong>App Setup</strong> command: 6 instances set up. The number of instances defined in the manifest.yml via the vars.yml variable value for instances:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572386976797/image.png"/></figure></li><li><strong>App Resize</strong> command: 50% desired instances. This ensures that the app deploys on a small number of instances before moving on to Phase 2.</li></ol></li><li>Phase 2:<ol><li><strong>App Resize</strong> command: 100% of instances.</li></ol></li></ol><p>To implement this Canary workflow, do the following:</p><ol><li>In your Harness application, click <strong>Workflows</strong>. The <strong>Workflows</strong> page appears.</li><li>Click <strong>Add Workflow</strong>. The <strong>Workflow</strong> dialog appears.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1568674522315/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>In <strong>Name</strong>, enter a name that describes what the Workflow does. For example, for a simple Canary deployment, <strong>Canary PCF</strong>.</li><li>In <strong>Workflow Type</strong>, select <strong>Canary Deployment</strong>.</li><li>In <strong>Environment</strong>, select the Environment containing the Infrastructure Definition for the target space where you will deploy your PCF app.</li><li>When the <strong>Workflow</strong> dialog is finished, click <strong>SUBMIT</strong>. The PCF Canary Workflow appears.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572386876018/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>First, we will set up <strong>Phase 1</strong>, where we will deploy 50% of the 6 instances defined in our Service&#39;s <strong>Manifests</strong> section.</p><p>To configure the Canary phases, do the following:</p><ol><li>In the Workflow, in <strong>Deployment Phases</strong>, click <strong>Add Phase</strong>. The <strong>Workflow Phase</strong> dialog appears.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572387176071/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>In <strong>Service</strong>, ensure you select the Harness Service that contains the manifest for the PCF app you want to deploy.</li><li>In <strong>Infrastructure Definition</strong>, select the <a href="https://docs.harness.io/article/n39w05njjv-environment-configuration#add_an_infrastructure_definition">Infrastructure Definition</a> that defines the target space where you want to deploy your app.</li><li>Click <strong>Submit</strong>. Phase 1 appears.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572387401606/image.png" style="max-height:25%;max-width:25%" data-hd-height="25%" data-hd-width="25%"/></figure><p>Now we configure this phase to deploy 50% of the PCF app instances we have set in the Service manifest.yml.</p><ol><li>Click <strong>App Setup</strong>. The <strong>App Setup</strong> dialog appears.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580331932559/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>You don&#39;t need to change any settings in App Setup, but let&#39;s review the default settings:</p><p></p><table><tbody><tr><td><p><strong>Setting</strong></p></td><td><p><strong>Description</strong></p></td></tr><tr><td><p><strong>Match running instances</strong></p></td><td><p>The first time you deploy this Workflow, this setting isn&#39;t used because we have no running instances.</p><p>In future deployments, you might wish to select this setting. For Canary Workflows, it isn&#39;t relevant because you will be setting the desired instance count for the phase.</p></td></tr><tr><td><p><strong>Resize Strategy</strong></p></td><td><p>Specify the order in which you want Harness to downsize and add old and new instances.</p><p>The first time you deploy this Workflow, this setting isn&#39;t used because we have no running instances.</p></td></tr><tr><td><p><strong>Active Versions To Keep</strong></p></td><td><p>Enter the number of previous app versions to downsize and keep. You can upsize these versions later if needed. The most recent app version will not be downsized.</p></td></tr><tr><td><p><strong>Additional Routes</strong></p></td><td><p>Select any routes that you want to map to your app, in addition to the routes specified in the manifest in your Harness Service.</p></td></tr><tr><td><p><strong>Use App Autoscaler Plugin</strong></p></td><td><p>Enable this setting if you have the  <a href="https://docs.run.pivotal.io/appsman-services/autoscaler/using-autoscaler-cli.html" target="_blank">App Autoscaler</a> service running in your target Pivotal space and bound to the app you are deploying.</p><p>For more information on using the plugin with Harness, see <a href="/article/6kt564f64q-using-cli-plugins-in-harness-pcf-deployments#app_autoscaler_cli_plugin">App Autoscaler CLI Plugin</a>.</p></td></tr><tr><td><p><strong>Timeout</strong></p></td><td><p>Set how long you want the Harness Delegate to wait for the PCF cloud to respond to API requests before timing out.</p></td></tr></tbody></table><ol><li style="counter-increment:li 1" start="2">Click <strong>Submit</strong> or close the dialog.</li></ol><p>Next, we will resize the number of instances to 50% of the instance count set in your Service manifest.yml.</p><ol><li>Click <strong>App Resize</strong>. The <strong>App Resize</strong> dialog appears.</li><li>In <strong>Desired Instances</strong>, enter <strong>50</strong> and choose <strong>Percent</strong>. The app will deploy on 3 instances successfully before the Workflow moves onto Phase 2.</li><li>Click <strong>SUBMIT</strong>.</li></ol><p>Next, we&#39;ll add Phase 2 where we will deploy to 100% of the instances specified in the Service manifest.yml.</p><ol><li>From the breadcrumb menu, click back to the main Canary Workflow page.</li><li>In <strong>Deployment Phases</strong>, under <strong>Phase 1</strong>, click <strong>Add Phase</strong>. The <strong>Workflow Phase</strong> dialog appears.</li><li>Select the same Service and <a href="https://docs.harness.io/article/n39w05njjv-environment-configuration#add_an_infrastructure_definition">Infrastructure Definition</a> that you selected in Phase 1, and then click <strong>Submit</strong>.</li></ol><p>The <strong>Phase 2</strong> steps appear.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572389017588/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>These step will be executed when the Phase 1 steps are successful.</p><ol><li>Click <strong>App Resize</strong>. The <strong>App Resize</strong> settings appear.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1583782343330/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure>In Phase 1, the app successfully deployed to 50% of the instances set in the Service manifest.yml. In Phase 2, you can deploy it to 100% of the instances.</li><li>In <strong>Desired Instances</strong>, enter <strong>100</strong> and choose <strong>Percent</strong>, and then click <strong>Submit</strong>. This will deploy the new app to 100% of the instances you set up in Phase 1. The Phase 2 steps are now complete.</li></ol><p>If your manifest does not specify the number of instances, Harness defaults to 2 instances.</p><p>In <strong>Advanced Settings</strong>, you can specify <strong>Desired Instances - Old Version</strong>. This allows you to manage how many instances of the old app version to keep running.</p><p>if you do not enter a value, Harness uses the number of new instances as its guide. For example, if you deployed 4 new instances and then select <strong>50 Percent</strong> in <strong>Desired Instances - Old Version</strong>, Harness downsizes the old app version to 50% <u>of 4 instances</u>.</p><div class="note-callout">If you are using the App Autoscaler plugin, then autoscaling is applied <u>after</u> the final phase of deployment. After all phases are completed and the number of old version instances has reached the desired number, then the final number of instances will be as configured as defined by the Autoscaler.</div><h4>Deploy a PCF Canary Workflow</h4><p>Now that the Canary Workflow is configured, from the breadcrumb menu, click back to the main Canary Workflow page. You can see both Phases are complete.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572389204739/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>You can now deploy the Canary Workflow.</p><ol><li>Click <strong>Deploy</strong>.</li><li>In <strong>Start New Deployment</strong>, select an artifact to deploy.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572389477322/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><ol><li style="counter-increment:li 2" start="3">Click <strong>Submit</strong> to deploy your app.</li></ol><p>Here you can see the <strong>App Setup</strong> step in Phase 1:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572390874041/image.png"/></figure><p>When this step is deployed, the output will look something like this:</p><pre>---------- Starting PCF App Setup Command<br/><br/># Fetching all existing applications <br/># No Existing applications found<br/><br/># Creating new Application<br/># Manifest File Content: <br/>---<br/>applications:<br/>- name: ExampleForDoc__PCF__Latest__Staging__0<br/>  memory: ((PCF_APP_MEMORY))<br/>  instances: 0<br/>  path: /home/ubuntu/harness-delegate/./repository/pcfartifacts/VsOd7PkCTgWyl0SEEZ5E0w/1572389711331todolist.war<br/>  random-route: true<br/>...<br/><br/>name:              ExampleForDoc__PCF__Latest__Staging__0<br/>requested state:   started<br/>routes:            examplefordocpcflateststaging0-anxious-wolverine.cfapps.io<br/>last uploaded:     Tue 29 Oct 22:55:40 UTC 2019<br/>stack:             cflinuxfs3<br/>buildpacks:        client-certificate-mapper=1.11.0_RELEASE container-security-provider=1.16.0_RELEASE java-buildpack=v4.24-offline-https://github.com/cloudfoundry/java-buildpack.git#a2dd394 java-opts java-security jvmkill-agent=1.16.0_RELEASE open-jdk-like-jre=...<br/><br/>type:            web<br/>instances:       0/0<br/>memory usage:    350M<br/>...<br/>There are no running instances of this process.<br/># Application created successfully<br/># App Details: <br/>NAME: ExampleForDoc__PCF__Latest__Staging__0<br/>INSTANCE-COUNT: 0<br/>ROUTES: [examplefordocpcflateststaging0-anxious-wolverine.cfapps.io]<br/><br/><br/> ----------  PCF Setup process completed successfully<br/># Deleting any temporary files created</pre><p>Note that since this is the first time this Workflow is deployed, there are no running instances.</p><p>Next is the <strong>App Resize</strong> step in Phase 1:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572390886602/image.png"/></figure><p>When this step is deployed, the output will look something like this:</p><pre>---------- Starting PCF Resize Command<br/><br/># Downsizing previous application version/s<br/># No Application is available for downsize<br/># Upsizing new application:<br/>APPLICATION-NAME: ExampleForDoc__PCF__Latest__Staging__0<br/>CURRENT-INSTANCE-COUNT: 0<br/>DESIRED-INSTANCE-COUNT: 3<br/># Application upsized successfully <br/><br/># Application state details after upsize:  <br/>NAME: ExampleForDoc__PCF__Latest__Staging__0<br/>INSTANCE-COUNT: 3<br/>ROUTES: [examplefordocpcflateststaging0-anxious-wolverine.cfapps.io]<br/><br/>Instance Details:<br/>Index: 0<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 1<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 2<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>--------- PCF Resize completed successfully</pre><p>Note the <code>DESIRED-INSTANCE-COUNT: 3</code> and <code>INSTANCE-COUNT: 3</code> information. This is the result of setting 50% in <strong>Desired Instances</strong>.</p><p>In Phase 2 we see the final step, <strong>App Resize</strong>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572390918658/image.png"/></figure><p>When this App Resize step is deployed, the output will look something like the following:</p><pre>---------- Starting PCF Resize Command<br/><br/># Downsizing previous application version/s<br/># No Application is available for downsize<br/># Upsizing new application:<br/>APPLICATION-NAME: ExampleForDoc__PCF__Latest__Staging__1<br/>CURRENT-INSTANCE-COUNT: 3<br/>DESIRED-INSTANCE-COUNT: 6<br/># Application upsized successfully <br/><br/># Application state details after upsize:  <br/>NAME: ExampleForDoc__PCF__Latest__Staging__1<br/>INSTANCE-COUNT: 6<br/>ROUTES: [examplefordocpcflateststaging1-fearless-eland.cfapps.io]<br/><br/>Instance Details:<br/>Index: 0<br/>State: STARTING<br/>Disk Usage: 138027008<br/>CPU: 0.0<br/>Memory Usage: 7250563<br/><br/>Index: 1<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 2<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 3<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 4<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 5<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>--------- PCF Resize completed successfully</pre><p>You can see that the app was deployed to 100% of the instances set in the manifest.yml (6).</p><h3>App Resizing in Canary Deployments</h3><p>To understand how app resizing works in a Canary deployment, let&#39;s look at an example of a 3 phase deployment:</p><ol><li>Phase 1 is set to 25% for new instances (<strong>Desired Instances (cumulative)</strong> in App Resize step) and 25% old instances (<strong>Desired Instances - Old Version</strong> in App Resize step).</li><li>Phase 2 is set to 50% for new instances and 50% old instances.</li><li>Phase 3 is set to 100% for new instances and 0% old instances.</li></ol><p>Now, let&#39;s imagine the PCF manifest specified in the Harness Service requests <strong>4 instances</strong> and there is no autoscaler plugin configured.</p><p>Here&#39;s what will happen each time you deploy:</p><p>First deployment:</p><ol><li>Phase 1 deploys 1 new instance.</li><li>Phase 2 deploys 2 new instances.</li><li>Phase 3 deploys all 4 desired instances.</li></ol><p>There are no running instances before deployment, and so there is nothing to downsize.</p><p>Second deployment:</p><ol><li>There are 4 running instances now. These were deployed by the first deployment. All downsize percentages refer to this number.</li><li>Phase 1 deploys 1 new instance and downsizes 1 instance. Downsize is 25%. It results in 25% <u>of 4</u> which is 1 instance.<br/>Current state: 1 new versioned instance and 3 old versioned instances running.</li><li>Phase 2 deploys 2 new versioned instances and downsizes 2 instances. Downsize is 50% of the number of old versioned instances (4). So 2 instances are downsized.<br/>Current state: 2 new versioned instances and 1 old versioned instance running.</li><li>Phase 2 deploys 4 new versioned instances and downsizes 1 old instance.<br/>Final state: 4 new instances and 0 old instances.</li></ol><h4>What about Autoscaler?</h4><p>If you were using an App Autoscaler plugin, it would be applied at the end of the deployment. For example, if Autoscaler is set to min 8 and max 10, Harness will set the desired number of instances to the minimum value. So the total number of new instances is 8.</p><h3>Blue/Green Deployments</h3><p>Harness PCF Blue/Green deployments use the route(s) in the PCF manifest.yml and a temporary route you specify in the Harness Workflow.</p><p>The Workflow deploys the app using the temporary route first using the <strong>App Setup</strong> command. Next, in the <strong>App Resize</strong> command, Harness maintains the number of instances at 100% of the <code>instances</code> specified in the manifest.yml.</p><p>For Blue/Green deployments, the <strong>App Resize</strong> step is always 100% because it does not change the number of instances as it did in the Canary deployment. In Blue/Green, you are simply deploying the new app to the number of instances set in the <strong>App Setup</strong> step and keeping the old app at the same number of instances (100% count).</p><p>Once that deployment is successful, the Workflow <strong>Swap Routes</strong> command switches the networking routing, directing production traffic (Green) to the new app and stage traffic (Blue) to the old app.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572471572840/image.png"/></figure><h4>PCF Service Routes</h4><p>In the manifest.yml in your Harness PCF Service, you can specify the route(s) to use for the Blue/Green deployment. For example:</p><pre>  ...<br/>  routes:<br/>  - route: example.com</pre><p>Each route for the app is created if it does not already exist.</p><p>As you will see when you set up the Blue/Green Workflow, you specify a temporary route in the App Setup command&#39;s <strong>Temporary Routes</strong> setting:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332058626/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h4>Set up a PCF Blue/Green Workflow</h4><p>To explain PCF Blue/Green Workflow commands and settings, we will create a Blue/Green Workflow that uses a temporary route and, if it is successful, deploys 100% of instances using the primary route.</p><p>To implement this Blue/Green Workflow, do the following:</p><ol><li>In your Harness Application, click <strong>Workflows</strong>.</li><li>In <strong>Workflows</strong>, click Add Workflow. The <strong>Workflow</strong> dialog appears.</li><li>In <strong>Name</strong>, enter a name for the Workflow.</li><li>In <strong>Workflow Type</strong>, select <strong>Blue/Green Deployment</strong>.</li><li>In <strong>Environment</strong>, select the Environment you created for PCF.</li><li>In <strong>Service</strong>, select a Harness PCF Service you have created. The Service manifest.yml must contain a <code>route</code>. The route can be an existing route or not. If the doesn&#39;t exist, Harness will create it for you. This is the route that will be used at the final stage of the Blue/Green deployment. The temporary route for the prior stage will be selected in the <strong>App Setup</strong> step of Workflow.</li><li>In <strong>Infrastructure Definition</strong>, select the Infrastructure Definition that describes the target PCF space.<br/><br/>When you are done, the dialog will look something like this:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572473124064/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Click <strong>Submit</strong>.</li></ol><p>The new Blue/Green Workflow is displayed, along with the preconfigured steps:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572473530244/image.png"/></figure><p>Let&#39;s look at each step to understand how the Blue/Green Workflow deploys you app.</p><h5>App Setup</h5><p>Click <strong>App Setup</strong> to see the default, preconfigured command:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332136704/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>None of the settings in this dialog are mandatory, but for Blue/Green Workflows, the <strong>Match running instances</strong>, <strong>Additional Routes</strong>, and <strong>Temporary Routes</strong> settings are important.</p><p>If you select <strong>Match running instances</strong>, Harness will ignore the number of instances set in the Service&#39;s manifest.yml <code>instances</code> property and use the number of currently running instances as the desired instance count during deployment.</p><p>The first time you deploy this Workflow, there is no reason to select <strong>Match running instances</strong> as there are no current running instances.</p><p><strong>Additional Routes</strong> is automatically populated with the routes Harness can find using the Infrastructure Definition you selected for this Workflow</p><p><strong>Additional Routes</strong> has two uses in Blue/Green deployments:</p><ul><li>Select the routes that you want mapped to the app in addition to the routes already mapped in the app in the manifest in your Harness Service.</li><li>You can also omit routes in the manifest in your Harness Service, and simply select them in <strong>Additional Routes</strong>. The routes selected in <strong>Additional Routes</strong> will be used as the final (green) routes for the app.</li></ul><p><strong>Temporary Routes</strong> is automatically populated with the routes Harness can find using the Infrastructure Definition you selected for this Workflow.</p><p>In <strong>Temporary Routes</strong>, you can select one or more temporary routes for Harness to use when it creates the PCF app. Later, in the <strong>Swap State</strong> step, Harness will replace these routes with the routes in the manifest.yml <code>routes</code> property in your Service.</p><p>If you do not select a route in <strong>Temporary Routes</strong>, Harness will create one automatically.</p><p>For information on using the <strong>Use App Autoscaler Plugin</strong> settings, see <a href="/article/6kt564f64q-using-cli-plugins-in-harness-pcf-deployments#app_autoscaler_cli_plugin">App Autoscaler CLI Plugin</a>.</p><h5>App Resize</h5><p>Click <strong>App Resize</strong> to see the default settings.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332157975/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>For Blue/Green deployments, the <strong>App Resize</strong> step is always 100% because it does not change the number of instances as it did in the Canary deployment. In Blue/Green, you are simply deploying the new app to the number of instances set in the <strong>App Setup</strong> step and keeping the old app at the same number of instances.</p><h5>Verify Staging</h5><p>There are no commands in <strong>Verify Staging</strong> because you have not set up verification steps in this tutorial, and you would not add them in the initial deployment because there are no other deployments for the steps to use in comparison.</p><p>Later, when you are developing Blue/Green Workflows, add verification steps to verify the deployment of your app using the temporary route(s). This way, Harness will only proceed to the <strong>Swap Routes</strong> step if verification does not detects failures. For more information about verifying deployments, see <a href="https://docs.harness.io/category/gurgsl2gqt-continuous-verification">Continuous Verification</a>.</p><h5>Swap Routes</h5><p>The final step in the PCF Blue/Green Workflow is the <strong>Swap Routes</strong> command.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332179128/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>This command will swap the route(s) used by the deployed app from the temporary route(s) to the route(s) specified in the manifest.yml in your Service.</p><div class="note-callout">When <strong>Swap Routes</strong> is used in a Workflow&#39;s <strong>Rollback Steps</strong>, the app that was active before deployment is restored to its original state with the same instances and routes it had before deployment. The new app is left with the temporary route set in <strong>App Setup</strong> with 0 instances so you can troubleshoot it.</div><h4>Deploy a PCF Blue/Green Workflow</h4><p>Now that the Blue/Green Workflow is configured, from the breadcrumb menu, click back to the main Workflow page.</p><p>You can now deploy the Blue/Green Workflow.</p><ol><li>Click <strong>Deploy</strong>.</li><li>In <strong>Start New Deployment</strong>, select an artifact to deploy, and click <strong>Submit</strong>.</li></ol><p>The PCF Blue/Green Workflow deploys.</p><p>Here you can see the <strong>App Step</strong> command deployed:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572475855314/image.png"/></figure><p>When this step is deployed, the output will look something like this:</p><pre>---------- Starting PCF App Setup Command<br/><br/># Fetching all existing applications <br/># Existing applications: <br/>ExampleForDoc__PCF__Blue__Green__Staging__2<br/><br/># Processing Apps with Non-Zero Instances<br/># No Change For Most Recent Application: ExampleForDoc__PCF__Blue__Green__Staging__2<br/><br/># No applications were eligible for deletion<br/><br/># Creating new Application<br/># Manifest File Content: <br/>---<br/>applications:<br/>- name: ExampleForDoc__PCF__Blue__Green__Staging__3<br/>  memory: ((PCF_APP_MEMORY))<br/>  instances: 0<br/>  path: /home/ubuntu/harness-delegate/./repository/pcfartifacts/11uZOBMRQoSbDqr_WfRuaQ/1572474750133SampleWebApp.war<br/>  random-route: true<br/><br/><br/># CF_HOME value: /home/ubuntu/harness-delegate/./repository/pcfartifacts/11uZOBMRQoSbDqr_WfRuaQ<br/># Performing &#34;login&#34;<br/>API endpoint: api.run.pivotal.io<br/>Authenticating...<br/>OK<br/><br/>Targeted org Harness<br/>Targeted space AD00001863<br/>...<br/>Getting app info...<br/>Creating app with these attributes...<br/>+ name:        ExampleForDoc__PCF__Blue__Green__Staging__3<br/>  path:        /home/ubuntu/harness-delegate/repository/pcfartifacts/11uZOBMRQoSbDqr_WfRuaQ/1572474750133SampleWebApp.war<br/>+ instances:   0<br/>+ memory:      350M<br/>  routes:<br/>+   examplefordocpcfbluegreenstaging3-insightful-cat.cfapps.io<br/>...<br/># Application created successfully<br/># App Details: <br/>NAME: ExampleForDoc__PCF__Blue__Green__Staging__3<br/>INSTANCE-COUNT: 0<br/>ROUTES: [examplefordocpcfbluegreenstaging3-insightful-cat.cfapps.io]<br/><br/> ----------  PCF Setup process completed successfully<br/># Deleting any temporary files created</pre><p>The route specified in the Service manifest.yml is <code>docs.cfapps.io</code>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572476202694/image.png"/></figure><p>Note that in the <strong>App Setup</strong> step, a temporary route has been used: <code>examplefordocpcfbluegreenstaging3-insightful-cat.cfapps.io</code>.</p><p>Here you can see the <strong>App Resize</strong> command deployed:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572476261030/image.png"/></figure><p>When this step is deployed, the output will look something like this:</p><pre>---------- Starting PCF Resize Command<br/><br/># Upsizing new application:<br/>APPLICATION-NAME: ExampleForDoc__PCF__Blue__Green__Staging__3<br/>CURRENT-INSTANCE-COUNT: 0<br/>DESIRED-INSTANCE-COUNT: 6<br/># Application upsized successfully <br/><br/># Application state details after upsize:  <br/>NAME: ExampleForDoc__PCF__Blue__Green__Staging__3<br/>INSTANCE-COUNT: 6<br/>ROUTES: [examplefordocpcfbluegreenstaging3-insightful-cat.cfapps.io]<br/><br/>Instance Details:<br/>Index: 0<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 1<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 2<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 3<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 4<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/>Index: 5<br/>State: STARTING<br/>Disk Usage: 0<br/>CPU: 0.0<br/>Memory Usage: 0<br/><br/># BG Deployment. Old Application will not be downsized.<br/>--------- PCF Resize completed successfully</pre><p>Note that 100% of the instances specified in the Service manifest.yml have been deployed (6).</p><p>Here you can see the <strong>Swap Routes</strong> command deployed:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572476360734/image.png"/></figure><p>When this step is deployed, the output will look something like this:</p><pre>--------- Starting PCF Route Update<br/><br/># Adding Routes<br/>APPLICATION: ExampleForDoc__PCF__Blue__Green__Staging__3<br/>ROUTE: <br/>[<br/>docs.cfapps.io<br/>]<br/><br/># Unmapping Routes<br/>APPLICATION: ExampleForDoc__PCF__Blue__Green__Staging__3<br/>ROUTES: <br/>[<br/>examplefordocpcfbluegreenstaging3-insightful-cat.cfapps.io<br/>]<br/># Unmapping Routes was successfully completed<br/><br/># Adding Routes<br/>APPLICATION: ExampleForDoc__PCF__Blue__Green__Staging__2<br/>ROUTE: <br/>[<br/>examplefordocpcfbluegreenstaging3-insightful-cat.cfapps.io<br/>]<br/><br/># Unmapping Routes<br/>APPLICATION: ExampleForDoc__PCF__Blue__Green__Staging__2<br/>ROUTES: <br/>[<br/>docs.cfapps.io<br/>]<br/># Unmapping Routes was successfully completed<br/><br/>--------- PCF Route Update completed successfully</pre><p>Note how the new app receives the <code>docs.cfapps.io</code> route from the Service manifest.yml and the old route receives the temporary route <code>examplefordocpcfbluegreenstaging3-insightful-cat.cfapps.io</code>.</p><p>The Blue/Green deployment is complete.</p><h3>CF Command</h3><p>You can use the CF Command to run any <a href="https://docs.cloudfoundry.org/cf-cli/cf-help.html" target="_blank">CF CLI command</a> or script at any point in your Harness PCF Workflows.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332218557/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><div class="tip-callout">You can also use the CF Command to create the service for the  <a href="https://docs.run.pivotal.io/appsman-services/autoscaler/using-autoscaler-cli.html" target="_blank">App Autoscaler plugin</a>, as described in <a href="/article/6kt564f64q-using-cli-plugins-in-harness-pcf-deployments">Using CLI Plugins in Harness PCF Deployments</a>. </div><p>The CF Command script does not require <code>cf login</code>. Harness performs logins using the credentials in the PCF Cloud Provider set up in the Infrastructure Definition for the Workflow executing the CF Command.</p><p>The CF Command has the settings described below.</p><h4>Scripts and Variables</h4><p>You can enter any CF CLI commands and scripts, but be sure to add the CF Command to a point in your Workflow where the targets of the script are available. If you add CF Command before the App Setup step, the new app is not available.</p><p>There are two built-in Harness PCF variables you can use to reference the manifest and vars files used by the script:</p><ul><li>If you are using inline Manifest files, the variable <code>${service.manifest}</code> refers to the folder containing your manifest files.</li></ul><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/6kt564f64q/1574895511399/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/6kt564f64q/1574895511399/image.png"/></a></figure><ul><li>If you are using remote Manifest files via a Git repo, <code>${service.manifest}</code> refers to the folder containing your manifest files and <code>${service.manifest.repoRoot}</code> refers to the root folder of the repo.</li></ul><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/6kt564f64q/1574890615262/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/6kt564f64q/1574890615262/image.png"/></a></figure><p>You can use the variables together to point to different locations. For example, here the manifest.yml file is one folder and the vars.yml is located using a path from the repo root folder:</p><pre class="hljs nginx">cf create-service-push --service-manifest <span class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223, 80, 0)">${service.manifest}</span>/manifest.yml --<span class="hljs-literal" style="box-sizing:inherit;color:rgb(0, 134, 179)" data-hd-color="rgb(0, 134, 179)">no</span>-push --vars-file <span class="hljs-variable" style="box-sizing:inherit;color:rgb(223, 80, 0)" data-hd-color="rgb(223, 80, 0)">${service.manifest.repoRoot}</span>/QA/vars.yml<br/>cf plugins | grep autoscaling-apps</pre><p>These variables appear when you type <code>${service</code> in <strong>Script</strong>:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332294684/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><div class="note-callout">Environment Service Overrides, such as  <a href="https://docs.harness.io/article/ur8gjgayds-pcf-environments#pcf_manifests_override">PCF Manifests Override</a>, do not apply to or override the <code>${service.manifest}</code> variable. The <code>${service.manifest}</code> variable only looks in the Harness Service.</div><p>You can also use variables in your script to templatize paths to manifest files. For example, if your Workflow Environment were templatized (see  <a href="https://docs.harness.io/article/m220i1tnia-workflow-configuration#template_a_workflow">Template a Workflow</a>), you can use the Environment variable <code>${env.name}</code> in your path, like this:</p><p><code>${service.manifest.repoRoot}/${env.name}/vars.yml</code></p><p>When the Workflow is deployed, the user will have to provide a name for the Environment to use. The same name will be substituted for <code>${env.name}</code> in the path in your script.</p><p>This substitution can be useful if you have folder names in your remote Git repo that match Harness Environment names, such as QA and PROD. The same Workflow and CF Command can be used for both Environments and use manifest files in separate repo folders.</p><h4>Delegate Selectors</h4><p>In order for the commands in your script to execute, the Harness Delegate(s) running the script must have the CF CLI and any related CF plugins installed.</p><p>Unless all of your Harness Delegates have the CF CLI and CF plugins installed, you can refer to the specific Delegates using <a href="/article/h9tkwmkrm7-delegate-installation#delegate_selectors">Delegate Selectors</a>.</p><p>In <strong>Run only on delegates having the following selectors</strong>, add the Delegate Selector(s) for the Delegates with the CF CLI and CF plugins installed.</p><p>If you do not add any Delegates Selectors to the CF Command, when the CF Command runs, Harness will only use Delegates that have the CF CLI installed.</p><p>However, if you are running plugins in CF Command, Harness cannot know which Delegates have the plugins installed.</p><p>This is why the <strong>Run only on delegates having the following selectors</strong> setting ensures that CF Command only executes on Delegates that can run the plugins mentioned in the CF Command script.</p><h4>Timeout</h4><p>Set the timeout period for your CF Command. If the command execution hangs beyond the timeout, Harness will fail the step.</p><h4>CF Command Templates</h4><p>You can also create CF Command templates in your Application or Account templates. Other users can then use these templates to quickly add the CF Commands to their Workflows.</p><p>Here are the steps for creating and adding a CF Command template:</p><ol><li>Decide on whether you want to use Application or Account templates.<br/><br/>Application templates can be used by any Workflow in the Application, and Account templates can be used by any Workflow in any Application. For an overview of template, see <a href="/article/ygi6d8epse-use-templates">Use Templates</a>.<br/>For this example, we will create an Application template.</li><li>In your Application, in <strong>Application Resources</strong>, click <strong>Template Library</strong>.</li><li>Click <strong>Add Template</strong>, and then click <strong>PCF Command</strong>. The PCF Command settings appear:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580238076802/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Configure the template the same way you would configure the CF Command in a Workflow, described in <a href="/article/9ao4gsr93j-pcf-workflows-and-deploy#cf_command">CF Command</a> above.</li><li>In <strong>Variables</strong>, enter the variable names and default values you want to use in the template. When a user adds or links this template to a Workflow, the user will provide the values for the variables.<br/>You can also type the variables in the <strong>Script</strong> field and Harness will prompt you to create them:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580238442689/image.png"/></figure>Here&#39;s an example showing variables used in the command script:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580238326747/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>When you are done, click <strong>Submit</strong>.</li><li>Navigate to a Workflow for a PCF Service.</li><li>In the <strong>Setup</strong> section on the Workflow steps, click <strong>Add Command</strong>.</li><li>Select <strong>Application Templates</strong> to select from the command from the Application Template Library.</li><li>Locate your command and click <strong>Link</strong> or <strong>Copy</strong>. A copied template does not provide version control like a linked template. In this example, we&#39;ll click <strong>Link</strong>.<br/>The CF Command template settings appear.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332502617/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Recommended: Add a Delegate Selector in <strong>Run only on delegates having the following selectors</strong>, as described in <a href="#delegate_selectors">Delegate Selectors</a>.</li><li>Provide values for the variables, if any.</li><li>Click <strong>Submit</strong>.</li></ol><p>The CF Command template is added to your Workflow.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1579654473830/image.png"/></figure><p>If you open the template, you can edit the <strong>Run only on delegates having the following selectors</strong> and <strong>Variables</strong> settings.</p><h3>Configure PCF Workflow as Code</h3><p>Harness provides a YAML code editor that enables you to perform all configuration using YAML in addition to the Harness Manager UI. In the Workflow page, simply click the <span style="color:#fb9e00" data-hd-color="#fb9e00"><strong>&lt;/&gt;</strong></span> button next to <strong>Deploy</strong>.</p><p>Harness syncs with Git, so you can create a Harness Workflow using YAML or the Harness Manager, sync it, and then simply make changes in Git. For more information, see <a href="/article/htvzryeqjw-configuration-as-code">Configuration as Code</a>.</p><h4>Blue/Green Workflow using Code</h4><p>As an example of Harness code editor functionality, let&#39;s compare how a PCF Blue/Green Workflow looks in the UI and in the code editor.</p><table><tbody><tr><td><p><strong>PCF Blue/Green Workflow in the UI</strong></p></td><td><p><strong>PCF Blue/Green Workflow in the Code Editor</strong></p></td></tr><tr><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572476933245/image.png"/></figure></td><td><figure><img src="https://files.helpdocs.io/kw8ldg1itf/other/1572476921221/image.png"/></figure></td></tr></tbody></table><p>As you can see, the <strong>Setup</strong> step in the UI has an <strong>App Setup</strong> step:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/9ao4gsr93j/1580332577968/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>In the YAML the <strong>App Setup</strong> is very simple to view:</p><pre>...<br/>    - type: PCF_SETUP<br/>      name: App Setup<br/>      properties:<br/>        blueGreen: true<br/>        isWorkflowV2: true<br/>        olderActiveVersionCountToKeep: 3<br/>        resizeStrategy: RESIZE_NEW_FIRST<br/>        tempRouteMap: null<br/>        templateUuid: null<br/>        templateVariables: null<br/>        templateVersion: null<br/>        timeoutIntervalInMinutes: 5<br/>        useCurrentRunningCount: false<br/>...</pre><p></p><h3>PCF Built-in Variables</h3><p>Harness includes the following variables to help you output PCF deployment information in your Workflows, such as in the <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#cf_command">CF Command</a> or the <a href="/article/1fjrjbau7x-capture-shell-script-step-output">Shell Script command</a>.</p><div class="note-callout">In Blue/Green deployments, the outputs for the <code>${pcf.finalRoutes}</code> and <code>${pcf.tempRoutes}</code> variables do not change, but the outputs for <code>${pcf.newAppRoutes}</code> and <code>${pcf.oldAppRoutes}</code> change as the routes are swapped in the <strong>Swap Routes</strong> or <strong>Rollback</strong> step. Simply put, <code>${pcf.newAppRoutes}</code> and <code>${pcf.oldAppRoutes}</code> reflect the routes at a point in time (before or after the <strong>Swap Routes</strong> or <strong>Rollback</strong> step).</div><table><tbody><tr><td><p><strong>Variable</strong></p></td><td><p><strong>Description</strong></p></td></tr><tr><td><p><code>${service.manifest}</code></p></td><td><p>Refers to the folder containing your manifest files. See <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#script_variables">Script Variables</a>.</p></td></tr><tr><td><p><code>${service.manifest.repoRoot}</code></p></td><td><p>Refers to the remote Git repo root folder containing your manifest files. See <a href="https://docs.harness.io/article/9ao4gsr93j-pcf-workflows-and-deploy#script_variables">Script Variables</a>.</p></td></tr><tr><td><p><code>${pcf.newAppRoutes}</code></p></td><td><p>An array of all the routes defined in your manifest.yml in your Harness Service.</p><p>You can reference any route in the array using its index, such as <code>${pcf.newAppRoutes[0]}</code>.</p><p>You can use the route to create a URL in a script, such as <code>http://${pcf.newAppRoutes[0]}</code>.</p><p>In a Blue/Green deployment, <code>${pcf.newAppRoutes}</code> are the same as <code>${pcf.tempRoutes}</code> until the Swap Routes step is run, after which <code>${pcf.newAppRoutes}</code> is the same as <code>${pcf.finalRoutes}</code>.</p></td></tr><tr><td><p><code>${pcf.newAppName}</code></p></td><td><p>New app name.</p></td></tr><tr><td><p><code>${pcf.newAppGuid}</code></p></td><td><p>New app GUID.</p></td></tr><tr><td><p><code>${pcf.oldAppName}</code></p></td><td><p>Old app name. This is the app that is replaced by your newly deployed app.</p></td></tr><tr><td><p><code>${pcf.oldAppGuid}</code></p></td><td><p>Old app GUID.</p></td></tr><tr><td><p><code>${pcf.oldAppRoutes}</code></p></td><td><p>An array of the routes that were used for the old app.</p><p>You can reference any route in the array using its index, such as <code>${pcf.oldAppRoutes[0]}</code>.</p><p>You can use the route to create a URL in a script, such as <code>http://${pcf.oldAppRoutes[0]}</code>.</p></td></tr><tr><td><p><code>${pcf.finalRoutes}</code></p></td><td><p>An array of the active routes once deployment is successful.</p></td></tr><tr><td><p><code>${pcf.tempRoutes}</code></p></td><td><p>An array of the temporary routes used for Blue/Green deployments.</p></td></tr><tr><td><p><code>${infra.pcf.cloudProvider.name}</code></p></td><td><p>The Cloud Provider name used in the Infrastructure Definition set up in the Workflow.</p></td></tr><tr><td><p><code>${infra.pcf.organization}</code></p></td><td><p>The Organization name used in the Infrastructure Definition set up in the Workflow.</p></td></tr><tr><td><p><code>${infra.pcf.space}</code></p></td><td><p>The Space name used in the Infrastructure Definition set up in the Workflow.</p></td></tr><tr><td><p><code>${host.pcfElement.applicationId}</code></p></td><td><p>Shows the PCF app ID <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/environment-variable.html#view-env" target="_blank">Environment variable</a>. Such as you would see in a cf env command:</p><pre>...<br/>{<br/> &#34;VCAP_APPLICATION&#34;: {<br/>  &#34;application_id&#34;: &#34;fa05c1a9-0fc1-4fbd-bae1-139850dec7a3&#34;,<br/>  &#34;application_name&#34;: &#34;my-app&#34;,<br/>...</pre></td></tr><tr><td><p><code>${host.pcfElement.displayName}</code></p></td><td><p>Shows the PCF app name (<code>&#34;application_name&#34;: &#34;my-app&#34;</code> in the example above).</p></td></tr><tr><td><p><code>${host.pcfElement.instanceIndex}</code></p></td><td><p>Shows the <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/environment-variable.html#CF-INSTANCE-INDEX" target="_blank">CF_INSTANCE_INDEX</a>.</p></td></tr></tbody></table><p>Here is a script that outputs some of the variables:</p><pre>echo ${pcf.newAppRoutes[0]}<br/><br/>echo New App Name: ${pcf.newAppName}<br/>echo New App Guild:  ${pcf.newAppGuid}<br/>echo New App Routes:  ${pcf.newAppRoutes}<br/><br/>echo &#34;\n\n&#34;<br/>echo Old App Name: ${pcf.oldAppName}<br/>echo Old App Guild:  ${pcf.oldAppGuid}<br/>echo Old App Routes:  ${pcf.oldAppRoutes}<br/><br/>echo activeRoute: ${pcf.finalRoutes}<br/>echo inActiveRoute: ${pcf.tempRoutes}<br/><br/>echo ${infra.pcf.cloudProvider.name}<br/>echo ${infra.pcf.organization}<br/>echo ${infra.pcf.space}</pre><p></p><h3>Harness PCF Environment Variables</h3><p>For Blue/Green Workflow deployments only, Harness uses the PCF user-provided <a href="https://docs.run.pivotal.io/devguide/deploy-apps/environment-variable.html" target="_blank">environment variable</a> <code>HARNESS_STATUS_IDENTIFIER</code> to identify new and old (active) apps.</p><p>When a new app is deployed, the variable is <code>HARNESS_STATUS_IDENTIFIER : STAGE</code>.</p><p>When Harness swaps route, the variable is updated to <code>HARNESS_STATUS_IDENTIFIER : ACTIVE</code> for the new app, and the old app variable becomes <code>HARNESS_STATUS_IDENTIFIER : STAGE</code>.</p><p>If rollback occurs, Harness restores routes and environment variables for old and new apps.</p><p>You can view this <code>HARNESS_STATUS_IDENTIFIER</code> variable in the PCF app in the PCF console.</p><h3>Next Steps</h3><ul><li> <a href="/article/6kt564f64q-using-cli-plugins-in-harness-pcf-deployments">Using CLI Plugins in Harness PCF Deployments</a></li></ul><p></p>