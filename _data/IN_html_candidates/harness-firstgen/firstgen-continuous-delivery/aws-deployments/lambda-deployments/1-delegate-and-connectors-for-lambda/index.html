<div class="tip-callout">This content is for Harness <a href="/article/1fjmm4by22">FirstGen</a>. Switch to <a href="/article/5fnx4hgwsa">NextGen</a>.</div><p>This topic sets up the Harness Delegate, Artifact Server, and Cloud Provider for your Lambda Deployment.</p><h3>Before You Begin</h3><ul><li>See <a href="/article/4o7oqwih6h-harness-key-concepts">Harness Key Concepts</a>.</li></ul><p></p><h3>Step 1: Create Roles and Policies</h3><p>Create an IAM role to support Harness Lambda deployments.</p><p>You will apply this role to the host that runs the Harness Delegate you install later, or to the AWS account you use to connect with Harness.</p><div class="note-callout">The AWS <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_testing-policies.html">IAM Policy Simulator</a> is a useful tool for evaluating policies and access.</div><h5>IAM Read Access</h5><p>Ensure that the IAM role assigned to the Delegate host has the <strong>IAMReadOnlyAccess</strong> (arn:aws:iam::aws:policy/IAMReadOnlyAccess) policy attached. The policy provides read-only access to IAM for the Delegate so that it can confirm that it has other required policies.</p><h5>Amazon S3</h5><p>The Lambda function metadata is pulled from an AWS S3 bucket and therefore the Delegate needs the <strong>AmazonS3ReadOnlyAccess</strong> (arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess) policy.</p><h5>EC2 and ECS</h5><p>The Delegate might be a Shell Script Delegate installed on an EC2 instance or an ECS Delegate installed on an ECS cluster. The required policies for the Delegate are described here:</p><ul><li><a href="https://docs.harness.io/article/whwnovprrb-cloud-providers#ecs_existing_cluster">ECS (Existing Cluster)</a> - <strong>AmazonEC2ContainerServiceforEC2Role</strong> and a custom Harness policy.</li><li><a href="https://docs.harness.io/article/whwnovprrb-cloud-providers#aws_ec2">AWS EC2</a> - <strong>AmazonEC2FullAccess</strong>.</li></ul><h5>AWS Lambda Policies</h5><p>For the Delegate to perform operations with Lambda, it requires an IAM role with the following policies:</p><ul><li><strong>AWSLambda_FullAccess (previously AWSLambdaFullAccess)</strong> (arn:aws:iam::aws:policy/AWSLambda_FullAccess)</li><li><strong>AWSLambdaRole</strong> (arn:aws:iam::aws:policy/service-role/AWSLambdaRole)</li></ul><p>The IAM role attached to your EC2 Delegate host must have the <strong>AWSLambdaRole</strong> (arn:aws:iam::aws:policy/service-role/AWSLambdaRole) policy attached. The policy contains the <code>lambda:InvokeFunction</code> needed for Lambda deployments:</p><pre>{<br/>    &#34;Version&#34;: &#34;2012-10-17&#34;,<br/>    &#34;Statement&#34;: [<br/>        {<br/>            &#34;Effect&#34;: &#34;Allow&#34;,<br/>            &#34;Action&#34;: [<br/>                &#34;lambda:InvokeFunction&#34;<br/>            ],<br/>            &#34;Resource&#34;: [<br/>                &#34;*&#34;<br/>            ]<br/>        }<br/>    ]<br/>}</pre><p>Attach the AWSLambdaRole (arn:aws:iam::aws:policy/service-role/AWSLambdaRole) policy to the IAM role for the Delegate host in EC2 or ECS.</p><p>For more information, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/access-control-identity-based.html">Identity-based IAM Policies for AWS Lambda</a> from AWS.</p><h5>Summary</h5><p>If the IAM role assigned to the Delegate has the following roles you will encounter no related issues:</p><ul><li>Shell Script Delegate on EC2 instance policies or ECS Delegate policies</li><li>IAMReadOnlyAccess</li><li>AWSLambdaRole</li><li>AWSLambda_FullAccess (previously AWSLambdaFullAccess)</li></ul><h5>Policy Requirements for Serverless Dashboard</h5><p>To see your Lambda invocations on the <a href="/article/vlj9xbj315-serverless-functions-dashboard">Serverless Dashboard</a>, the <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html" target="_blank">Execution Role</a> for the Lambda function must have the following policies:</p><ul><li>AmazonEC2FullAccess</li><li>AWSLambda_FullAccess (previously AWSLambdaFullAccess)</li><li>AWSLambdaVPCAccessExecutionRole</li><li>AWSLambdaRole</li><li>CloudWatchReadOnlyAccess</li></ul><p>The Function Invocations are updated every 10 minutes.</p><h3>Step 2: Install the Harness Delegate</h3><p>The Harness Delegate runs in your AWS VPC and executes all deployment steps, such the artifact collection and commands. The Delegate makes outbound HTTPS connections to the Harness Manager only.</p><p>The simplest method is to install a Harness Shell Script or ECS Delegate in same AWS VPC as your Lambda functions and then set up the Harness AWS Cloud Provider to use the same IAM credentials as the installed Delegate. This is described in <a href="/article/lo9taq0pze-1-delegate-and-connectors-for-lambda#add_the_cloud_provider">Add the Cloud Provider</a> below.</p><p>For steps on installing a Delegate in your VPC, see <a href="/article/h9tkwmkrm7-delegate-installation">Delegate Installation and Management</a>.</p><h4>Delegate Selector</h4><p>To ensure the IAM role applied to the Delegate you installed in the AWS VPC is used by your AWS Cloud Provider, you add Selectors to the Delegate and reference the Selector in the AWS Cloud Provider.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/lo9taq0pze/1585862327889/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>For steps on adding Selectors, see <a href="/article/h9tkwmkrm7-delegate-installation">Delegate Installation and Management</a>.</p><p></p><h3>Step 3: Add an AWS Cloud Provider</h3><p>In this section, we will add a Harness AWS Cloud Provider to your Harness account to connect to both AWS S3, Lambda, and the VPC. You can use a single or separate AWS Cloud Providers for the connections, but using a single AWS Cloud Provider is easiest.</p><div class="tip-callout">As Harness provides first-class support for <a href="/article/q6ti811nck-cloud-watch-verification-overview">CloudWatch</a>, you can also use the same AWS Cloud Provider for your CloudWatch connection.</div><h4>Permissions</h4><p>The AWS Cloud Provider in this example will assume the IAM Role associated with the Delegate you installed in your VPC. If you choose to use a AWS user account for the connection, apply the same policies to its IAM role described in <a href="/article/lo9taq0pze-1-delegate-and-connectors-for-lambda#iam_roles">IAM Roles</a> above.</p><h4>Add the Cloud Provider</h4><p>For the AWS Cloud Provider in Harness, you can specify an AWS account or assume the IAM role used by the installed Harness Delegate (recommended).</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/lo9taq0pze/1585937803477/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><h5>AWS Cloud Provider</h5><p>To set up an AWS Cloud Provider, do the following:</p><ol><li>In the Harness Manager, click <strong>Setup</strong>, and then click <strong>Cloud Providers</strong>.</li><li>Click <strong>Add Cloud Provider</strong>. The <strong>Cloud Provider</strong> dialog appears.</li><li>In <strong>Type</strong>, select <strong>Amazon Web Services</strong>.</li><li>In <strong>Display Name</strong>, enter the name that you will use to refer to this Cloud Provider when setting up your Harness Application, such as <strong>AWS Cloud</strong>. You will use the name when setting up Harness Environments, Service Infrastructures, and other settings.</li><li>In <strong>Credentials</strong>, select <strong>Assume IAM Role on Delegate</strong> (recommended) or <strong>Enter AWS Access Keys manually</strong>. If you selected <strong>Enter AWS Access Keys manually</strong>, enter your username and password.<br/>If you selected <strong>Assume IAM Role on Delegate</strong>, in <strong>Delegate Selector</strong>, select the Selector that you added to the Delegate installed in your VPC.</li></ol><p></p><h3>Next Steps</h3><ul><li><a href="/article/qp8hk4nzbo-2-service-for-lambda">Add Lambda Functions</a></li><li><a href="/article/45dm9z3m2h-3-lambda-environments">Define your Lambda Target Infrastructure</a></li></ul><p></p>