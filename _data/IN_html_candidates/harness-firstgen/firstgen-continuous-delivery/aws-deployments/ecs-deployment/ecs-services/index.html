<p>This topic covers setting up a Harness Application and Service for an ECS Deployment, including the ECS task and service definitions for various scenarios:</p><ul><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#create_the_harness_ecs_application">Create the Harness ECS Application</a></li><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#add_a_harness_ecs_service">Add a Harness ECS Service</a><ul><li><a href="#task_definition">Task Definition</a></li><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#awsvpc_network_mode">awsvpc Network Mode</a></li><li><a href="#service_definition">Service Definition</a></li><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#replica_strategy">Replica Strategy</a></li><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#daemon_strategy">Daemon Strategy</a></li><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#service_discovery">Service Discovery</a></li><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#using_private_docker_registry_authentication">Using Private Docker Registry Authentication</a></li></ul></li><li><a href="#review_task_definitions_and_amazon_ecs_service_quotas">Review: Task Definitions and Amazon ECS Service Quotas</a></li><li><a href="https://docs.harness.io/article/riu73ehy2m-ecs-services#next_step">Next Step</a></li></ul><h3>Create the Harness ECS Application</h3><p>The Harness Application represents a logical group of the ECS setup and release process, including the ECS service and task definitions, ECS cluster environment, and deployment workflow steps particular to each service you are deploying. For more information on Harness Applications, see <a href="https://docs.harness.io/article/bucothemly-application-configuration" target="_blank">Application Checklist</a>.</p><p>To create a new Application, do the following:</p><ol><li>In <strong>Harness</strong>, click <strong>Setup</strong>, and then click <strong>Add Application</strong>. The <strong>Application</strong> dialog appears.</li><li>Enter the name for your application, such as <strong>ECS Demo Application</strong>, and click <strong>SUBMIT</strong>. Your new Application appears.</li><li>Click the Application name. The Application entities appear.</li></ol><h4>ECS and Infrastructure Provisioners</h4><p>You can add a Harness Infrastructure Provisioner for CloudFormation or Terraform to your Harness Application and use the Infrastructure Provisioner to define the ECS infrastructure on the fly.</p><p>For more information, see <a href="/article/o22jx8amxb-add-an-infra-provisioner">Infrastructure Provisioners Overview</a>.</p><h3>Add a Harness ECS Service</h3><p>A Harness Service represents your microservice as the artifact source (for example, Docker image), ECS task and service definitions, and any runtime variables used for deployment. You define where the artifact comes from, and you define the container and service specs for the ECS cluster. In addition, you can use configuration variables and files for the service.</p><div class="note-callout">Harness Services are different from ECS services. Where a Harness Service describes your microservice, an ECS service is a specified number of task definition instances run and maintained simultaneously in an Amazon ECS cluster. For a detailed description of ECS services, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html" target="_blank">Services</a> from AWS.</div><p>In this guide, we will cover the how the following common ECS features are implemented in Harness Services:</p><ul><li>Replica Strategy.</li><li>Daemon Strategy.</li><li>awsvpc Network Mode.</li><li>Service Discovery.</li></ul><p>Configurations for these features are also discussed in the Harness Environment and Workflows, later in this guide. For the Harness Service artifact example, we will use a Docker image publicly hosted on Docker Hub.</p><p>To create a Harness Service for ECS, do the following:</p><ol><li>In <strong>Harness</strong>, click <strong>Setup</strong>. The list of Applications appears.</li><li>Click the name of the ECS Application you created. The Application appears.</li><li>Click <strong>Services</strong>. The <strong>Services</strong> page appears.</li><li>Click <strong>Add Service</strong>. The <strong>Service</strong> dialog appears.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/az9h2n0usr/1554157030450/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>In <strong>Name</strong>, enter a name for the service.</li><li>In <strong>Deployment Type</strong>, select <strong>Amazon Elastic Container Service (ECS)</strong>.</li><li>Click <strong>SUBMIT</strong>. The new service is listed.<br/>Next, we will add the artifact source for the service, a sample app publicly hosted on Docker Hub.</li><li>Click <strong>Add Artifact Source</strong>, and click <strong>Docker Registry</strong>.</li><li>The <strong>Artifact Source</strong> dialog appears.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1620840182048/j-of-6-r-mb-tzfbi-74-az-ieyx-53-izry-ja-qvbdu-09-rws-thil-9-mm-qvxqfw-es-gxa-5-iy-87-y-4-w-x-2-n-vgqtq-jxwun-0-l-h-10-fjej-efz-lzyb-bd-aezd-ytqrv-y-0-o-0-t-8-q-i-5-k-3-zi-06-oc-3-vvg-6-yvq-1-v-hx"/></figure></li><li>In <strong>Source Server</strong>, select the Harness Artifact Server for the Docker Registry. For information on setting up a Harness Artifact Server, see <a href="https://docs.harness.io/article/7dghbx1dbl-configuring-artifact-server" target="_blank">Add Artifact Servers</a>.</li><li>In <strong>Docker Image Name</strong>, enter the name of the image.</li><li>Click <strong>SUBMIT</strong>. The Artifact Source is added.</li></ol><p></p><p>Next, we will define the ECS task definition and service definition.</p><div class="note-callout">ECS private registry authentication for tasks using AWS Secrets Manager enables you to store your credentials securely and then reference them in your container definition. For information on using private registry authentication for tasks, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/private-auth.html" target="_blank">Private Registry Authentication for Tasks</a> from AWS.</div><h4>Task Definition</h4><div class="tip-callout">If you are not very familiar with task and service definitions, see these examples from AWS: <a href="https://github.com/aws-samples/aws-containers-task-definitions" target="_blank">Task Definitions for Amazon ECS</a>, <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/example_task_definitions.html" target="_blank">Example Task Definitions</a>.</div><p>You specify the ECS Task Definition in the Harness Service.</p><p>You can specify it inline, as described below, or using remote Git files, as described in <a href="/article/oy6sxbgqvc-use-ecs-task-and-service-definitions-in-git-repos">Use Remote ECS Task and Service Definitions in Git Repos</a>.</p><p>To specify the ECS Task Definition, do the following:</p><ol><li>In the Harness Service, in <strong>Deployment Specification</strong>, expand <strong>ECS</strong> (if necessary). The <strong>Task Definition</strong> appears.</li><li>Click <strong>Task Definition</strong>. The <strong>ECS Container Command Definition</strong> settings appear.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1605808163350/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><div class="note-callout">The simplified ECS Container Command Definition settings are for EC2 ECS clusters only. For <strong>Fargate</strong> (or advanced EC2) clusters, click <strong>Advanced Settings</strong> and use the JSON, as described below.<br/>Advanced Settings is required for Fargate because you must use the <code>${EXECUTION_ROLE}</code> placeholder, described below.</div>You can specify the Task Definition using the fields in the dialog or click <strong>Advanced Settings</strong> to add or edit the JSON.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1605808221691/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li></ol><p>For a description of all available Task Definition parameters, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_RegisterTaskDefinition.html" target="_blank">Task Definition Parameters</a> from AWS.</p><p>The Task Definition JSON uses the following placeholders.</p><table><tbody><tr><td><p><strong>Placeholder</strong></p></td><td><p><strong>Description</strong></p></td></tr><tr><td><p><code>${DOCKER_IMAGE_NAME}</code></p></td><td><p>Required. This placeholder is used with the image label in the JSON:</p><p><code>&#34;image&#34; : &#34;${DOCKER_IMAGE_NAME}&#34;</code></p><p>The placeholder is replaced with the Docker image name and tag at runtime.</p></td></tr><tr><td><p><code>${CONTAINER_NAME}</code></p></td><td><p>This placeholder is used with the name label in the JSON:</p><p><code>&#34;name&#34; : &#34;${CONTAINER_NAME}&#34;</code></p><p>The <code>${CONTAINER_NAME}</code> placeholder references the Docker image you added in the Service <strong>Artifact Source</strong>.</p><p>The placeholder is replaced with a container name based on the <strong>Artifact Source</strong> Docker image name at runtime.</p><p>You don&#39;t have to use this placeholder. You can hardcode the image name in the Task Definition. In this case, any <strong>Artifact Source</strong> Docker image is ignored.</p></td></tr><tr><td><p><code>${EXECUTION_ROLE}</code></p></td><td><p>Required for Fargate. This placeholder is used with the <code>executionRoleArn</code> label in the JSON.</p><p><code>&#34;executionRoleArn&#34; : &#34;${EXECUTION_ROLE}&#34;</code></p><p>At deployment runtime, the <code>${EXECUTION_ROLE}</code> placeholder is replaced with the ARN of the <strong>Target Execution Role</strong> used by the Infrastructure Definition of the Workflow deploying this Harness Service.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1591053523228/image.png"/></figure><p>You can also replace the <code>${EXECUTION_ROLE}</code> placeholder with another ARN manually in the Container Definition in the Service. This will override the <strong>Target Execution Role</strong> used by the Infrastructure Definition.</p><p>Replacing the <code>${EXECUTION_ROLE}</code> placeholder manually is usually only done when using a private repo.</p><p>In most cases, you can simply leave the placeholder as is.</p><p>For more information, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html" target="_blank">Amazon ECS Task Execution IAM Role</a> from AWS.</p></td></tr></tbody></table><p>If you have an existing Task Definition, you can paste it into the JSON. You can obtain the Task Definition from the ECS console:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1620840182327/uctu-qnn-fen-k-2-awt-dndk-3-bse-8-y-rc-35-uw-zc-0-c-nvwbhxamwyin-wre-5-fke-kd-yiw-vb-ijh-pcnx-8-vkb-za-2-aj-ip-i-7-pkmj-6-c-h-2-ian-yt-m-98-ysh-tum-7-j-ktyiv-of-6-n-tw-y-7-t-vj-ce-qnlps-pee-8-y"/></figure><p>You can also obtain the Task Definition using the AWS CLI (<a href="https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-task-definition.html" target="_blank">describe-task-definition</a>):</p><p><code>aws ecs describe-task-definition --task-definition ecsTaskDefinitionName</code></p><div class="note-callout">Ensure that the required placeholders <code>${DOCKER_IMAGE_NAME}</code> and <code>${EXECUTION_ROLE}</code> (for Fargate) are used.</div><p>For some example Task Definitions, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/example_task_definitions.html" target="_blank">Example Task Definitions</a> from AWS.</p><p>Once Harness deploys the ECS application, you can see the placeholders replaced in the Task Definition JSON:</p><pre class="hljs json">...<br/>     &#34;volumesFrom&#34;: [],<br/><br/>      &#34;image&#34;: &#34;registry.hub.docker.com/library/nginx:stable-perl&#34;,      ...<br/><br/>      &#34;name&#34;: &#34;library_nginx_stable-perl&#34;<br/><br/>    }</pre><p>For Fargate, you will see the <code>executionRoleArn</code> placeholder replaced:</p><pre class="hljs json">{<br/><br/>  &#34;ipcMode&#34;: null,<br/><br/>  &#34;executionRoleArn&#34;: &#34;arn:aws:iam::4XXX0225XX7:role/ecsTaskExecutionRole&#34;,<br/><br/>  &#34;containerDefinitions&#34;: [<br/><br/>    {<br/><br/>...</pre><p></p><h5>Launch Types and Infrastructure Definitions</h5><p>By definition, EC2 and Fargate support different Task Definition settings. Consequently, if you add launch type-specific settings to the Task Definition in the Harness Service, you must select the corresponding <strong>Launch Type</strong> in the Harness Infrastructure Definition used by the Harness Workflow that deploys that Service.</p><p>For example, the Fargate launch type Task Definition supports CPU and Memory settings:</p><pre>{<br/>   &#34;containerDefinitions&#34;: [ <br/>      { <br/>...<br/>      }<br/>   ],<br/>   &#34;cpu&#34;: &#34;256&#34;,<br/>   &#34;executionRoleArn&#34;: &#34;arn:aws:iam::012345678910:role/ecsTaskExecutionRole&#34;,<br/>   &#34;family&#34;: &#34;fargate-task-definition&#34;,<br/>   &#34;memory&#34;: &#34;512&#34;,<br/>   &#34;networkMode&#34;: &#34;awsvpc&#34;,<br/>   &#34;runtimePlatform&#34;: {<br/>        &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;<br/>    },<br/>   &#34;requiresCompatibilities&#34;: [ <br/>       &#34;FARGATE&#34; <br/>    ]<br/>}</pre><p></p><p>When you select the Infrastructure Definition, you must also select <strong>Fargate Launch Type</strong> for the <strong>Launch Type</strong>. </p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1663182816237/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>If you select EC2, Harness will ignore the CPU and Memory settings in your Task Definition.</p><p>If you are not very familiar with task and service definitions, see these examples from AWS: <a href="https://github.com/aws-samples/aws-containers-task-definitions" target="_blank">Task Definitions for Amazon ECS</a>, <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/example_task_definitions.html" target="_blank">Example Task Definitions</a>.</p><h5>Tags Support</h5><div class="note-callout">Currently, this feature is behind the Feature Flag <code>ECS_REGISTER_TASK_DEFINITION_TAGS</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature. Harness will remove Feature Flags for Harness Professional and Essentials editions. Once the feature is released to a general audience, it&#39;s available for Trial and Community Editions.</div><p>You can add ECS tags to your task definition just as you would in the AWS console or CLI.</p><p>You can use Harness <a href="/article/q78p7rpx9u-add-service-level-config-variables">Service</a> and <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow variables</a> in both keys and values.</p><p>For example:</p><pre>...<br/>  &#34;cpu&#34; : &#34;128&#34;,<br/>  &#34;memory&#34; : &#34;256&#34;,<br/>  &#34;tags&#34; : [  {<br/>    &#34;key&#34;: &#34;4713abcd&#34;,<br/>    &#34;value&#34;: &#34;þþÿÿ&#34;<br/>  },<br/>  {<br/>    &#34;key&#34;: &#34;6422abcd&#34;,<br/>    &#34;value&#34;: &#34;þþÿÿ&#34;<br/>  },<br/>  {<br/>    &#34;key&#34;: &#34;7592abcd&#34;,<br/>    &#34;value&#34;: &#34;þþÿÿ&#34;<br/>  },<br/>  {<br/>    &#34;key&#34;: &#34;${serviceVariable.foo}&#34;,<br/>    &#34;value&#34;: &#34;${serviceVariable.baz}&#34;<br/>  }<br/>],<br/>  &#34;inferenceAccelerators&#34; : [ ]<br/>}<br/>...</pre><p>When the Harness Service is deployed and the ECS task definition is registered, you will see the tags in AWS:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1611264412520/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Tags must meet the ECS requirements. See <a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/ecs-using-tags.html#tag-restrictions" target="_blank">Tag restrictions</a> from AWS.</p><h4>awsvpc Network Mode</h4><p>When configuring the Task Definition via the Harness Service <strong>Task Definition</strong>, you can set the <strong>awsvpc</strong> network mode by simply adding the <code>networkMode</code> parameter. For details Network Mode, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html#network_mode" target="_blank">networkMode</a> in the AWS docs.</p><h5>Example for awsvpc Network Mode</h5><p>The following example shows the <code>networkMode</code> parameter with the <strong>awsvpc</strong> value.</p><pre class="hljs json">...<br/><br/>  &#34;networkMode&#34; : &#34;awsvpc&#34;<br/><br/>}</pre><p>When you look at the Task Definition created by Harness, you can see the <strong>awsvpc</strong> network mode at the bottom of the definition JSON:</p><pre class="hljs json"> ...<br/><br/> &#34;pidMode&#34;: null,<br/><br/>  &#34;requiresCompatibilities&#34;: [],<br/><br/>  &#34;networkMode&#34;: &#34;awsvpc&#34;,<br/><br/>  &#34;cpu&#34;: null,<br/><br/>  &#34;revision&#34;: 2,<br/><br/>  &#34;status&#34;: &#34;ACTIVE&#34;,<br/><br/>  &#34;volumes&#34;: []<br/><br/>}</pre><p>Task definitions that use the <strong>awsvpc</strong> network mode use the <strong>AWSServiceRoleForECS</strong> service-linked role, which is created for you automatically. For more information, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using-service-linked-roles.html" target="_blank">Using Service-Linked Roles for Amazon ECS</a> from AWS.</p><h4>Service Definition</h4><p>You can specify the ECS service configuration in the Harness Service <strong>Service Definition</strong>.</p><p>You can specify it inline, as described below, or using remote Git files, as described in <a href="/article/oy6sxbgqvc-use-ecs-task-and-service-definitions-in-git-repos">Use Remote ECS Task and Service Definitions in Git Repos</a>.</p><p>To specify the service configuration, do the following:</p><ol><li>In the Harness Service, in <strong>Deployment Specification</strong>, expand <strong>ECS</strong> (if necessary). The <strong>Service Definition</strong> appears.</li></ol><div class="note-callout">By default, the <strong>Service Definition</strong> uses a <strong>Replica</strong> strategy.</div><p>If you have an existing service and you want to use its JSON in <strong>Service Definition</strong>, you can enter the JSON in <strong>Service Definition</strong>. You can enter in any parameter that is specified by the aws ecs <a href="https://docs.aws.amazon.com/cli/latest/reference/ecs/create-service.html" target="_blank">create-service</a> command.</p><p>You can obtain the JSON using the AWS CLI using <a href="https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-services.html" target="_blank">describe-services</a>:</p><p><code>aws ecs describe-services --cluster clusterName --service ecsServiceName</code></p><p>For information on all ECS Service definition parameters, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service_definition_parameters.html" target="_blank">Service Definition Parameters</a> from AWS.</p><p>The following sections describe how to configure the Service Definition for different ECS features.</p><div class="note-callout">If you add networking settings (<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service_definition_parameters.html#sd-networkconfiguration" target="_blank">Network configuration</a>) to the specification they will be overwritten at deployment runtime by the network settings you define for the target ECS cluster in the Harness Infrastructure Definition.</div><h5>Tags Support</h5><div class="note-callout">Currently, this feature is behind the Feature Flag <code>ECS_REGISTER_TASK_DEFINITION_TAGS</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature. Harness will remove Feature Flags for Harness Professional and Essentials editions. Once the feature is released to a general audience, it&#39;s available for Trial and Community Editions.</div><p>You can add ECS tags to your service definition just as you would in the AWS console or CLI.</p><p>You can use Harness <a href="/article/q78p7rpx9u-add-service-level-config-variables">Service</a> and <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow variables</a> in both keys and values.</p><p>For example:</p><pre>...<br/>{<br/>&#34;placementConstraints&#34;:[ ],<br/>&#34;placementStrategy&#34;:[ ],<br/>&#34;healthCheckGracePeriodSeconds&#34;:null,<br/>&#34;tags&#34;:[{<br/>    &#34;key&#34;: &#34;doc&#34;,<br/>    &#34;value&#34;: &#34;test&#34;<br/>  }],<br/>&#34;schedulingStrategy&#34;:&#34;REPLICA&#34;,<br/>&#34;propagateTags&#34;: &#34;TASK_DEFINITION&#34;<br/>}<br/>...</pre><p>When the Harness Service is deployed and the ECS service is registered, you will see the tags in AWS:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1611268218679/image.png"/></figure><p>Tags must meet the ECS requirements. See <a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/ecs-using-tags.html#tag-restrictions" target="_blank">Tag restrictions</a> from AWS.</p><h5>Capacity Provider Strategy Support</h5><p>You can use a <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service_definition_parameters.html#sd-capacityproviderstrategy" target="_blank">Capacity provider strategy</a> in your ECS Service definition via the <code>capacityProviderStrategy</code> parameter.</p><p>Later, when you define a <a href="/article/yasp1dt3h5-ecs-environments">Harness Infrastructure Definition</a> for the deployment of this ECS Service, you will select one of the following launch types:</p><ul><li>For <code>FARGATE</code> or <code>FARGATE_SPOT</code> strategies, select <strong>Fargate Launch Type</strong>.</li><li>For the Auto Scaling group strategy, select <code>EC2 Instances</code>.</li></ul><p>See <a href="/article/yasp1dt3h5-ecs-environments">ECS Environments</a>.</p><h4>Replica Strategy</h4><p>You specify the Replica strategy using the <code>schedulingStrategy</code> parameter. By default, when you create a Harness Service using the Docker Image type, the <strong>Service Definition</strong> will generate the JSON for the Replica strategy. There are no changes that you need to make.</p><h5>Example Service Definition for Replica Strategy</h5><p>The following example is the default JSON generated for the <strong>Service Definition</strong>, setting the scheduling strategy for Replica:</p><pre class="hljs json">{<br/><br/>&#34;placementConstraints&#34;:[ ],<br/><br/>&#34;placementStrategy&#34;:[ ],<br/><br/>&#34;healthCheckGracePeriodSeconds&#34;:null,<br/><br/>&#34;schedulingStrategy&#34;:&#34;REPLICA&#34;<br/><br/>}</pre><h4>Daemon Strategy</h4><p>You specify the Daemon strategy using the <code>schedulingStrategy</code> parameter. By default, when you create a Harness Service using the Docker Image type, the Service Definition will generate the JSON for the Replica strategy. To set a Daemon strategy, you simply need to change the <code>schedulingStrategy</code> parameter to <strong>DAEMON</strong>.</p><h5>Example Service Definition for Daemon Strategy</h5><p>Here is an example of how to specify the Daemon scheduling strategy in <strong>Service Definition</strong>:</p><pre class="hljs json">{<br/><br/>&#34;placementConstraints&#34;:[ ],<br/><br/>&#34;placementStrategy&#34;:[ ],<br/><br/>&#34;healthCheckGracePeriodSeconds&#34;:null,<br/><br/>&#34;schedulingStrategy&#34;:&#34;DAEMON&#34;<br/><br/>}</pre><h4>Service Discovery</h4><p>Harness does not create an ECS Service Discovery Service, but Harness registers the ECS services it creates with the Service Discovery Service.</p><p>If you have configured Service Discovery for an ECS service, Harness can deploy to that service, registering its DNS SRV records as needed. During rollback or in the case of an ECS task failing, ECS manages the DNS resolution, replacing A records, etc.</p><p>For a detailed description of Service Discovery concepts, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-discovery.html" target="_blank">Service Discovery</a> from AWS. In you are new to Service Discovery, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-service-discovery.html" target="_blank">Tutorial: Creating a Service Using Service Discovery</a> from AWS.</p><p>Here is what the ECS Service Discovery configuration looks like in AWS:</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/riu73ehy2m/1620840182435/v-xl-gbk-7-an-ggk-3-a-5-aus-3-ivhs-tf-54-a-farf-m-2-t-s-4-lftfqh-hpb-dh-si-0-mt-skl-1-sr-rz-66-cb-jxvr-8-l-t-4-yelhvh-pe-bk-5-kmwr-7-b-t-5-v-s-6-ywigkt-kmu-qo-7-wvuyr-o-8-te-yulu-d-4-fg-t-to-z-3-z" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>When you create the Service Discovery Service in ECS, you will specify a namespace and ECS will generate the DNS records (SRV and A records) for the ECS namespace in AWS Route 53. DNS Queries for the namespace are resolved by Route 53 and traffic is routed to the instances supporting the ECS cluster.</p><p>To specify the Service Discovery Service in the Harness <strong>Service Definition</strong>, add the <code>serviceRegistries</code> parameter to the Harness <strong>Service Definition</strong>. The <code>serviceRegistries</code> parameter is defined like this:</p><pre class="hljs json">&#34;serviceRegistries&#34;: [<br/><br/>  {<br/><br/>    &#34;registryArn&#34;: &#34;arn:aws:servicediscovery:us-east-1:00000000:service/srv-jwyz7x4igkxckqno&#34;,<br/><br/>    &#34;containerName&#34;: &#34;${CONTAINER_NAME}&#34;,<br/><br/>    &#34;containerPort&#34;: ${serviceVariable.containerPort}<br/><br/>    # &#34;port&#34;:<br/><br/>  }<br/><br/>],</pre><p>In this example, the Harness variable <code>${serviceVariable.containerPort}</code> is used for the <code>containerPort</code> value. You can simply enter the port number instead, such as <strong>8080</strong>. The <code>${serviceVariable.containerPort}</code> variable is created in the <strong>Config Variables</strong> section of the Service as <strong>containerPort</strong>, and referenced as <strong>${serviceVariable.containerPort}</strong> in the <strong>Service Definition</strong>. Using a <strong>Config Variable</strong> allows you to override the variable value when configuring the Harness Workflow that deploys the Service. For more information, see <a href="https://docs.harness.io/article/m220i1tnia-workflow-configuration#workflow_phases">Workflow Phases</a>.</p><p>The following list describes the fields and values needed for a Service Discovery Service in the Harness <strong>Service Definition</strong>:</p><ul><li><code>registryArn</code> - The Amazon Resource Name (ARN) of the service registry. The currently supported service registry is Amazon Route 53 Auto Naming. To obtain the <code>registryArn</code> value, use the <a href="https://docs.aws.amazon.com/cli/latest/reference/ecs/describe-services.html?highlight=registryarn" target="_blank">aws ecs describe-services</a> command.</li><li><code>containerName</code> - The <code>containerName</code> field is the container name value to be used for your Service Discovery Service, and already specified in the task definition in <strong>Task Definition</strong>. Typically, you simply use the variable <code>${CONTAINER_NAME}</code>. Harness verifies that the container name is specified in <strong>Task Definition</strong>.</li><li><code>containerPort</code> - The port value to be used for your Service Discovery Service.</li></ul><p>You can override Services variables in the Harness Environment and Workflow. For more information see <a href="https://docs.harness.io/article/n39w05njjv-environment-configuration#override_a_service_configuration" target="_blank">Override a Service Configuration</a> and <a href="https://docs.harness.io/article/m220i1tnia-workflow-configuration#workflow_phases" target="_blank">Workflow Phases</a>.</p><h5>Which Service Parameters Do I Use?</h5><p>Here are the guidelines for when to use the different service parameters in <code>serviceRegistries</code>:</p><ul><li>If the task definition for your service task uses the awsvpc network mode <em>and</em> a SRV DNS record is used, you must specify either a) <code>containerName</code> and <code>containerPort</code> or b) just <code>port</code> , <em>but not both</em>.</li><li>If you use SRV DNS records, but <em>not</em> the awsvpc network mode, a <code>containerName</code> and <code>containerPort</code> combination is required.</li><li>If you use awsvpc network mode <em>only</em> (no SRV record), you do <em>not</em> need the <code>containerName</code> and <code>containerPort</code>, but can use <code>port</code>. The <code>port</code> field is used only if both the awsvpc network mode <em>and</em> SRV records are used.</li></ul><p>Here is an example where the service task does not use the awsvpc network mode but a SRV DNS record is used:</p><pre class="hljs json">&#34;serviceRegistries&#34;: [<br/><br/>  {<br/><br/>   &#34;registryArn&#34;: &#34;arn:aws:servicediscovery:us-east-1:000000000000:service/srv-jwyz2x4igkxckqno&#34;, <br/><br/>   &#34;containerName&#34;: &#34;${CONTAINER_NAME}&#34;, <br/><br/>   &#34;containerPort&#34;: ${serviceVariable.containerPort}<br/><br/>  }<br/><br/>],</pre><p>The value for <code>containerName</code> is <code>${CONTAINER_NAME}</code>. This maps to the name field in the <strong>Task Definition</strong>, itself replaced with a container name based on the image name:</p><pre>{<br/><br/>  &#34;containerDefinitions&#34; : [ {<br/><br/>    &#34;name&#34; : &#34;${CONTAINER_NAME}&#34;,<br/><br/>    &#34;image&#34; : &#34;${DOCKER_IMAGE_NAME}&#34;,<br/><br/>...</pre><p>The value for containerPort is 8080.</p><pre>    &#34;portMappings&#34; : [ {<br/><br/>      &#34;containerPort&#34; : 8080,<br/><br/>      &#34;protocol&#34; : &#34;tcp&#34;<br/><br/>    } ],</pre><div class="note-callout">You can use Harness Environment variables to override the Service variables used in the Service Definition, thereby using the same Harness Service in multiple deployment environments. For more information, see <a href="https://docs.harness.io/article/n39w05njjv-environment-configuration#override_a_service_configuration" target="_blank">Override a Service Configuration</a>.</div><h4>Using Private Docker Registry Authentication</h4><p>In the Harness Service, you can add the <code>RepositoryCredentials</code> property type in the <strong>Task Definition</strong> to specify the repository credentials for private registry authentication.</p><p>This process has the following steps:</p><ol><li>Add the <code>secretsmanager:GetSecretValue</code> policy to the ECS task execution role. Here is the policy:</li></ol><pre>{<br/>  &#34;Version&#34;: &#34;2012-10-17&#34;,<br/>  &#34;Statement&#34;: [<br/>    {<br/>      &#34;Effect&#34;: &#34;Allow&#34;,<br/>      &#34;Action&#34;: [<br/>        &#34;kms:Decrypt&#34;,<br/>        &#34;secretsmanager:GetSecretValue&#34;<br/>      ],<br/>      &#34;Resource&#34;: [<br/>        &#34;arn:aws:secretsmanager:region:aws_account_id:secret:secret_name&#34;,<br/>        &#34;arn:aws:kms:region:aws_account_id:key:key_id&#34;     <br/>      ]<br/>    }<br/>  ]<br/>}</pre><div class="note-callout">The action <code>kms:Decrypt</code> is required only if your key uses a custom KMS key and not the default key. The ARN for your custom key should be added as a resource. For more information, and details about ECS platform versions that support this feature, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/private-auth.html" target="_blank">Private Registry Authentication for Tasks</a> from AWS.</div><ol><li style="counter-increment:li 1" start="2">Add the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-repositorycredentials.html">RepositoryCredentials</a> property type to the Harness Service as a part of the Task Definition in <strong>Task Definition</strong> like this:</li></ol><pre class="hljs json">&#34;containerDefinitions&#34;: [<br/><br/>  {<br/><br/>    &#34;name&#34; : &#34;${CONTAINER_NAME}&#34;,<br/><br/>    &#34;image&#34; : &#34;${DOCKER_IMAGE_NAME}&#34;,...<br/><br/>    &#34;repositoryCredentials&#34;: {<br/><br/>      &#34;credentialsParameter&#34;: &#34;arn:aws:secretsmanager:region:aws_account_id:secret:secret_name&#34;<br/><br/>    }<br/><br/>  ...<br/><br/>  }<br/><br/>]</pre><ol><li style="counter-increment:li 2" start="3">In addition to specifying the <code>repositoryCredentials</code>, you must also specify the Task execution role in the Service <strong>Task Definition</strong> for the Task Definition using the property <code>executionRoleArn</code>. This role authorizes Amazon ECS to pull private images for your task. For more information, see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/private-auth.html#private-auth-iam" target="_blank">Private Registry Authentication Required IAM Permissions</a>. For example:</li></ol><p><code>&#34;executionRoleArn&#34; : &#34;arn:aws:iam::448000000317:role/ecsTaskExecutionRole&#34;,</code></p><p>The Task execution role is specified when the Task Definition is created in ECS, or in AWS IAM (see <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html" target="_blank">Amazon ECS Task Execution Role</a>). If you are creating the ECS Task Definition for the first time using Harness, create the role in IAM, and then add it in <code>executionRoleArn</code> in <strong>Task Definition</strong>.</p><h3>Link Task and Service Definitions in Git Repos</h3><p>You can use your Git repo for the task and service definition files and Harness will use them at runtime.</p><p>You must use either inline or remote task and service definitions. You cannot use inline and remote together.</p><p>To use remote task and service definitions:</p><ol><li>Ensure you have set up a Harness Source Repo Provider connection to your Git repo. See <a href="/article/ay9hlwbgwa-add-source-repo-providers">Add Source Repo Providers</a>.</li><li>In your Harness ECS Service, in <strong>Deployment Specification</strong>, click more options (︙), and then click <strong>Link Remote Definitions</strong>.</li></ol><h3>Review: Task Definitions and Amazon ECS Service Quotas</h3><p>This section discusses the impact Harness ECS deployments have on Amazon ECS service quotas.</p><p>Once created, an ECS Task Definition cannot be updated as it is immutable. As discussed in AWS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/update-task-definition.html" target="_blank">Updating a task definition</a>, to update a Task Definition you need to make a revision.</p><p>In every new Harness ECS deployment, even if the task definition does not change, Harness must modify the task definition <code>image</code> property. For example, <code>&#34;image&#34;: &#34;registry.hub.docker.com/library/nginx:mainline&#34;</code>.</p><p>Harness must make this change so it can deploy the new version of the artifact.</p><p>As there is no way to update the existing Task Definition, the only way to make the change is to create a new version of the Task Definition.</p><p>AWS has a limit on <strong>Revisions per task definition family</strong> of 1 million, as covered in AWS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-quotas.html" target="_blank">Amazon ECS service quotas</a>. This limit is from AWS and Harness cannot change it.</p><p>There is the possibility of Harness deployments causing this limit to be reached. Especially if a Task Definition is shared by test, stage, and production deployments.</p><p>If the limit is reached, the ECS service name will have to be changed.</p><h3>Next Step</h3><p>Now that you have set up your <a href="/article/gpu36fl1y0-ecs-connectors-and-providers-setup">Harness Artifact Server and Cloud Provider</a> and <a href="/article/riu73ehy2m-ecs-services">ECS Service</a>, you can create the Harness Environment to identify your target ECS cluster:</p><ul><li><a href="/article/yasp1dt3h5-ecs-environments">4 - ECS Environments</a></li></ul><p></p>