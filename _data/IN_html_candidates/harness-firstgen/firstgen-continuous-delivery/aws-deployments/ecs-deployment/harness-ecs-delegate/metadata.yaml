type: article
article_id: wrm6hpyrjl
user_id: mfr0nxh4be
category_id: df9vj316ec
author:
  name: Michael Cretzman
  profile_image: https://www.gravatar.com/avatar/2e8616837f4ee92be5d19ffe9b9ccba9?d=mm&s=150
title: 1 - Harness ECS Delegate
slug: harness-ecs-delegate
description: Set up a Harness Delegate for ECS deployments.
short_version: Set up a Harness Delegate for ECS deployments.
tags:
- ECS Delegate
- ECS cluster
- ECS
- EC2
- AWS
- Delegate
- Delegate Task Spec
- Fargate
- taskRoleArn
- awsvpc
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: Article updated
  source: API
  triggered_at: 2021-05-12T17:23:02.691497Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: 1 - Harness ECS Delegate
  description: Set up a Harness Delegate for ECS deployments.
  short_version: Set up a Harness Delegate for ECS deployments.
  body: |-
    <p>The Harness ECS Delegate is software you install in your environment that connects to Harness Manager and performs Continuous Delivery tasks.</p>
    <p>This topic shows you how to install the Harness ECS Delegate in a ECS cluster as an ECS service to enable the Delegate to connect to your AWS resources:</p>
    <ul>
      <li>
        <a href="#set_up_an_ecs_delegate">Set up an ECS Delegate</a>
      </li>
      <li>
        <a href="#requirements_for_ecs_delegate">Requirements for ECS Delegate</a>
      </li>
      <li>
        <a href="#set_up_ecs_delegate_in_aws">Set up ECS Delegate in AWS</a>
      </li>
      <li>
        <a href="#multiple_ecs_delegates">Multiple ECS Delegates</a>
      </li>
      <li>
        <a href="#ecs_delegate_options">ECS Delegate Options</a>
      </li>
      <li>
        <a href="#network_modes">Network Modes</a>
      </li>
      <li>
        <a href="#change_ecs_delegate_defaults">Change ECS Delegate Defaults</a>
      </li>
      <li>
        <a href="#trust_relationships_and_roles">Trust Relationships and Roles</a>
      </li>
      <li>
        <a href="#add_a_delegate_selector">Add a Delegate Selector</a>
      </li>
      <li>
        <a href="#next_step">Next Step</a>
      </li>
    </ul>
    <h3>Set up an ECS Delegate</h3>
    <p>You can run the ECS Delegate in the same subnet as the target ECS cluster, which is often the easiest way to manage the Delegate. But this is not a requirement. The ECS cluster for the Harness ECS Delegate does not need to run in the same VPC as the target
      ECS cluster where you will deploy your ECS services.</p>
    <h4>Requirements for ECS Delegate</h4>
    <p>The Harness ECS Delegate runs as an ECS service in an ECS cluster. The ECS setup used to host the ECS Delegate must have the following:</p>
    <ul>
      <li>ECS Cluster.</li>
      <li>ECS Cluster must have 8GB memory for each ECS Delegate service added (m5ad.xlarge minimum).</li>
      <li>AWS IAM Role containing the required policies. The AWS policies are described in detail in
        <a href="https://docs.harness.io/article/whwnovprrb-infrastructure-providers#ecs_existing_cluster">ECS (Existing Cluster)</a>. For information on adding an IAM role to the ECS Delegate task definition, see
        <a href="#trust_relationships_and_roles">Trust Relationships and Roles</a>.</li>
    </ul>
    <p>You can also use a Shell Script Delegate on an EC2 instance that assumes the same role as your ECS cluster. In this case, update the trust relationship of the IAM role so that the EC2 instances can assume the role. You can set this up in the <strong>Trust relationships</strong>  tab of the IAM role:</p>
    <p></p>
    <figure>
      <img src="https://files.helpdocs.io/kw8ldg1itf/articles/az9h2n0usr/1560975059823/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/>
    </figure>
    <p>The Harness ECS Delegate requires an IAM role and policies to execute its deployment tasks (API calls, etc). For ECS clusters, there are two IAM roles to consider:</p>
    <ul>
      <li>The IAM role assigned to the cluster. When you set up an ECS cluster you select an IAM role for the cluster.</li>
      <li>The IAM role assigned to the Task Definition.</li>
    </ul>
    <p>For this tutorial, we will apply all of the roles and policies needed by the ECS Delegate to the IAM role assigned to the cluster.</p>
    <div class="note-callout">The IAM roles and policies applied to the cluster are inherited by the EC2 hosting the cluster. Consequently, in a production deployment, you might elect to add the roles and policies to the Task Definition for the Harness ECS Delegate instead. For more
      information on the best practices with ECS roles, see 
      <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html" target="_blank">Amazon ECS Container Instance IAM Role</a> from AWS.</div>
    <p>For information on adding the IAM role and policy, see
      <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html">Amazon ECS Container Instance IAM Role</a> from AWS.</p>
    <div class="note-callout">Ensure that you add the IAM roles and policies to your ECS cluster when you create it. You cannot add the IAM roles and policies to an existing ECS cluster. You can add policies to whatever role is already assigned to an existing ECS cluster.</div>
    <p><strong>Need a Cluster?</strong> If you do not have an AWS account, you can use an
      <a href="https://aws.amazon.com/free/">AWS Free Tier account</a> and create an ECS cluster by following the steps in
      <a href="https://console.aws.amazon.com/ecs/home?region=us-east-1#/getStarted">ECS Getting Started</a> from Amazon. If you do have an AWS account and you want to evaluate Harness with ECS, you can simply create a new ECS cluster in your AWS account.</p>
    <div class="note-callout">Though it is not a requirement, as a best practice, install the Delegate in the same VPC as the AWS resources Harness will use. You can even choose to install the Delegate in the same subnet. Installing the Delegate in the same VPC will help you to avoid
      cross-VPC networking complexities.</div>
    <p></p>
    <h4>Set up ECS Delegate in AWS</h4>
    <p>In most cases, your will want to run the ECS Delegate with the default launch type, EC2. You can also run it as a Fargate launch type, but this requires some additional steps.</p>
    <p>There are two specs in the Harness ECS Task Spec download, <strong>ecs-task-spec.json</strong> and <strong>service-spec-for-awsvpc-mode.json</strong>. For EC2 or awsvpc and Fargate, use the <strong>ecs-task-spec.json</strong> spec to create the default
      task definition named <strong>harness-delegate-task-spec</strong>.</p>
    <p>For EC2, you simply reference the definition name when using the <code>aws ecs create-service</code> command.</p>
    <p>For awsvpc network mode and Fargate, use the <strong>service-spec-for-awsvpc-mode.json</strong> service spec when using the <code>aws ecs create-service</code> command and it will reference the <strong>harness-delegate-task-spec</strong> task definition.</p>
    <p>The following procedure describes how to set up the ECS Delegate for the common EC2 launch type scenario:</p>
    <ol>
      <li style="counter-increment:li 0" start="1">Download the ECS Delegate Task Spec.
        <ol>
          <li>In <strong>Harness Manager</strong>, click <strong>Setup</strong>, and then click <strong>Harness Delegates</strong>.</li>
          <li>Click <strong>Download Delegate</strong>, and click the copy icon next to <strong>ECS Task Spec</strong>. The <strong>Delegate Setup</strong> dialog appears.
            <br/>
            <br/>
            <figure>
              <img src="https://files.helpdocs.io/kw8ldg1itf/articles/wrm6hpyrjl/1589498157475/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/>
            </figure>
          </li>
          <li>In <strong>Delegate Group Name</strong>, enter the name for your Delegate. When you add more ECS Delegates in the future, you can add to this group. All Delegates in this group use the same Task Definition, and share the same Delegate settings,
            including Selectors. When you change a Selector, it will apply to all Delegates running under that Group.</li>
          <li>In <strong>Profile</strong>, select a Profile for the Delegate. The default is named <strong>Primary</strong>. For more information, see
            <a href="/article/h9tkwmkrm7-delegate-installation#delegate_profiles">Delegate Profiles</a>.</li>
          <li>Select <strong>Use AWS VPC Mode</strong> if you want to run the ECS Delegate task with a
            <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_types.html">FARGATE launch type</a>.</li>
          <li>In <strong>Hostname</strong>, enter a hostname for the ECS Delegate. If you do not enter a hostname, ECS will use your Docker container ID as the hostname for the ECS Delegate. If you provide a hostname, ECS uses it.</li>
          <li>Click <strong>Download</strong>. The ECS Task Spec is downloaded. Next, you will use the aws CLI to register the ECS Task Spec and then create the ECS service for the ECS Delegate.</li>
        </ol>
      </li>
      <li>Register the ECS Task Spec in AWS.
        <ol>
          <li>Open a Terminal and navigate to the folder where you downloaded the ECS Task Spec.</li>
        </ol><code>$ cd /Users/johnsmith/Desktop/delegates/ECS</code>
        <ol>
          <li>Extract the ECS Task Spec download.
            <br/>
            <br/><code>$ tar -zxvf harness-delegate-ecs.tar.gz</code></li>
          <li>Navigate to the extracted folder: <code>cd harness-delegate-ecs</code>.</li>
          <li>Log into AWS using your AWS Access Key ID and AWS Secret Key ID.
            <br/>
            <br/><code>$ aws configure</code>
            <br/><code>AWS Access Key ID [****************LPAA]: XXXXXXX</code>
            <br/><code>AWS Secret Access Key [****************4z52]: XXXXXXX</code></li>
          <li>Register the ECS task definition using the Harness ECS Task Spec.
            <br/>
            <br/><code>$ aws ecs register-task-definition --cli-input-json file://ecs-task-spec.json</code>
            <br/>
            <br/>The JSON for the task is output.</li>
          <li>View the completed task.
            <br/>
            <br/><code>$ aws ecs list-task-definitions</code>
            <br/>
            <br/>The <code>taskDefinitionArns</code> is output.</li>
        </ol>
      </li>
      <li>Obtain the name of the ECS cluster where you want to create the ECS service. The cluster must have a minimum of 8GB of memory (m5ad.xlarge minimum).</li>
      <li>Create the ECS service for ECS Delegate.
        <ol>
          <li>Create the ECS service using the task definition, providing the service name in <code>--service-name</code>, cluster name in <code>--cluster</code>, and the desired number of tasks in <code>--desired-count</code>. The cluster will need a minimum
            of 8GB of memory per task.
            <br/>
            <br/><code>$ aws ecs create-service --service-name ecs-example --task-definition harness-delegate-task-spec --cluster default --desired-count 1</code>
            <br/>
            <br/>The output will display the JSON for the new service.
            <br/>
            <br/><code>{</code>
            <br/><code>&#34;service&#34;: {</code>
            <br/><code>&#34;status&#34;: &#34;ACTIVE&#34;,</code>
            <br/><code>&#34;serviceRegistries&#34;: [],</code>
            <br/><code>&#34;pendingCount&#34;: 0,</code>
            <br/><code>&#34;launchType&#34;: &#34;EC2&#34;,</code>
            <br/><code>&#34;schedulingStrategy&#34;: &#34;REPLICA&#34;,</code>
            <br/><code>&#34;loadBalancers&#34;: [],</code>
            <br/><code>&#34;placementConstraints&#34;: [],</code>
            <br/><code>&#34;createdAt&#34;: 1551222417.28,</code>
            <br/><code>&#34;desiredCount&#34;: 1,</code>
            <br/><code>&#34;serviceName&#34;: &#34;ecs-delegate&#34;,...</code></li>
          <li>View the new service.
            <br/>
            <br/><code>$ aws ecs list-services --cluster default</code>
            <br/>
            <br/>The output will display the new service:
            <br/>
            <br/><code>{</code>
            <br/><code>&#34;serviceArns&#34;: [</code>
            <br/><code>&#34;arn:aws:ecs:us-west-1:023826572170:service/ecs-delegate&#34;,</code>
            <br/><code>...</code>
            <br/><code>}</code></li>
          <li>Wait 5 to 10 minutes for ECS to allocate resources for the service.</li>
        </ol>
      </li>
      <li>View the new ECS Delegate in Harness Manager.
        <ol>
          <li>In <strong>Harness Manager</strong>, in the <strong>Installations</strong> page. When the ECS Delegate connects to the Harness Manager, it is listed with a status of <strong>Connected</strong>:
            <figure>
              <img src="https://files.helpdocs.io/kw8ldg1itf/articles/vea9jn2wkl/1551295797757/image.png" style="max-height:75%;max-width:75%" data-hd-height="75%" data-hd-width="75%"/>
            </figure>Congratulations! You are done installing and running the ECS Delegate.
            <br/>
            <br/>The following steps simply show you how to use a Selector name to identify this Delegate when making a connection to AWS. You simply instruct Harness to connect to AWS using the same IAM role as the Delegate via its Selector name.</li>
        </ol>
      </li>
      <li>Once the Delegate is listed in Harness Manager, assign a Selector to the Delegate.
        <ol>
          <li>Next to the <strong>Selectors</strong> label in the Delegate listing, click <strong>Edit</strong>.</li>
          <li>In the <strong>Edit Selector</strong> dialog, enter a Selector name, for example, <strong>ecs-delegate</strong>, and press <strong>Enter</strong>. Click <strong>SUBMIT</strong>. The Selector is listed.</li>
        </ol>
      </li>
      <li>Use the ECS Delegate for a Cloud provider connection.
        <ol>
          <li>In <strong>Harness Manager</strong>, click <strong>Setup</strong>.</li>
          <li>Click <strong>Cloud Providers</strong>. The <strong>Cloud Providers</strong> page appears.</li>
          <li>Click <strong>Add Cloud Provider</strong>. The <strong>Cloud Provider</strong> dialog appears.</li>
          <li>In <strong>Type</strong>, select <strong>AWS</strong>.</li>
          <li>In <strong>Display Name</strong>, enter a name for the Cloud Provider, such as <strong>aws-ecs</strong>.</li>
          <li>Enable the <strong>Assume IAM Role on Delegate</strong> option.</li>
          <li>In <strong>Delegate Selector</strong>, click to select the Selector you gave the Delegate.</li>
          <li>Click <strong>SUBMIT</strong>. The Cloud Provider is added.</li>
        </ol>
      </li>
    </ol>
    <p>Later, when you create a Harness Service or an Infrastructure Definition in a Harness Environment, you will select this Cloud Provider and Harness will use the connection to obtain ECS cluster and networking information.</p>
    <h4>Fargate Specs and Delegates</h4>
    <p>For awsvpc network mode and Fargate, use the <strong>service-spec-for-awsvpc-mode.json</strong> service spec when using the <code>aws ecs create-service</code> command and it will reference the <strong>harness-delegate-task-spec</strong> task definition.</p>
    <p>For the Fargate launch type, you must update the ECS task spec with the following
      <a href="https://aws.amazon.com/blogs/compute/migrating-your-amazon-ecs-containers-to-aws-fargate/" target="_blank">standard Fargate settings</a>:</p>
    <ul>
      <li>Set <code>requiresCompatibilities</code> to <code>FARGATE</code> instead of <code>EC2</code>.</li>
      <li>Add <code>executionRoleArn</code> to the ECS task spec. This is needed by FARGATE launch types.</li>
    </ul>
    <p>Here is an example:</p><pre>{<br/>    &#34;containerDefinitions&#34;: [<br/>        {<br/>        ...<br/>        }<br/>    ],<br/>    &#34;requiresCompatibilities&#34;: [<br/>        &#34;FARGATE&#34;<br/>    ],<br/>    &#34;executionRoleArn&#34;: &#34;arn:aws:iam::&lt;your_account_id&gt;:role/ecsTaskExecutionRole&#34;,<br/>    &#34;memory&#34;: &#34;6144&#34;,<br/>    &#34;networkMode&#34;: &#34;awsvpc&#34;,<br/>    &#34;cpu&#34;: &#34;1024&#34;,<br/>    &#34;family&#34;: &#34;harness-delegate-task-spec&#34;<br/>}</pre>
    <h5>Multiple Delegates on Delegates Page</h5>
    <p>For ECS Delegates using the EC2 launch type, Harness uses the hostname in the Task Spec as the Delegate name.</p>
    <p>For ECS Delegates using the Fargate launch type, or when using awsvpc mode, Harness cannot use the hostname in the Task Spec because AWS does not allow it. Harness uses the container ID instead (the Docker container ID and not the Amazon ECS container
      ID for the container).</p>
    <p>Consequently, every time a new task comes is run, a new Delegate is registered in Harness. This can result in multiple Delegates on the Harness Manager <strong>Harness Delegates</strong> page.</p>
    <h4>Multiple ECS Delegates</h4>
    <p>You can add multiple ECS Delegates using the following methods:</p>
    <ul>
      <li><strong>Add more tasks to the ECS service</strong> - If you installed the ECS Delegate as a ECS service, you can update the number of tasks in the ECS service. Find the task in the ECS console and click <strong>Run more like this</strong>. New delegates
        will be created and will have same Delegate Group in the Harness Manager.</li>
      <li><strong>Add more services</strong> - Create a new ECS service, in same or another cluster, using same ECS task definition.</li>
      <li><strong>Add more tasks</strong> - If you are running the ECS Delegate as an individual task, and not as an ECS service, you can create more ECS tasks using same ECS task definition. It does not matter if you use the same ECS cluster.</li>
    </ul>
    <h4>ECS Delegate Options</h4>
    <p>You can use the ECS Delegate Task Spec to set up the ECS Delegate in one of two ways:</p>
    <ul>
      <li><strong>Recommended</strong> - Create ECS services using the task definition created from the ECS Delegate Task Spec. An ECS service will spin up a new ECS Delegate task if any ECS Delegate task goes down, thus maintaining a persistent ECS Delegate.</li>
      <li>Create and run individual ECS tasks using the task definition created from the ECS Delegate Task Spec.</li>
    </ul>
    <h4>Network Modes</h4>
    <p>When you download the ECS Delegate Task Spec, you can select <strong>awsvpc</strong> as the network mode. When you create the service using the ECS Delegate Task Spec, use the service-spec-for-awsvpc-mode.json file:</p><pre>aws ecs create-service --cli-input-json file://&lt;$PATH&gt;/service-spec-for-awsvpc-mode.json</pre>
    <p>The ECS console will request network configuration info when you run the Delegate task or service, including subnets, security groups, and public IP (for Fargate launch type).</p>
    <h4>Change ECS Delegate Defaults</h4>
    <p>To change CPU, memory, port mappings, or hostname, edit the default values in <strong>ecs-task-spec.json</strong> file. You can also change any other JSON fields as needed.</p>
    <h4>Trust Relationships and Roles</h4>
    <p>If you have an IAM role that you want an ECS task to use, you need to add a trust relationship using a <strong>taskRoleArn</strong> definition in the ECS task definition. Consequently, if you have an IAM role that you want the ECS Delegate to use, you
      need to add a <strong>taskRoleArn</strong> definition in the ECS Delegate task definition.</p>
    <p>The taskRoleArn is the resource ARN of an IAM role that grants containers in the task permission to call AWS APIs on your behalf.</p>
    <p>By default, the ECS Delegate task definition does not use a taskRoleArn, but uses the cluster-level IAM role that was used to create the existing cluster.</p>
    <p>Here is an example of a ECS Delegate task definition with the taskRoleArn added before the container definition:</p><pre>{<br/>  &#34;ipcMode&#34;: null,<br/>  &#34;executionRoleArn&#34;: null,<br/>  &#34;<strong>taskRoleArn</strong>&#34;: &#34;arn:aws:iam::123456789012:role/my-task-role&#34;<br/>  &#34;containerDefinitions&#34;: [<br/>    {<br/>      &#34;dnsSearchDomains&#34;: null,<br/>      &#34;logConfiguration&#34;: null,<br/>      &#34;entryPoint&#34;: null,<br/>      &#34;portMappings&#34;: [<br/>        {<br/>...</pre>
    <div class="note-callout">For more information, see
      <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_manage_modify.html" target="_blank">Modifying a Role</a> from AWS.</div>
      <h3>Add a Delegate Selector</h3>
      <p>When Harness makes a connection to your ECS cluster via its Delegates, it will select the best Delegate according to its history and
        <a href="https://docs.harness.io/article/h9tkwmkrm7-delegate-installation#how_does_harness_manager_pick_delegates">other factors</a>. To ensure a specific Delegate is used by a Harness entity, you can scope the Delegate as explained in
        <a href="https://docs.harness.io/article/h9tkwmkrm7-delegate-installation#delegate_scope">Delegate Scope</a>, or you can add Selectors to Delegates and then reference the tags in commands and configurations.</p>
      <p>For this guide, we will use a Delegate Selector. Later, when you add an AWS Cloud Provider to your Harness account, you will use the Delegate Tag you added to ensure the Cloud Provider uses that Delegate.</p>
      <p>For steps on using Delegate Selector with your ECS Delegate, see the steps in
        <a href="/article/h9tkwmkrm7-delegate-installation#set_up_ecs_delegate_in_aws">Set up ECS Delegate in AWS</a>.</p>
      <h3>Next Step</h3>
      <ul>
        <li>
          <a href="/article/gpu36fl1y0-ecs-connectors-and-providers-setup">2 - ECS Connectors and Providers Setup</a>
        </li>
      </ul>
      <p></p>
  slug: harness-ecs-delegate
  tags:
  - ECS Delegate
  - ECS cluster
  - ECS
  - EC2
  - AWS
  - Delegate
  - Delegate Task Spec
  - Fargate
  - taskRoleArn
  - awsvpc
  is_live: true
