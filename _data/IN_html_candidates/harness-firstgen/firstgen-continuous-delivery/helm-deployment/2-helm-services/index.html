<div class="tip-callout">This content is for Harness <a href="/article/1fjmm4by22">FirstGen</a>. Switch to <a href="/article/lbhf2h71at">NextGen</a>.</div><p>This topic describes how to create a Harness Application and adds a Service that uses a Docker image and Helm chart for a Kubernetes deployment.</p><div class="note-callout">Harness includes both Kubernetes and Helm deployments, and you can use Helm charts in both. Harness <a href="https://docs.harness.io/article/pc6qglyp5h-kubernetes-deployments-overview">Kubernetes Deployments</a> allow you to use your own Helm chart (remote or local), and Harness executes the Kubernetes API calls to build everything without Helm and Tiller needing to be installed in the target cluster. See <a href="https://docs.harness.io/article/t6zrgqq0ny-kubernetes-services#helm_charts">Helm Charts</a>.</div><ul><li> <a href="#release_name_required">Release Name Required</a></li><li> <a href="https://docs.harness.io/article/svso08ogpb-2-helm-services#create_the_harness_application">Create the Harness Application</a></li><li> <a href="https://docs.harness.io/article/svso08ogpb-2-helm-services#add_the_helm_service_to_the_application">Add the Helm Service to the Application</a></li><li> <a href="https://docs.harness.io/article/svso08ogpb-2-helm-services#add_the_docker_artifact_source">Add the Docker Artifact Source</a></li><li> <a href="https://docs.harness.io/article/svso08ogpb-2-helm-services#add_the_helm_chart">Add the Helm Chart</a></li><li> <a href="#option_helm_command_flags">Option: Helm Command Flags</a></li><li> <a href="https://docs.harness.io/article/svso08ogpb-2-helm-services#spec_requirements_for_steady_state_check_and_verification">Spec Requirements for Steady State Check and Verification</a></li><li> <a href="https://docs.harness.io/article/svso08ogpb-2-helm-services#values_yaml_override">Values YAML Override</a></li><li> <a href="https://docs.harness.io/article/svso08ogpb-2-helm-services#next_step">Next Step</a></li></ul><h3>Release Name Required</h3><p>When using a Native Helm deployment in Harness, ensure that the workload-related manifests include a Release Name in their metadata. For an example, see this <a href="https://github.com/helm/charts/blob/master/stable/artifactory/templates/artifactory-statefulset.yaml">StatefulSet spec from Artifactory</a>.</p><p>You can see that the release name is under:</p><ul><li>metadata.labels</li><li>spec.selector.matchLabels</li><li>spec.template.metadata.labels</li></ul><p>Harness requires a release name for tracking different deployments as well as tracking resources deployed under that release.</p><p>The release name must be unique across the cluster.</p><h3>Create the Harness Application</h3><p>An application in Harness represents a logical group of one or more entities, including Services, Environments, Workflows, Pipelines, Triggers, and Infrastructure Provisioners. Applications organize all of the entities and configurations in Harness CI/CD. For more information, see <a href="/article/bucothemly-application-configuration">Application Checklist</a>.</p><p>To add the Harness Application and service, do the following:</p><ol><li>In <strong>Harness</strong>, click <strong>Setup</strong>.</li><li>Click <strong>Add Application</strong>. The <strong>Application</strong> dialog appears.</li><li>Give your application a name that describes your microservice or app. For the purposes of this guide, we use the name <strong>Docker-Helm</strong>.</li><li>Click <strong>SUBMIT</strong>. The new application is added.</li><li>Click the application name to open the application. The application entities are displayed.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zmrvylwqds/1539300754662/image.png"/></figure><p></p><h3>Add the Helm Service to the Application</h3><ol><li>In your new application, click <strong>Services</strong>. The <strong>Services</strong> page appears.</li><li>In the <strong>Services</strong> page, click <strong>Add Service</strong>. The <strong>Service</strong> dialog appears.</li><li>In <strong>Name</strong>, enter a name for your microservice. For example, if your microservice were the checkout service in a Web application, you could name it <strong>checkout</strong>. For this guide, we will use <strong>Docker-Helm</strong>.</li><li>In <strong>Deployment Type</strong>, select <strong>Native</strong> <strong>Helm</strong>. Harness will create a service that is designed for Helm deployments. When you are finished, the dialog will look like this:<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/svso08ogpb/1590689577320/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>Select <strong>Enable Helm V3</strong>. This ensures that you are using the latest Helm settings.</li><li>Click <strong>SUBMIT</strong>. The new service is added. Let&#39;s look at where Docker and Helm are configured in the Service page:</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/svso08ogpb/1576695023502/image.png"/></figure><p>The following table describes the different sections.</p><p></p><table><tbody><tr><td><p><strong>Component</strong></p></td><td><p><strong>Section in Service</strong></p></td><td><p><strong>Description</strong></p></td></tr><tr><td><p>Docker</p></td><td><p><strong>Artifact Source</strong></p></td><td><p>You add a pointer to the Docker image location you want to deploy.</p></td></tr><tr><td><p>Helm</p></td><td><p><strong>Chart Specification</strong></p></td><td><p>You enter the Helm chart repo and chart to use.</p><p>Typically, this is the only Helm configuration needed in a Harness service.</p><p>This is the easiest way to point to your chart, but you can add the chart info in <strong>Values YAML Override</strong> instead.</p></td></tr><tr><td><p>Helm</p></td><td><p><strong>Values YAML Override</strong></p></td><td><p>You can enter the contents of a Helm values.yaml file here. This file contains the default values for a chart.</p><p>Values entered here will overwrite values in the values.yaml entered in <strong>Chart Specification</strong>.</p><p>If you want to point to your Helm chart here, you can simply add the YAML:</p><pre>harness:<br/>  helm:<br/>    chart:<br/>      name: nginx<br/>      version: 1.0.1<br/>      url: https://charts.bitnami.com/bitnami</pre></td></tr></tbody></table><h3>Add the Docker Artifact Source</h3><ol><li>In the new service, click <strong>Add</strong><strong>Artifact Source</strong>, and select <strong>Docker Registry</strong>. There are a number of artifact sources you can use. For more information, see <a href="/article/gxv9gj6khz-add-a-docker-image-service#add_a_docker_image_service">Add a Docker Image Server</a>. The <strong>Docker Registry</strong> dialog appears.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/svso08ogpb/1580239555588/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>In <strong>Name</strong>, let Harness generate a name for the source.</li><li>In <strong>Source Server</strong>, select the Artifact Server you added earlier in this guide. We are using <strong>Docker Hub</strong> in this guide.</li><li>In <strong>Docker Image Name</strong>, enter the image name. Official images in public repos such as Docker Hub need the label <strong>library</strong>. For example, <strong>library/nginx</strong>. For this guide, we will use Docker Hub and the publicly available NGINX at <strong>library/nginx</strong>.</li><li>Click <strong>SUBMIT</strong>. The Artifact Source is added.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zmrvylwqds/1550778178074/image.png"/></figure><h3>Add the Helm Chart</h3><p>As explained earlier, you have two options when entering in the Helm chart info. The <strong>Chart Specifications</strong> or the <strong>Values YAML</strong>. For this guide, we will use the <strong>Chart Specifications</strong>.</p><ol><li>Click <strong>Chart Specifications</strong>. The <strong>Chart Specification</strong> settings appear.</li><li>In <strong>Location</strong>, select <strong>Helm Repository</strong> or <strong>Source Repository</strong>.</li></ol><p>For <strong>Source Repository</strong>, do the following:</p><ol><li>In <strong>Source Repository</strong>, select a Git SourceRepo Provider for the Git repo you added to your Harness account. For more information, see <a href="/article/ay9hlwbgwa-add-source-repo-providers">Add SourceRepo Providers</a>.</li><li>In <strong>Commit ID</strong>, select <strong>Latest from Branch</strong> or <strong>Specific Commit ID</strong>.</li><li>In <strong>Branch</strong> or <strong>Commit ID</strong>, enter the branch or commit ID for the remote repo.</li><li>In <strong>File/Folder path</strong>, enter the repo file and folder path.</li></ol><div class="note-callout">Helm <a href="https://helm.sh/docs/topics/charts/" target="_blank">chart dependencies</a> are not supported in <strong>Source Repository</strong>. If your Helm chart in a Git repo uses chart dependencies, you will need to move to the <strong>Helm Repository</strong> option.</div><p>For <strong>Helm Repository</strong>, do the following:</p><ol><li>In <strong>Helm Repository</strong>, select the Helm Chart Repository you added as a Harness Artifact Server. For more information, see <a href="/article/7dghbx1dbl-configuring-artifact-server#helm_repository">Helm Repository</a>.</li></ol><div class="note-callout">If you are using Google Cloud Storage for your Helm repo, you will see a <strong>Base Path</strong> setting for the bucket. See <a href="https://harness.helpdocs.io/article/whwnovprrb-cloud-providers#google_cloud_storage_gcs">Google Cloud Storage (GCS)</a> for details on the policies required.</div><ol><li style="counter-increment:li 1" start="2">In <strong>Base Path</strong>, enter the path to the charts&#39; bucket folder or a Workflow variable expression.<ol><li style="counter-increment:li 0" start="1">If you use a charts&#39; bucket folder, simply enter the name of the folder. Whether you need to specify a single folder (e.g. <code>charts</code>) a folder path (e.g. <code>helm/charts</code>) depends on the Helm Chart Repository you added as a Harness Artifact Server.</li><li>If you use a Workflow variable expression, you can enter in the expression as part of the path. For example, <code>/Myservice/Chart/${workflow.variables.branchName}/</code> or simply <code>${workflow.variables.chartFolder}</code>.</li></ol><div class="note-callout">For more information, see <a href="/article/9dvxcegm90-variables">Variables and Expressions in Harness</a> and <a href="/article/m220i1tnia-workflow-configuration#add_workflow_variables">Add Workflow Variables</a>.</div><ol><li style="counter-increment:li 2" start="3">If the chart is in the <strong>root</strong> folder of the repository location set in the Helm Chart Repository you added as a Harness Artifact Server, leave <strong>Base Path</strong> empty.</li></ol></li><li>In <strong>Chart Name</strong>, enter the name of the chart in that repo.</li><li>In <strong>Chart Version</strong>, enter the chart version to use. This is found in the <strong>Chart.yaml</strong> <strong>version</strong> label. If you leave this field empty Harness gets the latest chart.</li></ol><p>Here are a couple of examples using GCS and S3:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/svso08ogpb/1576696862182/image.png"/></figure><p>Here is an example using a Workflow variable expression. You can see the variable created in the Workflow&#39;s <strong>Workflow Variables</strong> section, referenced using an expression in <strong>Chart Specification</strong>, and then a value provided for the variable in the deployment dialog that matches the chart folder&#39;s name.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/svso08ogpb/1576701061276/image.png"/></figure><p></p><p></p><ol><li style="counter-increment:li 4" start="5">To use Helm command flags, click <strong>Enable Command Flags</strong>, and then enter the command to use.</li><li>Click <strong>SUBMIT</strong>. The chart specification is added to the service.</li></ol><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zmrvylwqds/1556925241950/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>When you deploy a Workflow using a Harness Kubernetes Service set up with a Helm Repository, you will see Harness fetch the chart:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/zmca0zai3s/1556315475242/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zmca0zai3s/1556315475242/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><p>Next, you will see Harness initialize using the chart:</p><figure><a href="https://files.helpdocs.io/kw8ldg1itf/articles/zmca0zai3s/1556315542170/image.png"><img src="https://files.helpdocs.io/kw8ldg1itf/articles/zmca0zai3s/1556315542170/image.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></a></figure><h4>Release Name Required</h4><p>Ensure that the workload-related manifests include a Release Name in their metadata.</p><p>See <a href="#release_name_required">Release Name Required</a>.</p><h4>Other Options</h4><p>You can specify other options in the <strong>Chart Specification</strong> dialog by choosing <strong>None</strong> in the <strong>Helm Repository</strong> field, and the using the remaining fields as described in the following table.</p><div class="note-callout">These options are provided for backwards-compatibility and it is preferable that you use either the <strong>Helm Repository</strong> or <strong>Source Repository</strong> options.</div><table><tbody><tr><td><p><strong>Installation Method</strong></p></td><td><p><strong>Example</strong></p></td><td><p><strong>Field Values</strong></p></td></tr><tr><td><p>Chart reference.</p></td><td><p><code>helm install stable/nginx</code></p></td><td><p><strong>Chart Name:</strong> stable/nginx</p></td></tr><tr><td><p>Path to a packaged chart.In this method, the chart file is located on the same pod as the Harness Delegate.You can add a Delegate Profile that copies the chart from a repo to the pod. For more information, see <a href="/article/h9tkwmkrm7-delegate-installation#delegate_profiles">Delegate Profiles</a>.</p></td><td><p><code>helm install ./nginx-1.2.3.tgz</code></p></td><td><p><strong>Chart Name:</strong> <em>dir_path_to_delegate</em>/nginx</p></td></tr><tr><td><p>Path to an unpacked chart directory.In this method, the chart file is located on the same pod as the Harness delegate.You can add a Delegate Profile that copies the chart from a repo to the pod. For more information, see <a href="/article/h9tkwmkrm7-delegate-installation#delegate_profiles">Delegate Profiles</a>.</p></td><td><p><code>helm install ./nginx</code></p></td><td><p><strong>Chart Name:</strong> <em>dir_path_to_delegate</em>/nginx</p></td></tr><tr><td><p>Absolute URL.</p></td><td><p><code>helm install https://example.com/charts/nginx-1.2.3.tgz</code></p></td><td><p><strong>Chart Name:</strong> https://example.com/charts/nginx-1.2.3.tgz</p></td></tr></tbody></table><p></p><p>For Helm, that&#39;s it. You don&#39;t have to do any further configuration to the service. Harness will use the chart you specified to configure the Kubernetes cluster.</p><div class="note-callout">File-based repo triggers are a powerful feature of Harness that lets you set a Webhook on your repo to trigger a Harness Workflow or Pipeline when a Push event occurs in the repo. For more information, see <a href="/article/xerirloz9a-add-a-trigger-2#file_based_repo_triggers">File-based Repo Triggers</a>.</div><p>Now you can define the deployment environment and workflow for the deployment.</p><h3>Option: Helm Command Flags</h3><p></p><p>You can extend the Helm commands that Harness runs when deploying your Helm chart.</p><p>Use <strong>Enable Command Flags</strong> to have Harness run Helm-specific Helm commands and their options <u>as part of preprocessing</u>. All the commands you select are run before <code>helm install/upgrade</code>.</p><p>Click Enable Command Flags, and then select commands from the <strong>Command Flag Type</strong> dropdown.</p><p>Next, in <strong>Input</strong>, add any options for the command.</p><div class="note-callout">The <code>--debug</code> option is not supported.</div><p>For Native Helm deployments using Helm charts (as opposed to Kubernetes deployments using Helm charts), multiple commands are supported.</p><p>You will see the outputs for the commands you select in the Harness deployment logs. The output will be part of pre-processing and appear before <code>helm install/upgrade</code>.</p><div class="note-callout">If you use Helm commands in the Harness Service and in a Workflow deploying that Service, the Helm commands in the Harness Service override the commands in the Workflow.</div><p></p><h4>Harness Variable Expressions are Supported</h4><p>You can use <a href="/article/9dvxcegm90-variables">Harness variable expressions</a> in any of the command options settings. For example, <a href="/article/q78p7rpx9u-add-service-level-config-variables">Service Config variables</a> and <a href="/article/766iheu1bk-add-workflow-variables-new-template">Workflow variables</a>.</p><h3>Spec Requirements for Steady State Check and Verification</h3><p>Harness requires that the <code>release: {{ .Release.Name }}</code> label be used in <strong>every</strong> Kubernetes spec to ensure that Harness can identify a release, check its steady state, and perform verification on it.</p><div class="warning-callout">Ensure that the <code>release: {{ .Release.Name }}</code> label is in every Kubernetes object&#39;s manifest. If you omit the <code>release: {{ .Release.Name }}</code> label from a manifest, Harness cannot track it.</div><p>The <a href="https://helm.sh/docs/chart_template_guide/#built-in-objects" target="_blank">Helm built-in Release object</a> describes the release and allows Harness to identify each release. For this reason, the <code>release: {{ .Release.Name }}</code> label must be used in your Kubernetes spec. For example:</p><pre>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: {{ template &#34;todolist.fullname&#34; . }}<br/>  namespace: {{ .Values.namespace }}<br/>  labels:<br/>    app: {{ template &#34;todolist.name&#34; . }}<br/>    chart: {{ template &#34;todolist.chart&#34; . }}<br/><strong>    release: {{ .Release.Name }}<br/></strong>    heritage: {{ .Release.Service }}<br/>...</pre><p>You will provide a name to be used in place of <code>{{ .Release.Name }}</code> in the Helm Workflow you create in Harness. The Workflow contains the <strong>Helm Deploy</strong> step, where you can enter in a release name to replace <code>{{ .Release.Name }}</code> at runtime:</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/svso08ogpb/1580239803061/image.png"/></figure><p>For information on the Helm Deploy step, see <a href="/article/m8ra49bqd5-4-helm-workflows">Helm Deploy</a>.</p><h3>Values YAML Override</h3><p>In the <strong>Values YAML Override</strong> section, you can enter the YAML for your values.yaml file. The values.yaml file contains the default values for a chart. You will typically have this file in the repo for your chart, but you can add it in the Harness service instead.</p><p>The <strong>Values YAML</strong> dialog has the following placeholders that save you from having to enter in some variables:</p><ul><li><strong>${NAMESPACE}</strong> - Replaced with the Kubernetes namespace, such as <strong>default</strong>. You will specify the namespace of the cluster in the <strong>Namespace</strong> setting when adding the Harness Environment infrastructure details later, and the placeholder will be replaced with that namespace.</li><li><strong>${DOCKER_IMAGE_NAME}</strong> - Replaced with the Docker image name.</li><li><strong>${DOCKER_IMAGE_TAG}</strong> - Replaced with the Docker image tag.</li></ul><p>For information about how values from different source are compiled at runtime, see <a href="https://docs.harness.io/article/m8ra49bqd5-4-helm-workflows#helm_values_priority">Helm Values Priority</a>.</p><p>You can override the values using the <strong>Inline</strong>, <strong>Remote</strong>, or <strong>From Helm Repository</strong> options.</p><h4>Inline Override</h4><p>Enter the YAML you want to use to override the Values YAML file used in <strong>Chart Specification</strong>.</p><h4>Remote Override</h4><p>In <strong>Configuration</strong>, in <strong>Values YAML Override</strong>, click the edit icon.</p><p>For <strong>Remote</strong>, do the following:</p><ol><li>In <strong>Source Repository</strong>, select the Git repo you added as a <a href="/article/ay9hlwbgwa-add-source-repo-providers">Source Repo Provider</a>.</li><li>For <strong>Commit ID</strong>, select either <strong>Latest from Branch</strong> and enter in the branch name, or <strong>Specific Commit ID</strong> and enter in the <strong>commit ID</strong>.</li><li>In <strong>File path</strong>, enter the path to the values.yaml file in the repo, including the repo name, like <strong>helm/values.yaml</strong>.</li></ol><h4>From Helm Repository Override</h4><p>If you are using the Helm Chart from Helm Repository option in <strong>Manifests</strong>, you can override the chart in <strong>Manifests</strong> using one or more values YAML files inside the Helm chart.</p><p>In <strong>Configuration</strong>, in <strong>Values YAML Override</strong>, click the edit icon.</p><p>In <strong>Store Type</strong>, select <strong>From Helm Repository</strong>.</p><p>In <strong>File Path(s)</strong>, enter the file path to the override values YAML file.</p><p>Multiple files can be used. When you enter the file paths, separate the paths using commas.</p><p>The latter paths are given higher priority.</p><p></p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/p453sikbqt/1627588950131/clean-shot-2021-07-29-at-13-02-21.png"/></figure><h3>Next Step</h3><ul><li> <a href="/article/134kx1k89d-3-helm-environments">3 - Helm Environments</a></li></ul><p></p>