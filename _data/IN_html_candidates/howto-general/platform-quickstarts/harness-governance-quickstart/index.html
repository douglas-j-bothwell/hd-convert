<div class="note-callout">Currently, this feature is behind the Feature Flag <code>OPA_PIPELINE_GOVERNANCE</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature.</div><p>Harness Policy As Code provides governance using Open Policy Agent (OPA), Policy Management, and Rego policies. You can use Harness Policy As Code to ensure that Harness entities like Pipelines meet specific compliance requirements when specific events happen (On Save, On Run, etc).</p><p>This quickstart shows you how to use Harness OPA integration to enforce Pipeline governance.</p><p>We&#39;ll show you how to use OPA&#39;s Rego policy language to create policies, test them against Pipelines, enforce them when saving and running Pipelines, and reviewing all of the policy evaluations for a Pipeline.</p><p>Let&#39;s get started.</p><h3>Objectives</h3><p>You&#39;ll learn how to:</p><ol><li>Create and test Rego policies in Harness.</li><li>Create a Policy Set using your new policy.</li><li>Run a Pipeline that fails a policy evaluation.</li><li>Run a Pipeline that passes a policy evaluation.</li><li>Review policy evaluations for a Pipeline.</li></ol><p></p><h3>Before You Begin</h3><ul><li><strong>What you don&#39;t need:</strong> this quickstart is only intended to show you how Pipeline governance works and so we use a simple Pipeline that only contains an Approval stage. You do <u>not</u> need a Kubernetes cluster or other host as a CD deployment target or CI build farm. You do <u>not</u> need a running Harness Delegate.</li><li>Review <a href="https://docs.harness.io/article/4o7oqwih6h-harness-key-concepts">Harness Key Concepts</a> to establish a general understanding of Harness.</li><li>The <a href="/article/1d3lmhv4jl-harness-governance-overview">Harness Policy As Code Overview</a> provides a concise overview of Harness Policy As Code.</li><li><strong>New to OPA Policy Authoring?</strong> OPA policies are written in OPA&#39;s Rego policy language. We&#39;ll provide the policy you need for this quickstart, but it&#39;s also helpful to have some familiarity with Rego before writing and reading policies.<ul><li><strong>Highly recommend:</strong> Free online course on Rego from Styra founder and OPA co-creator Tim Hendricks: <a href="https://academy.styra.com/courses/opa-rego" target="_blank">OPA Policy Authoring</a>.</li><li>See <a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank">Policy Language</a> from OPA. The <a href="https://dboles-opa-docs.netlify.app/docs/v0.10.7/rego-cheatsheet/" target="_blank">Rego Cheatsheet</a> is also helpful to have on hand.</li></ul></li></ul><div class="warning-callout">When you create Policy Sets they are applied to all matching entities (for example, Pipelines). Be careful that you do not create a Policy Set that might impact existing Pipelines <u>unintentionally</u>.<br/><br/>For this quickstart, we&#39;ll create a new Harness Project and only apply Policy Sets to its Pipelines. We will not impact Pipelines outside of this Project.</div><h4>How does Harness use OPA?</h4><p>The Harness OPA server is an OPA server managed by Harness.</p><p>In Harness, you add Rego policies to a Policy Set and select the Harness entities for evaluation (e.g. Pipelines). At that point, the policies are configured on the Harness OPA Server via a Kubernetes ConfigMap.</p><p>When certain events happen (e.g. saving or running a Pipeline), Harness reaches out to the Harness OPA server to evaluate the action using the Policy Set.</p><p>For more details, see <a href="/article/1d3lmhv4jl-harness-governance-overview">Harness Policy As Code Overview</a>.</p><h3>Step 1: Create a Project</h3><p>In your Harness account, click <strong>Home</strong>.</p><p>Click <strong>Projects</strong>, and then click <strong>New Project</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1636484069036/clean-shot-2021-11-09-at-10-54-17-2-x.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Name the Project <strong>Quickstart</strong>, and click <strong>Save and Continue</strong>.</p><p>In <strong>Invite Collaborators</strong>, click <strong>Save and Continue</strong>. You automatically be added as a Project Admin.</p><p>Your new Project is created.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1636485680678/clean-shot-2021-11-09-at-11-21-12-2-x.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Next we&#39;ll add a Pipeline that we&#39;ll evaluate later using OPA policies.</p><h3>Step 2: Create a Pipeline</h3><p>For this quickstart, we&#39;ll use a very simple Pipeline that only contains an <a href="/article/fkvso46bok-adding-harness-approval-stages">Approval stage</a>.</p><p>Open the new Harness Project you created and click <strong>Deployments</strong>.</p><p>Click <strong>Pipelines</strong>, and then click <strong>Create a Pipeline</strong>.</p><p>Name the Pipeline <strong>Policy Example</strong> and click <strong>Start</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1634678222361/clean-shot-2021-10-19-at-14-16-55.png"/></figure><p>In Pipeline Studio, click <strong>YAML</strong> to switch to the YAML editor.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1634678310967/clean-shot-2021-10-19-at-14-18-19.png"/></figure><p>Click <strong>Edit YAML</strong>.</p><p>Replace the existing YAML with the following YAML:</p><pre class="hljs yaml">pipeline:<br/>    name: Policy Example<br/>    identifier: Policy_Example<br/>    projectIdentifier: Quickstart<br/>    orgIdentifier: default<br/>    tags: {}<br/>    stages:<br/>        - stage:<br/>              name: Test<br/>              identifier: Test<br/>              description: &#34;&#34;<br/>              type: Approval<br/>              spec:<br/>                  execution:<br/>                      steps:<br/>                          - step:<br/>                                type: ShellScript<br/>                                name: Echo<br/>                                identifier: Echo<br/>                                spec:<br/>                                    shell: Bash<br/>                                    onDelegate: true<br/>                                    source:<br/>                                        type: Inline<br/>                                        spec:<br/>                                            script: echo &#34;hello&#34;<br/>                                    environmentVariables: []<br/>                                    outputVariables: []<br/>                                    executionTarget: {}<br/>                                timeout: 10m<br/>                  serviceDependencies: []<br/>              tags: {}</pre><p></p><div class="note-callout">We use the <strong>Quickstart</strong> <code>projectIdentifier</code> and the <strong>default</strong> <code>orgIdentifier</code>. If you are in a different org, you can replace <strong>default</strong> with the current org Id. You can get Ids from the URL in your browser: <code>.../orgs/&lt;Org Id&gt;/projects/&lt;Project Id&gt;/...</code>.</div><p>Click <strong>Save</strong>. The Pipeline is now saved.</p><p>Click <strong>Visual</strong> and you can see it&#39;s a simple Pipeline with a manual <a href="/article/fkvso46bok-adding-harness-approval-stages">Approval stage</a> and one <a href="/article/k5lu0u6i1i-using-shell-scripts">Shell Script</a> step that echoes <code>hello</code>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1636576537218/clean-shot-2021-11-10-at-12-35-23-2-x.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Next, we&#39;ll create a policy that requires any Pipeline with an Approval <u>stage</u> to also contain an Approval <u>step</u> in that stage.</p><h3>Step 2: Create and Test a Policy</h3><p>In this step, we&#39;ll quickly review a Rego policy, add the policy in Harness, and then test our Pipeline using the policy.</p><h4>Review: Rego Policies</h4><p>Harness uses the <a href="https://www.openpolicyagent.org/docs/latest/policy-language/">Rego policy language</a> for defining rules that are evaluated by the OPA engine. Basically, you use Rego to answer queries such as &#34;does the Pipeline have an Approval step?&#34; and so on.</p><p>Your Harness Pipelines and entities might be created using the Harness UI or YAML, but your Rego policies will validate the JSON of your Pipelines or other entities.</p><p>Let&#39;s look at a simple example:</p><pre class="hljs json">package pipeline<br/><br/># Deny pipelines that don&#39;t have an approval step<br/># NOTE: Try removing the HarnessApproval step from your input to see the policy fail<br/>deny[msg] {<br/>	# Find all stages that are Deployments ...<br/>	input.pipeline.stages[i].stage.type == &#34;Approval&#34;<br/><br/>	# ... that are not in the set of stages with HarnessApproval steps<br/>	not stages_with_approval[i]<br/><br/>	# Show a human-friendly error message<br/>	msg := sprintf(&#34;deployment stage &#39;%s&#39; does not have a HarnessApproval step&#34;, [input.pipeline.stages[i].stage.name])<br/>}<br/><br/># Find the set of stages that contain a HarnessApproval step<br/>stages_with_approval[i] {<br/>	input.pipeline.stages[i].stage.spec.execution.steps[_].step.type == &#34;HarnessApproval&#34;<br/>}</pre><p></p><p>Basically, this policy checks whether a Pipeline has an Approval stage containing Approval steps. If the Pipeline does not, then the policy <code>deny</code> is enforced.</p><p>The Pipeline fails the policy if:</p><ul><li><code>deny</code> is true.</li><li><code>deny</code> is a non-empty string.</li><li><code>deny</code> is a non-empty array of strings.</li></ul><p>The Pipeline passes the policy if:</p><ul><li><code>deny</code> is undefined.</li><li><code>deny</code> is false.</li><li><code>deny</code> is an empty string.</li><li><code>deny</code> is an empty array of strings.</li></ul><p>You also must consider severity, but that is discussed later.</p><h4>Create the Policy</h4><p>In the Harness Project, in <strong>Project Setup</strong>, click <strong>Policies</strong>.</p><p>Click <strong>Policies</strong>, and then click <strong>New Policy</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651786458656/clean-shot-2022-05-05-at-14-33-56-2-x.png"/></figure><p>Name the new policy <strong>Quickstart</strong>, and click <strong>Apply</strong>. The policy editor appears.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1634844532487/clean-shot-2021-10-21-at-12-28-33.png"/></figure><p>In <strong>Library</strong>, in <strong>Sample Policies</strong>, click <strong>Pipeline - Approval</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651786530661/clean-shot-2022-05-05-at-14-35-16-2-x.png"/></figure><p>The policy appears:</p><pre>package pipeline<br/><br/># Deny pipelines that don&#39;t have an approval step<br/># NOTE: Try removing the HarnessApproval step from your input to see the policy fail<br/>deny[msg] {<br/>	# Find all stages that are Deployments ...<br/>	input.pipeline.stages[i].stage.type == &#34;Deployment&#34;<br/><br/>	# ... that are not in the set of stages with HarnessApproval steps<br/>	not stages_with_approval[i]<br/><br/>	# Show a human-friendly error message<br/>	msg := sprintf(&#34;deployment stage &#39;%s&#39; does not have a HarnessApproval step&#34;, [input.pipeline.stages[i].stage.name])<br/>}<br/><br/># Find the set of stages that contain a HarnessApproval step<br/>stages_with_approval[i] {<br/>	input.pipeline.stages[i].stage.spec.execution.steps[_].step.type == &#34;HarnessApproval&#34;<br/>}</pre><p></p><p>Click <strong>Use this Sample</strong>.</p><p>The policy is selected and sample input is provided.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651786627732/clean-shot-2022-05-05-at-14-36-58-2-x.png"/></figure><p>Let&#39;s edit this policy to test the Pipeline we created.</p><p>The Pipeline uses an Approval stage, not a Deployment stage, so we need to change the policy.</p><p>On line 7 and 13, replace <code>Deployment</code> with <code>Approval</code>.</p><pre>...<br/>	input.pipeline.stages[i].stage.type == &#34;Approval&#34;<br/>...<br/>	msg := sprintf(&#34;Approval stage &#39;%s&#39; does not have a HarnessApproval step&#34;, [input.pipeline.stages[i].stage.name])</pre><p></p><p>Now we can test the policy using our Pipeline.</p><h4>Test the Policy against you Pipeline</h4><p>In <strong>Input</strong>, delete the sample and paste the YAML for the Pipeline we created. You can copy it from earlier in this doc.</p><p>Since <strong>Input</strong> only uses JSON and we pasted in YAML, you will see an error like <code>Unexpected token p in JSON at line 1</code>.</p><p>Click the format button (&lt;/&gt;) to convert the YAML to JSON.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651859945873/clean-shot-2022-05-06-at-10-58-51.png"/></figure><p></p><div class="note-callout">Harness Pipelines can be created in YAML, but Rego evaluates JSON.</div><p>In the JSON, you can see the Fully Qualified Names (FQNs) of the labels your Rego references.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1636584242294/clean-shot-2021-11-10-at-14-43-36-2-x.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><div class="note-callout">The input payload contains user <code>metadata</code> for the user that initiated the event. Metadata includes roles, groups, etc, and is added to every evaluation automatically. This can be used for policies where you want to evaluate users.</div><p>Click <strong>Test</strong>.</p><p>In <strong>Output</strong>, you can see that the Pipeline failed the policy because it is missing an Approval step.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651860058244/clean-shot-2022-05-06-at-11-00-48.png"/></figure><p>We&#39;ll fix the Pipeline later in this quickstart. The important thing is we know it works.</p><p>Click <strong>Save</strong>.</p><p>We tested the policy, but we still need to enforce it. To enforce a policy, you add it to a Policy Set.</p><h3>Step 3: Create a Policy Set</h3><p>OPA evaluates rules using Policy Sets. Policy Sets are groups of related policies. A single policy can be a member of many Policy Sets.</p><p>For this quickstart, we&#39;ll just create a Policy Set using our single policy.</p><p>Click <strong>Policy Sets</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1634856120356/clean-shot-2021-10-21-at-15-41-49-2-x.png"/></figure><p>In <strong>Policy Sets</strong>, click <strong>New Policy Set</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1636584541766/clean-shot-2021-11-10-at-14-48-45-2-x.png"/></figure><p>Name the new Policy Set <strong>Quickstart</strong>.</p><p>Now we can select the Harness entity for the Policy Set, and the event that triggers evaluation.</p><p>In <strong>Entity Type that this policy set applies to</strong>, select <strong>Pipeline</strong>.</p><p>In <strong>On what event should the policy set be evaluated</strong>, select <strong>On Run</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1634856500415/clean-shot-2021-10-21-at-15-48-07-2-x.png"/></figure><p>Click <strong>Continue</strong>.</p><p>Now we can select the policies for this Policy Set.</p><p>In <strong>Policy to Evaluate</strong>, click <strong>Add Policy</strong>.</p><p>In <strong>Select</strong> <strong>Policy</strong>, click <strong>Project Quickstart</strong>, and select the <strong>Quickstart</strong> policy you created.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651860830490/clean-shot-2022-05-06-at-11-13-42.png"/></figure><p>Be sure to select <strong>Error and exit</strong>.</p><p>Click <strong>Apply</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651860889351/clean-shot-2022-05-06-at-11-14-42.png"/></figure><p>Click <strong>Finish</strong>. The new Policy Set is listed.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651860924590/clean-shot-2022-05-06-at-11-15-15.png"/></figure><p>This Policy Set will be evaluated on every Pipeline.</p><div class="warning-callout">When you create Policy Sets they are applied to all matching entities (for example, Pipelines). Be careful that you do not create a Policy Set that might impact existing Pipelines <u>unintentionally</u>.</div><h3>Step 4: Evaluate a Pipeline on Run</h3><p>Now that we have a Policy Set, let&#39;s see it in action.</p><p>Click <strong>Pipelines</strong> to navigate back to the Pipeline you created earlier. Remember, it does not have an <u>Approval</u> step and it will fail the Policy Set evaluation.</p><p>Click <strong>Run</strong>, and then <strong>Run Pipeline</strong>.</p><p>The Policy Set is evaluated and the Pipeline execution fails.</p><p>In the Pipeline execution, click <strong>Policy Evaluations</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651861054462/clean-shot-2022-05-06-at-11-17-20.png"/></figure><p>You can see the Policy Set that failed the Pipeline, and the reason for the failure. Clicking the Policy Set name will take you to the Policy Set.</p><p>Let&#39;s fix the Pipeline and try again.</p><h3>Step 5: Conform a Failed Pipeline and Rerun</h3><p>Open the Pipeline in Pipeline Studio. Click the Pipeline name in the breadcrumbs and click <strong>Pipeline Studio</strong>.</p><p>Switch to the YAML editor and click <strong>Edit YAML</strong>.</p><p>Add a new line before the <code>- step:</code> for the <strong>Shell Script</strong> step.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1636587263885/clean-shot-2021-11-10-at-15-33-52-2-x.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>On the new line, paste the YAML for a <a href="/article/43pzzhrcbv-using-harness-approval-steps-in-cd-stages">Manual Approval</a> step:</p><pre>                          - step:<br/>                                type: HarnessApproval<br/>                                name: Approval<br/>                                identifier: Approval<br/>                                spec:<br/>                                    approvalMessage: Please review the following information and approve the pipeline progression<br/>                                    includePipelineExecutionHistory: true<br/>                                    approvers:<br/>                                        userGroups:<br/>                                            - account.admin<br/>                                        minimumCount: 1<br/>                                        disallowPipelineExecutor: false<br/>                                    approverInputs: []<br/>                                timeout: 1d</pre><p></p><div class="note-callout">Note the <code>userGroups</code> setting. This is the Harness User Group that is allowed to approve this step. You can edit this in the Visual editor if you want to add your User Group(s), but it&#39;s not necessary for this quickstart.</div><p>Click <strong>Save</strong>.</p><p>Click <strong>Run</strong>, and then <strong>Run Pipeline</strong>.</p><p>The Pipeline runs. It passed the Policy Set successfully.</p><p>The new Approval step appears during execution.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651861423463/clean-shot-2022-05-06-at-11-23-29.png"/></figure><p>Click <strong>Approve</strong> to finish running the Pipeline.</p><h3>Step 6: Review Policy Evaluations</h3><p>You can review policy evaluations in a few places.</p><h4>Review in Pipeline Execution</h4><p>On the Pipeline deployment summary (<strong>Execution History</strong>), click <strong>Policy Evaluations</strong>.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1634859288101/clean-shot-2021-10-21-at-16-34-28-2-x.png"/></figure><p>You can see Policy Set evaluations listed.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jws2znftay/1651861476936/clean-shot-2022-05-06-at-11-24-27.png"/></figure><h4>Review in Governance Overview</h4><p>Click <strong>Project Setup</strong>, and then click <strong>Policies</strong>.</p><p>Click <strong>Evaluations</strong>.</p><p>You can see the evaluation you just performed.</p><h3>Summary</h3><p>In this tutorial, you:</p><ol><li>Created and tested a Rego policy in Harness.</li><li>Created a Policy Set from your new policy.</li><li>Ran a Pipeline that failed a policy evaluation.</li><li>Ran a Pipeline that passed a policy evaluation.</li><li>Reviewed policy evaluations for a Pipeline.</li></ol><h3>See Also</h3><ul><li><a href="/article/xy8zsn8fa3-add-a-governance-policy-step-to-a-pipeline">Add a Policy Engine Step to a Pipeline</a></li><li><a href="/article/1d3lmhv4jl-harness-governance-overview">Harness Policy As Code Overview</a></li><li><a href="/article/4vx27jqwv2-harness-policy-engine">Harness Policy As Code Overview for Feature Flags</a></li></ul><p></p>