<div class="note-callout">Currently, this feature is behind the Feature Flag <code>OPA_PIPELINE_GOVERNANCE</code>. Contact <a href="mailto:support@harness.io" target="_blank">Harness Support</a> to enable the feature.</div><p>This topic provides an overview of how Harness Policy As Code implemented governance.</p><div class="note-callout">Looking for the quickstart? See <a href="/article/jws2znftay-harness-governance-quickstart">Harness Policy As Code Quickstart</a>.</div><h3>Before You Begin</h3><p>Before learning about Harness Policy As Code, you should have an understanding of the following:</p><ul><li><a href="/article/hv2758ro4e-learn-harness-key-concepts">Learn Harness&#39; Key Concepts</a></li></ul><h3>How does Harness use OPA?</h3><p>Harness Policy As Code uses <a href="https://www.openpolicyagent.org/" target="_blank">Open Policy Agent (OPA)</a> as the central service to store and enforce policies for the different entities and processes across the Harness platform.</p><p>You can centrally define and store policies and then select where (which entities) and when (which events) they will be applied.</p><p>Currently, you can define and store policies directly in the OPA service in Harness.</p><p>Soon, you will be able to use remote Git or other repos (e.g. OCI-compatible registries) to define and store the policies used in Harness.</p><h3>Governance Examples with Harness OPA</h3><h4>Example A: Pipeline &gt; On Save</h4><blockquote>When a Pipeline is saved, there needs to be an Approval step before deploying to a production environment.</blockquote><p></p><ul><li><strong>Success:</strong> you configure an Approval Step in the Pipeline and then proceed to configure a prod stage. When you save the Pipeline, the policy rule is evaluated and returns <code>success</code>.</li><li><strong>Warning:</strong> a warning message appears: <code>You need an Approval step. If you save the Pipeline and deploy, Harness will throw an error.</code></li><li><strong>Failure:</strong> you configure a Pipeline with a Deploy stage that deploys to a prod environment without an Approval stage before it. When you save the Pipeline, Harness throws an error message indicating the rule was enforced and the Pipeline fails validation.</li></ul><h4>Example B: Pipeline &gt; On Run</h4><blockquote>On deployment, I need my pod CPU and memory to be pre-defined.</blockquote><p></p><ul><li><strong>Success:</strong> you deploy the Pipeline and during the dry run the pod CPU and memory have been defined and populated in the deployment manifest. As a result, the dry run progresses. Harness indicates that the rule was evaluated and the action was valid.</li><li><strong>Failure:</strong> pod CPU and memory were not defined in the deployment manifest. As a result, the dry run fails. Harness indicates that a rule was enforced and the deployment is prevented.</li></ul><h3>Harness OPA Server</h3><p>The Harness OPA server is an OPA server managed by Harness.</p><p>In Harness, you add Rego policies to a Policy Set and select the Harness entities (e.g. Pipelines) for evaluation. At that point, the policies are configured on the Harness OPA Server via a Kubernetes ConfigMap.</p><p>When certain events happen (e.g. saving or running a Pipeline), Harness reaches out to the Harness OPA server to evaluate the action using the Policy Set.</p><h3>Harness Policies</h3><p>A policy is a single rule. Policies are written as code in the OPA Rego policy language.</p><p>A policy itself is just the rule and it&#39;s not enforced anywhere. When a policy is added to a Policy Set, it is associated with the entity event on which it will be enforced (On Save, On Run, etc).</p><p>Policies are written against an input payload. The input payload is the JSON of the entity that the policy is being enforced against (Pipeline, Feature Flag, etc).</p><p>Policies are saved within the hierarchy in the Harness platform: Account &gt; Organizations &gt; Projects.</p><p>Policy scope is determined by the whether the policy is created at the account, Organization, or Project level. A policy added at the account level can be applied to all entities in the Orgs and Projects in the account. A policy added at the Project level can be applied to entities in that Project alone.</p><p>Polices can be tested individually, but they are not applied individually. To enforce a policy, it must be in a Policy Set.</p><p>Policies are written in the OPA policy language, Rego.</p><p><strong>New to OPA Policy Authoring?</strong> Use the following resources to learn Rego:</p><ul><li><strong>Highly recommend:</strong> Free online course on Rego from Styra founder and OPA co-creator Tim Hendricks: <a href="https://academy.styra.com/courses/opa-rego" target="_blank">OPA Policy Authoring</a>.</li><li>See <a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank">Policy Language</a> from OPA. The <a href="https://dboles-opa-docs.netlify.app/docs/v0.10.7/rego-cheatsheet/" target="_blank">Rego Cheatsheet</a> is also helpful to have on hand.</li></ul><h4>Policy Editor</h4><p>Harness policies are written and tested using the built-in policy editor.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1d3lmhv4jl/1651783545046/clean-shot-2022-05-05-at-13-45-29-2-x.png"/></figure><p>For an example of how to use the policy editor, see <a href="/article/jws2znftay-harness-governance-quickstart">Harness Policy As Code Quickstart</a>.</p><h4>Policy Library</h4><p>The Policy Editor includes a library of policies that cover many common governance scenarios.</p><p>Sample policies are also useful references while writing your policy. When you import an example, a sample payload is also loaded for testing the policy.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1d3lmhv4jl/1651783632162/clean-shot-2022-05-05-at-13-46-58-2-x.png"/></figure><p>You can simply use the library policies to quickly generate the policy you want to create.</p><h4>Select Input</h4><p>In the Policy Editor, you can select sample entities to test your policy on. For example, Pipelines.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1d3lmhv4jl/1651783803656/clean-shot-2022-05-05-at-13-49-30-2-x.png"/></figure><h4>Testing Terminal</h4><p>The Testing Terminal lets you test the policy against real inputs while you&#39;re developing it. You can select input payloads from previous evaluations to test what will happen when your policy is evaluated.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1d3lmhv4jl/1651783873627/clean-shot-2022-05-05-at-13-50-49-2-x.png"/></figure><h4>Policy Input Payload User Metadata</h4><p>The input payload contains user metadata for the user that initiated the event. Metadata includes roles, groups, etc, and is added to every evaluation automatically. For example:</p><pre>{<br/>  &#34;action&#34;: null,<br/>  &#34;date&#34;: &#34;2022-05-05T20:41:23.538+0000&#34;,<br/>  &#34;metadata&#34;: {<br/>    &#34;action&#34;: &#34;onsave&#34;,<br/>    &#34;roleAssignmentMetadata&#34;: [<br/>      {<br/>        &#34;identifier&#34;: &#34;role_assignment_NsFQM43RqnfQJmtPWx7s&#34;,<br/>        &#34;managedRole&#34;: true,<br/>        &#34;managedRoleAssignment&#34;: true,<br/>        &#34;resourceGroupIdentifier&#34;: &#34;_all_project_level_resources&#34;,<br/>        &#34;resourceGroupName&#34;: &#34;All Project Level Resources&#34;,<br/>        &#34;roleIdentifier&#34;: &#34;_project_viewer&#34;,<br/>        &#34;roleName&#34;: &#34;Project Viewer&#34;<br/>      }<br/>    ],<br/>    &#34;timestamp&#34;: 1651783283,<br/>    &#34;type&#34;: &#34;pipeline&#34;,<br/>    &#34;user&#34;: {<br/>      &#34;disabled&#34;: false,<br/>      &#34;email&#34;: &#34;john.doe@harness.io&#34;,<br/>      &#34;externallyManaged&#34;: false,<br/>      &#34;locked&#34;: false,<br/>      &#34;name&#34;: &#34;john.doe@harness.io&#34;,<br/>      &#34;uuid&#34;: &#34;U6h_smb9QTGimsYfNdv6VA&#34;<br/>    },<br/>    &#34;userGroups&#34;: []<br/>  },<br/>...</pre><p></p><p>This enables enforcing policies with advanced and attribute-based access control use cases.</p><p>See <a href="/article/vz5cq0nfg2-rbac-in-harness">Harness Role-Based Access Control Overview</a>.</p><h3>Harness Policy Set</h3><p>You define a set of rules (policies) that are evaluated together in a Policy Set.</p><p>Policies are only enforced once they are added to a Policy Set. In the Policy Set, policies are grouped and associated with a Harness entity and the event that will initiate evaluation.</p><p>Each policy in the set is also assigned a <u>severity</u> that determines what will happen if the policy evaluation fails (Error and Exit, Warn and Continue).</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1d3lmhv4jl/1651784482121/clean-shot-2022-05-05-at-14-00-45-2-x.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure><p>Policy Sets are stored to the Harness OPA server for a given entity type and event in Harness. The entity (Pipelines, etc) and event (On Save, On Run, etc) associated with a Policy Set determine when the policies in that set are evaluated.</p><p>Policy Sets are saved at the Harness account, Organization, or Project level, and where they are saved determines the scope of the Policy Set.</p><p>A Policy Set at the account level applies to all entities in the Orgs and Projects in the account. A Policy Set at the Project level only applies to entities in that Project alone.</p><h3>Entities and Events</h3><p>When you create a policy, you identify the Harness entities were the policy is applied.</p><p>For example, here&#39;s a policy that applies the <a href="/article/43pzzhrcbv-using-harness-approval-steps-in-cd-stages">Harness Approval</a> steps:</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1d3lmhv4jl/1644436710230/clean-shot-2022-02-09-at-11-57-25.png"/></figure><p>Currently, governance can be applied to the following Harness entities and events.</p><div class="note-callout">Soon, policies can be applied to more entities, such as Connectors, Services, Environments, Cloud Cost Management, Infrastructure Provisioners.</div><h4>Pipelines</h4><p>Policies are evaluated against Harness Pipelines. The input payload is an expanded version of the Pipeline YAML, including expanded references and parameters at runtime. </p><p>Policy Sets can be configured to be enforced automatically on these Pipeline events:</p><ul><li><strong>On Save:</strong> Policies are evaluated when the Pipeline is saved.</li><li><strong>On Run:</strong> Policy sets are evaluated after the preflight checks.</li></ul><p>Severities:</p><ul><li><strong>On error (Error and Exit):</strong> a message is shown and the action does not complete.</li><li><strong>On warning (Warn and Continue):</strong> a message is shown and the action is completed.</li></ul><div class="note-callout">The Policy step in a Pipeline also enables evaluating policies during Pipeline execution. See <a href="/article/xy8zsn8fa3-add-a-governance-policy-step-to-a-pipeline">Add a Governance Policy Step to a Pipeline</a>.</div><h4>Feature Flags</h4><p>Policies are evaluated against Harness <a href="/article/7n9433hkc0-cf-feature-flag-overview">Feature Flags</a>.  </p><p>Policy Sets can be configured to evaluate policies on these Feature Flag events:</p><ul><li>Feature Flag is saved.</li><li>Flag is created.</li><li>Flag is toggled on or off.</li></ul><p>See <a href="/article/vb6ilyz194-using-harness-policy-engine-for-feature-flags">Use Harness Policy As Code for Feature Flags</a>.</p><h4>Custom</h4><p>You can define a policy with the entity type <u>Custom</u>.</p><p>The Custom entity type provides flexibility to enforce policy evaluations against any input payload during Pipeline execution. This is done using the Policy step. See <a href="/article/xy8zsn8fa3-add-a-governance-policy-step-to-a-pipeline">Add a Governance Policy Step to a Pipeline</a>.</p><p>Custom entity types are open ended. There is no pre-set JSON schema that is used for Custom policies. The payload that the policy is evaluated against is determined by you (defined in the Policy step).</p><h3>Policy and Policy Set Hierarchy and Inheritance</h3><p>Policies and Policy Sets are saved at the Harness Account, Organization, or Project level in the Harness. Where the Policy or Policy set is saved determines its scope. </p><ul><li>Policies saved at the Account level can be added to Policy Sets in the Account, or Orgs and Projects within that Account.</li><li>A policy at the Org level can only be added to Policy Sets in that Org and its Project.</li><li>A policy at the Project level can only be added to Policy Sets in that Project.</li></ul><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1d3lmhv4jl/1651785234609/clean-shot-2022-05-05-at-14-13-40-2-x.png"/></figure><p></p><h3>See Also</h3><ul><li><a href="/article/jws2znftay-harness-governance-quickstart">Harness Policy As Code Quickstart</a></li><li><a href="/article/xy8zsn8fa3-add-a-governance-policy-step-to-a-pipeline">Add a Policy Step to a Pipeline</a></li><li><a href="/article/4vx27jqwv2-harness-policy-engine">Harness Policy As Code Overview for Feature Flags</a></li></ul><p></p>