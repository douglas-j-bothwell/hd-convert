<p>You can connect Harness with your Kubernetes clusters using a Kubernetes Cluster Connector or <a href="/article/cii3t8ra3v-connect-to-google-cloud-platform-gcp">Google Cloud Platform (GCP) Connector</a>. This topic explains how to set up the Kubernetes Cluster Connector.</p><p>Once connected, you can use Kubernetes and Harness for provisioning infrastructure, running a CI build farm, and deploying microservices and other workloads to clusters.</p><div class="note-callout"><strong>What roles should my Kubernetes account have?</strong> What roles and policies needed by the account used in the Connector depend on what operations you are using Harness for in the cluster. For a list of roles and policies, see <a href="/article/sjjik49xww-kubernetes-cluster-connector-settings-reference">Kubernetes Cluster Connector Settings Reference</a>.</div><h3>Before You Begin</h3><ul><li><a href="/article/hv2758ro4e-learn-harness-key-concepts">Learn Harness&#39; Key Concepts</a></li><li><a href="/article/knunou9j30-kubernetes-cd-quickstart">Kubernetes CD Quickstart</a></li></ul><h3>Visual Summary</h3><p>Here&#39;s a quick video that shows you how to add a Kubernetes Cluster Connector and install the Kubernetes Delegate in the target cluster at the same time:</p><p></p><div class="hd--embed" data-provider="YouTube" data-thumbnail="https://i.ytimg.com/vi/wUC23lmqfnY/hqdefault.jpg"><iframe width=" 200" height="150" src="https://www.youtube.com/embed/wUC23lmqfnY?feature=oembed" frameborder="0" allowfullscreen="allowfullscreen"></iframe></div><p></p><h3>Review: Roles and Policies for the Connector</h3><p>The IAM roles and policies needed by the account used in the Connector depend on what operations you are using with Harness and what operations you want Harness to perform in the cluster.</p><p>You can use different methods for authenticating with the Kubernetes cluster, but all of them use a Kubernetes Role.</p><p>The Role used must have either the <code>cluster-admin</code> permission in the target cluster or admin permissions in the target namespace.</p><p>For a detailed list of roles and policies, see <a href="/article/sjjik49xww-kubernetes-cluster-connector-settings-reference">Kubernetes Cluster Connector Settings Reference</a>.</p><p>In general, the following permissions are require:</p><ul><li><strong>Deployments:</strong> A Kubernetes service account with permission to create entities in the target namespace is required. The set of permissions should include <code>list</code>, <code>get</code>, <code>create</code>, <code>watch</code> (to fetch the pod events), and <code>delete</code> permissions for each of the entity types Harness uses. In general, cluster admin permission or namespace admin permission is sufficient.</li><li><strong>Builds:</strong> A Kubernetes service account with CRUD permissions on Secret, Service, Pod, and PersistentVolumeClaim (PVC).</li></ul><p>If you don’t want to use <code>resources: [“*”]</code> for the Role, you can list out the resources you want to grant. Harness needs <code>configMap</code>, <code>secret</code>, <code>event</code>, <code>deployment</code>, and <code>pod</code> at a minimum for deployments, as stated above. Beyond that, it depends on the resources you are deploying via Harness.</p><p>If you don’t want to use <code>verbs: [“*”]</code> for the Role, you can list out all of the verbs (<code>create</code>, <code>delete</code>, <code>get</code>, <code>list</code>, <code>patch</code>, <code>update</code>, <code>watch</code>).</p><p>The YAML provided for the Harness Delegate defaults to <code>cluster-admin</code> because that ensures anything could be applied. Any restriction must take into account the actual manifests to be deployed.</p><h3>Review: Kubernetes Cluster Connector for EKS</h3><p>If you want to connect Harness to Elastic Kubernetes Service (Amazon EKS), use the platform-agnostic Kubernetes Cluster Connector discussed here. Do not use an <a href="/article/98ezfwox9u-add-aws-connector">AWS Connector</a>.</p><h3>Review: AKS Clusters Must have Local Accounts Enabled</h3><p>To use an AKS cluster for deployment, the AKS cluster must have local accounts enabled (AKS property <code>disableLocalAccounts=false</code>).</p><p></p><h3>Review: Switching IAM Policies</h3><p>If the IAM role used by your Connector does not have the policies required, you can modify or switch the role.</p><p>You simply change the role assigned to the cluster or the Harness Delegate your Connector is using.</p><p>When you switch or modify the IAM role, it might take up to 5 minutes to take effect.</p><h3>Supported Platforms and Technologies</h3><p>For a list of the platforms and technologies supported by Harness, see <a href="/article/1e536z41av">Supported Platforms and Technologies</a>.</p><h3>Step 1: Add a Kubernetes Cluster Connector</h3><p>Open a Harness Project.</p><p>In <strong>Project Setup</strong>, click <strong>Connectors</strong>.</p><p>Click <strong>New Connector</strong>, and click <strong>Kubernetes Cluster</strong>. The Kubernetes Cluster Connector settings appear.</p><p></p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/1gaud2efd4/1632172340471/clean-shot-2021-09-20-at-14-12-11.png"/></figure><p>In <strong>Name</strong>, enter a name for this connector.</p><p>Harness automatically creates the corresponding Id (<a href="/article/li0my8tcz3-entity-identifier-reference">entity identifier</a>).</p><p>Click <strong>Continue</strong>.</p><h3>Step 2: Enter Credentials</h3><p>Choose the method for Harness to use when connecting to the cluster.</p><p>Select one of the following:</p><ul><li><strong>Specify master URL and credentials</strong>:<ul><li>You provide the Kubernetes master node URL. The easiest method to obtain the master URL is using kubectl: <code>kubectl cluster-info</code>.</li><li>Next, enter the <strong>Service Account Key</strong> or other credentials.</li></ul></li><li><strong>Use the credentials of a specific Harness Delegate</strong>: Select this option to have the Connector inherit the credentials used by the Harness Delegate running in the cluster. You can install a Delegate as part of adding this Connector.</li></ul><p>For details on all of the credential settings, see <a href="/article/sjjik49xww-kubernetes-cluster-connector-settings-reference">Kubernetes Cluster Connector Settings Reference</a>.</p><h4>Obtaining the Service Account Token using kubectl</h4><p>To use a Kubernetes Service Account (SA) and token, you will need to either use an <u>existing</u> SA that has the <code>cluster-admin</code> permission (or namespace <code>admin</code>) or create a new SA and grant it the <code>cluster-admin</code> permission (or namespace <code>admin</code>).</p><p>For example, here&#39;s a manifest that creates a new SA named <code>harness-service-account</code> in the <code>default</code> namespace.</p><pre># harness-service-account.yml<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: harness-service-account<br/>  namespace: default</pre><p></p><p>Next, you apply the SA.</p><pre>kubectl apply -f harness-service-account.yml</pre><p></p><p>Next, grant the SA the <code>cluster-admin</code> permission.</p><pre># harness-clusterrolebinding.yml<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: harness-admin<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: cluster-admin<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: harness-service-account<br/>  namespace: default</pre><p></p><p>Next, apply the ClusterRoleBinding.</p><pre>kubectl apply -f harness-clusterrolebinding.yml</pre><p></p><p>Once you have the SA added, you can gets its token using the following commands.</p><pre>SERVICE_ACCOUNT_NAME={SA name}<br/><br/>NAMESPACE={target namespace}<br/><br/>SECRET_NAME=$(kubectl get sa &#34;${SERVICE_ACCOUNT_NAME}&#34; --namespace &#34;${NAMESPACE}&#34; -o=jsonpath=&#39;{.secrets[].name}&#39;)<br/><br/>TOKEN=$(kubectl get secret &#34;${SECRET_NAME}&#34; --namespace &#34;${NAMESPACE}&#34; -o=jsonpath=&#39;{.data.token}&#39; | base64 -d)<br/><br/>echo $TOKEN</pre><p></p><p>The <code>| base64 -d</code> piping decodes the token. You can now enter it into the Connector.</p><h3>Step 3: Set Up Delegates</h3><p>Regardless of which authentication method you selected, you select Harness Delegates to perform authentication for this Connector.</p><p>If you do not have Harness Delegates, click <strong>Install New Delegate</strong> to add one to the cluster, or any cluster in your environment that can connect to the cluster.</p><p>Harness uses Kubernetes Cluster Connectors at Pipeline runtime to authenticate and perform operations with Kubernetes. Authentications and operations are performed by Harness Delegates.</p><p>You can select <strong>Any Available Harness Delegate</strong> and Harness will select the Delegate. For a description of how Harness picks Delegates, see <a href="/article/2k7lnc7lvl-delegates-overview">Delegates Overview</a>.</p><p>You can use Delegate Tags to select one or more Delegates. For details on Delegate Tags, see <a href="/article/nnuf8yv13o-select-delegates-with-selectors">Select Delegates with Tags</a>.</p><p>If you need to install a Delegate, see <a href="/article/re8kk0ex4k-delegate-installation-overview">Delegate Installation Overview</a> or the <a href="#visual_summary">Visual Summary</a> above.</p><p>Click <strong>Save and Continue</strong>.</p><p>Harness tests the credentials you provided using the Delegates you selected.</p><p></p><p></p>