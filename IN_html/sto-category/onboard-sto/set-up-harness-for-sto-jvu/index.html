<p>This topic describes the steps you need to do to set up STO in your pipeline.</p><p>The entire setup workflow should take about 30 minutes.</p><h3 id="before-you-begin">STO Requirements</h3><p>You will meet all these requirements after you do the <a href="#sto-setup-procedures">STO Setup Procedures</a> described below.</p><h4>External Requirements</h4><p>Before you start setting up Harness, make sure you have the following:</p><ul><li>Git account and Personal Access Token — If you are scanning a repo, you need an account and access token with the Git provider.</li><li>Docker Hub account — STO uses Docker-in-Docker to run scans. The Pipeline needs to pull the <strong>docker:dind</strong> image from Docker Hub. </li><li><a href="#harness-delegate-requirements" target="_blank">Kubernetes cluster</a> — Running builds in your infrastructure, rather than in a vendor&#39;s cloud, has significant benefits. Vendor clouds often experience outages that can result in backlogs and delayed builds. You can build software and run tests, repeatedly and automatically, on a scalable platform with no outages or backlogs.</li></ul><h4>Harness User Requirements</h4><ul><li>To set up STO, you need Administrative privileges at the Account level (Account Admin role). It is not enough to have Administrative privileges at the Project level (Project Admin role).</li><li>Developers need a Security Testing Developer role to run tests and view results.</li><li>Security Operations staff need a Security Testing SecOps role to run tests, view results, and approve security exemptions.</li></ul><h4>Harness Account Requirements</h4><p>Harness recommends you create the following resources at the Account level. This enables you to use them across all projects and pipelines in the account.</p><ul><li>Harness delegate — Required to run builds in your Kubernetes infrastructure.</li><li>Secret for Git access credentials — Required to set up a codebase connector.</li><li>Git codebase connector — Required if you want to scan a codebase in your pipeline.</li><li>Docker Hub connector — Required to download images needed to run the pipeline.</li></ul><h4>Harness Pipeline Requirements</h4><ul><li>To run security scans, the pipeline requires a Security Stage with a Docker-in-Docker service dependency.</li></ul><h3 id="sto-setup-procedures">STO Setup Procedures</h3><p>The following sections describe the workflow for setting up STO. Once you complete this workflow, you will have the build infrastructure and connectors required to build a pipeline and run security scans. You will also have an STO-enabled pipeline that you can clone and configure based on your security requirements.</p><ol><li><a href="https://docs.harness.io/article/rlbw5luj4h#install-the-delegateadd-security-testing-roles">Add Security Testing roles</a></li><li><a href="https://docs.harness.io/article/rlbw5luj4h#install-the-delegateinstall-the-harness-delegate" target="_blank">Install the Harness Delegate</a></li><li><a href="#create-a-dockerhub-connector" target="_blank">Create a Docker Hub connector</a></li><li><a href="https://docs.harness.io/article/rlbw5luj4h#install-the-delegate#create-a-secret" target="_blank">Create a Secret for your Git Access Credentials</a></li><li><a href="#https://docs.harness.io/article/rlbw5luj4h#install-the-delegatecreate-a-codebase-connector" target="_blank">Create a Codebase Connector</a></li><li><a href="https://docs.harness.io/article/rlbw5luj4h#install-the-delegate#create-an-sto-pipeline" target="_blank">Create an STO pipeline</a></li></ol><h3 id="add-security-testing-roles">Add Security Testing roles</h3><p>Harness includes two RBAC roles specifically for STO users:</p><ul><li><strong>Developer</strong> role — Permissions needed for developer workflows. These workflows are described in <a href="https://docs.harness.io/article/yvy4pmt8bw" target="_blank">Tutorial 1</a>.</li><li><strong>SecOps</strong> role — Permissions needed for Security Operations staff. This role includes all Developer permissions and also allows users to approve security exemptions. These workflows are covered in <a href="https://docs.harness.io/article/zy4h4ch6dh">Tutorial 2</a>.</li></ul><div class="note-callout">You need Administrative privileges at the Account level (Account Admin role) to assign these roles.</div><details><summary>Assign Security Testing Roles: Default Workflow</summary><div><ol><li>Click <strong>Account Settings</strong> (left menu) &gt; <strong>Access Control</strong>.</li><li>In the <strong>Users</strong> table, click the user profile.</li><li>Under Role Bindings, click <strong>+Role</strong>.</li><li>Assign the <strong>Security Testing Developer</strong> role or the <strong>Security Testing SecOps</strong> role to the user profile.</li></ol><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/qhgshfw3mg/1658601251263/00-add-secops-role.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></div></details><h3 id="install-the-harness-delegate">Install the Harness Delegate</h3><p>You need a Kubernetes cluster for Harness to use for the Harness Delegate and as the Security Testing Orchestration scanning infrastructure.</p><details><summary>Harness Delegate Requirements</summary><div><ul><li>Number of pods: 3 (two pods for the Harness Delegate, the remaining pod for scanning infrastructure).</li><li>Machine type: 4vCPU.</li><li>Memory: 16GB RAM. The scanning infrastructure and Delegate requirements are low but the remaining memory is for Kubernetes, the Docker container, and other default services.</li><li>Networking: outbound HTTPS for the Harness connection, and to connect to Docker Hub. Allow TCP port 22 for SSH.</li><li>Namespace: when you install the Harness Delegate, it will create the <strong>harness-delegate-ng</strong> namespace. You&#39;ll use the same namespace for the scanning infrastructure.</li><li>A Kubernetes service account with permission to create entities in the target namespace is required. The set of permissions should include <strong>list</strong>, <strong>get</strong>, <strong>create</strong>, and <strong>delete permissions</strong>. In general, the <strong>cluster-admin</strong> role or a namespace <em>admin</em> permission is enough. For more information, go to <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles" target="_blank">User-Facing Roles</a> from Kubernetes.</li></ul><div class="note-callout">Google Kubernetes Engine (GKE) <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-overview">Autopilot</a> is not supported at this time.</div></div></details><p>To set up the build infrastructure, you add a connector to your Kubernetes cluster and install a Harness delegate.</p><details><summary>Install the Delegate: Default Workflow</summary><div><ol><li>Click <strong>Account Settings</strong> &gt; <strong>Account Resources</strong> &gt; <strong>Connector</strong>, then <strong>New Connector</strong>.</li><li>Under Cloud Providers, choose <strong>Kubernetes cluster</strong>.</li><li>Enter the following settings in the wizard.<ol><li>In Overview, Name = <strong>STO delegate</strong></li><li>In Details, click <strong>Use the credentials of a specific Harness Delegate</strong>.<br/>If you already have a Delegate set up in your Harness account, you can use the <strong>Specify master URL and credentials</strong> option.<br/>This workflow assumes you are new to Harness.</li><li>Delegate setup: Click <strong>Install new Delegate</strong>.<br/>If you already have a Delegate set up in your Harness account, you can use it.<br/>This workflow assumes you are new to Harness.</li><li>Delegate type: click <strong>Kubernetes</strong>.</li><li>Kubernetes setup:<br/>You might need to scroll up/down to set all options.<ul><li>Delegate Name = <strong>sto</strong></li><li>Delegate Size =<strong> Small</strong></li><li>What installer do you want to use? <strong>Kubernetes</strong></li><li>Delegate permissions = <strong>Install Delegate with cluster-wide read/write access</strong></li><li>Delegate Configurations = <strong>Primary Configuration</strong></li><li>Delegate Tokens = <strong>default_token</strong></li></ul></li><li>Download the YAML file.<br/><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/jyzxelly59/1664980982387/delegate-setup-download-yaml.png"/></figure></li><li>In a terminal, navigate to the location of the file.</li><li>In the same Terminal, log into your cluster and run the following:<br/><code>kubectl apply -f harness-delegate.yml</code><br/>Once you apply the YAML file, you&#39;ll see an output like this:<pre>% kubectl apply -f harness-delegate.yml<br/>namespace/harness-delegate-ng created<br/>clusterrolebinding.rbac.authorization.k8s.io/harness-delegate-ng-cluster-admin created<br/>secret/sto-proxy created<br/>statefulset.apps/sto created<br/>service/delegate-service created</pre>In the Harness Delegate setup, you will see the Delegate register with Harness. This might take a few minutes.<div class="note-callout">If you encounter errors, ensure your cluster can connect outbound to <strong>app.harness.io</strong>. See <a href="/article/ooelo06uy5-whitelist-harness-domains-and-ips">Allowlist Harness Domains and IPs</a>.</div></li></ol></li><li>Click <strong>Done</strong> to close the delegate wizard and return to the connector setup.</li><li>In <strong>Delegates Setup</strong>, select <strong>Only use Delegates with all of the following tags</strong>, select the new delegate, and then click <strong>Save and Continue</strong>.</li><li>In <strong>Connection Test</strong>, wait for &#34;Verification successful&#34; and then click <strong>Finish</strong>.</li></ol></div></details><h3 id="create-a-dockerhub-connector">Create secrets for your Git and DockerHub access credentials</h3><p>Harness includes a built-in Secrets Manager that enables you to store encrypted secrets, such as access keys, and use them in your Harness account. Secrets are always stored in encrypted form and are not accessible by Harness. Only the delegate, which runs in your infrastructure, can access them.</p><p>In this step, you&#39;ll create a secret for your GitHub and DockerHub access tokens. Then you&#39;ll use the secret when you set up the connector to your GitHub repo.</p><details><summary>Create a Secret for your GitHub Access Token: Default Workflow</summary><div><ol><li>In your Github account, a <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank">GitHub Personal Access Token</a> that has the following scopes:<ul><li>repo</li><li>admin:repo_hook</li><li>user</li></ul></li><li>Go to <strong>Account Settings</strong> &gt; <strong>Account Resources</strong> and click <strong>Secrets</strong>.</li><li>Click <strong>New Secret</strong> &gt; <strong>Text</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661218671833/github-path-new-secret-text-01.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li><li>Specify the <strong>Secret Name</strong> and <strong>Secret Value</strong> (your GitHub access token). It&#39;s good practice to indicate the scope of the secret in the name, as shown in this example.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661218544429/github-path-new-secret-text-02.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li><li>Repeat this procedure to create a secret for your <a href="https://docs.docker.com/docker-hub/access-tokens/" target="_blank">DockerHub access token</a>.</li></ol></div></details><h3 id="create-a-codebase-connector">Create a Docker Hub connector</h3><p>A Docker Hub connector is required to run a Docker-in-Docker service as described in <a href="#set-up-security-tests-stage" target="_blank">Set up the Security Tests stage</a> below. It is also required for any pipeline that scans or uploads a built image.</p><details><summary>Create a Docker Hub Connector: Default Workflow</summary><div><ol><li>If you want to upload images to your Docker Hub repo, you will need an access token. To do this:<ol><li>Create a token: log in to your Docker Hub account and go to <a href="https://hub.docker.com/settings/security" target="_blank">https://hub.docker.com/settings/security</a>.</li><li><a href="#create-a-secret" target="_blank">Create a secret</a> for your token.</li></ol></li><li>Go to the <strong>Account Settings</strong> &gt; <strong>Account Resources</strong> page and select <strong>Connectors</strong>.</li><li>Click <strong>New Connector</strong>. Under Artifact Repositories, click <strong>Docker Registry</strong>.</li><li>In the connector setup wizard, specify the following:<ol><li>Docker Registry URL = <strong>https://index.docker.io/v2/</strong></li><li>Provider Type = <strong>DockerHub</strong></li><li>Username = Your Docker Hub username</li><li>Password = The secret you created for your Docker Hub access token.</li></ol></li><li>In Delegates Setup, select <strong>Use any available Delegate</strong> and then click <strong>Save and Continue</strong>.</li><li>Wait for &#34;Verification successful&#34; and then click <strong>Finish</strong>.</li></ol></div></details><h3 id="create-a-codebase-connector">Create a Codebase Connector</h3><p>You&#39;ll need a GitHub Connector to do the <a href="https://docs.harness.io/article/yvy4pmt8bw" target="_blank">STO Tutorials</a>. You also need a Git repo connector for any STO pipeline that scans a codebase. You can create connectors for codebases in <a href="https://harness.helpdocs.io/article/jed9he2i45" target="_blank">AWS CodeCommit</a>, <a href="https://docs.harness.io/article/9epdx5m9ae" target="_blank">Azure</a>, <a href="https://harness.helpdocs.io/article/iz5tucdwyu" target="_blank">Bitbucket</a>, <a href="https://harness.helpdocs.io/article/tbm2hw6pr6" target="_blank">Git</a> (platform-agnostic), <a href="https://harness.helpdocs.io/article/v9sigwjlgo" target="_blank">GitHub</a>, and <a href="https://harness.helpdocs.io/article/5abnoghjgo" target="_blank">GitLab</a>.</p><div class="note-callout">To do the STO tutorials, point the connector at the following repo: <a href="https://github.com/williamwissemann/dvpwa">https://github.com/williamwissemann/dvpwa</a></div><details><summary>Create a GitHub Connector: Default Workflow</summary><div><ol><li>Go to the <strong>Account Settings</strong> &gt; <strong>Account Resources</strong> page and click <strong>Connectors</strong>.</li><li>Under Code Repositories, choose <strong>GitHub</strong>.</li><li>Specify the following in the setup wizard:<ol><li>Overview:<br/>Name = <strong>GitHub STO tutorial</strong></li><li>Details:<br/>URL Type =<strong> Repository</strong><br/>Connection Type = <strong>HTTP</strong><br/>GitHub Repository URL = <strong>https://github.com/williamwissemann/dvpwa</strong></li><li>Credentials:<br/>Username = <strong> </strong>Your GitHub username<br/>Personal Access Token = Your <a href="https://docs.harness.io/article/rlbw5luj4h#install-the-delegate#create-a-secret">GitHub Personal Access Token secret</a>.<br/>Enable API Access  — Select this checkbox and select the same secret.</li><li>Connect to the provider:<br/>Click <strong>Connect through Harness Platform</strong>.</li></ol></li><li>When you&#39;re done, click <strong>Save and Continue</strong>. Harness will test the connection and credentials. Click <strong>Finish</strong>.</li></ol></div></details><h3 id="create-an-sto-pipeline">Create a base pipeline for STO</h3><p>The following procedure creates a pipeline with the STO functionality required to run scans on your repos, images, and instances. Once you set up this pipeline, you can clone it to a new pipeline and update the pipeline to set up your scans. This workflow is described in <a href="https://docs.harness.io/article/yvy4pmt8bw" target="_blank">STO Tutorial 1</a>.</p><h4>Add a Security Test stage</h4><ol><li>In the Pipeline Studio, click <strong>Home</strong> &gt; <strong>Projects</strong> and choose the project where you want to create the pipeline.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661354922517/pipeline-stage-00.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li><li>Under Modules, choose <strong>Security Tests</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661355636355/pipeline-stage-01.png" style="max-height:50%;max-width:50%" data-hd-height="50%" data-hd-width="50%"/></figure></li><li>In Create New Pipeline:<ol><li>Click <strong>Pipelines</strong> &gt; <strong>New Pipeline</strong>.</li><li>In Create new Pipeline &gt; Name, enter <strong>sto-pipeline-base</strong>.</li><li>Click <strong>Start</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661355649487/pipeline-stage-02-b.png"/></figure></li></ol></li><li>In About your Stage:<ol><li>Click <strong>Add Stage</strong> and then select <strong>Security Tests</strong>.</li><li>Stage Name = <strong>securityTestStage</strong></li><li>Connector = The connector you created in <a href="https://docs.harness.io/article/rlbw5luj4h#install-the-delegate#create-a-codebase-connector" target="_blank">Create a Codebase Connector</a>.</li><li>Click <strong>Set Up Stage</strong>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661355932130/pipeline-stage-03.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li></ol></li></ol><p></p><h4 id="set-up-security-tests-stage">Set up the Security Tests stage</h4><ol><li>In the <strong>Overview</strong> tab, under <strong>Shared Paths</strong>, click <strong>Add</strong> and enter the path <code>/var/run</code>.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/m2nmo0gzp9/1664915691352/setup-stage-00-overview-varru.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li><li>In the <strong>Infrastructure</strong> tab, specify the following:<ol><li>The infrastructure where you want your builds to run = <strong>Kubernetes</strong></li><li>Kubernetes Cluster = The delegate you created in <a href="https://docs.harness.io/article/rlbw5luj4h#install-the-delegate" target="_blank">Install the delegate</a>.</li><li>Namespace = <code>harness-delegate-ng</code></li><li>OS = <code>Linux</code><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/m2nmo0gzp9/1664915724374/setup-stage-01-infra-tab.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li></ol></li><li>In the Execution tab, do the following:<ol><li>Click <strong>Add Service Dependency</strong>.</li><li>Dependency Name = <code>dind</code></li><li>Container Registry = The image connector you specified in <a href="https://docs.harness.io/article/create-a-dockerhub-connector">Create a Docker Hub connector</a>.</li><li>Image = <code>docker:dind</code></li><li>Under Optional Configuration, select the <strong>Privileged</strong> checkbox.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/m2nmo0gzp9/1664915778513/setup-stage-03-config-dind.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li></ol></li></ol><p></p><h4>Add a Security Step</h4><ol><li>In the Execution tab, click <strong>Add Step</strong> and select <strong>Security</strong>.</li><li>Configure the step as follows:<ol><li>Name = <strong>banditScan</strong></li><li><code>policy_type</code> = <strong><code>orchestratedScan</code></strong></li><li><code>scan_type</code> = <strong><code>repository</code></strong></li><li><code>product_name</code> = <code><strong>bandit</strong></code></li><li><code>product_config_name</code> = <strong><code>default</code></strong></li><li><code>repository_branch</code> = <strong><code>&lt;+codebase.branch&gt;</code></strong></li><li><code>repository_project</code> = <strong><code>dvpwa</code></strong></li></ol></li><li>Apply your changes, return to the Stage, and <strong>Save</strong> the pipeline.<figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661616083068/sto-setup-run-step-settings.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure></li></ol><h3>Run the pipeline (<em>optional</em>)</h3><ol><li>Click <strong>Run</strong>.</li><li>Select Git Branch, enter <strong>master</strong> for the branch name, and then click <strong>Run Pipeline</strong>.</li><li>When the pipeline finishes, click the <strong>Security Tests</strong> tab to see the dashboard.</li></ol><h3>Congratulations!</h3><p>You now have the build infrastructure, connectors, and pipeline required to build a pipeline and run security scans. You can simply clone the pipeline you just created and configure new pipelines based on your security requirements.</p><figure><img src="https://files.helpdocs.io/kw8ldg1itf/articles/rlbw5luj4h/1661431889676/clone-pipeline.png" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure><p></p><p></p>