type: article
article_id: ia5dwx5ya8
user_id: c5pqxi9gu9
category_id: rg8mrhqm95
author:
  name: Manish Jaiswal
  email: manish.jaiswal@harness.io
  profile_image: https://www.gravatar.com/avatar/a690002c3812e556fec2f79f91e5715e?d=mm&s=150
title: Define a Kubernetes Cluster Build Infrastructure
slug: set-up-a-kubernetes-cluster-build-infrastructure
description: This topic describes how to set up a Kubernetes cluster build infrastructure
  for a Harness CI stage. The codebase and tests you add to a Harness CI Stage are
  built and run using a build infrastructur…
short_version: This topic describes how to set up a Kubernetes cluster build infrastructure
  for a Harness CI stage. The codebase and tests you add to a Harness CI Stage are
  built and run using a build infrastructur…
tags: []
show_toc: true
is_private: false
is_published: true
is_featured: false
stale_status:
  is_stale: false
  reason: ""
  source: API
  triggered_at: 2022-05-04T15:06:32.659628Z
  expires_at: null
permission_groups: []
multilingual:
- language_code: en
  title: Define a Kubernetes Cluster Build Infrastructure
  description: ""
  short_version: ""
  body: |-
    <p>This topic describes how to set up a Kubernetes cluster build infrastructure for a Harness CI stage.</p><p>The codebase and tests you add to a Harness CI Stage are built and run using a build infrastructure in your environment.</p><p>Some CI providers use in-house orchestration systems for build farms like Docker Machine (<a href="https://docs.docker.com/machine/" target="_blank">deprecated since 2019</a>). With these systems, outages and backlogs can occur in their infrastructure. Often, the backlogs occur because they do not have enough capacity to cover the backlog that accrued during the outage.</p><p>Harness build farms run on <u>your</u> infrastructure using battle-tested platforms for large container workloads (Kubernetes, AWS VMs). This enables you to build software and run tests, repeatedly and automatically, on a scalable platform with no outages.</p><p>Once you set up the Kubernetes cluster to use as your build infrastructure, you connect Harness to it using a Harness Kubernetes Cluster Connector and Harness Delegate.</p><div class="note-callout">You can also use an AWS VM build infrastructure. See <a href="/article/z56wmnris8-set-up-an-aws-vm-build-infrastructure">Define an AWS VM Build Infrastructure</a>.</div><h3>Limitations</h3><h4>GKE Autopilot is Not Supported</h4><div class="hd--html"><details>
      <summary>Harness CI doesn&#39;t support GKE Autopilot for the following reasons.</summary>
      <div>
        <h5>Cannot use Docker-in-Docker </h5>
        <p>Autopilot clusters do not allow Privileged pods. Thus you cannot use <a href="https://ngdocs.harness.io/article/ajehk588p4" target="_blank">Docker-in-Docker</a> to run Docker commands, since these require Privileged mode.</p>
        <h5>GKE Autopilot Can Result in Higher Cloud Costs</h5>
        <p>GKE Autopilot sets resource limits = resource requests for each container. This can cause your Builds to allocate more resources than they need. The result is higher cloud costs with no added benefit. </p>
        <p>Consider the following CI Stage:</p>
        <figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/ia5dwx5ya8/1650375095800/6-ktko-wt-be-0-sgex-fp-2-id-vs-ukc-3-3-yh-9-my-zlemeg-g-6-cn-2-irpys-aak-uz-7-m-x-2-p-qb-qed-91-h-5-k-37-x-r-7-vximk-vsy-pw-3-fqqniwp-gpl-lrz-c-g-wn-mu-pxz-7-d-dnh-1-lu-4-t-1-pikig-rvoqhr-aqs-5-m-o" style="display:block;margin-left:0;margin-right:auto" data-hd-align="left"/></figure>
        <p>  Assume that you configure your Stage resources as follows:</p>
        <ul>
          <li>redis (service dependency): 5GB, 2 cpu</li>
          <li>s1 step: 2GB, 2 cpu</li>
          <li>s2 step: 3GB, 1 cpu</li>
          <li>s3 step: 4GB, 1 cpu</li>
          <li>s4 step: 2GB, 1 cpu</li>
          <li>s5 step: 2GB, 1 cpu</li>
        </ul>
        <p>Kubernetes will allocate the pod based on the maximum requirements for the overall Stage — in this case, when the s3, s4, and s5 steps run in parallel. The pod also needs to run the Redis service at the same time. The requirements are the sum of Redis + s3 + s4 + s5: </p>
        <ul>
          <li>5 + 4 + 2 + 2 = <strong>13GB Memory</strong></li>
          <li>2 + 1 + 1 + 1 = <strong>5 CPUs</strong></li>
        </ul>
        <p>GKE Autopilot calculates resource requirements differently. For containers, it sets resource limits to the same as resource requests. For pods, it sums all Step requirements in the Stage, whether they’re running in parallel or not. In this case, the requirements are the sum of Redis + s1 + s2 + s3 + s4 + s5:</p>
        <ul>
          <li>5 + 2 + 2+ 4 + 4 + 4 = <strong>17GB Memory</strong></li>
          <li>2 + 1 + 1+ 1 + 1 + 1 = <strong>7 CPUs</strong></li>
        </ul>
        <p>Autopilot might be cheaper than standard Kubernetes if you only run builds occasionally. This can result in cost savings because some worker nodes are always running in a standard Kubernetes cluster. </p>
      </div>
    </details></div><p></p><h3>Before You Begin</h3><ul><li><a href="https://ngdocs.harness.io/article/x0d77ktjw8-ci-pipeline-quickstart">CI Pipeline Quickstart</a></li><li><a href="https://ngdocs.harness.io/article/2k7lnc7lvl-delegates-overview">Delegates Overview</a></li><li><a href="https://ngdocs.harness.io/article/yn4x8vzw3q-ci-stage-settings">CI Stage Settings</a></li><li><a href="https://ngdocs.harness.io/article/hv2758ro4e-learn-harness-key-concepts">Learn Harness&#39; Key Concepts</a></li></ul><h3>Visual Summary</h3><p>Here&#39;s a short video that walks you through adding a Harness Kubernetes Cluster Connector and Harness Kubernetes Delegate. The Delegate is added to the target cluster, then the Kubernetes Cluster Connector uses the Delegate to connect to the cluster.</p><div class="hd--embed" data-provider="YouTube" data-thumbnail="https://i.ytimg.com/vi/wUC23lmqfnY/hqdefault.jpg"><iframe width=" 200" height="150" src="https://www.youtube.com/embed/wUC23lmqfnY?feature=oembed" frameborder="0" allowfullscreen="allowfullscreen"></iframe></div><p></p><h3>Step 1: Create a Kubernetes Cluster</h3><h4>Prerequisites</h4><ul><li>Ensure your Kubernetes cluster meets the build infrastructure requirements in <a href="/article/sjjik49xww-kubernetes-cluster-connector-settings-reference#harness_ci_cluster_requirements">CI Cluster Requirement</a>.</li><li>For Harness-specific permission requirements, see <a href="https://ngdocs.harness.io/article/sjjik49xww-kubernetes-cluster-connector-settings-reference#permissions_required">permission required</a> for CI.</li><li>Install the Harness Kubernetes Delegate on the same cluster you use as your build infrastructure. Make sure that the cluster has enough memory and CPU for the Delegate you are installing.<div class="note-callout">Harness Kubernetes Delegates can be in a different <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a> than the one you provide while <a href="/article/x7aedul8qs-kubernetes-cluster-build-infrastructure-setup#step_1_define_the_build_farm_infrastructure">defining the build farm infrastructure</a> for the CI Pipeline.</div></li></ul><p>To create a new Kubernetes cluster, see:</p><ul><li><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/create-cluster/">Creating a cluster in Kubernetes</a></li><li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-zonal-cluster">Creating a cluster in GKE (Google Kubernetes Engine</a>)</li></ul><h3>Step 2: Add Kubernetes Cluster Connector and Delegate in Harness</h3><ul><li>In your <strong>Project</strong>, click <strong>Project Setup</strong>.</li><li>Click <strong>Connectors</strong>.</li><li>Click <strong>New Connector</strong> and then click <strong>Kubernetes Cluster</strong>.</li></ul><p>Set up the Connector as follows.</p><h4>Connector Overview</h4><ul><li>Enter a unique name for the Connector.</li></ul><h4>Connector Details</h4><p>You can select Master URL and Credentials or Use the credentials of a specific Harness Delegate. </p><p>In this example, click Use the credentials of a specific Harness Delegate and click <strong>Continue</strong>.</p><h4>Delegate Setup</h4><p>You should now be in the Delegates Setup screen of the GitHub Connector wizard. Click <strong>Install new Delegate</strong>.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jznnrb9tvz/1648478859173/ci-tut-02-delegate-01-setu.png" style="max-height:50%;max-width:50%;display:block;margin-left:0;margin-right:auto" data-hd-height="50%" data-hd-width="50%" data-hd-align="left"/></figure><h4>Delegate Location</h4><p>You can install the Delegate in different locations. Usually it makes sense to install and run the Delegate on a pod in your Kubernetes build infrastructure. You&#39;ll do this in the next steps.</p><ul><li>Select <strong>Kubernetes</strong>.</li></ul><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jznnrb9tvz/1648479234464/ci-tut-02-delegate-02-platform.png" style="max-height:50%;max-width:50%;display:block;margin-left:0;margin-right:auto" data-hd-height="50%" data-hd-width="50%" data-hd-align="left"/></figure><h4>Delegate Details</h4><p>Now you specify the Delegate name, size, and permissions.</p><ul><li>Specify the following:<ul><li><strong>Delegate name</strong></li><li><strong>Delegate size</strong></li><li><strong>Delegate Permissions:</strong> Install Delegate with cluster-wide read/write access<br/>This is simply a default. In the future, you can add configurations to run scripts on your Delegates and scope them to different environments.</li></ul></li></ul><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jznnrb9tvz/1648480695665/ci-tut-02-delegate-03-details.png" style="max-height:50%;max-width:50%;display:block;margin-left:0;margin-right:auto" data-hd-height="50%" data-hd-width="50%" data-hd-align="left"/></figure><h4>Delegate Install</h4><p>Harness now generates and displays a workspace-definition YAML file that you can install in your build infrastructure.</p><figure><img src="https://files.helpdocs.io/i5nl071jo5/articles/jznnrb9tvz/1648480953258/ci-tut-02-delegate-04-download-yaml.png" style="max-height:50%;max-width:50%;display:block;margin-left:0;margin-right:auto" data-hd-height="50%" data-hd-width="50%" data-hd-align="left"/></figure><ul><li>Click <strong>Download Script</strong>. This downloads the YAML file for the Kubernetes Delegate.</li><li>Open a terminal and navigate to where the Delegate file is located. You&#39;ll connect to your cluster using the terminal so you can simply run the YAML file on the cluster.</li><li>In the same terminal, log into your Kubernetes cluster. In most platforms, you select the cluster, click <strong>Connect</strong>, and copy the access command.</li><li>Install the Harness Delegate using the <strong>harness-delegate.yaml</strong> file you just downloaded. Click <strong>Next</strong> in the Harness UI, then run the command shown. For example:<pre class="hljs bash">kubectl apply -f harness-delegate.yaml</pre>You should see output similar to this:<pre class="hljs cpp">% kubectl apply -f harness-delegate.yaml<br/>namespace/harness-delegate-ng created<br/>clusterrolebinding.rbac.authorization.k8s.io/harness-delegate-ng-cluster-admin created<br/>secret/ci-quickstart created<br/>statefulset.apps/ci-quickstart created<br/>service/delegate-service created</pre></li></ul><h4>Connect to the Delegate</h4><ul><li>Return to the Harness UI. It might take a few minutes to verify the Delegate. Once it is verified, close the wizard.</li><li>Back in <strong>Delegates Setup</strong>, you can select the new Delegate:<ul><li>In the list of Delegates, you can see your new Delegate and its tags.</li><li>Select the <strong>Connect using Delegates with the following Tags</strong> option.</li><li>Enter the tag of the new Delegate and click <strong>Save and Continue</strong>.</li><li>Wait for the connection test to complete and then click <strong>Finish</strong>.</li></ul></li></ul><h3>Step 3: Define the Build Farm Infrastructure in Harness</h3><p>In this step, you set up your build infrastructure using the Connector and Delegate you added previously. </p><p>In the CI stage Infrastructure, select the Kubernetes Cluster Connector you created in the previous step.</p><p>In Namespace, enter the Kubernetes namespace to use.</p><p>You can use a Runtime Input (<code>&lt;+input&gt;</code>) or expression also. See <a href="https://ngdocs.harness.io/article/f6yobn7iq0-runtime-inputs">Runtime Inputs</a>.</p><h3>Option: Service Account Name</h3><p>The Kubernetes service account name. You must set this field in the following cases:</p><ul><li>Your build infrastructure runs on EKS, you have an IAM role associated with the service account, and a CI step uses an AWS Connector with IRSA. See <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html">IAM Roles for Service Accounts</a> in the AWS docs. </li><li>You have a CI Build stage with Steps that communicate with any external services using a service account other than default. See <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Configure Service Accounts for Pods</a> in the Kubernetes docs.  </li></ul><h3>Option: Run as User</h3><p>You can override the default Linux user ID for containers running in the build infrastructure. This is useful if your organization requires containers to run as a specific user with a specific set of permissions. See <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-pod">Configure a security context for a Pod</a> in the Kubernetes docs. </p><h3>Option: Init Timeout</h3><p>If you use large images in your Build Steps, you might find that the initialization step times out and the build fails when the Pipeline runs. In this case, you can increase the default init time window (10 minutes). </p><h3>Option: Add Annotations </h3><p>You can add Kubernetes annotations to the pods in your infrastructure. An annotation can be small or large, structured or unstructured, and can include characters not permitted by labels. See <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/">Annotations</a> in the Kubernetes docs. </p><h3>Option: Add Labels </h3><p>You can add Kubernetes labels (key-value pairs) to the pods in your infrastructure. Labels are useful for searching, organizing, and selecting objects with shared metadata. See <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">Labels and Selectors</a> in the Kubernetes docs. </p><div class="note-callout">If a custom label value does not match the following regex, the label won&#39;t get generated:<br/><code>^[a-z0-9A-Z][a-z0-9A-Z\\-_.]*[a-z0-9A-Z]$ </code></div><p>Labels make it easy to find pods associated with specific Stages, Organizations, Projects, Pipelines, Builds, and any custom labels you want to add: </p><pre>kubectl get pods -l stageID=mycibuildstage</pre><p></p><p>Harness adds the following labels automatically:</p><ul><li><code>stageID</code>: See <code>pipeline.stages.stage.identifier</code> in the Pipeline YAML. </li><li><code>stageName</code>: See <code>pipeline.stages.stage.name</code> in the Pipeline YAML. </li><li><code>orgID</code>: See <code>pipeline.orgIdentifier</code> in the Pipeline YAML. </li><li><code>projectID</code>: See <code>pipeline.projectIdentifier</code> in the Pipeline YAML.</li><li><code>pipelineID</code>: See <code>pipeline.identifier</code> in the Pipeline YAML.</li><li><code>pipelineExecutionId</code>: To find this, go to a CI Build in the Harness UI. The <code>pipelineExecutionID</code> is near the end of the URL path, between <span style="color:#009ce0" data-hd-color="#009ce0">executions/</span> and <span style="color:#009ce0" data-hd-color="#009ce0">/pipeline</span>: <span style="color:#009ce0" data-hd-color="#009ce0">https://app.harness.io/ng/#/account/myaccount/ci/orgs/myusername/projects/myproject/pipelines/mypipeline/executions/<strong>PIPELINE_EXECUTION-ID</strong>/pipeline</span></li></ul><h3>Configure As Code</h3><p>When configuring your Pipeline in YAML, you add the Kubernetes Cluster CI infrastructure using the infrastructure of type KubernetesDirect:</p><pre class="hljs yaml">pipeline:<br/>...<br/>  stages:<br/>    - stage:<br/>        ...<br/>        spec:<br/>          ...<br/>          infrastructure:<br/>            type: KubernetesDirect<br/>            spec:<br/>              connectorRef: account.mydelegate<br/>              namespace: default<br/>          ...</pre><p></p><p></p><p>Once the build infrastructure is set up, you can now add CI stages to execute your Run steps to build, deploy your code.</p><h3>See Also</h3><ul><li><a href="https://ngdocs.harness.io/article/1gaud2efd4" target="_blank">Add a Kubernetes Cluster Connector</a></li><li><a href="https://ngdocs.harness.io/article/sjjik49xww-kubernetes-cluster-connector-settings-reference">Kubernetes Cluster Connector Settings</a></li></ul><p></p>
  slug: set-up-a-kubernetes-cluster-build-infrastructure
  tags: []
  is_live: true
